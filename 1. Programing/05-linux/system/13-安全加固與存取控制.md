# 安全加固與存取控制

## 目錄
- [概述](#概述)
- [系統安全基礎](#系統安全基礎)
- [使用者與權限強化](#使用者與權限強化)
- [SELinux 強制存取控制](#selinux-強制存取控制)
- [AppArmor 應用程式防護](#apparmor-應用程式防護)
- [審計系統](#審計系統)
- [加密與憑證](#加密與憑證)
- [安全掃描與加固](#安全掃描與加固)
- [最佳實踐](#最佳實踐)
- [實戰案例](#實戰案例)

---

## 概述

系統安全加固是透過多層防護機制減少攻擊面,防止未授權存取與資料洩漏。

**安全層級：**
1. 實體安全: BIOS 密碼,機櫃鎖定
2. 開機安全: GRUB 密碼,安全啟動
3. 系統安全: 使用者權限,防火牆,SELinux
4. 應用安全: 最小權限,輸入驗證
5. 資料安全: 加密,備份,審計

---

## 系統安全基礎

### 最小化安裝原則

```bash
$ sudo apt autoremove
$ sudo dnf autoremove

$ sudo apt purge telnet rsh-client

$ systemctl list-unit-files --state=enabled
$ sudo systemctl disable bluetooth.service
$ sudo systemctl stop bluetooth.service

$ sudo systemctl list-sockets --all
```

### 自動更新

**Debian/Ubuntu:**
```bash
$ sudo apt install unattended-upgrades

$ sudo dpkg-reconfigure --priority=low unattended-upgrades

$ sudo vi /etc/apt/apt.conf.d/50unattended-upgrades
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
```

**RHEL/CentOS:**
```bash
$ sudo dnf install dnf-automatic

$ sudo vi /etc/dnf/automatic.conf
[commands]
apply_updates = yes

$ sudo systemctl enable --now dnf-automatic.timer
```

### 核心參數強化

```bash
$ sudo vi /etc/sysctl.conf

kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2
kernel.randomize_va_space = 2

net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_syncookies = 1

fs.suid_dumpable = 0

$ sudo sysctl -p
```

### GRUB 密碼保護

```bash
$ sudo grub-mkpasswd-pbkdf2
Enter password:
PBKDF2 hash of your password is grub.pbkdf2.sha512.10000...

$ sudo vi /etc/grub.d/40_custom
set superusers="admin"
password_pbkdf2 admin grub.pbkdf2.sha512.10000...

$ sudo update-grub
```

---

## 使用者與權限強化

### 密碼策略

```bash
$ sudo vi /etc/login.defs
PASS_MAX_DAYS   90
PASS_MIN_DAYS   7
PASS_MIN_LEN    12
PASS_WARN_AGE   14

$ sudo chage -M 90 -m 7 -W 14 username

$ sudo chage -l username
```

**PAM 密碼複雜度:**
```bash
$ sudo apt install libpam-pwquality

$ sudo vi /etc/security/pwquality.conf
minlen = 12
dcredit = -1
ucredit = -1
ocredit = -1
lcredit = -1
difok = 3
retry = 3
```

### 帳號鎖定

```bash
$ sudo vi /etc/pam.d/common-auth

auth required pam_tally2.so deny=5 unlock_time=900 onerr=fail

$ sudo pam_tally2 -u username

$ sudo pam_tally2 -u username --reset
```

### sudo 權限管理

```bash
$ sudo visudo

%wheel ALL=(ALL) ALL

username ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx

username ALL=(ALL) !/bin/su, !/usr/bin/passwd root

Defaults    timestamp_timeout=5
Defaults    passwd_tries=3
Defaults    logfile=/var/log/sudo.log
Defaults    log_year, log_host, loglinelen=0

$ sudo -l
```

### 限制 root 登入

```bash
$ sudo vi /etc/ssh/sshd_config
PermitRootLogin no

$ sudo systemctl restart sshd

$ cat /etc/securetty
console
tty1
```

### umask 設定

```bash
$ umask
0022

$ umask 0027

$ sudo vi /etc/profile
umask 027

$ sudo vi /etc/bashrc
umask 027
```

---

## SELinux 強制存取控制

### SELinux 基礎

```bash
$ getenforce
Enforcing

$ sestatus
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
Current mode:                   enforcing
Mode from config file:          enforcing
Policy version:                 31
Policy from config file:        targeted
```

### 模式切換

```bash
$ sudo setenforce 0
$ getenforce
Permissive

$ sudo setenforce 1
$ getenforce
Enforcing

$ sudo vi /etc/selinux/config
SELINUX=enforcing
SELINUXTYPE=targeted
```

### 檔案 Context

```bash
$ ls -Z /var/www/html/
-rw-r--r--. apache apache unconfined_u:object_r:httpd_sys_content_t:s0 index.html

$ semanage fcontext -l | grep httpd

$ sudo semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"

$ sudo restorecon -Rv /web

$ sudo chcon -t httpd_sys_content_t /var/www/html/test.html

$ matchpathcon /var/www/html/index.html
```

### 布林值管理

```bash
$ getsebool -a | grep httpd
httpd_can_network_connect --> off
httpd_enable_cgi --> on

$ sudo setsebool httpd_can_network_connect on

$ sudo setsebool -P httpd_can_network_connect on
```

### 埠號管理

```bash
$ semanage port -l | grep http
http_port_t                    tcp      80, 443, 488, 8008, 8009, 8443

$ sudo semanage port -a -t http_port_t -p tcp 8080

$ sudo semanage port -d -t http_port_t -p tcp 8080
```

### 疑難排解

```bash
$ sudo ausearch -m avc -ts recent

$ sudo aureport -a

$ sudo audit2why < /var/log/audit/audit.log

$ sudo audit2allow -a

$ sudo audit2allow -a -M mypolicy
$ sudo semodule -i mypolicy.pp
```

---

## AppArmor 應用程式防護

### AppArmor 狀態

```bash
$ sudo aa-status
apparmor module is loaded.
15 profiles are loaded.
15 profiles are in enforce mode.
0 profiles are in complain mode.
```

### Profile 管理

```bash
$ sudo aa-enforce /etc/apparmor.d/usr.sbin.nginx

$ sudo aa-complain /etc/apparmor.d/usr.sbin.nginx

$ sudo aa-disable /etc/apparmor.d/usr.sbin.nginx

$ sudo aa-logprof

$ sudo aa-genprof /usr/bin/myapp
```

### 建立 Profile

```bash
$ sudo vi /etc/apparmor.d/usr.bin.myapp

#include <tunables/global>

/usr/bin/myapp {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  /usr/bin/myapp mr,
  /etc/myapp/** r,
  /var/log/myapp/*.log w,
  /var/run/myapp.pid rw,
  
  capability net_bind_service,
  
  network inet stream,
  network inet6 stream,
}

$ sudo apparmor_parser -r /etc/apparmor.d/usr.bin.myapp
```

---

## 審計系統

### auditd 配置

```bash
$ sudo systemctl status auditd

$ sudo vi /etc/audit/auditd.conf
log_file = /var/log/audit/audit.log
max_log_file = 50
max_log_file_action = ROTATE
num_logs = 5

$ sudo systemctl restart auditd
```

### 審計規則

```bash
$ sudo auditctl -l

$ sudo auditctl -w /etc/passwd -p wa -k passwd_changes

$ sudo auditctl -w /etc/shadow -p wa -k shadow_changes

$ sudo auditctl -w /etc/sudoers -p wa -k sudoers_changes

$ sudo auditctl -a always,exit -F arch=b64 -S open,openat -F success=0 -k file_access_failures

$ sudo auditctl -a always,exit -F arch=b64 -S adjtimex,settimeofday -k time_change

$ sudo vi /etc/audit/rules.d/audit.rules
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -k delete

$ sudo service auditd restart
```

### 審計日誌查詢

```bash
$ sudo ausearch -k passwd_changes

$ sudo ausearch -m USER_LOGIN -ts today

$ sudo ausearch -ui 1000 -ts recent

$ sudo aureport --summary

$ sudo aureport --auth

$ sudo aureport --failed

$ sudo aureport -x --summary
```

---

## 加密與憑證

### 磁碟加密 (LUKS)

```bash
$ sudo cryptsetup luksFormat /dev/sdb1
WARNING: This will overwrite data on /dev/sdb1 irrevocably.
Are you sure? (Type uppercase yes): YES
Enter passphrase:

$ sudo cryptsetup luksOpen /dev/sdb1 encrypted_disk
Enter passphrase for /dev/sdb1:

$ sudo mkfs.ext4 /dev/mapper/encrypted_disk

$ sudo mount /dev/mapper/encrypted_disk /mnt/encrypted

$ sudo vi /etc/crypttab
encrypted_disk /dev/sdb1 none luks

$ sudo cryptsetup luksClose encrypted_disk
```

### OpenSSL 加密

```bash
$ openssl enc -aes-256-cbc -salt -in file.txt -out file.enc
enter aes-256-cbc encryption password:

$ openssl enc -d -aes-256-cbc -in file.enc -out file.txt
enter aes-256-cbc decryption password:

$ tar czf - /path/to/dir | openssl enc -aes-256-cbc -out backup.tar.gz.enc

$ openssl enc -d -aes-256-cbc -in backup.tar.gz.enc | tar xz
```

### SSL/TLS 憑證

```bash
$ openssl genrsa -out private.key 2048

$ openssl req -new -key private.key -out request.csr

$ openssl x509 -req -days 365 -in request.csr -signkey private.key -out certificate.crt

$ openssl x509 -in certificate.crt -text -noout

$ openssl s_client -connect example.com:443 -showcerts

$ openssl verify certificate.crt
```

---

## 安全掃描與加固

### Lynis 安全掃描

```bash
$ sudo apt install lynis

$ sudo lynis audit system

$ sudo lynis audit system --quick

$ sudo lynis show groups

$ sudo lynis show tests

$ cat /var/log/lynis.log
$ cat /var/log/lynis-report.dat
```

### CIS 基準檢查

```bash
$ sudo apt install openscap-scanner scap-security-guide

$ oscap info /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml

$ sudo oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_cis \
    --results results.xml \
    --report report.html \
    /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml
```

### 檔案完整性檢查

**AIDE:**
```bash
$ sudo apt install aide

$ sudo aideinit

$ sudo cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db

$ sudo aide --check

$ sudo aide --update
```

**Tripwire:**
```bash
$ sudo apt install tripwire

$ sudo tripwire --init

$ sudo tripwire --check

$ sudo tripwire --update -r /path/to/report.twr
```

### 端口掃描

```bash
$ nmap localhost

$ sudo nmap -sS -sV -O localhost

$ sudo nmap -p- localhost

$ sudo ss -tuln
```

---

## 最佳實踐

### 安全 Checklist

**系統層級:**
- [ ] 定期更新系統與套件
- [ ] 移除不需要的服務與套件
- [ ] 設定防火牆規則
- [ ] 啟用 SELinux/AppArmor
- [ ] 配置 auditd 審計
- [ ] 設定自動安全更新

**使用者管理:**
- [ ] 強制密碼複雜度
- [ ] 定期變更密碼
- [ ] 禁用不需要的帳號
- [ ] 限制 root 登入
- [ ] 配置 sudo 權限
- [ ] 設定帳號鎖定策略

**網路安全:**
- [ ] 僅開放必要埠號
- [ ] 使用 SSH 金鑰認證
- [ ] 變更預設 SSH 埠號
- [ ] 啟用 Fail2ban
- [ ] 配置 TCP Wrapper
- [ ] 啟用網路加密 (TLS/SSL)

**檔案系統:**
- [ ] 設定適當檔案權限
- [ ] 使用 noexec,nosuid 掛載選項
- [ ] 分離分區 (/tmp, /var, /home)
- [ ] 啟用磁碟加密
- [ ] 定期備份重要資料
- [ ] 檔案完整性監控

**監控與審計:**
- [ ] 啟用系統日誌
- [ ] 集中日誌管理
- [ ] 監控異常登入
- [ ] 追蹤檔案變更
- [ ] 定期審查日誌
- [ ] 設定安全告警

---

## 實戰案例

### 案例 1: SSH 安全加固

```bash
$ sudo vi /etc/ssh/sshd_config

Port 2222
Protocol 2
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding no
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
AllowUsers user1 user2
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
LoginGraceTime 60

$ sudo systemctl restart sshd

$ sudo apt install fail2ban

$ sudo vi /etc/fail2ban/jail.local
[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600

$ sudo systemctl restart fail2ban
```

### 案例 2: Web 伺服器加固

```bash
$ sudo chown -R www-data:www-data /var/www/html
$ sudo find /var/www/html -type d -exec chmod 755 {} \;
$ sudo find /var/www/html -type f -exec chmod 644 {} \;

$ sudo vi /etc/nginx/nginx.conf
server_tokens off;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000" always;

$ sudo semanage fcontext -a -t httpd_sys_content_t "/var/www/html(/.*)?"
$ sudo restorecon -Rv /var/www/html

$ sudo setsebool -P httpd_can_network_connect on
$ sudo setsebool -P httpd_can_network_connect_db on
```

### 案例 3: 資料庫安全

```bash
$ sudo mysql_secure_installation

$ sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf
bind-address = 127.0.0.1
skip-name-resolve
local-infile = 0

$ mysql -u root -p
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON appdb.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;

$ sudo chmod 600 /etc/mysql/mysql.conf.d/mysqld.cnf
$ sudo chown mysql:mysql /etc/mysql/mysql.conf.d/mysqld.cnf
```

### 案例 4: 檔案系統加固

```bash
$ sudo vi /etc/fstab
/dev/sda1  /  ext4  defaults  0  1
/dev/sda2  /tmp  ext4  defaults,noexec,nosuid,nodev  0  2
/dev/sda3  /var  ext4  defaults,nodev  0  2
/dev/sda4  /home  ext4  defaults,nodev,nosuid  0  2

$ sudo mount -o remount /tmp

$ sudo find / -xdev -type f -perm -4000 -ls

$ sudo chmod u-s /usr/bin/suspect-suid-file

$ sudo find / -nouser -o -nogroup

$ sudo find / -type f -perm -002 -ls
```

### 案例 5: 安全審計自動化

```bash
#!/bin/bash

REPORT="/var/log/security-audit-$(date +%Y%m%d).log"

cat > $REPORT <<EOF
安全審計報告
生成時間: $(date)

========== 系統更新狀態 ==========
$(apt list --upgradable 2>/dev/null | grep -v "Listing")

========== 失敗登入嘗試 ==========
$(sudo grep "Failed password" /var/log/auth.log | tail -20)

========== sudo 使用記錄 ==========
$(sudo grep "sudo" /var/log/auth.log | tail -20)

========== 監聽埠號 ==========
$(sudo ss -tuln)

========== SUID 檔案 ==========
$(sudo find / -xdev -type f -perm -4000 2>/dev/null)

========== 世界可寫檔案 ==========
$(sudo find / -xdev -type f -perm -002 2>/dev/null | head -20)

========== 最近建立的帳號 ==========
$(awk -F: '$3 >= 1000 {print $1, $3, $4}' /etc/passwd)

========== SELinux 違規 ==========
$(sudo ausearch -m avc -ts today 2>/dev/null | head -20)

========== 防火牆狀態 ==========
$(sudo iptables -L -n -v)

EOF

echo "審計報告已生成: $REPORT"
cat $REPORT | mail -s "安全審計報告 $(date +%Y-%m-%d)" admin@example.com
```

---

> **參考資料：**
> - CIS Benchmarks
> - NIST Cybersecurity Framework
> - Red Hat Security Guide
> - SELinux Project Documentation
> - OWASP Security Guidelines
