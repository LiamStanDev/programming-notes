# 日誌與監控系統

## 目錄
- [概述](#概述)
- [日誌系統架構](#日誌系統架構)
- [systemd journald](#systemd-journald)
- [syslog 系統](#syslog-系統)
- [日誌管理](#日誌管理)
- [系統監控工具](#系統監控工具)
- [效能指標收集](#效能指標收集)
- [告警與通知](#告警與通知)
- [最佳實踐](#最佳實踐)
- [實戰案例](#實戰案例)

---

## 概述

日誌記錄系統事件,監控追蹤系統狀態。兩者結合可快速定位問題、預防故障、優化效能。

**核心目標：**
- 記錄系統與應用事件
- 即時監控資源使用
- 異常檢測與告警
- 效能分析與優化
- 安全審計與合規

---

## 日誌系統架構

### Linux 日誌架構

```mermaid
graph TB
    A[應用程式] --> B[syslog API]
    C[核心] --> D[/dev/kmsg]
    E[systemd服務] --> F[journald]
    
    B --> G[rsyslog]
    D --> F
    F --> H[/var/log/journal/]
    G --> I[/var/log/]
    
    F -.轉發.-> G
    G -.遠端.-> J[集中日誌伺服器]
```

### 日誌級別

| 級別 | 數值 | 說明 | 範例 |
|------|------|------|------|
| emerg | 0 | 系統無法使用 | 核心崩潰 |
| alert | 1 | 需立即處理 | 資料庫損毀 |
| crit | 2 | 嚴重錯誤 | 硬體故障 |
| err | 3 | 一般錯誤 | 服務啟動失敗 |
| warning | 4 | 警告訊息 | 磁碟空間不足 |
| notice | 5 | 正常但重要 | 服務重啟 |
| info | 6 | 資訊訊息 | 使用者登入 |
| debug | 7 | 除錯訊息 | 詳細追蹤 |

### 主要日誌檔案

```bash
/var/log/syslog          # Debian/Ubuntu 系統日誌
/var/log/messages        # RHEL/CentOS 系統日誌
/var/log/auth.log        # 認證日誌
/var/log/secure          # RHEL 認證日誌
/var/log/kern.log        # 核心日誌
/var/log/dmesg           # 開機訊息
/var/log/cron            # cron 任務日誌
/var/log/mail.log        # 郵件日誌
/var/log/apache2/        # Apache 日誌
/var/log/nginx/          # Nginx 日誌
/var/log/mysql/          # MySQL 日誌
```

---

## systemd journald

### journalctl 基本使用

```bash
$ journalctl
-- Logs begin at Mon 2024-01-01 00:00:00 UTC --
Jan 10 10:30:15 server systemd[1]: Started Session 1 of user admin.
Jan 10 10:30:20 server sshd[1234]: Accepted publickey for admin

$ journalctl -n 50

$ journalctl -f

$ journalctl -r

$ journalctl --since "2024-01-10 10:00:00"
$ journalctl --since today
$ journalctl --since yesterday
$ journalctl --since "1 hour ago"

$ journalctl --until "2024-01-10 12:00:00"

$ journalctl --since "2024-01-10 09:00" --until "2024-01-10 12:00"
```

### 服務與單元日誌

```bash
$ journalctl -u nginx.service
$ journalctl -u sshd

$ journalctl -u nginx -u mysql

$ journalctl -u nginx --since today

$ journalctl -u nginx -f

$ systemctl status nginx
● nginx.service - A high performance web server
   Loaded: loaded (/lib/systemd/system/nginx.service)
   Active: active (running) since Wed 2024-01-10 10:00:00 UTC
```

### 過濾與查詢

```bash
$ journalctl -p err

$ journalctl -p warning

$ journalctl -p 0..3

$ journalctl -b

$ journalctl -b -1

$ journalctl --list-boots

$ journalctl _PID=1234

$ journalctl _UID=1000

$ journalctl _COMM=nginx

$ journalctl SYSLOG_FACILITY=3

$ journalctl -k
```

### 輸出格式

```bash
$ journalctl -o short

$ journalctl -o verbose

$ journalctl -o json

$ journalctl -o json-pretty

$ journalctl -o cat

$ journalctl -o export > journal.export
```

### 磁碟使用與清理

```bash
$ journalctl --disk-usage
Archived and active journals take up 512.0M in the file system.

$ sudo journalctl --vacuum-size=100M

$ sudo journalctl --vacuum-time=7d

$ sudo journalctl --verify

$ sudo vi /etc/systemd/journald.conf
[Journal]
SystemMaxUse=500M
SystemKeepFree=1G
SystemMaxFileSize=100M
MaxRetentionSec=7day

$ sudo systemctl restart systemd-journald
```

---

## syslog 系統

### rsyslog 配置

**主配置檔：** `/etc/rsyslog.conf`

```bash
$ sudo vi /etc/rsyslog.conf

$ModLoad imuxsock
$ModLoad imklog

auth,authpriv.*         /var/log/auth.log
*.*;auth,authpriv.none  -/var/log/syslog
kern.*                  -/var/log/kern.log
mail.*                  -/var/log/mail.log
cron.*                  /var/log/cron.log

*.emerg                 :omusrmsg:*

*.info;mail.none;authpriv.none;cron.none   /var/log/messages

local7.*                /var/log/boot.log
```

### 自訂規則

```bash
$ sudo vi /etc/rsyslog.d/50-custom.conf

if $programname == 'myapp' then /var/log/myapp.log
& stop

:msg, contains, "error" /var/log/errors.log

:msg, regex, "failed.*login" /var/log/security.log

$ sudo systemctl restart rsyslog
```

### 遠端日誌

**發送端：**
```bash
$ sudo vi /etc/rsyslog.conf

*.* @@logserver.example.com:514

*.* @logserver.example.com:514

$ sudo systemctl restart rsyslog
```

**接收端：**
```bash
$ sudo vi /etc/rsyslog.conf

$ModLoad imudp
$UDPServerRun 514

$ModLoad imtcp
$InputTCPServerRun 514

$template RemoteHost,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteHost

$ sudo systemctl restart rsyslog

$ sudo firewall-cmd --add-port=514/tcp --permanent
$ sudo firewall-cmd --add-port=514/udp --permanent
$ sudo firewall-cmd --reload
```

### logger 工具

```bash
$ logger "測試訊息"

$ logger -p user.notice "這是通知"

$ logger -t myapp "應用程式訊息"

$ logger -f /path/to/file

$ echo "錯誤發生" | logger -p user.err -t script

$ logger -s "同時輸出到 stderr"
```

---

## 日誌管理

### logrotate 配置

**主配置檔：** `/etc/logrotate.conf`

```bash
$ sudo vi /etc/logrotate.conf

weekly
rotate 4
create
compress
include /etc/logrotate.d
```

**自訂規則：** `/etc/logrotate.d/nginx`

```bash
$ sudo vi /etc/logrotate.d/nginx

/var/log/nginx/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    prerotate
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
            run-parts /etc/logrotate.d/httpd-prerotate; \
        fi \
    endscript
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

**選項說明：**
- `daily/weekly/monthly`: 輪替頻率
- `rotate N`: 保留 N 個舊檔
- `compress`: 壓縮舊檔
- `delaycompress`: 延遲一次再壓縮
- `missingok`: 檔案不存在不報錯
- `notifempty`: 空檔不輪替
- `create mode owner group`: 建立新檔權限
- `sharedscripts`: 多檔案共用腳本
- `prerotate/postrotate`: 前後執行腳本

### 測試與執行

```bash
$ sudo logrotate -d /etc/logrotate.conf

$ sudo logrotate -f /etc/logrotate.conf

$ sudo logrotate -v /etc/logrotate.conf

$ cat /var/lib/logrotate/status
```

### 手動壓縮舊日誌

```bash
$ find /var/log -name "*.log" -mtime +7 -exec gzip {} \;

$ find /var/log -name "*.log.gz" -mtime +30 -delete

$ tar czf logs-$(date +%Y%m%d).tar.gz /var/log/*.log
```

---

## 系統監控工具

### top / htop

```bash
$ top

$ top -u username

$ top -p 1234,5678

$ htop

$ htop -u username
```

**常用快捷鍵（htop）：**
- `F5`: 樹狀顯示
- `F6`: 排序
- `F9`: 終止程序
- `F10`: 退出
- `/`: 搜尋

### vmstat

```bash
$ vmstat 1 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 123456  7890 234567    0    0     5    10  100  200  5  2 92  1  0

$ vmstat -s

$ vmstat -d

$ vmstat -p /dev/sda1
```

### iostat

```bash
$ iostat
$ iostat 1 5

$ iostat -x
Device            r/s     w/s     rkB/s   wkB/s  %util
sda              5.00   10.00    100.0   200.0   15.5

$ iostat -c

$ iostat -d

$ iostat -p sda1
```

### mpstat

```bash
$ mpstat
$ mpstat 1 5

$ mpstat -P ALL

$ mpstat -P 0,1 1 3
```

### sar

```bash
$ sar -u 1 5

$ sar -r 1 3

$ sar -b 1 3

$ sar -n DEV 1 3

$ sar -f /var/log/sysstat/sa10

$ sar -A
```

### free

```bash
$ free
              total        used        free      shared  buff/cache   available
Mem:       16384000     4096000     8192000      102400     4096000    11776000
Swap:       2048000           0     2048000

$ free -h
$ free -m
$ free -g

$ free -s 1
```

### df / du

```bash
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        50G   20G   28G  42% /
/dev/sdb1       100G   50G   46G  53% /data

$ df -i

$ df -T

$ du -sh /var/log
512M    /var/log

$ du -h --max-depth=1 /var/log | sort -hr

$ du -sh * | sort -hr | head -10
```

### ps

```bash
$ ps aux

$ ps aux --sort=-%mem | head

$ ps aux --sort=-%cpu | head

$ ps -ef

$ ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head

$ ps -C nginx

$ pstree

$ pstree -p
```

---

## 效能指標收集

### dstat

```bash
$ dstat
$ dstat -cdngy

$ dstat --top-cpu --top-mem

$ dstat -c -d -n 5 10
```

### nmon

```bash
$ nmon

$ nmon -f -s 60 -c 60
```

### atop

```bash
$ atop

$ atop -r /var/log/atop/atop_20240110

$ atopsar -c -r /var/log/atop/atop_20240110
```

### 自訂監控腳本

```bash
#!/bin/bash

LOGFILE="/var/log/system-monitor.log"

while true; do
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    MEM=$(free | grep Mem | awk '{printf "%.2f", $3/$2 * 100}')
    DISK=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
    
    echo "$TIMESTAMP CPU: ${CPU}% MEM: ${MEM}% DISK: ${DISK}%" >> $LOGFILE
    
    if (( $(echo "$CPU > 80" | bc -l) )); then
        echo "警告: CPU 使用率過高 ${CPU}%" | mail -s "CPU Alert" admin@example.com
    fi
    
    sleep 60
done
```

---

## 告警與通知

### 簡易 CPU 告警

```bash
#!/bin/bash

THRESHOLD=80
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | cut -d'.' -f1)

if [ $CPU_USAGE -gt $THRESHOLD ]; then
    echo "CPU 使用率: ${CPU_USAGE}%" | mail -s "CPU Alert" admin@example.com
fi
```

### 磁碟空間告警

```bash
#!/bin/bash

THRESHOLD=90

df -H | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{ print $5 " " $1 }' | while read output;
do
    USAGE=$(echo $output | awk '{ print $1}' | sed 's/%//g')
    PARTITION=$(echo $output | awk '{ print $2 }')
    
    if [ $USAGE -ge $THRESHOLD ]; then
        echo "警告: 磁碟分區 $PARTITION 使用率達 ${USAGE}%" | \
            mail -s "Disk Alert: $PARTITION" admin@example.com
    fi
done
```

### 服務監控

```bash
#!/bin/bash

SERVICES=("nginx" "mysql" "sshd")

for service in "${SERVICES[@]}"; do
    if ! systemctl is-active --quiet $service; then
        echo "服務 $service 已停止" | mail -s "Service Alert: $service" admin@example.com
        systemctl start $service
    fi
done
```

---

## 最佳實踐

### 日誌管理原則

1. **集中化管理**
   - 使用遠端日誌伺服器
   - 實施日誌聚合方案 (ELK, Graylog)

2. **適當的輪替策略**
   - 依據磁碟空間規劃保留期限
   - 壓縮舊日誌節省空間
   - 定期清理過期日誌

3. **安全性考量**
   - 限制日誌檔案權限
   - 加密傳輸遠端日誌
   - 定期審計日誌存取

4. **結構化日誌**
   - 使用統一格式 (JSON, syslog)
   - 包含必要的上下文資訊
   - 便於自動化分析

### 監控最佳實踐

1. **選擇關鍵指標**
   - CPU, Memory, Disk, Network
   - 應用層指標 (請求量, 回應時間, 錯誤率)
   - 業務指標

2. **設定合理閾值**
   - 基於歷史數據設定
   - 考慮業務特性
   - 定期review和調整

3. **多層次告警**
   - Warning: 預警級別
   - Critical: 緊急級別
   - 避免告警疲勞

4. **自動化響應**
   - 自動重啟失敗服務
   - 自動擴展資源
   - 記錄所有自動化操作

---

## 實戰案例

### 案例 1: 追蹤 SSH 登入失敗

```bash
$ sudo grep "Failed password" /var/log/auth.log | tail -20

$ sudo journalctl -u sshd | grep "Failed"

$ sudo grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr
     15 192.168.1.100
      8 203.0.113.50
      3 10.0.0.25

$ sudo awk '/Failed password/{print $(NF-3)}' /var/log/auth.log | sort | uniq -c | sort -nr | head
```

### 案例 2: 分析網站存取日誌

```bash
$ tail -f /var/log/nginx/access.log

$ awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

$ awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

$ awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr

$ awk '{print $4}' /var/log/nginx/access.log | cut -d: -f2 | sort | uniq -c

$ awk '$9 == "404" {print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr
```

### 案例 3: 監控日誌成長速度

```bash
#!/bin/bash

LOGFILE="/var/log/nginx/access.log"
INTERVAL=60

while true; do
    SIZE1=$(stat -c %s "$LOGFILE")
    sleep $INTERVAL
    SIZE2=$(stat -c %s "$LOGFILE")
    
    GROWTH=$((($SIZE2 - $SIZE1) / 1024))
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "$TIMESTAMP 日誌成長: ${GROWTH} KB/min"
    
    if [ $GROWTH -gt 10240 ]; then
        echo "警告: 日誌成長異常快速 ${GROWTH} KB/min" | \
            mail -s "Log Growth Alert" admin@example.com
    fi
done
```

### 案例 4: 系統效能報告

```bash
#!/bin/bash

REPORT="/tmp/system-report-$(date +%Y%m%d).txt"

cat > $REPORT <<EOF
系統效能報告
生成時間: $(date)

========== 系統資訊 ==========
$(uname -a)
$(uptime)

========== CPU 使用率 ==========
$(top -bn1 | head -20)

========== 記憶體使用 ==========
$(free -h)

========== 磁碟使用 ==========
$(df -h)

========== 磁碟 I/O ==========
$(iostat -x)

========== 網路統計 ==========
$(ss -s)

========== Top 10 程序 (CPU) ==========
$(ps aux --sort=-%cpu | head -11)

========== Top 10 程序 (記憶體) ==========
$(ps aux --sort=-%mem | head -11)

========== 最近錯誤日誌 ==========
$(journalctl -p err --since "1 hour ago" --no-pager)
EOF

echo "報告已生成: $REPORT"
cat $REPORT | mail -s "系統效能報告 $(date +%Y-%m-%d)" admin@example.com
```

---

> **參考資料：**
> - systemd.journal Documentation
> - rsyslog Documentation
> - Linux Performance Tools
> - Site Reliability Engineering (Google)
