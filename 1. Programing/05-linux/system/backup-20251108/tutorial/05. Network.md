# 1. 網路基本
---
### 1.1 OSI 七層架構

| Layer                         | 描述                                                   |
| ----------------------------- | ---------------------------------------------------- |
| Layer 1 <br>Physical Layer    | 達成 bit 傳輸                                            |
| Layer 2<br>Data-Link Layer    | 封裝成幀<br>e.g. **MAC Frame: 表頭主要為 MAC 地址 (一般稱為網卡卡號)**  |
| Layer 3<br>Network Layer      | 發送主機到目的主機的數據分組與轉發<br>e.g. **IP packet: 表頭主要為 IP 位置** |
| Layer 4<br>Transport Layer    | 達到進程間的通信<br>e.g. **TCP/UDP: 表頭主要為 port 號碼**          |
| Layer 5<br>Seession Layer     | 定義兩個位置間連些通道的連接與掛斷                                    |
| Layer 6<br>Presentation Layer | 將資料格式轉換網路格式，包含資料加密                                   |
| Layer 7<br>Application Layer  | 支持應用程序所需                                             |
### 1.2 協定詳解
#### 二層協定
這邊最重要的就是 Media Access Control (MAC) 的 Frame，Frame 是一個包裹包含目標與來源網卡的卡號，也就是 MAC 地址。
Frame 內容依序如下

| 內容   | 大小 (bytes) |
| ---- | ---------- |
| 前導碼  | 8          |
| 目標位置 | 6          |
| 來源位置 | 6          |
| 資訊欄位 | 2          |
| 主要資料 | 46-1500    |
| 檢查碼  | 4          |
> 每一張網卡都有一個獨一無二的 MAC 地址。
##### Maximum Transmission Unit, MTU
現在標準的乙太網路 Frame 最大可以達到 1500 bytes，MTU 越大可以減少上層 IP packet 需要進行拆裝的消耗，但是需要每一個裝置都能支持這麼大的 MTU。
* 自建網路可以設依據設備取最小的 MTU 來設定
* **外部網路一律使用標準的 1500**

##### 使用 ip link 操作二層參數
```shell
# 顯示 ens01 設備參數
ip link show ens01
# 偽裝 MAC 地址
ip link set ens01 address 52:54:00:ed:63:ff
# 修改 MTU
ip link set ens01 mtu 9000
```
> 以上只是臨時生效，永久生效要使用 nmcli

#### 三層協定
##### IP Packet 詳解
![[Pasted image 20241210152919.png]]
以下列出需要關注的內容:
* Time To Live (TTL): 表示 IP 封包存活的時間，當**經過一個路由器就會減一**，當減至 0 就會被丟棄，範圍為 0 ~ 255。
* Protocol Number，常見的如下:
	* 1 : ICMP (Internet Control Message Protocol)
	* 4 : IP (IP in IP encapsulation)
	* 6 : TCP (Transmission Control Protocol)
	* 17: UDP (User Datagram Protocol)

##### ICMP 協定
ICMP 同樣是透過 IP 封包進行傳輸，用於提供偵測與回報錯誤的機制。
可以使用 `ping` 與 `traceroute` 來透過 ICMP 封包來檢查網路狀態。

##### 路由 (Gateway)
當封包目標在 LAN 中，可以透過廣播的方式直接交給目標主機，但目標不是 LAN 中的主機，那這個封包就會透過你自己的路由表 (routing table)，傳送到預設的通訊閘，由該設備主動幫你傳輸出去。

#### 四層協定
##### TCP 協定
##### UDP 協定

# 2. 網路連線命令
---
### 2.1 操作網路: iproute2
##### 添加與修改 IP 與 Netmask: ip addr
```shell
# 顯示全部網卡資訊
ip addr show

# 顯示單一網卡資訊
ip addr show ens160

# 添加 IP 地址
ip addr add 192.168.66.129/24 dev ens160

# 刪除 IP 地址
ip addr del 192.168.66.129/24 dev ens160
```

* 輸出說明:
```text
2: ens160: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:0c:29:ba:53:48 brd ff:ff:ff:ff:ff:ff
    altname enp3s0
    inet 10.17.10.198/24 brd 10.17.10.255 scope global dynamic noprefixroute ens160
       valid_lft 40451sec preferred_lft 40451sec
    inet6 fe80::15a6:fb4:54c5:40ff/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
* `<BROADCAST,MULTICAST,UP,LOWER_UP>`: 為接口的標誌
    - `BROADCAST`：接口支持廣播。
    - `MULTICAST`：接口支持多播。
    - `UP`：網卡已啟用。
    - `LOWER_UP`：物理層連接正常。
- link/ether: 顯示 MAC 地址與廣播地址
- altname: 別名
- inet 中 dynamic 表示透過 DHCP 建立的
	- valid_lft: 表示地址有效時間 (租用時間)

##### 路由設定: ip route
靜態路由: 指定網段並設置要發送的路由地址
默認路由: 所有非靜態路由指定的網段都會送到默認路由
```shell
# 查看路由表
ip route show

# 添加靜態路由 (廣播)
# 表示 192.168.66.0/24 網段會由 ens160 設備負責傳送，採用廣播方式
ip route add 192.168.66.0/24 dev ens160

# 刪除路由
ip route add 192.168.66.0/24

# 添加默認網關
# 將非靜態路由網段封包送給指定地址，由 ens160 設備進行傳送
ip route add default via 192.168.66.254 dev ens160
```

### 2.3 NetworkManager 管理網路連線
自從 REHL 7 後，就預設啟用 NetworkManager 服務來管理網路連線，前面使用的工具會被 NetworkManager 所覆蓋，提供 `nmtui` 工具可以方便的設置網路參數。
```shell
# 確認 NetworkManager 服務
systemctl status NetworkManager

# 查看設備
nmcli device show # or nmcli d s
nmcli device show <device_name>

# 查看連線
nmcli conneciton show # or nmcli c s
nmcli connection show <conn_name>

# 啟用/關閉連線
nmcli connection up <conn_name> 
nmcli connection down <conn_name>
```
- `connection.autoconnect [yes|no]`：是否需要啟動這個網路界面
- `ipv4.method [auto|manual]`：取得的方式為自動或手動
- `ipv4.addresses [IP/Netmask]`：直接設定 IP 位址與子網路遮罩
- `ipv4.gateway [GWIP]`：設定 Gateway 的 IP 位址
- `ipv4.dns [DNSIP]`：設定 DNS server 的 IP 位址

#### 網路操作一: 修改網路配置文件
在 `/etc/NetworkManager/system-connections` 中對應網卡名稱都有對應的 .nmconnection 文件，e.g. `ens160.nmconnection` 內容如下
```toml
[connection]
id=ens160
uuid=12345678-1234-1234-1234-123456789abc # 可以透過 uuidgen 生成
type=ethernet
interface-name=ens160
autoconnect=true # 自動連接

[ethernet]
# mac-address=00:1a:2b:3c:4d:5e # 可以自己設定

[ipv4]
method=manual # 分為 auto（自動）、manual（手動）或 disabled（禁用）
addresses=192.168.66.128/24 # 可以配置多個，使用 , 分隔
dns=8.8.8.8,8.8.4.4; # 多個 dns 用 , 分隔
gateway=192.168.66.100 # 指定默認網關

[ipv6]
method=auto
```
完成之後需要進行 reload
```shell
# 需要修改權限
chown root:root ens160.nmconnection
chmod 600 ens160.nmconnection # 這一定要改!!!!不然無法使用
sudo nmcli device reapply ens160
nmcli connection reload # or nmcli c load ./ens224.nmconnection
```
> 這邊就不說明 wifi，wifi 使用 nmtui 比較方便

#### 網路操作二: 使用命令
```shell
# 刪除 connection
nmcli connection delete <con_name>
# 添加 connection
nmcli connection add con-name <con_name> type ethernet ifname <if_name> \
ipv4.method manual ipv4.addresses 192.168.66.101/24 \
ipv4.gateway 192.168.66.100 ipv4.dns 168.95.1.1,8.8.8.8
# 啟用 connection
nmcli connection up <con_name>
```
# 3. 防火牆
---
### 3.1 防火牆軟體
* Linux 內核支持
	* version 2.4 之後: 使用 iptables
	* version 3.13 之後: 可以選用 iptables/nftables 
		* nftables 是為了支持 IPv6 而生，現在也是推薦使用 nftables
* RHEL 發行版本提供
	* iptables
	* nftables
	* firewalld: 簡單的工具可以建立防火牆，目前推薦使用在單機系統

### 3.2 iptables
因為 REHL 使用 nftables，但有提供 `iptables-nft` 這個軟件包(需要下載)，使用 iptables 命令本質上是使用 nftables。

#### 3.2.1 基礎
##### 啟動
```shell
dnf install iptables-nft
# 啟動 iptables
systemctl disable --now firewalld
systemctl enable --now nftables
```

##### table 與 chain
table 分為三種: 
* filter (過濾): 管理進出 Linux 的封包，有以下三個 chain
	* `INPUT`: 進入的封包執行的規則
	* `FORWARD`: 傳遞封包
	* `OUTPUT`: 送出的封包執行的規則
* nat (地址轉換): 用來轉換 IP 地址，有以下三個 chain
	* `PREROUTING`: 路由判斷之前所要進行的規則 (DNAT/REDIRECT)
	* `POSTROUTING`: 路由判斷之後所要進行的規則 (SNAT/MASQUERADE)
	* `OUTPUT`: 送出封包
* mangle: skip...
#### 3.2.2 針對 filter 的語法
```shell
# 列出 filter table 的三條 chain 規則
iptables -L 
iptables-save # 更好用

# 清除
iptables -F # 清除 rule
iptables -X # 清除鏈
iptables -Z # 清除統計資訊
```

##### 添加規則
```shell
# 添加(-A)刪除(-D)規則
iptables -A INPUT -p icmp -j ACCEPT # 允許 icmp
iptables -A INPUT -i lo -j ACCEPT # lo 介面均信任
iptables -A INPUT -m state --state NEW -p tcp --dport 22 -j ACCEPT # 只要是新的連接且為 22 port 均放行
iptables -A INPUT -j REJECT # 全部拒絕
iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # 接收已經建立的連接與返回的封包
```
* `-m`: 匹配，可以匹配狀態
	* `state` 分為:
		1. `NEW`: 表示新建立的連接
		2. `ESTABLISHED`: 已經建立的連接
		3. `RELATED`: 與建立連接相關的封包，表示這個封包是與我們主機發送出去的封包有關
* `-i`: 網卡
* `-s`: 來源 IP or IP/netmask
* `-d`: 目標 IP or IP/netmask
* `-p`: 協定，分別為 `udp`, `tcp`, `icmp`
* `--sport`: 來源端口
* `--dport`: 目標端口
* `-j`: jump，用來指定 rule，常見的有 `ACCEPT`, `REJECT`, `DROP`

##### 建立規則腳本
```shell
#!/bin/bash
# 0. clear 
iptables -F
iptables -X
iptables -Z
iptables -P INPUT DROP
iptables -P OUPUT ACCEPT
iptables -P FORWARD ACCEPT

# 1. basic rules
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p icmp -j ACCEPT

# 2. while list and block
iptables -A INPUT -m state --state NEW -p tcp --dport 22 -j ACCEPT # 允許 ssh (小危險)
# iptables -A INPUT -s 10.30.30.0/24 -j REJECT
# iptables -A INPUT -i enp1s0 -s 192.168.201.254 -j ACCEPT
# iptables -A INPUT -i enp2s0 -s 192.168.10.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT
# iptables -A INPUT -i enp2s0 -s 192.168.20.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT
# iptables -A INPUT -i enp3s0 -s 192.168.30.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT

# 3. network service
# iptables -A INPUT -m state --state NEW -p tcp --dport  80 -j ACCEPT # HTTP
# iptables -A INPUT -m state --state NEW -p tcp --dport 443 -j ACCEPT # HTTPS
# iptables -A INPUT -m state --state NEW -p udp --dport  53 -j ACCEPT # DNS
# iptables -A INPUT -m state --state NEW -p tcp --dport  53 -j ACCEPT # DNS (DNS 有兩種方式)
```
* 補充: 將 iptables 設定保存到 nft 中，開機自啟動
```shell
echo "flush ruleset" > /etc/nftables/main.nft
nft list ruleset >> /etc/nftables/main.nft
```

#### 3.2.3 針對 NAT 的語法
##### MASQUERADE: 將主機變成 SNAT 伺服器
當內部網絡的設備發起請求到外部網絡時，會將源 IP 地址轉換為路由器的外部 IP 地址。
* **使用場景**: 內部設備訪問外部網絡（如互聯網），需要開啟 SNAT。

1. IP 轉發
```shell
vim /etc/sysctl.d/server.conf
# 添加以下文字
net.ipv4.ip_forward = 1
# 啟用
sysctl -p /etc/sysctl.d/server.conf
# 顯示 1 表示成功
cat /proc/sys/net/ipv4/ip_forward
```
2. 設定 SNAT 機制
```shell
# 使用 nat table 添加到 POSTROUTING 使用的網域為 192.168.20.0/24 透過 enp1s0 送出，採用偽裝
iptables -t nat -A POSTROUTING -s 192.168.20.0/24 -o enp1s0 -j MASQUERADE
```

##### REDIRECT: port mapping
常用於將 port 進行轉發，如下
```shell
iptables -t nat -A PREROUTING -p tcp --dport 2121 -j REDIRECT --to 22
```
此時你可以透過 22 與 2121 進行 ssh 連接，而不需要修改 sshd 設定。

##### DNAT: 將主機變成 DNAT 伺服器
當外部網絡的請求發送到路由器時，DNAT 將外部請求的目標 IP 地址轉換為內部設備的 IP 地址。概念與 nginx 一樣，只是一個是防火牆，另外一個是應用層服務。
* **使用場景**: 外部設備訪問內部服務（例如 Web 伺服器），需要開啟 DNAT。
```shell
# 將訪問主機 tcp/80 的服務轉到別台主機的 port
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to 192.168.66.28:223
```
### 3.3 firewalld
skip...

### 3.4 nftables
目前的 Linux 系統，核心已經轉向 nftables，他改進了 iptables 程式碼架構，並提供更彈性的設置。nftables 使用一個統一的語法來定義封包過濾規則，這些*規則被存儲在內核中的一個表（table）中。每個表包含多個鏈（chain），每個鏈包含多個規則（rule）。* 當封包進入系統時，它會根據這些規則進行處理。

首先關閉其他防火牆軟體
```shell
systemctl disable --now firewalld
systemctl enable --now nftables
```
nftables 的設定檔位於 `/etc/sysconfig/nftables.conf`，但他默認不啟動，所以要進去反註解第四行。

#### 3.4.1 table
```shell
nft list tables
# 輸出如下
# 格式: table [IP格式] [table名稱]
table inet nftables_svc
```

**IP 格式分為**:

| 類型     | 說明                                                  |
| ------ | --------------------------------------------------- |
| ip     | 僅針對 IPv4 的格式做封包分析                                   |
| ip6    | 僅針對 IPv6 的格式做封包分析                                   |
| inet   | 可同時針對 IPv4 與 IPv6 的封包作分析                            |
| arp    | 主要針對 IPv4 的 ARP (address resolution protocol) 封包做分析 |
| bridge | 分析來自橋接器裝置的封包                                        |
| netdev | 分析來自某個網路卡 (ingress) 的封包                             |

#### 3.4.2 chain
```shell
nft list chains
# 輸出如下
# chain 格式: chain [chain名稱] { type [類型] hook [封包流向] priority [優先序數值]; policy [預測政策]; }
table inet nftables_svc {
        chain allow {
        }
        chain INPUT {
                type filter hook input priority 20; policy accept;
        }
}
```

**chain 類型如下**:

| 類型     | 適用IP格式        | 封包流向 (hook)                            | 說明                                                                                                                                                                                                                                            |
| ------ | ------------- | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| filter | 所有格式          | 所有流向                                   | 最常見的鏈，它用來實現**封包過濾**(基本防火牆規則)，即根據特定的條件（如 IP 地址、端口、協議類型等）來決定是否允許或拒絕網絡流量                                                                                                                                                                         |
| nat    | ip, ip6, inet | prerouting, postrouting, input, output | 用於執行**網絡地址轉換**。這包括**源地址轉換 (SNAT)** 和**目的地址轉換 (DNAT)**，這樣可以改變數據包的源 IP 或目標 IP 地址，常用於實現內外網之間的流量轉換、端口轉發等。<br>- **SNAT**：改變源地址，通常用於 **出口網絡流量**，例如內部網絡設備上網時，將內部的私有 IP 地址轉換為公共 IP 地址。<br>- **DNAT**：改變目標地址，通常用於 **端口轉發**，例如將外部的某個端口流量轉發到內部某個特定主機和端口。 |
| route  | ip, ip6       | output                                 | 與 **路由操作** 相關，主要用於在處理網絡流量時進行路由決策。這些操作通常與 **路由表** 配置和 **數據包的路徑選擇** 相關。根據數據包的特徵（如來源 IP、目的 IP、端口等）來選擇不同的路由路徑。                                                                                                                                    |

**優先序**:
nftables 沒有對於 chain 有默認的優先順序，而是透過優先序來指定，而優先序數值越小越先被執行，也可以透過文字的形式來指定優先序，文字與數值對應如下:


| 優先序文字    | 數值           | IP 格式                   | 封包流向        |
| -------- | ------------ | ----------------------- | ----------- |
| raw      | -300         | ip, ip6, inet           | all         |
| mangle   | -150         | ip, ip6, inet           | all         |
| dstnat   | -100<br>-300 | ip, ip6, inet<br>bridge | prerouting  |
| filter   | 0<br>-100    | ip, ip6, inet<br>bridge | all         |
| security | 50           | ip, ip6, inet           | all         |
| srcnat   | 100<br>300   | ip, ip6, inet<br>bridge | postrouting |
| out      | 100          | bridge                  | output      |
**政策**
* accept
* drop

#### 3.4.3 rule
```shell
nft list ruleset
```
每個表可以包含不同的鏈，鏈內則包含多條規則，規則中包含各種匹配（match）條件、行為（action），以下逐個對不同的匹配進行說明:

1. **ct (Connection Tracking)**: 用於跟踪網絡連接的狀態，判斷封包是否屬於已建立或相關的連接。
	* ct state：根據連接的狀態來匹配封包。e.g. `ct state established,related` 會匹配已建立或與現有連接相關的封包。
2. **ip (IP 協議)**: 匹配 IPv4 或 IPv6 封包。ip 和 ip6 是最常見的 match 類型，用來處理不同的 IP 協議版本。
	* ip saddr：根據來源 IP 地址匹配封包。
	* ip daddr：根據目的 IP 地址匹配封包。
	* ip protocol：根據協議類型匹配封包，例如 TCP、UDP 等。
	* ip ttl：根據 TTL（生存時間）匹配封包。
3. **meta (元數據匹配)**: 用來匹配封包的一些基本元數據，例如協議類型、封包大小等。
	* meta l4proto：匹配封包的第4層協議（如 TCP、UDP、ICMP 等）。
	* meta length：匹配封包的長度。
4. **iifname (輸入接口名稱)**: 根據封包的來源接口名稱進行匹配。這可以用來控制哪些接口允許流量進入。
5. **oifname (輸出接口名稱)**: 根據封包的目的接口名稱進行匹配。這可以用來限制流量是否可以通過某個接口發送。
6. **tcp (TCP 協議)**: 用於匹配 TCP 協議的封包，可以根據不同的 TCP 特徵來篩選封包。
	* tcp dport：匹配 TCP 的目的端口（destination port）。
	* tcp sport：匹配 TCP 的來源端口（source port）。
	* tcp flags：匹配 TCP 標誌位（如 SYN、ACK 等）。
7. **udp (UDP 協議)**: 用於匹配 UDP 協議的封包，與 tcp 相似，可以根據來源端口和目的端口進行匹配。
	* udp dport：匹配 UDP 的目的端口。
	* udp sport：匹配 UDP 的來源端口。
8. **ip6 (IPv6 協議)**: 類似於 ip，但專門用於匹配 IPv6 封包。
	* ip6 saddr：匹配 IPv6 的來源地址。
	* ip6 daddr：匹配 IPv6 的目的地址。
9. **arp (ARP 協議)**: 用於匹配 ARP 協議的封包，通常用於局域網中。
	* arp saddr：匹配 ARP 的來源硬體地址（MAC 地址）。
	* arp daddr：匹配 ARP 的目的硬體地址。
10. **icmp (ICMP 協議)**: 用於匹配 ICMP 協議封包，通常用於檢查網絡狀況（如 ping 命令）。
11. **ip protocol (IP 協議)**: 根據 IP 封包的協議類型來匹配封包。
12. **time (時間匹配)**: 允許基於時間範圍過濾流量。可以用來指定某個時間段內的流量。
13. **addrtype (地址類型匹配)**: 用於匹配源或目標地址的類型，例如是否是本地地址、廣播地址等。
14. **limit (流量限制)**:  用於限制封包的速率。這個 match 常用於防止 DoS 攻擊。

#### 4.3.4 配置 nft 
修改 `/etc/nftables/main.nft` 中的內容
```shell
flush ruleset # 清空

table inet mytable {
        chain myinput {
		        # 為 filter chain 針對 input 封包，默認為 drop
                type filter hook input priority filter; policy drop;
                
                # 基礎防火牆規則
                ct state established,related accept # 接受回應的封包
                meta l4proto icmp accept # 接受 icmp
                iifname "lo" accept # 信任 lo 網卡
                
                # 白名單/黑名單
                ip saddr { 192.168.66.0/24 } tcp dport 22 accept
                tcp dport { 22, 80, 443 } accept # 允許所有 22 端口連線 (不一定要空格)
                # udp dport 53 accept
        }
}
```
刷新防火牆設置
```
nft -f /etc/nftables/main.nft
```

#### 4.3.5 NAT
##### SNAT
```shell
table inet mynat {
        chain mysnat {
                type nat hook postrouting priority srcnat; policy accept;
                iifname "enp2s0" oifname "enp1s0" ip saddr 192.168.20.0/24 masquerade
                iifname "wlp7s0u1" oifname "enp1s0" ip saddr 192.168.10.0/24 masquerade
                iifname "enp3s0" oifname "enp1s0" ip saddr 192.168.30.0/24 masquerade
        }
}
```

##### DNAT
```shell
table inet mynat {
        chain mydnat {
                type nat hook prerouting priority dstnat; policy accept;
                iifname "enp1s0" tcp dport 2121 redirect to :22
        }
}
```