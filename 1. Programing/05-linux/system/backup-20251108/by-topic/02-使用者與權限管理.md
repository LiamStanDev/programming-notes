# 使用者與權限管理

## 目錄
- [主題簡介](#主題簡介)
- [核心原理與架構](#核心原理與架構)
  - [帳號與群組](#帳號與群組)
  - [UID/GID](#uidgid)
  - [檔案權限模型](#檔案權限模型)
  - [umask](#umask)
  - [SUID/SGID/Sticky Bit](#suidsgidsticky-bit)
  - [ACL（Access Control List）](#aclaccess-control-list)
- [常用指令與範例](#常用指令與範例)
  - [帳號與群組管理](#帳號與群組管理)
  - [權限查詢與設定](#權限查詢與設定)
  - [進階權限操作](#進階權限操作)
  - [su/sudo 實戰](#susudo-實戰)
  - [批次帳號管理腳本](#批次帳號管理腳本)
- [常見錯誤與排查](#常見錯誤與排查)
- [最佳實踐與安全建議](#最佳實踐與安全建議)
- [實戰案例](#實戰案例)

---

## 主題簡介

使用者與權限管理是 Linux/UNIX 系統安全、資源分配與多用戶協作的基石。透過帳號、群組、權限、進階權限（如 SUID/SGID/ACL）等機制，能精細控管誰能存取、修改或執行系統資源，防止未授權操作與資安風險。

**應用場景：**
- 多人協作開發、維運
- 伺服器安全加固
- 敏感資料與服務保護
- 自動化帳號與權限管理

---

## 核心原理與架構

### 帳號與群組

- **帳號（User Account）**：每位使用者皆有唯一帳號，登入系統時識別身份。
- **群組（Group）**：權限集合，方便多帳號批次授權與管理。

### UID/GID

- **UID（User ID）**：帳號唯一識別碼，root 為 0。
- **GID（Group ID）**：群組唯一識別碼。

### 檔案權限模型

- **三種角色**：擁有者（owner）、群組（group）、其他人（others）
- **三種權限**：讀取（r）、寫入（w）、執行（x）
- **權限表示法**：
  - 符號式：`-rwxr-xr--`
  - 數字式：`chmod 755 file`
- **權限模型圖解：**

  | 欄位 | 1 | 2-4 | 5-7 | 8-10 |
  |------|---|-----|-----|------|
  | 範例 | - | rwx | r-x | r--  |
  | 說明 | 類型 | 擁有者 | 群組 | 其他人 |

### umask

- **umask**：預設權限遮罩，決定新建立檔案/目錄的預設權限。
- 查詢目前 umask：
  ```shell
  $ umask
  0022
  ```
- 設定 umask（僅對當前 shell）：
  ```shell
  $ umask 027
  ```

### SUID/SGID/Sticky Bit

- **SUID**：執行檔以檔案擁有者身份執行（如 `/usr/bin/passwd`）。
- **SGID**：執行檔以群組身份執行，或新檔案繼承目錄群組。
- **Sticky Bit**：目錄下只有檔案擁有者或 root 可刪除檔案（如 `/tmp`）。
- 權限顯示範例：
  ```
  -rwsr-xr-x  root root ... /usr/bin/passwd   # SUID
  drwxrwsr-x  root dev  ... /srv/dev          # SGID
  drwxrwxrwt  root root ... /tmp              # Sticky Bit
  ```

### ACL（Access Control List）

- 提供更細緻的權限控管，超越傳統 rwx 模型。
- 常用於多用戶協作或特殊權限需求。

---

## 常用指令與範例

### 帳號與群組管理

#### 新增使用者
```shell
$ sudo useradd alice
$ sudo passwd alice
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
```

#### 修改使用者群組
```shell
$ sudo usermod -aG sudo alice
# 將 alice 加入 sudo 群組
```

#### 查詢帳號與群組
```shell
$ id alice
uid=1001(alice) gid=1001(alice) groups=1001(alice),27(sudo)
```
```shell
$ getent passwd alice
alice:x:1001:1001::/home/alice:/bin/bash
```
```shell
$ getent group sudo
sudo:x:27:alice
```

### 權限查詢與設定

#### 變更檔案擁有者/群組
```shell
$ sudo chown bob:dev team.txt
$ ls -l team.txt
-rw-r--r-- 1 bob dev 0 Sep 17 12:00 team.txt
```

#### 變更檔案權限
```shell
$ chmod 755 script.sh
$ ls -l script.sh
-rwxr-xr-x 1 alice dev 123 Sep 17 12:01 script.sh
```

#### 批次變更權限
```shell
$ chmod -R 750 /srv/project/
```

### 進階權限操作

#### 設定 SUID/SGID/Sticky Bit
```shell
$ chmod u+s /usr/local/bin/mycmd   # SUID
$ chmod g+s /srv/dev               # SGID
$ chmod +t /srv/share              # Sticky Bit
```

#### ACL 權限設定
```shell
$ setfacl -m u:bob:rwx project/
$ getfacl project/
# file: project/
# owner: root
# group: dev
user::rwx
user:bob:rwx
group::r-x
mask::rwx
other::---
```

### su/sudo 實戰

#### 切換使用者
```shell
$ su - bob
Password:
```

#### 執行管理員指令
```shell
$ sudo apt update
[sudo] password for alice:
```

#### sudo 權限設定（建議用 visudo 編輯）
```shell
$ sudo visudo
# %dev ALL=(ALL:ALL) NOPASSWD: /usr/bin/systemctl restart nginx
```

### 批次帳號管理腳本

#### 批次建立帳號
```shell
$ for user in user1 user2 user3; do sudo useradd $user; done
```

#### 自動化權限設定腳本
```bash
#!/bin/bash
for file in *.sh; do
  chmod 750 "$file"
  chown root:dev "$file"
done
```

---

## 常見錯誤與排查

| 錯誤訊息             | 可能原因           | 排查與解決方式                                   |
|----------------------|--------------------|--------------------------------------------------|
| Permission denied    | 權限不足           | 檢查檔案權限、所屬群組，必要時用 sudo 執行        |
| Account locked       | 帳號被鎖定         | `passwd -S user` 查狀態，`usermod -U user` 解鎖   |
| Password expired     | 密碼過期           | `chage -l user` 查詢，`passwd user` 重設密碼      |
| user not in sudoers  | 無 sudo 權限       | 檢查 `/etc/sudoers`，用 visudo 加入對應群組        |
| Too many open files  | 檔案描述符限制      | `ulimit -n` 查詢/調整，檢查程式是否有資源洩漏      |

---

## 最佳實踐與安全建議

- **權限最小化**：僅授予必要權限，避免 root 直接操作。
- **sudo 管理**：用 `/etc/sudoers` 控制 sudo 權限，建議用 `visudo` 編輯。
- **帳號安全**：
  - 強制密碼複雜度與定期更換
  - 停用未使用帳號
  - 設定帳號鎖定策略（如登入失敗次數限制）
- **目錄權限**：重要目錄（如 `/etc`, `/var/log`）嚴格限制寫入權限。
- **審計與監控**：定期檢查帳號、權限異動紀錄，善用 `auditd`、`last`、`faillog`。
- **自動化管理**：用腳本批次處理帳號與權限，降低人為疏失。
- **避免共用帳號**：每人專屬帳號，方便追蹤與管理。

---

## 實戰案例

### 案例一：修復權限錯誤導致服務啟動失敗

**情境**：Web 服務啟動失敗，日誌顯示 `Permission denied`。

**排查步驟：**
1. 查詢服務檔案權限
   ```shell
   $ ls -l /srv/web/index.html
   -rw------- 1 root root 1234 Sep 17 12:00 /srv/web/index.html
   ```
2. 修正權限與擁有者
   ```shell
   $ sudo chown www-data:www-data /srv/web/index.html
   $ chmod 644 /srv/web/index.html
   ```

### 案例二：批次建立專案帳號並設定權限

**需求**：建立 10 個專案帳號，並將家目錄權限設為僅本人可存取。

**腳本：**
```bash
#!/bin/bash
for user in proj01 proj02 proj03 proj04 proj05 proj06 proj07 proj08 proj09 proj10; do
  sudo useradd -m $user
  sudo chmod 700 /home/$user
done
```

### 案例三：設定目錄 ACL 讓多用戶協作

**需求**：讓 bob、alice 皆可完全存取 `/srv/project`。

**操作：**
```shell
$ sudo setfacl -m u:bob:rwx /srv/project
$ sudo setfacl -m u:alice:rwx /srv/project
$ getfacl /srv/project
```

---
