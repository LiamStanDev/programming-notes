### iptables-nft

#### 鏈路
依照數據包流向的不同建立的不同埋府方式稱之
1. Prerouting: 數據包抵達系統 (kernel space)
2. Input: 數據包目標是本機 (user space)
3. Ouput: 數據包從本機流出
4. Forward: 本機將數據包轉發出去
5. Postrouting: 數據包離開系統 (kernel space)

![[Pasted image 20250720140801.png|1200]]

#### Tables
iptables 表分為五大類: 
* **fitler** (過濾): 管理進出 Linux 的封包，有以下三個 chain
	* `INPUT`: 進入的封包執行的規則
	* `FORWARD`: 傳遞封包
	* `OUTPUT`: 送出的封包執行的規則
* **nat** (地址轉換): 用來轉換 IP 地址，有以下三個 chain
	* `PREROUTING`: 路由判斷之前所要進行的規則 (DNAT/REDIRECT)
	* `POSTROUTING`: 路由判斷之後所要進行的規則 (SNAT/MASQUERADE)
	* `OUTPUT`: 送出封包
* mangle, raw, security: skip...

#### Filter 表

##### 管理
```shell
# 列出 filter table 的三條 chain 規則
iptables -L 
iptables-save # (更好用) iptables-save 用於 dump iptables 規則

# 清除
iptables -F # Flush（清空）所有 chain 中的規則
iptables -X # 刪除自定義 chain
iptables -Z # 清除統計資訊
```

##### 添加規則
```shell
# 添加(-A), 刪除(-D), 插入(-I) 規則
iptables -A INPUT -p icmp -j ACCEPT # 允許 icmp
iptables -A INPUT -i lo -j ACCEPT # lo 介面均信任
iptables -A INPUT -m state --state NEW -p tcp --dport 22 -j ACCEPT # 只要是新的連接且為 22 port 均放行
iptables -A INPUT -j REJECT # 全部拒絕
iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # 接收已經建立的連接與返回的封包
```
* `-m`: 指定匹配採用的模組
	* `state` 模組:
		1. `NEW`: 表示新建立的連接
		2. `ESTABLISHED`: 已經建立的連接
		3. `RELATED`: 與建立連接相關的封包，表示這個封包是與我們主機發送出去的封包有關
	* `conntrack`：用來取代 state 請見 [[03.防火牆#腳本示例]]
* `-i`: 網卡
* `-s`: 來源 IP or IP/netmask
* `-d`: 目標 IP or IP/netmask
* `-p`: 協定，分別為 `udp`, `tcp`, `icmp`
* `--sport`: 來源端口
* `--dport`: 目標端口
* `-j`: jump，用來指定 rule，常見的有 `ACCEPT`, `REJECT`, `DROP`

#### 腳本示例

撰寫以下腳本放在 `~/.config/zsh/scripts/firewall.sh`
```shell
#!/bin/bash
# /etc/iptables/rules.sh
set -euo pipefail

log() {
  echo "[+] $1"
}

log "清除現有規則"
iptables -F
iptables -X
iptables -t nat -F
iptables -t mangle -F

log "設定預設政策（DROP）白名單策略"
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

log "允許已建立與相關連線"
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

log "允許 loopback"
iptables -A INPUT -i lo -j ACCEPT

log "允許 SSH 連線(22)"
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

log "允許 ICMP (ping)"
iptables -A INPUT -p icmp -j ACCEPT

# -------------------------------
# libvirt (virbr0) NAT 與轉發
# -------------------------------
log "允許 libvirt VM 透過 virbr0 出網"
# VM -> WWW
iptables -A FORWARD -i virbr0 -o wlo1 -j ACCEPT
# WWW -> VM
iptables -A FORWARD -i wlo1 -o virbr0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -t nat -A POSTROUTING -s 192.168.122.0/24 -o wlo1 -j MASQUERADE

# -------------------------------
# docker (docker0) NAT 與轉發
# -------------------------------
log "允許 Docker 容器透過 docker0 出網"
iptables -A FORWARD -i docker0 -o wlo1 -j ACCEPT
iptables -A FORWARD -i wlo1 -o docker0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -t nat -A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE

log "拒絕其他封包前 log 一下（方便 debug）"
iptables -A INPUT -j LOG --log-prefix "DROP_INPUT: " --log-level 4
iptables -A FORWARD -j LOG --log-prefix "DROP_FORWARD: " --log-level 4

log "✅ 防火牆設定完成"
```
> `-i <interface>` : 表示從對應網卡進來的封包, 用於 `INPUT` 與 `FORWARD`
> `-o <interface>` : 表示從對應網卡出去的封包, 用於 `OUTPUT` 與 `FORWARD`




使用
```shell
chmod +x ~/.config/zsh/scripts/firewall.sh
sudo ~/.config/zsh/scripts/firewall.sh
sudo iptables-save | sudo tee /etc/iptables/iptables.rules # tee 會同時寫到 stdout 與文件
sudo systemctl enable --now iptables.service
```

> 注意 iptables-nft 不要與 nftables 混用，站在易用的角度建議都使用 iptables-nft
### nftables
將以上配置轉換成 nftables，注意 nftables 沒有預設得 tables 與 chains，都可以自由設定。


將以下內容寫入 `/etc/nftables.conf`
```c
#!/usr/bin/nft -f
# vim:set ts=2 sw=2 et:

# IPv4/IPv6 Simple & Safe firewall ruleset.
# More examples in /usr/share/nftables/ and /usr/share/doc/nftables/examples/.

table inet filter {
  # 管理進入宿主機的封包
  chain input {
    # 這條鏈掛到 Netfilter 的 input hook
    type filter hook input priority 0;

    # 採用白名單策略
    policy drop;

    # 允許已建立或相關連的連線 (用於保持通話)
    ct state established,related accept

    # 接受來自 loopback（本機）介面的封包
    iif "lo" accept

    # 允許新的 SSH 封包 (port 22)
    tcp dport 22 ct state new accept

    # 允許 ICMP 封包
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    reject
  }

  # 經過宿主機的封包
  chain forward {
    # 這條鏈掛到 Netfilter 的 forward hook
    type filter hook forward priority 0;
    policy drop;
    
    # 保持連線
    ct state established,related accept

    # 從 VM 出來的封包允許出網
    iifname "virbr0" oifname != "virbr0" accept
    # 從外部回來的封包允許進入 VM
    iifname != "virbr0" oifname "virbr0" ct state related,established accept
  }

  # 管理宿主機送出的封包
  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}

# 設定 NAT 網路 (ipv4)
table ip nat {
  chain postrouting {
    # 載到 NAT 的 postrouting 階段
    type nat hook postrouting priority 100;
    policy accept;

    # 來自 (192.168.122.0/24) 的封包送到非 virbr0 網卡，並進行 masquerade (動態 SNAT)
    ip saddr 192.168.122.0/24 oifname != "virbr0" masquerade
  }
}

```

> inet: 表示 ipv4 + ipv6

然後執行
```shell
sudo systemctl enable --now nftables
```
### 參考
* [技術蛋老師](https://www.youtube.com/watch?v=yY71l_FAn3w)
* [Arch wiki](https://wiki.archlinux.org/title/Nftables)
