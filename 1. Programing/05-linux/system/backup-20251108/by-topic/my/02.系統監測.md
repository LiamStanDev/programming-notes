### CPU 使用率分析

1. `iostat`
命令：
```shell
 # 1. 每秒顯示 cpu 使用率 
iostat -c 1

# 2. 每秒顯示 cpu 使用率 (單頁刷新)
watch -n 1 'iostat -c 1 1'
```

輸出：
```text
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.85    0.08    7.20   12.98    0.00   76.88
```

| 欄位        | 說明                             |
| --------- | ------------------------------ |
| `%user`   | User space CPU 使用率             |
| `%system` | Kernel Space CPU 使用率（如網卡、磁碟驅動） |
| `%iowait` | CPU 等待磁碟 I/O 的時間，>10% 可能表示磁碟瓶頸 |
| `%idle`   | 閒置比例，太低表示 CPU 負載高              |


> `iostat` 系列相關的監控工具需要提供採樣時間不然數值會不正確

##### 如何判斷 IO 瓶頸?

| 情況     | 解釋                           |
| ------ | ---------------------------- |
| < 5%   | 正常，I/O 不影響 CPU 執行            |
| 5–15%  | 偏高，可能有磁碟壅塞，但系統還能接受           |
| 15–30% | 明顯高，I/O 瓶頸，CPU 會閒置等待資料       |
| >30%   | 很高，系統可能需要升級磁碟、調整 I/O 或檢查應用程式 |
> `iowait` 表示 CPU 在工作總時長有多少比例是用於等待 IO


### 記憶體使用情況
1. `vmstat`
命令：
```shell
# 1. 每秒顯示記憶體狀態
vmstat 1

# 2. 每秒顯示記憶體狀態 (單頁刷新)
watch -n 1 'vmstat 1 1' 
```

輸出：
```text
procs -----------memory---------- ---swap-- -----io---- -system-- -------cpu-------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st gu
 1  0 2000724 4790556 89192 4827372  0    0 26205 25794 8137   10  4  4 84  8  0  0
```


| 欄位    | 說明                       |
| ----- | ------------------------ |
| r     | runnable 執行續數量           |
| b     | block 執行續數量              |
| swpd  | 使用中的 swap 空間，過高實體記憶體可能不足 |
| free  | 空閒記憶體                    |
| buff  | 暫存區塊設備資料                 |
| cache | 檔案系統快取                   |
| si    | swap in，swap -> 記憶體      |
| so    | swap out，記憶體 -> swap     |
| bi    | block in，磁碟 -> 記憶體       |
| bo    | block out，記憶體 -> 磁碟      |
| in    | 每秒中斷次數/s                 |
| cs    | context switch 次數/s      |


### 磁碟 I/O 分析
1. `iostat`
命令：
```shell
# 1. 每秒顯示 io 狀態
iostat --human 1 1

# 2. 每秒顯示 io 狀態 (單頁刷新)
watch -n 1 'iostat --human 1 1'
```
> 注意 `--human` 是較新版才有

| 欄位        | 說明        |
| --------- | --------- |
| tps       | 每秒 I/O 次數 |
| KB_read/s | 每秒讀入速度    |
| KB_wrtn/s | 每秒寫入速度    |
| KB_dscd/s | 沒秒捨棄量     |

### 網路分析
1. 網路連線情況
命令：
```shell
# 列出所有網路
ss -tnuap

# 顯示全部 TCP
ss -ta

# 顯示全部 UDP
ss -ua

# 顯示狀態爲已連線
ss -t state established

# 顯示所有 listening
ss -tnlp
```

輸出：
```text
❯ ss -tunap
Netid        State         Recv-Q         Send-Q                   Local Address:Port                    Peer Address:Port         Process
udp          UNCONN        0              0                              0.0.0.0:43830                        0.0.0.0:*             users:(("kdeconnectd",pid=1428,fd=47))
udp          UNCONN        0              0                              0.0.0.0:60364                        0.0.0.0:*             users:(("kdeconnectd",pid=1428,fd=45))
udp          UNCONN        213568         0                              0.0.0.0:5353                         0.0.0.0:*             users:(("kdeconnectd",pid=1428,fd=40))
udp          UNCONN        0              0                              0.0.0.0:55612                        0.0.0.0:*             users:(("zen",pid=411409,fd=246))
```

| 欄位              | 說明                                                                                                                                                |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| Recv-Q / Send-Q | 接收/傳送隊列，大於零表示延遲                                                                                                                                   |
| State           | 狀態：<br>1. LISTEN: 等待連線<br>2. ESTABLISHED：TCP 已連線<br>3. CLOSE-WAIT：以收到 FIN 等待程序呼叫 `close()`<br>4. TIME-WAIT：本地已完全關閉，但還無法使用，以確保安全<br>5. CLOSED：連線終止 |

2.  網路流量與封包
命令：
```shell
# 顯示個網卡封包數量與狀態
ip -s link

# 每秒顯示
watch -n 1 'ip -s link'

# 網路測速
speedtest-cli
```

### Process 監控
1. 查找 CPU / 記憶體占用最大的程序
命令：
```shell
# 1. 使用實時監控
htop

# 2. 使用 ps
ps aux --sort=-%mem | head
ps aux --sort=-%cpu | head

```

2. 查看 Process 資源占用
命令：
```shell
# 1. 每秒打印 CPU (-u), 記憶體 (-r), 磁碟I/O (-d)
pidstat -d -r -u -p <PID> 1
```

### 文件占用
命令：
```shell
# 1. 查看哪個進程占用該文件
sudo lsof /path/to/file

# 2. 查看某進程開啓文件
sudo lsof -p <PID>

# 3. 查看哪個進程占用大量文件
lsof | awk '{ print $1 }' | sort | uniq -c | sort -nr

# 4. 查看 port 占用
sudo lsof -i :<port>

# 5. 找出
```
