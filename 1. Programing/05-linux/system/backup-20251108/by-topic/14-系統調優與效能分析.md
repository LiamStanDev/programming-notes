# 系統調優與效能分析

## 目錄
- [主題簡介](#主題簡介)
- [原理與架構說明](#原理與架構說明)
- [常用命令範例與解讀](#常用命令範例與解讀)
- [常見錯誤與排查流程](#常見錯誤與排查流程)
- [最佳實踐與安全性建議](#最佳實踐與安全性建議)
- [實戰案例](#實戰案例)

---

## 主題簡介

系統調優與效能分析是確保 Linux 伺服器與應用穩定、高效運作的核心技能。透過監控、分析、調整 CPU、記憶體、I/O、網路等資源，能精準定位瓶頸、提升效能、預防異常。常見應用場景：高併發服務、資源有限環境、異常排查、容量規劃、壓力測試。

---

## 原理與架構說明

### 效能瓶頸與資源監控

- **效能瓶頸**：指限制系統效能的資源（如 CPU 過載、I/O 等待、記憶體不足），需透過監控工具定位。
- **資源監控**：持續追蹤 CPU、記憶體、磁碟、網路等指標，數據有助於趨勢分析與異常預警。

### 核心參數與調校

- **Kernel 參數**：如 `/etc/sysctl.d/` 設定 TCP、網路、記憶體、I/O 等行為，合理調整可提升吞吐量與穩定性。
- **I/O 調校**：磁碟讀寫效能、I/O 排程器、快取機制等。
- **CPU 調校**：多核心分配、排程策略、CPU affinity。
- **記憶體調校**：swap、cache/buffer 管理、OOM 行為。
- **網路調校**：MTU、TCP 參數、佇列長度、offload 設定。

---

## 常用命令範例與解讀

### 1. CPU 與記憶體監控

#### `top` / `htop`
```shell
top
htop
```
- 動態顯示 CPU、記憶體、程序狀態，htop 支援滑鼠操作。
- 主要欄位：%CPU、%MEM、load average、任務狀態。

#### `iostat`
```shell
iostat -c 1
```
- 每秒顯示 CPU 使用率。
- 範例輸出：
```
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.85    0.08    7.20   12.98    0.00   76.88
```
| 欄位    | 說明                       |
| ------- | ------------------------ |
| %user   | User space CPU 使用率      |
| %system | Kernel Space 使用率        |
| %iowait | 等待 I/O 時間，>10% 需關注 |
| %idle   | 閒置比例                   |

#### `vmstat`
```shell
vmstat 1
```
- 顯示記憶體、swap、I/O、CPU 狀態。
- 範例輸出：
```
procs -----------memory---------- ---swap-- -----io---- -system-- -------cpu-------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0 2000724 4790556 89192 4827372  0    0 26205 25794 8137   10  4  4 84  8  0  0
```
| 欄位    | 說明                       |
| ------- | ------------------------ |
| r       | runnable 執行緒數量         |
| swpd    | 使用中的 swap 空間          |
| free    | 空閒記憶體                  |
| buff    | 暫存區塊設備資料             |
| cache   | 檔案系統快取                |
| us/sy/id/wa | CPU 各狀態              |

### 2. 磁碟 I/O 與網路監控

#### `iostat`（I/O 詳細）
```shell
iostat --human 1 1
```
- 顯示磁碟 I/O 狀態（新版支援 --human）。
- 主要欄位：tps、KB_read/s、KB_wrtn/s。

#### `ss`
```shell
ss -tnuap
```
- 顯示所有網路連線與狀態。
- 欄位說明：Recv-Q/Send-Q（隊列）、State（連線狀態）、Local/Peer Address、Process。

#### `ip -s link`
```shell
ip -s link
```
- 顯示各網卡封包數量與狀態。

### 3. 進階分析與壓力測試

#### `pidstat`
```shell
pidstat -d -r -u -p <PID> 1
```
- 監控指定程序的 CPU、記憶體、磁碟 I/O。

#### `fio`（磁碟 I/O 壓力測試）
```shell
fio --name=randreadwrite --ioengine=libaio --rw=randrw --bs=4k --size=10G --numjobs=4 --runtime=60 --group_reporting --direct=1 --iodepth=16 --directory=/home
```
- 隨機讀寫測試，參數可調整測試型態。

#### `stress-ng`（CPU/記憶體壓力測試）
```shell
stress-ng --cpu 4 --vm 1 --vm-bytes 1G --io 2 --timeout 60s
```
- 綜合壓力測試，適合驗證系統極限。

#### `sysctl`（核心參數調整）
```shell
sudo sysctl -w net.ipv4.tcp_syncookies=1
sudo sysctl --system
```
- 動態調整核心參數，建議寫入 `/etc/sysctl.d/` 並套用。

---

## 常見錯誤與排查流程

| 現象           | 排查命令與說明                                                                 |
| -------------- | ---------------------------------------------------------------------------- |
| 記憶體不足     | `free -h`、`vmstat`、`dmesg | grep -i oom`，檢查 swap、OOM 訊息                |
| 磁碟 I/O 過高  | `iostat`、`iotop`、`df -h`，檢查 %iowait、磁碟空間、I/O 熱點                   |
| CPU 負載過高   | `top`、`htop`、`pidstat`，找出高 CPU 程序                                      |
| 網路延遲/丟包  | `ss`、`ip -s link`、`ping`、`traceroute`，檢查網路隊列、丟包、延遲             |
| 參數設錯       | `sysctl -a`、檢查 `/etc/sysctl.d/`、`/etc/sysctl.conf`，回復預設值              |
| 檔案描述符耗盡 | `ulimit -n`、`lsof | wc -l`，調整 `fs.file-max`、關閉不必要程序                 |

---

## 最佳實踐與安全性建議

- **監控指標聚焦**：CPU、load average、記憶體剩餘、I/O 等待、網路流量。
- **調校步驟**：監控 → 定位瓶頸 → 調整參數 → 驗證成效 → 持續追蹤。
- **基準線建立**：定期記錄效能數據，便於異常偵測與容量規劃。
- **異常分析**：多工具交叉驗證，避免單一指標誤判。
- **變更控管**：調整核心參數前，務必備份現有設定並記錄調整內容。
- **安全建議**：
  - 禁用危險 sysctl 參數（如 kernel.sysrq）。
  - 強化 TCP/IP 安全（如 rp_filter、accept_redirects）。
  - 限制檔案描述符數量，防止資源耗盡攻擊。
  - 定期審查與最小化服務開放端口。

---

## 實戰案例

### 案例一：I/O 瓶頸定位與優化

1. **發現現象**：系統回應慢，load average 高。
2. **初步判斷**：
   ```shell
   iostat -c 1
   ```
   - 若 %iowait > 10%，懷疑 I/O 瓶頸。
3. **進一步分析**：
   ```shell
   iostat --human 1 1
   ```
   - 找出高負載磁碟。
4. **檢查磁碟空間與 inode**：
   ```shell
   df -h
   df -i
   ```
5. **優化建議**：
   - 檢查應用程式寫入模式，調整 I/O 排程器（如 `noop`、`deadline`）。
   - 增加 SSD 或調整 RAID。
   - 合理分配磁碟分區，避免單一磁碟過載。

### 案例二：高負載排查與 CPU 調優

1. **發現現象**：CPU 使用率高，系統卡頓。
2. **分析步驟**：
   ```shell
   top
   pidstat -u -p <PID> 1
   ```
   - 找出高 CPU 程序。
3. **進階分析**：
   ```shell
   perf top
   ```
   - 定位熱點函式，判斷是否為應用程式或系統瓶頸。
4. **優化建議**：
   - 合理分配多核心（taskset、cpuset）。
   - 調整 kernel 參數（如 `sched_child_runs_first`）。
   - 檢查應用程式演算法與資源使用。

### 案例三：核心參數安全強化

1. **設定安全參數**：
```ini
# /etc/sysctl.d/99-custom.conf
kernel.sysrq = 0
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_congestion_control = cubic
net.core.default_qdisc = fq_codel
```
   
2. **套用設定**：
```shell
sudo sysctl --system
```

---

## 參考資料

- man page：`man iostat`、`man vmstat`、`man sysctl`
- [my/01.系統參數.md](01.系統參數.md)
- [my/02.系統監測.md](02.系統監測.md)
- [my/04.主機性能測試.md](04.主機性能測試.md)
