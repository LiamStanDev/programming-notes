# 軟體安裝與套件管理

## 目錄
- [主題簡介](#主題簡介)
- [核心原理與架構](#核心原理與架構)
- [主流套件管理器比較](#主流套件管理器比較)
- [常用命令範例與完整輸出](#常用命令範例與完整輸出)
- [常見錯誤與排查方式](#常見錯誤與排查方式)
- [最佳實踐與安全性建議](#最佳實踐與安全性建議)
- [實戰案例](#實戰案例)
- [進階技巧](#進階技巧)

---

## 主題簡介

軟體安裝與套件管理是 Linux 系統管理的基石。透過套件管理系統（Package Manager），可高效安裝、升級、移除及管理軟體，並自動處理依賴關係。正確的套件管理能提升系統穩定性、安全性與維護效率，是自動化部署、故障排查與日常維運不可或缺的技能。

---

## 核心原理與架構

### 套件管理系統組成
- **Package Manager**：如 `apt`、`yum`、`dnf`、`pacman`，負責套件的查詢、安裝、升級、移除。
- **Repository (repo)**：集中存放套件的伺服器，分官方與第三方，可自建內部 repo。
- **依賴（Dependency）**：套件間相互依賴，管理器自動解決依賴樹，避免手動安裝地獄。
- **套件格式**：`deb`（Debian/Ubuntu）、`rpm`（RHEL/CentOS/Fedora）、`pkg.tar.zst`（Arch）。
- **原始碼安裝**：無套件時可自行編譯，需手動管理依賴與升級。
- **Metadata/Cache**：本地快取 repo 資訊，加速查詢與安裝。

---

## 主流套件管理器比較

| 發行版         | 管理器      | 套件格式 | 主要指令         | 特色                     |
| -------------- | ----------- | -------- | ---------------- | ------------------------ |
| Debian/Ubuntu  | apt, dpkg   | .deb     | apt, dpkg        | 依賴自動解決，社群活躍   |
| RHEL/CentOS    | yum, dnf    | .rpm     | dnf, rpm         | 支援多 repo，企業常用     |
| Fedora         | dnf         | .rpm     | dnf, rpm         | 新技術導向，更新快        |
| Arch Linux     | pacman      | .pkg.tar.zst | pacman      | 滾動更新，AUR 豐富        |

---

## 常用命令範例與完整輸出

### Debian/Ubuntu（apt, dpkg）

#### 套件查詢與安裝
```bash
$ sudo apt update
$ sudo apt install nginx
```
**輸出：**
```
Reading package lists... Done
Building dependency tree... Done
The following NEW packages will be installed: nginx ...
...
```

#### 查詢已安裝套件
```bash
$ dpkg -l | grep nginx
```
**輸出：**
```
ii  nginx     1.18.0-6ubuntu14.3   amd64   high performance web server
```

#### 升級所有套件
```bash
$ sudo apt upgrade
```

#### 移除套件
```bash
$ sudo apt remove nginx
```

#### 清理不需要的套件
```bash
$ sudo apt autoremove
```

---

### RHEL/CentOS/Fedora（dnf, rpm）

#### 安裝套件
```bash
$ sudo dnf install httpd
```
**輸出：**
```
Dependencies resolved.
================================================================================
 Package      Arch   Version         Repository      Size
================================================================================
Installing:
 httpd        x86_64 2.4.6-97.el7   base            2.7 M
...
```

#### 查詢已安裝套件
```bash
$ rpm -qa | grep httpd
```

#### 升級所有套件
```bash
$ sudo dnf upgrade
```

#### 移除套件
```bash
$ sudo dnf remove httpd
```

#### 清理不需要的套件
```bash
$ sudo dnf autoremove
```

---

### Arch Linux（pacman）

#### 安裝套件
```bash
$ sudo pacman -S vim
```

#### 查詢已安裝套件
```bash
$ pacman -Qs vim
```

#### 升級所有套件
```bash
$ sudo pacman -Syu
```

#### 移除套件
```bash
$ sudo pacman -R vim
```

#### 清理孤兒套件
```bash
$ sudo pacman -Rns $(pacman -Qdtq)
```

---

### 原始碼安裝（通用流程）
```bash
$ tar zxvf package.tar.gz
$ cd package
$ ./configure
$ make
$ sudo make install
```
> 注意：需手動管理依賴與升級，建議僅用於特殊需求。

---

## 常見錯誤與排查方式

| 錯誤訊息/現象                        | 原因與排查建議                                                                 |
| ------------------------------------- | ------------------------------------------------------------------------------ |
| 依賴問題（Dependency is not satisfiable） | 依賴缺失或版本衝突，執行 `apt --fix-broken install` 或手動安裝缺失依賴           |
| 鎖定問題（Could not get lock ...）     | 有其他套件管理程序執行，確認無其他安裝進程，必要時移除 lock 檔（如 `/var/lib/dpkg/lock`）|
| repo 無法連線（Failed to fetch）       | 檢查網路、repo 設定或更換鏡像源                                                |
| 安裝失敗                              | 檢查錯誤訊息、依賴、磁碟空間，查閱 log（如 `/var/log/apt/`、`/var/log/dnf.log`）|
| rpm/rpmdb 錯誤                        | 嘗試 `sudo rpm --rebuilddb` 修復 rpm 資料庫                                    |
| pacman 鎖定（unable to lock database） | 檢查 `/var/lib/pacman/db.lck`，無進程時可手動移除                              |

---

## 最佳實踐與安全性建議

- **定期更新**：保持系統與套件最新，減少安全漏洞。
- **來源管理**：僅信任官方或可靠第三方 repo，避免安裝來路不明套件。
- **依賴衝突處理**：遇到依賴問題，先檢查衝突套件版本，必要時手動解決。
- **清理舊套件**：定期執行 `autoremove` 清理不再需要的套件。
- **備份設定**：升級或移除前備份重要設定檔（如 `/etc` 下相關設定）。
- **權限最小化**：安裝/移除時使用 sudo，避免以 root 長時間操作。
- **審查腳本**：安裝第三方腳本前，務必審查內容，防止惡意程式碼。
- **監控異常**：安裝後建議檢查服務狀態與 log，及早發現異常。

---

## 實戰案例

### 案例一：修復依賴問題

**現象：**
```
E: Unmet dependencies. Try 'apt --fix-broken install' with no packages (or specify a solution).
```
**解法：**
```bash
$ sudo apt --fix-broken install
```
> 若仍失敗，檢查 `/var/log/apt/term.log`，手動安裝缺失依賴。

---

### 案例二：建立本地套件倉庫（repo）

**需求：** 企業內部部署，需自建 repo。

**Debian/Ubuntu：**
```bash
$ sudo apt install reprepro
$ mkdir -p /srv/repo/{conf,incoming}
# 編輯 conf/distributions，設定套件資訊
$ reprepro -b /srv/repo/ includedeb focal package.deb
```

**RHEL/CentOS：**
```bash
$ sudo dnf install createrepo
$ createrepo /srv/repo/
# 設定本地 repo
$ echo -e "[local]\nname=Local Repo\nbaseurl=file:///srv/repo/\ngpgcheck=0\nenabled=1" | sudo tee /etc/yum.repos.d/local.repo
```

---

### 案例三：原始碼安裝與移除

**需求：** 官方無套件，需自行編譯。

```bash
$ wget https://example.com/foo.tar.gz
$ tar zxvf foo.tar.gz
$ cd foo
$ ./configure
$ make
$ sudo make install
```
**移除方式：**
- 若有 `make uninstall`，可直接移除。
- 否則需手動刪除安裝檔案，建議記錄安裝路徑。

---

### 案例四：快速查找並移除孤兒套件

**Arch Linux：**
```bash
$ sudo pacman -Rns $(pacman -Qdtq)
```
> 定期清理可減少系統負擔。

---

## 進階技巧

- **自建 repo**：用 `createrepo`（rpm）或 `reprepro`（deb）建立內部套件倉庫，適用企業部署。
- **套件打包**：學習 `dpkg-deb`、`rpmbuild`、`makepkg` 打包自製軟體。
- **chroot/隔離環境**：用 `chroot` 建立測試環境，避免污染主系統。
- **多版本管理**：用 `update-alternatives`、`modules` 或容器（如 Docker）管理多版本軟體。
- **自動化部署**：結合 shell script、Ansible 等工具批次安裝與升級。
- **repo 鏡像加速**：選擇地區近的鏡像源，提升安裝速度。

---

> 參考：官方文件、Arch Wiki、企業內部經驗
