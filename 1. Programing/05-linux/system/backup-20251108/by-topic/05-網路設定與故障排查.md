# 網路設定與故障排查

## 目錄
- [主題簡介](#主題簡介)
- [原理與架構說明](#原理與架構說明)
  - [網路堆疊與協定](#網路堆疊與協定)
  - [IP/MAC 位址](#ipmac-位址)
  - [路由與 DNS](#路由與-dns)
  - [VLAN 與虛擬網路](#vlan-與虛擬網路)
  - [Netfilter 與防火牆](#netfilter-與防火牆)
- [常用命令與範例](#常用命令與範例)
- [常見錯誤與排查流程](#常見錯誤與排查流程)
- [最佳實踐與安全建議](#最佳實踐與安全建議)
- [實戰案例](#實戰案例)

---

## 主題簡介

Linux 網路設定與故障排查是系統管理與維運的核心技能。涵蓋網路協定、設備管理、路由、DNS、虛擬網路、封包分析與防火牆。熟悉這些內容能有效解決連線異常、效能瓶頸、安全問題，並提升架構設計能力。適用於日常維運、架構設計、面試準備。

---

## 原理與架構說明

### 網路堆疊與協定

- **OSI 七層模型**：實體、資料連結、網路、傳輸、會議、表示、應用層。
- **TCP/IP 四層模型**：網路介面、網際網路、傳輸、應用層。
- **常見協定**：Ethernet、IP、TCP/UDP、ICMP、ARP、DNS、HTTP/HTTPS。

### IP/MAC 位址

- **IPv4/IPv6**：唯一標識網路設備，子網遮罩決定網段範圍。
- **MAC 位址**：網卡硬體位址，資料連結層唯一識別。
- **分配方式**：靜態（手動）、動態（DHCP）。

### 路由與 DNS

- **路由**：決定封包轉送路徑，分靜態/動態（如 OSPF、BGP）。
- **預設路由**：無法比對時的出口。
- **DNS**：將網域名稱解析為 IP 位址，常見伺服器如 BIND、dnsmasq。
- **/etc/resolv.conf**：DNS 設定檔。

### VLAN 與虛擬網路

- **VLAN**：虛擬區域網路，隔離流量，802.1Q 標準。
- **虛擬介面**：如 veth、bridge，常用於容器、測試環境。
- **網路命名空間**：隔離網路環境，提升安全與彈性。

### Netfilter 與防火牆

- **Netfilter**：Linux 核心封包過濾框架。
- **iptables/nftables**：實現防火牆、NAT、流量導向。
- **常見鏈路**：INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING。

---

## 常用命令與範例

### 1. 介面與 IP 設定

| 指令                    | 功能          | 範例              | 輸出重點                   |
| --------------------- | ----------- | --------------- | ---------------------- |
| `ip addr show`        | 顯示所有網卡狀態    | `ip addr show`  | 介面名稱、IP、MAC、狀態         |
| `ifconfig`            | 顯示/設定網卡（舊式） | `ifconfig eth0` | inet、netmask、broadcast |
| `ip link set eth0 up` | 啟用網卡        |                 |                        |

### 2. 路由與 DNS

| 指令 | 功能 | 範例 | 輸出重點 |
|---|---|---|---|
| `ip route` | 顯示路由表 | `ip route` | default、via、dev |
| `route -n` | 顯示路由表（舊式） | `route -n` | Destination、Gateway |
| `cat /etc/resolv.conf` | 查看 DNS 設定 |  | nameserver |

### 3. 連線狀態與監控

| 指令 | 功能 | 範例 | 輸出重點 |
|---|---|---|---|
| `ss -tuln` | 顯示監聽連接 | `ss -tuln` | Local Address、State |
| `netstat -tuln` | 顯示監聽連接（舊式） |  |  |
| `ping 8.8.8.8` | 測試連通性 |  | icmp_seq、ttl、time |
| `traceroute google.com` | 路徑追蹤 |  | 跳點 IP、延遲 |
| `dig www.google.com` | DNS 查詢 |  | ANSWER SECTION |
| `nslookup www.google.com` | DNS 查詢 |  | Address |

### 4. 封包分析與防火牆

| 指令 | 功能 | 範例 | 輸出重點 |
|---|---|---|---|
| `tcpdump -i eth0 tcp port 80` | 封包擷取 |  | 封包來源/目的、協定 |
| `iptables -L` | 列出防火牆規則 |  | Chain、target、prot |
| `nft list ruleset` | 列出 nftables 規則 |  | table、chain |

---

## 常見錯誤與排查流程

### 1. 無法連線

- 檢查網卡狀態
  ```shell
  ip link show
  ```
- 檢查 IP 設定
  ```shell
  ip addr show
  ```
- 檢查線路連接（物理/虛擬）

### 2. DNS 解析失敗

- 檢查 `/etc/resolv.conf`
- 測試 DNS
  ```shell
  dig www.google.com
  nslookup www.google.com
  ```
- 嘗試更換 DNS（如 8.8.8.8）

### 3. 路由錯誤

- 檢查路由表
  ```shell
  ip route
  ```
- 確認預設路由是否正確

### 4. 封包遺失/延遲

- 使用 `ping` 測試延遲與丟包
- 使用 `traceroute` 追蹤路徑
- 使用 `tcpdump` 擷取異常封包

### 5. 防火牆阻擋

- 檢查 iptables/nftables 規則
  ```shell
  iptables -L -n
  nft list ruleset
  ```
- 關閉防火牆測試（僅限排障，勿長期關閉）

---

## 最佳實踐與安全建議

- 優先使用 `ip` 指令，取代舊式 `ifconfig`、`route`。
- 介面命名建議使用預設（如 eth0、ens33），避免混淆。
- 靜態設定需確認 IP、網關、DNS 正確無誤。
- 動態設定（DHCP）時，確認 dhclient/dhcpcd 服務狀態。
- 定期檢查路由表與防火牆規則，避免誤設導致斷線。
- 強化網路安全：
  - 限制不必要的服務
  - 啟用防火牆（iptables/nftables）
  - 監控異常流量（如 netstat、ss、tcpdump）
  - 設定 VLAN 時，確認標籤一致與交換機支援
- 參考 sysctl 強化網路安全（如 rp_filter、accept_redirects、tcp_syncookies 等）

---

## 實戰案例

### 案例一：新主機無法上網

1. 檢查網卡狀態
   ```shell
   ip link show
   ```
   - 若為 DOWN，執行 `ip link set eth0 up`

2. 檢查 IP 設定
   ```shell
   ip addr show eth0
   ```
   - 若無 IP，檢查 DHCP 服務或手動設定

3. 檢查預設路由
   ```shell
   ip route
   ```
   - 若無 default，設定：
     ```shell
     ip route add default via 192.168.1.1
     ```

4. 測試 DNS
   ```shell
   ping 8.8.8.8
   dig www.google.com
   ```

5. 檢查防火牆
   ```shell
   iptables -L -n
   ```

### 案例二：網站連線間歇性失敗

1. 使用 `ping`、`traceroute` 測試延遲與路徑
2. 用 `ss -tuln` 檢查服務監聽狀態
3. 用 `tcpdump` 擷取異常時段封包
4. 檢查防火牆規則是否有誤攔截

### 案例三：VLAN 無法互通

1. 檢查 VLAN 設定與標籤
2. 確認交換機支援並正確配置
3. 用 `ip link`、`bridge` 工具檢查虛擬介面狀態

---

## 進階技巧

- **網路命名空間**：隔離網路環境，常用於容器與測試
  ```shell
  ip netns add testns
  ip netns exec testns ip link
  ```
- **虛擬網路介面**：如 veth、bridge，實現複雜網路拓撲
  ```shell
  ip link add veth0 type veth peer name veth1
  ip link set veth0 up
  ```
- **iptables 進階應用**：多層防護、NAT、流量導向
  ```shell
  iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
  ```
- **封包分析**：利用 `tcpdump`、`wireshark` 進行協定解析與問題定位
  ```shell
  tcpdump -nn -i eth0 port 80
  ```

---
