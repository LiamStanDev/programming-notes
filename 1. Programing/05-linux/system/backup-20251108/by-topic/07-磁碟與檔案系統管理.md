# 磁碟與檔案系統管理

## 目錄
- [主題簡介](#主題簡介)
- [核心原理與架構](#核心原理與架構)
  - [磁碟分割](#磁碟分割)
  - [檔案系統類型](#檔案系統類型)
  - [LVM（邏輯卷管理）](#lvm邏輯卷管理)
  - [掛載流程](#掛載流程)
  - [inode](#inode)
  - [quota（磁碟配額）](#quota磁碟配額)
  - [RAID](#raid)
- [常用指令與範例](#常用指令與範例)
- [常見錯誤與排查](#常見錯誤與排查)
- [最佳實踐與安全建議](#最佳實踐與安全建議)
- [實戰案例](#實戰案例)
- [進階技巧](#進階技巧)

---

## 主題簡介

磁碟與檔案系統管理是 Linux/UNIX 系統維運的基石，涵蓋磁碟分割、檔案系統建立、掛載、空間監控、資料一致性、備份、效能調校與故障排查。正確規劃與管理可提升系統穩定性、效能與安全性，並有效應對資料爆滿、硬碟損毀等突發狀況。

---

## 核心原理與架構

### 磁碟分割

- 將一顆物理磁碟劃分為多個邏輯區域（分割區），每個分割可獨立格式化與掛載。
- 分割表類型：MBR（舊式，最多 2TB）、GPT（新式，支援大容量與多分割）。
- 工具：`fdisk`（MBR）、`gdisk`（GPT）、`parted`（支援兩者）。

### 檔案系統類型

- **ext4**：最常用，穩定、支援大檔案。
- **xfs**：高效能，適合大容量與高併發。
- **btrfs**：支援快照、壓縮、子卷。
- **zfs**：進階功能，資料完整性保護。
- **vfat/exfat/ntfs**：跨平台需求（如 USB 隨身碟）。

### LVM（邏輯卷管理）

- 將多顆磁碟或分割區整合為邏輯卷，支援動態擴容、快照。
- 結構：PV（Physical Volume）→ VG（Volume Group）→ LV（Logical Volume）。
- 適合雲端、資料中心等需彈性調整空間場景。

### 掛載流程

1. 格式化分割區（`mkfs`）
2. 建立掛載點目錄（`mkdir`）
3. 掛載（`mount`）
4. 設定 `/etc/fstab` 以開機自動掛載

### inode

- 檔案系統的元資料結構，記錄檔案屬性與資料區塊位置。
- 每個檔案/目錄佔用一個 inode，inode 用盡會導致無法建立新檔案。
- `df -i` 可查詢 inode 使用情況。

### quota（磁碟配額）

- 限制使用者或群組的磁碟空間或 inode 數量，防止資源被濫用。
- 常用於多用戶環境，避免單一用戶佔滿空間。

### RAID

- 多顆磁碟組合成一個邏輯磁碟，提升效能或可靠性。
- 常見等級：
  - RAID 0（條帶）：效能高，無容錯
  - RAID 1（鏡像）：資料雙份，容錯高
  - RAID 5/6（帶奇偶校驗）：效能與容錯兼具
  - RAID 10（條帶+鏡像）：效能與容錯兼具

---

## 常用指令與範例

### 磁碟與分割

```bash
# 查看磁碟與分割
lsblk
# 輸出範例
# NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
# sda      8:0    0  100G  0 disk
# ├─sda1   8:1    0   50G  0 part /
# └─sda2   8:2    0   50G  0 part /data

# 互動式分割
sudo fdisk /dev/sda

# GPT 分割
sudo parted /dev/sdb
```

### 檔案系統建立與檢查

```bash
# 建立 ext4 檔案系統
sudo mkfs.ext4 /dev/sda2

# 建立 xfs 檔案系統
sudo mkfs.xfs /dev/sdb1

# 檢查檔案系統
sudo fsck /dev/sda1
```

### 掛載與卸載

```bash
# 建立掛載點
sudo mkdir /mnt/data

# 掛載
sudo mount /dev/sda2 /mnt/data

# 卸載
sudo umount /mnt/data

# 查看掛載狀態
mount | grep /mnt/data
```

### 空間與 inode 監控

```bash
# 查看磁碟空間
df -h

# 查看 inode 使用情況
df -i

# 查看目錄大小
du -sh /var/log/*
```

### LVM 操作

```bash
# 建立 PV
sudo pvcreate /dev/sdb1

# 建立 VG
sudo vgcreate vg_data /dev/sdb1

# 建立 LV
sudo lvcreate -L 20G -n lv_data vg_data

# 格式化 LV
sudo mkfs.ext4 /dev/vg_data/lv_data

# 掛載 LV
sudo mount /dev/vg_data/lv_data /mnt/data
```

### quota 設定

```bash
# 編輯 /etc/fstab，加入 usrquota,grpquota
# 重新掛載
sudo mount -o remount /

# 啟用 quota
sudo quotacheck -cum /
sudo quotaon /

# 設定使用者配額
sudo edquota username
```

### RAID 管理（以 mdadm 為例）

```bash
# 建立 RAID 1
sudo mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdb1 /dev/sdc1

# 查看 RAID 狀態
cat /proc/mdstat
```

### btrfs 進階應用

```bash
# 建立子卷
sudo btrfs subvolume create /mnt/data/subvol1

# 建立快照
sudo btrfs subvolume snapshot /mnt/data/subvol1 /mnt/data/snap1
```

---

## 常見錯誤與排查

| 問題                | 排查方式與解決建議                                   |
|---------------------|-----------------------------------------------------|
| 掛載失敗            | 檢查裝置路徑、檔案系統類型、`dmesg` 訊息、權限設定   |
| 檔案系統損毀        | 使用 `fsck` 修復，嚴重時需還原備份                   |
| 空間不足            | `df`/`du` 檢查大檔案，清理不必要檔案                 |
| inode 用盡          | `df -i` 檢查，刪除大量小檔案或調整分割區             |
| RAID 陣列降級       | `cat /proc/mdstat`，檢查硬碟狀態，替換損壞磁碟       |
| quota 無法啟用      | 檢查 fstab 設定、quota 套件是否安裝                  |
| LVM 無法擴容        | 檢查 PV/VG 空間、LV 是否掛載、`lvdisplay` 狀態        |
| fstab 設定錯誤      | 檢查 UUID/LABEL 是否正確，語法錯誤會導致開機掛載失敗  |

---

## 最佳實踐與安全建議

- **分割與掛載規劃**：根據應用需求分割（如 `/`, `/home`, `/var`, `/data`），避免單一分割區爆滿影響系統。
- **備份與快照**：定期備份重要資料，善用 LVM/btrfs/zfs 快照功能。
- **監控**：持續監控空間與 inode 使用，設置警示（如 `df -h`, `df -i`，結合監控工具）。
- **資料一致性**：關機前卸載磁碟，避免強制斷電導致檔案系統損毀。
- **fstab 設定**：使用 UUID 或 LABEL 增加掛載穩定性，避免裝置名稱變動導致掛載失敗。
- **權限與配額**：設定目錄權限與 quota，防止資源被濫用。
- **RAID 熱備援**：RAID 1/5/6/10 建議預留熱備援磁碟（hot spare）。
- **安全性**：重要資料分區建議加密（如 LUKS），避免未授權存取。

---

## 實戰案例

### 案例一：根分割區爆滿排查與處理

```bash
# 1. 檢查空間
df -h
# 2. 檢查大檔案
du -sh /* | sort -hr | head
# 3. 找出異常大檔案
find / -type f -size +500M
# 4. 清理不必要檔案（如 log、暫存檔）
sudo rm -rf /var/log/old_logs/*
# 5. 釋放 inode
df -i
find /tmp -type f -delete
```

### 案例二：LVM 線上擴容

```bash
# 1. 新增磁碟並建立 PV
sudo pvcreate /dev/sdc1
# 2. 加入 VG
sudo vgextend vg_data /dev/sdc1
# 3. 擴充 LV
sudo lvextend -l +100%FREE /dev/vg_data/lv_data
# 4. 線上擴展檔案系統（ext4）
sudo resize2fs /dev/vg_data/lv_data
# 5. 驗證
df -h
```

### 案例三：RAID 1 硬碟損毀重建

```bash
# 1. 查看 RAID 狀態
cat /proc/mdstat
# 2. 標記損壞磁碟為失效
sudo mdadm --manage /dev/md0 --fail /dev/sdb1
# 3. 移除損壞磁碟
sudo mdadm --manage /dev/md0 --remove /dev/sdb1
# 4. 插入新磁碟並加回陣列
sudo mdadm --manage /dev/md0 --add /dev/sdb2
# 5. 監控重建進度
watch cat /proc/mdstat
```

---

## 進階技巧

- **動態擴容**：LVM 支援線上擴容與縮減邏輯卷，btrfs/zfs 可動態擴展儲存池。
- **快照**：LVM、btrfs、zfs 皆支援快照，方便資料還原與備份。
- **RAID 管理**：mdadm 支援 RAID 重建、擴容、熱插拔。
- **btrfs/zfs 進階應用**：壓縮、去重、檔案層級快照、即時校驗、資料自我修復。
- **自動化腳本**：結合 shell script 與監控工具自動化磁碟管理與警示。

---

> 本文件適合日常查閱、面試準備與故障排查，內容涵蓋原理、實務、命令、排錯與安全建議，並參考 my 筆記風格，強調條列、範例、表格與實戰。
