# 常見錯誤與除錯方式

## 目錄
- [主題簡介](#主題簡介)
- [原理與架構說明](#原理與架構說明)
- [常見錯誤類型與排查流程](#常見錯誤類型與排查流程)
- [除錯命令範例與完整輸出](#除錯命令範例與完整輸出)
- [常見錯誤訊息對照表](#常見錯誤訊息對照表)
- [最佳實踐與安全性建議](#最佳實踐與安全性建議)
- [實戰案例：從現象到解決](#實戰案例從現象到解決)
- [進階技巧與資深工程師建議](#進階技巧與資深工程師建議)

---

## 主題簡介

本筆記彙整 Linux/UNIX 系統常見錯誤類型、排查流程、除錯工具與進階技巧，協助工程師與系統管理員在日常維運、故障排查、面試實戰中快速定位與解決問題。內容涵蓋：
- 常見錯誤來源與訊息判讀
- 系統訊息流與除錯思維
- 工具應用、SOP 建立、核心傾印分析
- 實戰案例與最佳實踐

---

## 原理與架構說明

### 錯誤來源與系統訊息流

| 錯誤來源         | 常見情境                             | 影響層級         |
|------------------|--------------------------------------|------------------|
| 檔案/目錄        | 路徑錯誤、權限不足、空間不足           | 應用層/系統層    |
| 網路             | 連線失敗、DNS、封包遺失、防火牆        | 應用層/網路層    |
| 系統資源         | 記憶體、CPU、磁碟、檔案描述元耗盡       | 核心/系統層      |
| 服務啟動/運行    | 設定錯誤、依賴缺失、SELinux 阻擋        | 應用層/系統層    |

- **訊息流**：應用程式 → 系統呼叫 → 核心 → 硬體/網路 → 回傳訊息/錯誤碼
- **除錯思維**：由外而內、由簡入深，先確認現象再逐層排查

### 除錯流程 SOP

1. **重現問題**：確認錯誤現象與觸發條件
2. **收集資訊**：檢查日誌、錯誤訊息、系統狀態
3. **分析原因**：比對正常與異常狀態，推敲可能成因
4. **驗證假設**：逐步排除、測試修正方案
5. **記錄與回報**：紀錄步驟、結論，必要時回報團隊

---

## 常見錯誤類型與排查流程

### 1. 檔案/目錄錯誤

- **錯誤訊息**：`No such file or directory`、`Permission denied`
- **排查步驟**：
  1. 確認路徑拼寫與存在性
  2. `ls -l` 檢查權限、擁有者
  3. `df -h`、`df -i` 檢查空間與 inode
  4. 檢查 SELinux/AppArmor 狀態
- **常用命令**：
  ```shell
  ls -l /path/to/file
  stat /path/to/file
  getenforce
  ```

### 2. 網路錯誤

- **錯誤訊息**：`Connection timed out`、`Network is unreachable`
- **排查步驟**：
  1. `ping`、`traceroute` 測試連線
  2. `ip addr`、`ip route` 檢查網路設定
  3. `ss -tunlp`、`iptables -L` 檢查防火牆
- **常用命令**：
  ```shell
  ping -c 4 8.8.8.8
  ip addr
  ss -tnlp
  ```

### 3. 系統資源錯誤

- **錯誤訊息**：`Out of memory`、`Too many open files`
- **排查步驟**：
  1. `free -h`、`top`、`htop` 檢查記憶體/CPU
  2. `ulimit -a` 查資源限制
  3. `lsof` 查檔案描述元
- **常用命令**：
  ```shell
  free -h
  ulimit -a
  lsof | wc -l
  ```

### 4. 服務啟動/運行錯誤

- **錯誤訊息**：`Failed to start <service>`、`Job for <service> failed`
- **排查步驟**：
  1. `systemctl status <service>`
  2. `journalctl -u <service>`
  3. 檢查設定檔、依賴服務
- **常用命令**：
  ```shell
  systemctl status nginx
  journalctl -u nginx
  ```

### 5. SELinux/AppArmor 阻擋

- **錯誤訊息**：`SELinux is preventing ...`
- **排查步驟**：
  1. `getenforce` 查狀態
  2. `ausearch -m avc` 或 `audit2why` 查詢阻擋原因
- **常用命令**：
  ```shell
  getenforce
  ausearch -m avc
  ```

---

## 除錯命令範例與完整輸出

### 1. dmesg

```shell
$ dmesg | tail -5
[12345.678901] EXT4-fs error (device sda1): ...
[12345.678902] Out of memory: Kill process 1234 (nginx) score 987 or sacrifice child
```

### 2. journalctl

```shell
$ journalctl -u nginx --since "10 min ago"
Sep 17 16:00:00 server systemd[1]: Starting A high performance web server...
Sep 17 16:00:01 server nginx[1234]: nginx: [emerg] bind() to 0.0.0.0:80 failed
```

### 3. strace

```shell
$ strace -e openat ls /notfound
openat(AT_FDCWD, "/notfound", O_RDONLY) = -1 ENOENT (No such file or directory)
```

### 4. lsof

```shell
$ lsof -i :80
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
nginx   1234 root    6u  IPv4  12345      0t0  TCP *:http (LISTEN)
```

### 5. ss

```shell
$ ss -tnlp
State   Recv-Q Send-Q Local Address:Port Peer Address:Port Process
LISTEN  0      128    0.0.0.0:80        0.0.0.0:*        users:(("nginx",pid=1234,fd=6))
```

### 6. top/htop

```shell
$ top
PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
1234 root      20   0  162348   2348   1234 S   0.3  0.1   0:00.01 nginx
```

---

## 常見錯誤訊息對照表

| 錯誤訊息                       | 可能原因                   | 排查重點                  |
|--------------------------------|--------------------------|--------------------------|
| No such file or directory      | 路徑錯誤、檔案不存在         | 路徑拼寫、檔案建立         |
| Permission denied              | 權限不足、SELinux/AppArmor | 權限設定、身份、SELinux   |
| No space left on device        | 磁碟空間/ inode 用盡        | `df -h`、`df -i`         |
| Connection timed out           | 網路不通、防火牆、路由      | ping、traceroute、iptables|
| Out of memory                  | 記憶體耗盡、程式洩漏        | free、top、dmesg         |
| Too many open files            | 檔案描述元耗盡              | ulimit、lsof             |
| Failed to start <service>      | 設定錯誤、依賴缺失           | systemctl、journalctl    |
| SELinux is preventing ...      | SELinux policy 阻擋         | getenforce、ausearch     |

---

## 最佳實踐與安全性建議

- **紀錄除錯步驟**：每次排查過程建議詳細紀錄，便於回溯與知識傳承
- **建立 SOP**：針對常見問題建立標準作業流程，提升效率
- **善用日誌**：定期檢查與分析系統/應用日誌，預防問題擴大
- **團隊協作**：遇到複雜問題時，善用團隊討論與經驗分享
- **權限最小化**：避免以 root 執行非必要操作，降低風險
- **備份與還原**：重要設定與資料應定期備份，測試還原流程
- **資安防護**：善用 SELinux/AppArmor、防火牆，並定期檢查規則

---

## 實戰案例：從現象到解決

### 案例一：Nginx 啟動失敗

**現象**
服務啟動時出現：
```
Job for nginx.service failed because the control process exited with error code.
```

**排查流程**
1. 查看服務狀態
   ```shell
   systemctl status nginx
   ```
2. 查看詳細日誌
   ```shell
   journalctl -u nginx
   ```
3. 發現錯誤訊息：
   ```
   nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
   ```
4. 查找 80 port 被誰佔用
   ```shell
   lsof -i :80
   ```
5. 若為舊 nginx 或其他服務佔用，先停止再重啟 nginx
   ```shell
   systemctl stop httpd
   systemctl restart nginx
   ```

### 案例二：磁碟空間不足導致服務異常

**現象**
應用程式寫入檔案時失敗，日誌顯示：
```
No space left on device
```

**排查流程**
1. 檢查磁碟空間
   ```shell
   df -h
   ```
2. 檢查 inode 使用量
   ```shell
   df -i
   ```
3. 找出大檔案
   ```shell
   du -sh /* | sort -hr | head
   ```
4. 清理不必要檔案或擴充磁碟

---

## 進階技巧與資深工程師建議

### 核心傾印分析

- 產生 core dump：`ulimit -c unlimited`
- 分析 core dump：`gdb <binary> core`
- 判讀 SIGSEGV、SIGABRT 等異常

### 系統追蹤與效能分析

- 使用 `perf`, `systemtap`, `bcc` 工具進行效能與行為追蹤
- 例：`perf top`、`stap -v script.stp`

### 動態偵錯

- 利用 `gdb`、`ltrace`、`valgrind` 進行即時偵錯與記憶體檢查

### 跨主機排查

- 結合集中式日誌（如 ELK）、遠端執行工具（如 Ansible、SaltStack）進行大規模排查
- 善用 SSH 隧道、VPN 進行安全連線

---
