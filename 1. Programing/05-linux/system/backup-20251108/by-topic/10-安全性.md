# 安全性

## 目錄
- [主題簡介](#主題簡介)
- [原理與架構](#原理與架構)
  - [Linux 安全模型](#linux-安全模型)
  - [防火牆](#防火牆)
  - [SELinux](#selinux)
  - [AppArmor](#apparmor)
  - [權限控管](#權限控管)
  - [加密](#加密)
- [常用命令與範例](#常用命令與範例)
- [常見錯誤與排查](#常見錯誤與排查)
- [最佳實踐與安全建議](#最佳實踐與安全建議)
- [實戰案例](#實戰案例)

---

## 主題簡介

Linux 安全性涵蓋存取控制、防火牆、權限管理、加密、審核與自動化檢查等，目標為防止未授權存取、資料洩漏與惡意攻擊，確保系統穩定與資料完整。應用於企業伺服器、雲端主機、IoT 裝置等多元場景。

---

## 原理與架構

### Linux 安全模型

- 多用戶、多層級權限設計，結合 DAC（自主存取控制）、MAC（強制存取控制）。
- 透過用戶、群組、檔案權限、SELinux/AppArmor 等機制強化安全。
- 權限流程圖（文字描述）：
  1. 使用者發起操作 → 檢查檔案/目錄權限（DAC）
  2. 若啟用 SELinux/AppArmor，進一步檢查進程與資源互動（MAC）
  3. 最終決定是否允許操作

### 防火牆

- 控制網路流量進出，阻擋未授權存取。
- 常見工具：`iptables`、`firewalld`、`ufw`、`nftables`
- 流程（文字描述）：封包進入 → 依序經過 PREROUTING、INPUT、FORWARD、OUTPUT、POSTROUTING → 依規則決定放行/拒絕

### SELinux

- Security-Enhanced Linux，提供細緻的強制存取控制（MAC）。
- 以 policy 為核心，限制進程與資源互動。
- 三種模式：Enforcing（強制）、Permissive（警告）、Disabled（關閉）

### AppArmor

- 以 profile 為基礎的 MAC 系統，限制應用程式行為。
- 配置較簡單，適合快速部署。
- 支援 enforce（強制）、complain（僅記錄）模式。

### 權限控管

- 檔案/目錄權限（rwx）、用戶與群組、sudo 機制。
- 最小權限原則（Principle of Least Privilege）。
- 關鍵檔案（如 `/etc/shadow`）僅限 root 存取。

### 加密

- 傳輸加密（如 SSH、TLS）、儲存加密（如 LUKS）、檔案加密（如 openssl）。
- 加密流程：明文 → 加密 → 儲存/傳輸 → 解密

---

## 常用命令與範例

### 防火牆

#### ufw

```shell
$ sudo ufw status
Status: active

$ sudo ufw allow 22/tcp
Rule added

$ sudo ufw deny 80/tcp
Rule added

$ sudo ufw enable
Firewall is active and enabled on system startup
```

#### firewalld

```shell
$ sudo firewall-cmd --state
running

$ sudo firewall-cmd --add-service=http --permanent
success

$ sudo firewall-cmd --reload
success
```

#### iptables

```shell
$ sudo iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

$ sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
$ sudo iptables -A INPUT -j DROP
```

| 參數         | 說明                       |
| ------------ | ------------------------ |
| -A           | 新增規則                  |
| -D           | 刪除規則                  |
| -I           | 插入規則                  |
| -p           | 協定（tcp/udp/icmp）      |
| --dport      | 目標埠口                  |
| -j           | 動作（ACCEPT/DROP/REJECT）|

#### nftables

```shell
$ sudo nft list ruleset
table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;
    ct state established,related accept
    iif "lo" accept
    tcp dport 22 ct state new accept
    ip protocol icmp accept
    reject
  }
}
```

### SELinux

```shell
$ getenforce
Enforcing

$ sudo setenforce 0
$ getenforce
Permissive

$ sudo semanage port -l | grep http
http_port_t                    tcp      80, 443, 488, 8008, 8009, 8443
```

### AppArmor

```shell
$ sudo aa-status
apparmor module is loaded.
5 profiles are loaded.

$ sudo aa-enforce /etc/apparmor.d/usr.sbin.nginx
Setting /etc/apparmor.d/usr.sbin.nginx to enforce mode.
```

### 權限控管

```shell
$ ls -l /etc/shadow
-r-------- 1 root root 1234 Sep 17 10:00 /etc/shadow

$ sudo chmod 600 /etc/ssh/sshd_config
$ sudo chown root:root /etc/ssh/sshd_config
```

### 加密

```shell
$ openssl enc -aes-256-cbc -salt -in secret.txt -out secret.enc
enter aes-256-cbc encryption password:

$ openssl enc -d -aes-256-cbc -in secret.enc -out secret.txt
enter aes-256-cbc decryption password:
```

---

## 常見錯誤與排查

- **防火牆規則衝突**
  - 現象：預期流量被阻擋或未放行
  - 排查：檢查規則順序與重疊，使用 `iptables -L`、`ufw status`、`firewall-cmd --list-all`
  - 解法：調整規則順序，避免重複或矛盾

- **SELinux 阻擋**
  - 現象：服務啟動失敗、權限被拒
  - 排查：查閱 `/var/log/audit/audit.log`，用 `audit2why`、`audit2allow` 分析
  - 解法：調整 policy 或暫時切換為 Permissive

- **AppArmor profile 問題**
  - 現象：應用程式無法存取特定資源
  - 排查：檢查 `/var/log/syslog` 或 `dmesg`，調整 profile
  - 解法：使用 `aa-logprof`、`aa-genprof` 工具輔助修正

- **權限錯誤**
  - 現象：檔案/目錄無法存取
  - 排查：確認權限與擁有者，使用 `ls -l`、`chmod`、`chown`
  - 解法：修正權限與擁有者設定

- **加密失敗**
  - 現象：openssl 執行錯誤
  - 排查：檢查參數與密碼正確性
  - 解法：重新確認命令與密碼

---

## 最佳實踐與安全建議

- 採用最小權限原則，僅授權必要權限
- 定期更新系統與套件，修補已知漏洞
- 使用強密碼與多因素認證
- 定期執行弱點掃描（如 OpenVAS、Lynis）
- 審查與監控日誌，及早發現異常
- 關閉不必要的服務與埠口
- 定期備份重要資料並測試還原流程
- 防火牆規則腳本化，開機自動載入
- 關鍵檔案（如 `/etc/shadow`、`/etc/ssh/sshd_config`）權限嚴格控管

---

## 實戰案例

### 1. 防火牆腳本自動化（iptables）

撰寫腳本 `~/.config/zsh/scripts/firewall.sh`：

```bash
#!/bin/bash
set -euo pipefail

log() { echo "[+] $1"; }

log "清除現有規則"
iptables -F
iptables -X
iptables -t nat -F
iptables -t mangle -F

log "設定預設政策（DROP）白名單策略"
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

log "允許已建立與相關連線"
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

log "允許 loopback"
iptables -A INPUT -i lo -j ACCEPT

log "允許 SSH 連線(22)"
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

log "允許 ICMP (ping)"
iptables -A INPUT -p icmp -j ACCEPT

log "拒絕其他封包前 log 一下（方便 debug）"
iptables -A INPUT -j LOG --log-prefix "DROP_INPUT: " --log-level 4
iptables -A FORWARD -j LOG --log-prefix "DROP_FORWARD: " --log-level 4

log "✅ 防火牆設定完成"
```

使用方式：

```shell
chmod +x ~/.config/zsh/scripts/firewall.sh
sudo ~/.config/zsh/scripts/firewall.sh
sudo iptables-save | sudo tee /etc/iptables/iptables.rules
sudo systemctl enable --now iptables.service
```

### 2. SELinux 問題排查與自訂 policy

- 問題：Nginx 啟動後無法存取自訂目錄
- 步驟：
  1. 查閱 `/var/log/audit/audit.log`，找出被拒事件
  2. 產生自訂 policy module
     ```shell
     grep nginx /var/log/audit/audit.log | audit2allow -M nginx_custom
     sudo semodule -i nginx_custom.pp
     ```
  3. 驗證服務恢復正常

### 3. AppArmor profile 快速修正

- 問題：自訂應用程式被 AppArmor 阻擋
- 步驟：
  1. 查閱 `/var/log/syslog` 或 `dmesg`
  2. 執行 `sudo aa-logprof`，依提示修正 profile
  3. 設定 enforce 模式
     ```shell
     sudo aa-enforce /etc/apparmor.d/usr.bin.myapp
     ```

### 4. openssl 檔案加密與解密

```shell
$ openssl enc -aes-256-cbc -salt -in secret.txt -out secret.enc
enter aes-256-cbc encryption password:

$ openssl enc -d -aes-256-cbc -in secret.enc -out secret.txt
enter aes-256-cbc decryption password:
```

- 常見錯誤：密碼錯誤或參數拼寫錯誤，導致解密失敗。

---
