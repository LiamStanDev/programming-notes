# 10-常見問題與最佳實踐

本章節彙整 Git 與 CI/CD 在大型專案、二進位檔案、效能優化、團隊協作等常見問題與最佳實踐，並提供進階技巧，協助工程師在實務與面試中展現專業能力。

---

## 10.1 大型專案最佳化（partial clone, shallow clone）

### 主題簡介
大型專案因歷史紀錄龐大，clone 速度慢、磁碟空間佔用高。Git 提供 shallow clone（淺層複製）與 partial clone（部分複製）來優化效能。

### 原理說明
- **Shallow Clone**：只下載最近 N 次 commit，不含完整歷史。
- **Partial Clone**：僅下載必要物件（如 commit、tree），延遲下載 blob（檔案內容），需 Git 2.19+。

### 常用命令與範例
#### Shallow Clone
```bash
git clone --depth 1 https://github.com/example/huge-repo.git
```
**輸出：**
```
Cloning into 'huge-repo'...
remote: Enumerating objects: 100, done.
remote: Counting objects: 100, done.
Receiving objects: 100% (100/100), 10.00 MiB | 5.00 MiB/s, done.
```

#### Partial Clone
```bash
git clone --filter=blob:none https://github.com/example/huge-repo.git
```
**輸出：**
```
Cloning into 'huge-repo'...
remote: Enumerating objects: 100, done.
remote: Counting objects: 100, done.
Receiving objects: 100% (100/100), 2.00 MiB | 2.00 MiB/s, done.
```

### 實際開發場景
- 大型 monorepo 初次 clone
- CI/CD pipeline 需快速拉取專案

### 最佳實踐與排查
- 使用 shallow/partial clone 時，避免進行 rebase、merge 等需完整歷史的操作。
- 若遇到 `error: object not found`，可嘗試 `git fetch --unshallow` 或完整 clone。

### 進階技巧
- 結合 sparse-checkout 只拉取特定目錄：
```bash
git sparse-checkout init --cone
git sparse-checkout set path/to/dir
```

---

## 10.2 二進位檔案管理（Git LFS）

### 主題簡介
Git 不適合管理大型二進位檔案（如圖片、模型），易造成 repo 膨脹。Git LFS（Large File Storage）專為此設計。

### 原理說明
Git LFS 以 pointer 取代二進位檔案，實際內容存於遠端 LFS server，clone/pull 時自動下載。

### 常用命令與範例
#### 安裝與初始化
```bash
git lfs install
git lfs track "*.psd"
git add .gitattributes
git add design.psd
git commit -m "Add design.psd via LFS"
```
**輸出：**
```
Tracking "*.psd"
```

#### clone/pull 自動下載 LFS 檔案
```bash
git clone https://github.com/example/large-assets.git
```

### 實際開發場景
- 遊戲開發、AI 模型、設計圖檔等需管理大檔案的專案

### 最佳實踐與排查
- 務必將 `.gitattributes` 納入版本控制
- 若 clone 時 LFS 檔案未下載，執行 `git lfs pull`
- 檢查 LFS 配額與權限，避免 push 失敗

### 進階技巧
- LFS 檔案自動化清理：定期移除未被引用的 LFS 物件
```bash
git lfs prune
```

---

## 10.3 高效能 CI/CD pipeline 設計

### 主題簡介
大型專案的 CI/CD pipeline 容易因步驟冗長、資源競爭而拖慢。高效設計可大幅提升開發效率。

### 原理說明
- **Cache**：重複步驟（如依賴安裝）利用快取
- **並行化**：可獨立的 job 同時執行
- **條件觸發**：僅在必要時執行特定 job

### 常用命令與範例
#### GitHub Actions 範例
```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - run: npm ci
      - run: npm test
```
**輸出：**
```
Cache restored from key: Linux-node-abcdef
added 500 packages in 10s
```

### 實際開發場景
- 單元測試、靜態分析、部署流程自動化
- 多平台（Linux/Windows/macOS）同時測試

### 最佳實踐與排查
- 避免 job 間不必要的依賴
- 使用 artifacts 傳遞產物
- 若 cache 未命中，檢查 key 設定

### 進階技巧
- 動態 matrix 生成，根據 PR 內容決定測試範圍
- 針對大型 monorepo，僅針對變動子專案執行 pipeline

---

## 10.4 常見錯誤與排查技巧

### 主題簡介
Git 與 CI/CD 常見錯誤多與權限、合併衝突、LFS、CI 配置有關，需系統性排查。

### 原理說明
- **權限問題**：SSH key、token 遺失或權限不足
- **合併衝突**：多分支同時修改同檔案
- **CI/CD 失敗**：環境變數、快取、依賴未正確設置

### 常用命令與範例
#### 權限排查
```bash
ssh -T git@github.com
# 或
git config --get remote.origin.url
```
#### 合併衝突解決
```bash
git status
git mergetool
```
#### CI/CD log 查詢
- GitHub Actions: 點選失敗 job，檢查 log
- GitLab Runner: `CI/CD > Pipelines > Failed Job > Trace`

### 實際開發場景
- 新人加入專案遇到權限問題
- 多人同時開發導致衝突
- CI/CD pipeline 無法通過

### 最佳實踐與排查
- 權限問題優先檢查 SSH key/token
- 衝突時先 `git pull --rebase`，減少 merge commit
- CI/CD 失敗時，逐步比對本地與 CI 環境差異

### 進階技巧
- 使用 pre-commit hook 自動檢查格式，減少 CI 失敗
- 以 `git bisect` 快速定位引入 bug 的 commit

---

## 10.5 團隊協作常見問題

### 主題簡介
團隊協作常見問題包含分支策略混亂、commit message 不一致、review 流程不嚴謹等。

### 原理說明
- **分支策略**：明確規範 feature、release、hotfix 分支
- **Commit Message**：採用 Conventional Commits，利於自動化
- **Code Review**：強制 PR/MR 流程，確保品質

### 常用命令與範例
#### 建立 feature 分支
```bash
git checkout -b feature/login
```
#### 標準 commit message
```
feat(login): 新增登入功能
fix(api): 修正 API 回傳錯誤
```
#### PR/MR 流程
- GitHub: Fork → Push → Pull Request → Review → Merge
- GitLab: Branch → Push → Merge Request → Review → Merge

### 實際開發場景
- 多人同時開發新功能
- 需追蹤每次修改原因

### 最佳實踐與排查
- 強制使用 PR/MR，避免直接 push main
- 設定 branch protection，防止未 review 合併
- 定期 code review，提升團隊技術水準

### 進階技巧
- 自動化檢查 commit message 格式（如 commitlint）
- PR/MR 模板自動生成檢查清單

---

## 10.6 進階技巧與最佳實踐

### 主題簡介
進階技巧可提升專案維護效率與團隊協作品質，適合資深工程師精進。

### 原理說明
- **Submodule/Subtree**：管理跨專案共用模組
- **Rebase vs Merge**：選擇合適的歷史管理策略
- **自動化工具**：pre-commit、commitlint、semantic-release

### 常用命令與範例
#### Submodule
```bash
git submodule add https://github.com/example/lib.git libs/lib
git submodule update --init --recursive
```
#### Rebase
```bash
git pull --rebase origin main
```
#### pre-commit
```bash
pre-commit install
```

### 實際開發場景
- 多專案共用底層函式庫
- 保持 commit 歷史乾淨
- 自動化版本發布

### 最佳實踐與排查
- Submodule 更新需同步 commit
- Rebase 前先 stash，避免衝突
- 自動化工具需納入 CI/CD pipeline

### 進階技巧
- 利用 Git hooks 實現自動化流程
- 結合 semantic-release 實現自動化版本號與 changelog
- 以 `git worktree` 管理多分支開發

---
