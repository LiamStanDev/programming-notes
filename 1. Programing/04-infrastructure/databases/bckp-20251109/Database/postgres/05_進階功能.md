# 05 進階功能

本章節涵蓋 PostgreSQL 進階功能，包括 Trigger、Function、自訂 Stored Procedure 及 Extension。內容包含理論說明、語法、範例與實務建議，適合作為快速查詢手冊。

---

## 1. Trigger（觸發器）

### 理論說明
Trigger 是一種自動執行的資料庫物件，當特定事件（如 INSERT、UPDATE、DELETE）發生於資料表時，自動執行預先定義的動作。常用於資料驗證、稽核、同步等場景。

### 建立與管理

#### 建立 Trigger Function
```sql
CREATE OR REPLACE FUNCTION audit_log()
RETURNS trigger AS $$
BEGIN
  INSERT INTO audit_table(table_name, action, changed_at)
  VALUES (TG_TABLE_NAME, TG_OP, NOW());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

#### 建立 Trigger
```sql
CREATE TRIGGER trg_audit
AFTER INSERT OR UPDATE OR DELETE ON target_table
FOR EACH ROW
EXECUTE FUNCTION audit_log();
```

#### 刪除 Trigger
```sql
DROP TRIGGER IF EXISTS trg_audit ON target_table;
```

### 應用場景
- 資料異動稽核（Audit Trail）
- 自動維護衍生欄位
- 複雜商業邏輯自動化

### 實務建議
- 避免在高頻率異動表上使用複雜 Trigger，可能影響效能。
- Trigger 內部邏輯應簡潔，複雜處理建議移至 Function。
- 定期檢查 Trigger 執行效能。

---

## 2. Function（自訂函式）

### 理論說明
Function 允許開發者封裝重複邏輯，支援多種語言（如 PL/pgSQL、SQL、PL/Python）。可回傳單一值或集合，提升程式碼重用性。

### 語法與範例

#### 建立簡單函式
```sql
CREATE OR REPLACE FUNCTION add_numbers(a integer, b integer)
RETURNS integer AS $$
BEGIN
  RETURN a + b;
END;
$$ LANGUAGE plpgsql;
```

#### 呼叫函式
```sql
SELECT add_numbers(10, 20); -- 回傳 30
```

#### 回傳資料表
```sql
CREATE OR REPLACE FUNCTION get_active_users()
RETURNS TABLE(id integer, name text) AS $$
BEGIN
  RETURN QUERY SELECT id, name FROM users WHERE active = true;
END;
$$ LANGUAGE plpgsql;
```

### 實務建議
- 函式應專注單一職責，便於維護與測試。
- 避免在函式內進行大量 DML 操作，減少鎖定與效能問題。
- 善用 IMMUTABLE/STABLE/VOLATILE 屬性，協助查詢最佳化。

---

## 3. Stored Procedure（儲存過程）

### 理論說明
Stored Procedure 與 Function 類似，但可執行複雜流程控制（如交易、例外處理），且可使用 CALL 語法執行。自 PostgreSQL 11 起支援。

### 差異與用途
- Procedure 可使用 `CALL` 執行，Function 則用 `SELECT`。
- Procedure 可內嵌交易控制（如 COMMIT/ROLLBACK）。
- 適合批次處理、資料遷移等複雜任務。

### 範例

#### 建立 Procedure
```sql
CREATE OR REPLACE PROCEDURE transfer_funds(from_id integer, to_id integer, amount numeric)
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE accounts SET balance = balance - amount WHERE id = from_id;
  UPDATE accounts SET balance = balance + amount WHERE id = to_id;
END;
$$;
```

#### 執行 Procedure
```sql
CALL transfer_funds(1, 2, 100.00);
```

### 實務建議
- Procedure 適合需多步驟、需交易控制的流程。
- 請妥善處理例外與錯誤，避免資料不一致。
- 建議將複雜商業邏輯封裝於 Procedure，簡化應用端程式。

---

## 4. Extension（擴充功能）

### 理論說明
Extension 提供 PostgreSQL 額外功能，如地理資訊（PostGIS）、加密（pgcrypto）等。可透過 `CREATE EXTENSION` 安裝。

### 常用 Extension 與應用

#### PostGIS（地理資訊系統）
- 安裝：
  ```sql
  CREATE EXTENSION IF NOT EXISTS postgis;
  ```
- 應用：
  ```sql
  SELECT ST_Distance(
    ST_GeomFromText('POINT(121.5 25.0)', 4326),
    ST_GeomFromText('POINT(121.6 25.1)', 4326)
  );
  ```

#### pgcrypto（加密/雜湊）
- 安裝：
  ```sql
  CREATE EXTENSION IF NOT EXISTS pgcrypto;
  ```
- 應用：
  ```sql
  SELECT crypt('my_password', gen_salt('bf'));
  SELECT encode(digest('abc', 'sha256'), 'hex');
  ```

### 實務建議
- 僅安裝必要 Extension，避免潛在安全與維護風險。
- 定期更新 Extension，確保相容性與安全性。
- 使用 Extension 前，詳閱官方文件與授權條款。

---

## 參考資料

- [PostgreSQL 官方文件](https://www.postgresql.org/docs/)
- [PostGIS 官方文件](https://postgis.net/documentation/)
- [pgcrypto 官方文件](https://www.postgresql.org/docs/current/pgcrypto.html)
