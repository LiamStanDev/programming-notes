# 07 維運與管理

本章節涵蓋 PostgreSQL 維運與管理的核心主題，包含備份還原、監控、權限管理、多租戶設計等，並提供理論說明、官方風格範例 SQL 及實務建議，適合作為快速查詢手冊。

---

## 1. 備份與還原

### 理論說明

- **pg_dump**：邏輯備份工具，適用於單一資料庫或特定資料表的備份與還原。
- **PITR（Point-In-Time Recovery）**：利用 Write-Ahead Logging (WAL) 支援時間點還原，適合大型資料庫與災難復原。

### 操作範例

#### 使用 `pg_dump` 備份與還原

```sql
-- 備份資料庫
$ pg_dump -U postgres -F c -b -v -f db.backup mydb

-- 還原資料庫
$ pg_restore -U postgres -d mydb_restored -v db.backup
```
1.  pg_dump 參數
	- `-U postgres`：指定使用者名稱（這裡是 postgres）
	- `-F c`：指定輸出格式為 custom（自訂格式，適合用 pg_restore 還原）
	- `-b`：包含 large objects（大物件，如 BLOB）
	- `-v`：verbose，顯示詳細執行過程
	- `-f db.backup`：輸出檔案名稱（這裡是 db.backup）
	- `mydb`：要備份的資料庫名稱
2. pg_restore 參數
	- `-U postgres`：指定使用者名稱
	- `-d mydb_restored`：指定還原目標資料庫
	- `-v`：verbose，顯示詳細執行過程
	- `db.backup`：要還原的備份檔案

#### PITR 操作流程（簡要）

1. 啟用 WAL 檔案歸檔：
   ```sql
   # postgresql.conf 設定
   archive_mode = on
   archive_command = 'cp %p /path/to/archive/%f'
   ```
2. 備份資料目錄（base backup）：
   ```bash
   $ pg_basebackup -U postgres -D /var/lib/postgresql/data_backup -F tar -z -P
   ```
3. 還原至指定時間點：
   - 停止 PostgreSQL，還原 base backup，放置 WAL 檔案，設定 `recovery.conf`（或 `postgresql.auto.conf`）。
   - 設定還原目標時間點：
     ```
     recovery_target_time = '2025-09-17 12:00:00'
     ```

### 實務建議

- 定期測試備份檔案可還原性。
- 生產環境建議結合 base backup 與 WAL 檔案。
- 備份與還原腳本自動化，並監控備份狀態。

---

## 2. 監控

### 理論說明

- 監控可即時掌握資料庫健康狀態，預防異常與效能瓶頸。
- 常見監控指標：連線數、查詢延遲、鎖定、WAL 活動、磁碟空間、複寫延遲等。

### 常用監控工具

- `pg_stat_activity`：查詢目前連線與執行狀態。
- `pg_stat_replication`：監控主從複寫狀態。
- `pg_stat_database`：資料庫層級統計。
- 外部工具：Prometheus + PostgreSQL Exporter、pgAdmin、Zabbix。

### 查詢語法範例

```sql
-- 查詢目前連線
SELECT pid, usename, application_name, state, query
FROM pg_stat_activity;

-- 查詢資料庫 I/O 活動
SELECT datname, blks_read, blks_hit
FROM pg_stat_database;

-- 查詢主從複寫延遲
SELECT application_name, state, write_lag, flush_lag, replay_lag
FROM pg_stat_replication;
```

### 實務建議

- 設置自動告警（如連線數過高、磁碟空間不足）。
- 定期檢查慢查詢與鎖定狀況。
- 結合外部監控平台，集中管理多個資料庫實例。

---

## 3. 權限管理

### 理論說明

- PostgreSQL 採用角色（Role）管理權限，角色可為使用者或群組。
- 透過 `GRANT`/`REVOKE` 控制資料庫、Schema、資料表等物件的存取權限。

### 範例 SQL

```sql
-- 建立角色
CREATE ROLE readonly LOGIN PASSWORD 'secure_pass';

-- 賦予查詢權限
GRANT CONNECT ON DATABASE mydb TO readonly;
GRANT USAGE ON SCHEMA public TO readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;

-- 撤銷權限
REVOKE INSERT ON ALL TABLES IN SCHEMA public FROM readonly;
```

### 最佳實踐

- 採用最小權限原則（Least Privilege）。
- 使用群組角色集中管理權限。
- 定期審查與調整權限，移除不必要的帳號與授權。

---

## 4. 多租戶設計

### 理論說明

- 多租戶（Multi-Tenancy）可用 Schema 隔離不同租戶資料，兼顧安全與維運彈性。
- 可搭配資源控管（如連線池、CPU/IO 限制）提升穩定性。

### Schema 隔離範例

```sql
-- 為每個租戶建立獨立 Schema
CREATE SCHEMA tenant_a;
CREATE SCHEMA tenant_b;

-- 指定 Schema 權限
GRANT USAGE ON SCHEMA tenant_a TO tenant_a_user;
GRANT USAGE ON SCHEMA tenant_b TO tenant_b_user;
```

### 資源控管範例

```sql
-- 設定連線數上限
ALTER ROLE tenant_a_user CONNECTION LIMIT 10;
```

### 實務案例與建議

- Schema 隔離適合中大型多租戶系統，便於資料備份、權限控管與維運。
- 小型系統可考慮單一 Schema 加租戶識別欄位，簡化結構。
- 定期監控各租戶資源使用，避免單一租戶影響整體效能。

---

## 5. 專業工程師實務建議

- 備份策略需結合全備、增量備份與異地備份，並定期演練還原流程。
- 權限管理建議自動化（如以 CI/CD 管理 SQL 權限腳本）。
- 監控與告警應納入日常維運流程，並持續優化監控指標。
- 多租戶設計需評估未來擴展性與維運成本，選擇最適合的隔離策略。

---

## 參考資料

- [PostgreSQL 官方文件](https://www.postgresql.org/docs/)
- [pgBackRest 備份工具](https://pgbackrest.org/)
- [Prometheus PostgreSQL Exporter](https://github.com/prometheus-community/postgres_exporter)