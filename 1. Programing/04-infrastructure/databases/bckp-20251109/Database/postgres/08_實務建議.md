# 08_實務建議

本章節彙整資深工程師於資料庫設計、開發與維運層面的最佳實踐、常見錯誤與反模式，以及真實案例分享，並提供官方文件風格的 SQL 範例與專業建議，協助讀者快速查詢與落實於實務。

---

## 1. 資深工程師常用的最佳實踐

### 1.1 設計層面

**理論說明**
良好的資料庫設計能確保資料一致性、易於擴充與維護，並提升查詢效能。

**實務建議**
- 採用正規化設計，避免資料冗餘。
- 針對查詢需求適度反正規化。
- 明確定義主鍵、外鍵與唯一約束。
- 命名規則一致，表達意圖明確。

**範例 SQL**
```sql
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE orders
ADD CONSTRAINT fk_user
FOREIGN KEY (user_id) REFERENCES users(user_id);
```

---

### 1.2 開發層面

**理論說明**
開發階段應重視 SQL 可讀性、維護性與效能，並避免硬編碼與重複邏輯。

**實務建議**
- 使用參數化查詢防止 SQL Injection。
- 善用視圖（View）與儲存程序（Stored Procedure）封裝複雜邏輯。
- 定期重構查詢語句，移除不必要的 JOIN 或子查詢。

**範例 SQL**
```sql
-- 參數化查詢（以 PostgreSQL 為例）
PREPARE get_user (int) AS
SELECT * FROM users WHERE user_id = $1;

-- 建立視圖
CREATE VIEW active_users AS
SELECT user_id, username FROM users WHERE is_active = TRUE;
```

---

### 1.3 維運層面

**理論說明**
維運需確保資料安全、效能穩定與異常可追蹤。

**實務建議**
- 定期備份資料庫並驗證還原流程。
- 監控慢查詢與資源使用狀況。
- 設置適當的權限與審計機制。

**範例 SQL**
```sql
-- 查詢慢查詢紀錄（以 PostgreSQL 為例）
SELECT * FROM pg_stat_activity WHERE state = 'active' AND query_start < NOW() - INTERVAL '5 minutes';

-- 建立備份（CLI 範例）
-- pg_dump -U dbuser -F c -b -v -f /backup/db.backup dbname
```

---

## 2. 常見錯誤與反模式

### 2.1 設計反模式

**理論說明**
設計不良會導致資料不一致、效能低落與維護困難。

**常見錯誤**
- 未設主鍵或主鍵選擇不當。
- 所有資料皆存於單一表（One Big Table）。
- 過度依賴自動增號欄位，忽略業務唯一性。

**範例 SQL**
```sql
-- 反例：未設主鍵
CREATE TABLE logs (
    event_time TIMESTAMP,
    message TEXT
);
```

---

### 2.2 查詢反模式

**理論說明**
不良查詢會造成效能瓶頸與資源浪費。

**常見錯誤**
- SELECT * 濫用，撈取不必要欄位。
- 未加索引導致全表掃描。
- 在 WHERE 子句對欄位進行函數運算，導致索引失效。

**範例 SQL**
```sql
-- 反例：未加索引且使用函數
SELECT * FROM users WHERE LOWER(email) = 'test@example.com';
```

---

### 2.3 維運反模式

**理論說明**
維運疏忽會導致資料遺失、權限外洩或無法追蹤異常。

**常見錯誤**
- 未定期備份或未驗證備份可用性。
- 權限設置過寬，所有人皆為 superuser。
- 忽略日誌與監控。

**範例 SQL**
```sql
-- 反例：所有人皆為 superuser
GRANT ALL PRIVILEGES ON DATABASE dbname TO public;
```

---

## 3. 實務案例分享

### 案例一：查詢效能瓶頸

**情境**
某大型電商平台發現訂單查詢速度緩慢，影響用戶體驗。

**解決方案**
- 針對查詢條件加上複合索引。
- 移除不必要的 SELECT *，僅撈取所需欄位。
- 使用 EXPLAIN 分析查詢計劃。

**學習重點**
- 針對實際查詢模式設計索引。
- 定期檢視查詢效能並優化。

**範例 SQL**
```sql
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date);

EXPLAIN ANALYZE
SELECT order_id, order_date FROM orders WHERE user_id = 123 AND order_date > '2024-01-01';
```

---

### 案例二：資料一致性異常

**情境**
跨系統同步時，發現資料重複或遺失。

**解決方案**
- 設定唯一約束與外鍵。
- 使用交易（Transaction）確保操作原子性。

**學習重點**
- 利用資料庫約束提升一致性。
- 交易機制可防止部分寫入。

**範例 SQL**
```sql
ALTER TABLE users ADD CONSTRAINT unique_email UNIQUE (email);

BEGIN;
INSERT INTO orders (user_id, amount) VALUES (1, 1000);
UPDATE users SET balance = balance - 1000 WHERE user_id = 1;
COMMIT;
```

---

### 案例三：備份與還原失敗

**情境**
因硬碟損壞需還原資料，卻發現備份檔案損毀。

**解決方案**
- 建立自動化備份排程。
- 定期驗證備份檔案可用性。

**學習重點**
- 備份不僅要做，更要驗證。
- 自動化與監控可降低人為疏失。

**範例 SQL**
```sql
-- 建立自動化備份（Linux cron 範例）
# 0 2 * * * pg_dump -U dbuser -F c -b -v -f /backup/db_$(date +\%F).backup dbname

-- 驗證備份
pg_restore -l /backup/db_2024-09-17.backup
```

---

## 4. 專業工程師的實務建議

- 設計階段即考慮未來擴充性與維護性。
- 查詢語句應簡潔明確，避免過度複雜。
- 定期檢視與優化資料庫結構與查詢效能。
- 建立完善的備份、監控與權限管理機制。
- 持續學習官方文件與社群最佳實踐。

---

> 本章內容涵蓋設計、開發、維運三大層面之最佳實踐、常見錯誤、實務案例與專業建議，並輔以官方文件風格 SQL 範例，適合作為工程師快速查詢與落實實務的參考手冊。