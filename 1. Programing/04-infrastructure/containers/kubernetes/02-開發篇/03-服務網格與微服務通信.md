# 03-æœå‹™ç¶²æ ¼èˆ‡å¾®æœå‹™é€šä¿¡

> Service Mesh åŸºç¤ã€æœå‹™é–“é€šä¿¡æ¨¡å¼èˆ‡æµé‡ç®¡ç†

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- ç†è§£å¾®æœå‹™é€šä¿¡çš„æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ
- æŒæ¡ Kubernetes åŸç”Ÿæœå‹™ç™¼ç¾æ©Ÿåˆ¶
- äº†è§£ Service Mesh çš„æ ¸å¿ƒæ¦‚å¿µ
- å­¸ç¿’ Istio åŸºç¤èˆ‡å¯¦æˆ°æ‡‰ç”¨
- å¯¦ç¾ç°åº¦ç™¼å¸ƒèˆ‡æµé‡ç®¡ç†

---

## 1. å¾®æœå‹™é€šä¿¡æŒ‘æˆ°

### 1.1 å‚³çµ±å•é¡Œ

```mermaid
graph TB
    subgraph "å¾®æœå‹™æ¶æ§‹æŒ‘æˆ°"
        A[æœå‹™ç™¼ç¾<br/>å¦‚ä½•æ‰¾åˆ°æœå‹™?]
        B[è² è¼‰å‡è¡¡<br/>å¦‚ä½•åˆ†é…æµé‡?]
        C[æ•…éšœè™•ç†<br/>å¦‚ä½•è™•ç†å¤±æ•—?]
        D[å®‰å…¨é€šä¿¡<br/>å¦‚ä½•åŠ å¯†?]
        E[å¯è§€æ¸¬æ€§<br/>å¦‚ä½•è¿½è¹¤?]
        F[æµé‡æ§åˆ¶<br/>å¦‚ä½•ç°åº¦?]
    end
    
    style A fill:#f96
    style B fill:#f96
    style C fill:#f96
    style D fill:#f96
    style E fill:#f96
    style F fill:#f96
```

### 1.2 è§£æ±ºæ–¹æ¡ˆæ¼”é€²

```mermaid
graph LR
    A[ç›´æ¥èª¿ç”¨<br/>ç¡¬ç·¨ç¢¼IP] --> B[å®¢æˆ¶ç«¯åº«<br/>Ribbon/Feign]
    B --> C[Sidecarä»£ç†<br/>Envoy/Linkerd]
    C --> D[Service Mesh<br/>Istio/Linkerd2]
    
    style A fill:#f96
    style D fill:#9f9
```

**æ¼”é€²å°æ¯”ï¼š**

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|-----|------|------|---------|
| **ç¡¬ç·¨ç¢¼** | ç°¡å–®ç›´æ¥ | ç¶­è­·å›°é›£ã€ä¸éˆæ´» | å°å‹å–®é«” |
| **å®¢æˆ¶ç«¯åº«** | åŠŸèƒ½è±å¯Œ | èªè¨€ç¶å®šã€ä¾µå…¥æ€§å¼· | å–®èªè¨€å¾®æœå‹™ |
| **Sidecar** | èªè¨€ç„¡é—œ | è³‡æºé–‹éŠ· | å¤šèªè¨€å¾®æœå‹™ |
| **Service Mesh** | çµ±ä¸€ç®¡ç† | è¤‡é›œåº¦é«˜ | å¤§è¦æ¨¡å¾®æœå‹™ |

---

## 2. Kubernetes åŸç”Ÿæœå‹™ç™¼ç¾

### 2.1 DNS æœå‹™ç™¼ç¾

```mermaid
graph TB
    subgraph "K8s DNS è§£æ"
        A[æ‡‰ç”¨ Pod] -->|æŸ¥è©¢| B[CoreDNS]
        B -->|è¿”å›| C[Service ClusterIP]
        C -->|è² è¼‰å‡è¡¡| D1[Pod 1]
        C -->|è² è¼‰å‡è¡¡| D2[Pod 2]
        C -->|è² è¼‰å‡è¡¡| D3[Pod 3]
    end
    
    style B fill:#9cf
    style C fill:#fc9
```

**DNS å‘½åè¦å‰‡ï¼š**
```
<service-name>.<namespace>.svc.cluster.local
```

**ç¤ºä¾‹ï¼š**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: production
spec:
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
```

**æ‡‰ç”¨å…§è¨ªå•ï¼š**
```python
import requests

response = requests.get('http://backend.production.svc.cluster.local')

response = requests.get('http://backend.production')

response = requests.get('http://backend')
```

### 2.2 ç’°å¢ƒè®Šé‡ç™¼ç¾

**Kubernetes è‡ªå‹•æ³¨å…¥ï¼š**
```bash
BACKEND_SERVICE_HOST=10.96.100.50
BACKEND_SERVICE_PORT=80
BACKEND_PORT=tcp://10.96.100.50:80
BACKEND_PORT_80_TCP=tcp://10.96.100.50:80
BACKEND_PORT_80_TCP_PROTO=tcp
BACKEND_PORT_80_TCP_PORT=80
BACKEND_PORT_80_TCP_ADDR=10.96.100.50
```

**æ‡‰ç”¨ä½¿ç”¨ï¼š**
```python
import os

backend_host = os.getenv('BACKEND_SERVICE_HOST')
backend_port = os.getenv('BACKEND_SERVICE_PORT')

url = f'http://{backend_host}:{backend_port}/api/users'
```

### 2.3 Headless Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  clusterIP: None
  selector:
    app: mysql
  ports:
  - port: 3306
```

**ç”¨é€”ï¼š**
- StatefulSet ç©©å®šç¶²çµ¡æ¨™è­˜
- å®¢æˆ¶ç«¯è‡ªè¡Œè² è¼‰å‡è¡¡
- æœå‹™ç™¼ç¾è¿”å›æ‰€æœ‰ Pod IP

**DNS è§£æï¼š**
```
mysql-0.mysql.default.svc.cluster.local -> Pod IP
mysql-1.mysql.default.svc.cluster.local -> Pod IP
mysql-2.mysql.default.svc.cluster.local -> Pod IP
```

---

## 3. Service Mesh æ ¸å¿ƒæ¦‚å¿µ

### 3.1 æ¶æ§‹æ¦‚è¦½

```mermaid
graph TB
    subgraph "Control Plane æ§åˆ¶å¹³é¢"
        CP1[Istiod<br/>é…ç½®ç®¡ç†]
        CP2[Pilot<br/>æµé‡ç®¡ç†]
        CP3[Citadel<br/>è­‰æ›¸ç®¡ç†]
        CP4[Galley<br/>é…ç½®é©—è­‰]
    end
    
    subgraph "Data Plane æ•¸æ“šå¹³é¢"
        subgraph "Pod 1"
            A1[App Container]
            A2[Envoy Sidecar]
        end
        
        subgraph "Pod 2"
            B1[App Container]
            B2[Envoy Sidecar]
        end
        
        subgraph "Pod 3"
            C1[App Container]
            C2[Envoy Sidecar]
        end
    end
    
    CP1 -.æ¨é€é…ç½®.-> A2
    CP1 -.æ¨é€é…ç½®.-> B2
    CP1 -.æ¨é€é…ç½®.-> C2
    
    A1 --> A2
    A2 -.mTLS.-> B2
    B2 --> B1
    B1 --> B2
    B2 -.mTLS.-> C2
    C2 --> C1
    
    style CP1 fill:#9cf
    style A2 fill:#fc9
    style B2 fill:#fc9
    style C2 fill:#fc9
```

### 3.2 æ ¸å¿ƒåŠŸèƒ½

```mermaid
graph TB
    SM[Service Mesh]
    
    SM --> TM[æµé‡ç®¡ç†]
    SM --> SEC[å®‰å…¨]
    SM --> OBS[å¯è§€æ¸¬æ€§]
    SM --> POL[ç­–ç•¥æ§åˆ¶]
    
    TM --> TM1[æ™ºèƒ½è·¯ç”±]
    TM --> TM2[è² è¼‰å‡è¡¡]
    TM --> TM3[æ•…éšœæ³¨å…¥]
    TM --> TM4[è¶…æ™‚é‡è©¦]
    
    SEC --> SEC1[mTLS åŠ å¯†]
    SEC --> SEC2[èº«ä»½é©—è­‰]
    SEC --> SEC3[æˆæ¬Šç­–ç•¥]
    
    OBS --> OBS1[åˆ†ä½ˆå¼è¿½è¹¤]
    OBS --> OBS2[æŒ‡æ¨™æ”¶é›†]
    OBS --> OBS3[æ—¥èªŒèšåˆ]
    
    style SM fill:#9cf
```

---

## 4. Istio å¿«é€Ÿå…¥é–€

### 4.1 å®‰è£ Istio

```bash
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.20.0
export PATH=$PWD/bin:$PATH

istioctl install --set profile=demo -y

kubectl label namespace default istio-injection=enabled

kubectl get pods -n istio-system
```

**é æœŸè¼¸å‡ºï¼š**
```
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-xxx                1/1     Running   0          2m
istiod-xxx                              1/1     Running   0          2m
```

### 4.2 è‡ªå‹•æ³¨å…¥ Sidecar

**å•Ÿç”¨ namespace è‡ªå‹•æ³¨å…¥ï¼š**
```bash
kubectl label namespace default istio-injection=enabled

kubectl get namespace -L istio-injection
```

**éƒ¨ç½²æ‡‰ç”¨ï¼š**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productpage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productpage
  template:
    metadata:
      labels:
        app: productpage
        version: v1
    spec:
      containers:
      - name: productpage
        image: docker.io/istio/examples-bookinfo-productpage-v1:1.18.0
        ports:
        - containerPort: 9080
```

**é©—è­‰ Sidecar æ³¨å…¥ï¼š**
```bash
kubectl apply -f productpage.yaml

kubectl get pods

kubectl describe pod productpage-xxx | grep -A 5 "Containers:"
```

**é æœŸçœ‹åˆ°å…©å€‹å®¹å™¨ï¼š**
- `productpage`ï¼ˆæ‡‰ç”¨å®¹å™¨ï¼‰
- `istio-proxy`ï¼ˆEnvoy sidecarï¼‰

### 4.3 Istio æµé‡ç®¡ç†ç‰©ä»¶

```mermaid
graph TB
    Gateway[Gateway<br/>å…¥å£ç¶²é—œ] --> VS[VirtualService<br/>è·¯ç”±è¦å‰‡]
    VS --> DR[DestinationRule<br/>ç›®æ¨™è¦å‰‡]
    DR --> Subset1[Subset: v1]
    DR --> Subset2[Subset: v2]
    
    Subset1 --> Pod1[Pod v1]
    Subset2 --> Pod2[Pod v2]
    
    style Gateway fill:#9cf
    style VS fill:#fc9
    style DR fill:#f9c
```

---

## 5. æµé‡ç®¡ç†å¯¦æˆ°

### 5.1 åŸºç¤è·¯ç”±

**VirtualService å®šç¾©ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
```

**DestinationRule å®šç¾©ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
```

### 5.2 ç°åº¦ç™¼å¸ƒï¼ˆé‡‘çµ²é›€éƒ¨ç½²ï¼‰

```mermaid
sequenceDiagram
    participant User
    participant Gateway
    participant VS as VirtualService
    participant V1 as Reviews v1 (90%)
    participant V2 as Reviews v2 (10%)
    
    User->>Gateway: è¨ªå•æ‡‰ç”¨
    Gateway->>VS: è·¯ç”±è«‹æ±‚
    
    VS->>V1: 90% æµé‡
    VS->>V2: 10% æµé‡
    
    V1-->>User: è¿”å›éŸ¿æ‡‰
    V2-->>User: è¿”å›éŸ¿æ‡‰
```

**é…ç½®ç¤ºä¾‹ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-canary
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: beta-tester
    route:
    - destination:
        host: reviews
        subset: v2
      weight: 100
  
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90
    - destination:
        host: reviews
        subset: v2
      weight: 10
```

**é€æ­¥å¢åŠ æµé‡ï¼š**
```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-canary
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v2
      weight: 50
EOF

kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-canary
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2
      weight: 100
EOF
```

### 5.3 A/B æ¸¬è©¦

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-ab-test
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        user-agent:
          regex: ".*Mobile.*"
    route:
    - destination:
        host: reviews
        subset: mobile
  
  - match:
    - headers:
        cookie:
          regex: "^(.*?;)?(version=v2)(;.*)?$"
    route:
    - destination:
        host: reviews
        subset: v2
  
  - route:
    - destination:
        host: reviews
        subset: v1
```

### 5.4 æ•…éšœæ³¨å…¥æ¸¬è©¦

**å»¶é²æ³¨å…¥ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings-delay
spec:
  hosts:
  - ratings
  http:
  - fault:
      delay:
        percentage:
          value: 10.0
        fixedDelay: 5s
    route:
    - destination:
        host: ratings
        subset: v1
```

**éŒ¯èª¤æ³¨å…¥ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings-abort
spec:
  hosts:
  - ratings
  http:
  - fault:
      abort:
        percentage:
          value: 10.0
        httpStatus: 500
    route:
    - destination:
        host: ratings
        subset: v1
```

---

## 6. å½ˆæ€§èˆ‡å¯é æ€§

### 6.1 è¶…æ™‚èˆ‡é‡è©¦

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-timeout
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
    
    timeout: 3s
    
    retries:
      attempts: 3
      perTryTimeout: 1s
      retryOn: 5xx,reset,connect-failure,refused-stream
```

### 6.2 ç†”æ–·å™¨ï¼ˆCircuit Breakerï¼‰

```mermaid
stateDiagram-v2
    [*] --> Closed: æ­£å¸¸ç‹€æ…‹
    Closed --> Open: éŒ¯èª¤ç‡è¶…éé–¾å€¼
    Open --> HalfOpen: å†·å»æ™‚é–“å¾Œ
    HalfOpen --> Closed: è«‹æ±‚æˆåŠŸ
    HalfOpen --> Open: è«‹æ±‚å¤±æ•—
    
    note right of Closed
        å…è¨±æ‰€æœ‰è«‹æ±‚é€šé
    end note
    
    note right of Open
        å¿«é€Ÿå¤±æ•—ï¼Œä¸ç™¼é€è«‹æ±‚
    end note
    
    note right of HalfOpen
        å…è¨±å°‘é‡è«‹æ±‚æ¸¬è©¦
    end note
```

**é…ç½®ç¤ºä¾‹ï¼š**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews-circuit-breaker
spec:
  host: reviews
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40
```

**åƒæ•¸èªªæ˜ï¼š**
- `consecutiveErrors: 5` - é€£çºŒ 5 æ¬¡éŒ¯èª¤è§¸ç™¼ç†”æ–·
- `interval: 30s` - æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡
- `baseEjectionTime: 30s` - ç†”æ–·æŒçºŒ 30 ç§’
- `maxEjectionPercent: 50` - æœ€å¤šç†”æ–· 50% å¯¦ä¾‹

### 6.3 è² è¼‰å‡è¡¡ç­–ç•¥

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews-lb
spec:
  host: reviews
  trafficPolicy:
    loadBalancer:
      simple: LEAST_REQUEST
    
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpHeaderName: "x-user-id"
```

**è² è¼‰å‡è¡¡ç®—æ³•ï¼š**
- `ROUND_ROBIN` - è¼ªè©¢ï¼ˆé»˜èªï¼‰
- `LEAST_REQUEST` - æœ€å°‘è«‹æ±‚
- `RANDOM` - éš¨æ©Ÿ
- `PASSTHROUGH` - ç›´é€£
- `consistentHash` - ä¸€è‡´æ€§å“ˆå¸Œï¼ˆæœƒè©±ä¿æŒï¼‰

---

## 7. å®‰å…¨é€šä¿¡

### 7.1 mTLS é›™å‘èªè­‰

```mermaid
sequenceDiagram
    participant A as Service A<br/>Envoy
    participant B as Service B<br/>Envoy
    
    A->>B: ClientHello (TLS)
    B->>A: ServerHello + Certificate
    A->>B: Certificate + Verify
    B->>A: Verify Success
    
    Note over A,B: å»ºç«‹åŠ å¯†é€šé“
    
    A->>B: Encrypted Request
    B->>A: Encrypted Response
```

**å•Ÿç”¨ mTLSï¼š**
```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT
```

**æ¨¡å¼èªªæ˜ï¼š**
- `STRICT` - å¼·åˆ¶ mTLS
- `PERMISSIVE` - å…è¨±æ˜æ–‡æˆ– mTLS
- `DISABLE` - ç¦ç”¨ mTLS

### 7.2 æˆæ¬Šç­–ç•¥

```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: reviews-viewer
  namespace: default
spec:
  selector:
    matchLabels:
      app: reviews
  
  action: ALLOW
  
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/productpage"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/reviews/*"]
```

**æ‹’çµ•ç­–ç•¥ï¼š**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: default
spec:
  action: DENY
  rules:
  - from:
    - source:
        notNamespaces: ["default"]
```

---

## 8. å¯è§€æ¸¬æ€§

### 8.1 åˆ†ä½ˆå¼è¿½è¹¤

```mermaid
graph LR
    A[frontend] -->|Span 1| B[productpage]
    B -->|Span 2| C[reviews]
    B -->|Span 3| D[details]
    C -->|Span 4| E[ratings]
    
    F[Jaeger] -.æ”¶é›†.-> A
    F -.æ”¶é›†.-> B
    F -.æ”¶é›†.-> C
    F -.æ”¶é›†.-> D
    F -.æ”¶é›†.-> E
    
    style F fill:#9cf
```

**æ‡‰ç”¨éœ€è¦å‚³é Headersï¼š**
```python
import requests

TRACE_HEADERS = [
    'x-request-id',
    'x-b3-traceid',
    'x-b3-spanid',
    'x-b3-parentspanid',
    'x-b3-sampled',
    'x-b3-flags',
    'x-ot-span-context'
]

def forward_request(url, incoming_headers):
    headers = {}
    for header in TRACE_HEADERS:
        if header in incoming_headers:
            headers[header] = incoming_headers[header]
    
    return requests.get(url, headers=headers)
```

### 8.2 Prometheus æŒ‡æ¨™

**Istio è‡ªå‹•ç”ŸæˆæŒ‡æ¨™ï¼š**
```yaml
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: metrics
spec:
  metrics:
  - providers:
    - name: prometheus
    
    dimensions:
      source_app:
        value: source.workload.name
      destination_app:
        value: destination.workload.name
```

**å¸¸ç”¨æŒ‡æ¨™æŸ¥è©¢ï¼š**
```promql
# è«‹æ±‚é€Ÿç‡
rate(istio_requests_total[5m])

# æˆåŠŸç‡
sum(rate(istio_requests_total{response_code!~"5.*"}[5m])) 
/ 
sum(rate(istio_requests_total[5m]))

# P99 å»¶é²
histogram_quantile(0.99, 
  sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le)
)
```

---

## 9. å®Œæ•´ç¤ºä¾‹ï¼šBookinfo æ‡‰ç”¨

### 9.1 æ¶æ§‹

```mermaid
graph TB
    User[ç”¨æˆ¶] --> IG[Istio Gateway]
    IG --> PP[productpage]
    
    PP --> D[details<br/>v1]
    PP --> R[reviews]
    
    R --> R1[reviews v1<br/>ç„¡è©•åˆ†]
    R --> R2[reviews v2<br/>é»‘æ˜Ÿè©•åˆ†]
    R --> R3[reviews v3<br/>ç´…æ˜Ÿè©•åˆ†]
    
    R2 --> RT[ratings<br/>v1]
    R3 --> RT
    
    style IG fill:#9cf
    style PP fill:#fc9
```

### 9.2 éƒ¨ç½²æ‡‰ç”¨

```bash
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml

kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml

export GATEWAY_URL=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

curl http://$GATEWAY_URL/productpage
```

### 9.3 æµé‡ç®¡ç†ç¤ºä¾‹

**1. å…¨éƒ¨æµé‡åˆ° v1ï¼š**
```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
EOF
```

**2. åŸºæ–¼ç”¨æˆ¶çš„è·¯ç”±ï¼š**
```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
EOF
```

**3. é‡‘çµ²é›€ç™¼å¸ƒï¼š**
```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 80
    - destination:
        host: reviews
        subset: v3
      weight: 20
EOF
```

---

## 10. æœ€ä½³å¯¦è¸

### 10.1 ä½•æ™‚ä½¿ç”¨ Service Mesh

**æ¨è–¦å ´æ™¯ï¼š**
- âœ… å¤šèªè¨€å¾®æœå‹™æ¶æ§‹
- âœ… éœ€è¦ç´°ç²’åº¦æµé‡æ§åˆ¶
- âœ… éœ€è¦ mTLS åŠ å¯†
- âœ… éœ€è¦åˆ†ä½ˆå¼è¿½è¹¤
- âœ… æœå‹™æ•¸é‡ > 20

**ä¸æ¨è–¦å ´æ™¯ï¼š**
- âŒ å–®é«”æ‡‰ç”¨æˆ–å°‘é‡æœå‹™
- âŒ è³‡æºå—é™ç’°å¢ƒ
- âŒ åœ˜éšŠç¼ºä¹é‹ç¶­èƒ½åŠ›
- âŒ ç°¡å–®çš„æœå‹™é€šä¿¡éœ€æ±‚

### 10.2 æ€§èƒ½å„ªåŒ–

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews-optimization
spec:
  host: reviews
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 30ms
      http:
        http1MaxPendingRequests: 1024
        http2MaxRequests: 1024
        maxRequestsPerConnection: 10
        idleTimeout: 60s
    
    loadBalancer:
      simple: LEAST_REQUEST
      localityLbSetting:
        enabled: true
        distribute:
        - from: us-east-1a
          to:
            "us-east-1a": 80
            "us-east-1b": 20
```

### 10.3 æ•…éšœæ’æŸ¥

```bash
istioctl analyze

istioctl proxy-status

istioctl proxy-config cluster <pod-name>

istioctl proxy-config route <pod-name>

istioctl proxy-config endpoint <pod-name>

kubectl logs <pod-name> -c istio-proxy

kubectl exec -it <pod-name> -c istio-proxy -- curl localhost:15000/stats
```

---

## 11. å°çµ

æœ¬ç« ä»‹ç´¹äº†å¾®æœå‹™é€šä¿¡èˆ‡ Service Mesh çš„æ ¸å¿ƒæ¦‚å¿µï¼š

**Kubernetes åŸç”Ÿèƒ½åŠ›ï¼š**
- âœ… DNS æœå‹™ç™¼ç¾ï¼ˆæ¨è–¦ï¼‰
- âœ… ç’°å¢ƒè®Šé‡ç™¼ç¾
- âœ… Headless Serviceï¼ˆStatefulSetï¼‰

**Service Meshï¼ˆIstioï¼‰ï¼š**
- âœ… æµé‡ç®¡ç†ï¼ˆç°åº¦ç™¼å¸ƒã€A/B æ¸¬è©¦ï¼‰
- âœ… å½ˆæ€§è¨­è¨ˆï¼ˆè¶…æ™‚ã€é‡è©¦ã€ç†”æ–·ï¼‰
- âœ… å®‰å…¨é€šä¿¡ï¼ˆmTLSã€æˆæ¬Šç­–ç•¥ï¼‰
- âœ… å¯è§€æ¸¬æ€§ï¼ˆè¿½è¹¤ã€æŒ‡æ¨™ã€æ—¥èªŒï¼‰

**é—œéµè¦é»ï¼š**
- ğŸ¯ å°è¦æ¨¡æœå‹™ä½¿ç”¨ K8s åŸç”Ÿèƒ½åŠ›å³å¯
- ğŸ¯ å¤§è¦æ¨¡å¾®æœå‹™æ¶æ§‹è€ƒæ…® Service Mesh
- ğŸ¯ ç°åº¦ç™¼å¸ƒæ˜¯ç”Ÿç”¢ç’°å¢ƒçš„æ¨™æº–å¯¦è¸
- ğŸ¯ mTLS æä¾›é›¶ä¿¡ä»»ç¶²çµ¡å®‰å…¨
- ğŸ¯ åˆ†ä½ˆå¼è¿½è¹¤éœ€è¦æ‡‰ç”¨å‚³é Headers

ä¸‹ä¸€ç« å°‡æ·±å…¥å­¸ç¿’é«˜å¯ç”¨èˆ‡å½ˆæ€§è¨­è¨ˆï¼ŒåŒ…æ‹¬è‡ªå‹•æ“´ç¸®å®¹ã€å¥åº·æª¢æŸ¥ç­‰ç”Ÿç”¢ç’°å¢ƒå¿…å‚™æŠ€èƒ½ã€‚
