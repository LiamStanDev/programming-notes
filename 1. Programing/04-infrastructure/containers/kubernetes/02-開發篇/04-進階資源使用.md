# 04-é€²éšè³‡æºä½¿ç”¨

> æŒæ¡ Kubernetes é€²éšè³‡æºé…ç½®èˆ‡ç®¡ç†

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- æŒæ¡ PriorityClass å„ªå…ˆç´šèª¿åº¦
- å­¸æœƒ RBAC æ¬Šé™ç®¡ç†
- ç†è§£ ServiceAccount èº«ä»½èªè­‰
- æŒæ¡ Custom Resource Definition (CRD)
- äº†è§£ Admission Webhook æ©Ÿåˆ¶

---

## 1. PriorityClassï¼ˆå„ªå…ˆç´šé¡åˆ¥ï¼‰

### 1.1 å„ªå…ˆç´šèª¿åº¦åŸç†

```mermaid
graph TB
    subgraph "è³‡æºä¸è¶³å ´æ™¯"
        HP[é«˜å„ªå…ˆç´š Pod<br/>PriorityClass: high]
        LP[ä½å„ªå…ˆç´š Pod<br/>PriorityClass: low]
        
        HP -->|é©…é€| LP
        HP --> S[èª¿åº¦æˆåŠŸ]
        LP -.è¢«é©…é€.-> F[Pending]
    end
    
    style HP fill:#9f9
    style LP fill:#f96
```

### 1.2 å‰µå»º PriorityClass

```yaml
# é«˜å„ªå…ˆç´š
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "ç”¨æ–¼é—œéµæ¥­å‹™æœå‹™"

---
# ä¸­ç­‰å„ªå…ˆç´š
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: medium-priority
value: 100000
globalDefault: true
description: "é»˜èªå„ªå…ˆç´š"

---
# ä½å„ªå…ˆç´š
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: low-priority
value: 1000
globalDefault: false
description: "ç”¨æ–¼æ‰¹è™•ç†ä»»å‹™"
```

### 1.3 ä½¿ç”¨ PriorityClass

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: critical-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: critical-app
  template:
    metadata:
      labels:
        app: critical-app
    spec:
      priorityClassName: high-priority
      containers:
      - name: app
        image: myapp:v1.0
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
```

---

## 2. ServiceAccount èˆ‡ RBAC

### 2.1 RBAC æ¶æ§‹

```mermaid
graph TB
    SA[ServiceAccount<br/>webapp-sa]
    RB[RoleBinding]
    R[Role<br/>pod-reader]
    
    Pod[Pod] --> SA
    SA --> RB
    RB --> R
    R --> API[API Server]
    
    style SA fill:#9cf
    style R fill:#fc9
```

### 2.2 å‰µå»º ServiceAccount

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: webapp-sa
  namespace: production
```

### 2.3 å‰µå»º Role

```yaml
# Roleï¼ˆå‘½åç©ºé–“ç´šåˆ¥ï¼‰
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: production
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]

- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
# ClusterRoleï¼ˆé›†ç¾¤ç´šåˆ¥ï¼‰
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-reader
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "watch", "list"]
```

### 2.4 å‰µå»º RoleBinding

```yaml
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: production
subjects:
- kind: ServiceAccount
  name: webapp-sa
  namespace: production
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: read-secrets-global
subjects:
- kind: ServiceAccount
  name: webapp-sa
  namespace: production
roleRef:
  kind: ClusterRole
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
```

### 2.5 Pod ä½¿ç”¨ ServiceAccount

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
  namespace: production
spec:
  serviceAccountName: webapp-sa
  containers:
  - name: app
    image: myapp:v1.0
```

---

## 3. Custom Resource Definition (CRD)

### 3.1 å‰µå»º CRD

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: webapps.example.com
spec:
  group: example.com
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              replicas:
                type: integer
                minimum: 1
                maximum: 10
              image:
                type: string
              port:
                type: integer
          status:
            type: object
            properties:
              availableReplicas:
                type: integer
  scope: Namespaced
  names:
    plural: webapps
    singular: webapp
    kind: WebApp
    shortNames:
    - wa
```

### 3.2 ä½¿ç”¨ Custom Resource

```yaml
apiVersion: example.com/v1
kind: WebApp
metadata:
  name: my-webapp
spec:
  replicas: 3
  image: myapp:v1.0
  port: 8080
```

---

## 4. æœ€ä½³å¯¦è¸

### 4.1 å®‰å…¨é…ç½®

```yaml
# âœ… æœ€å°æ¬Šé™åŸå‰‡
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: minimal-role
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get"]
  resourceNames: ["my-config"]    # é™åˆ¶ç‰¹å®šè³‡æº
```

### 4.2 å„ªå…ˆç´šè¨­ç½®

```yaml
# âœ… é—œéµæœå‹™ä½¿ç”¨é«˜å„ªå…ˆç´š
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
spec:
  template:
    spec:
      priorityClassName: high-priority
      
      # é…åˆ PDB ä¿è­·
      # åƒè€ƒ 01-åŸºç¤ç¯‡/07-é…ç½®è³‡æºè©³è§£.md PDB ç« ç¯€
```

---

## 5. å°çµ

æœ¬ç« ä»‹ç´¹äº† Kubernetes é€²éšè³‡æºï¼š

- âœ… **PriorityClass**ï¼šå„ªå…ˆç´šèª¿åº¦
- âœ… **ServiceAccount & RBAC**ï¼šæ¬Šé™ç®¡ç†
- âœ… **CRD**ï¼šè‡ªå®šç¾©è³‡æº

ä¸‹ä¸€ç« å°‡æ·±å…¥å­¸ç¿’ Helm åŒ…ç®¡ç†ã€‚

---

## åƒè€ƒè³‡æ–™ (References)

1. [Kubernetes å®˜æ–¹æ–‡æª” - Pod Priority](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/)
2. [Kubernetes å®˜æ–¹æ–‡æª” - RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)
3. [Kubernetes å®˜æ–¹æ–‡æª” - CRD](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/)
