# 05-ç¶²è·¯è³‡æºè©³è§£

> æ·±å…¥æŒæ¡ Kubernetes ç¶²è·¯è³‡æºçš„å®Œæ•´é…ç½®èˆ‡ä½¿ç”¨

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- æ·±å…¥ç†è§£ Service çš„å››ç¨®é¡å‹èˆ‡ä½¿ç”¨å ´æ™¯
- æŒæ¡ Ingress é…ç½®èˆ‡ TLS è­‰æ›¸ç®¡ç†
- å­¸æœƒä½¿ç”¨ NetworkPolicy å¯¦ç¾ç¶²è·¯éš”é›¢
- ç†è§£ Endpoints èˆ‡ EndpointSlices å·¥ä½œåŸç†
- æŒæ¡æœå‹™ç™¼ç¾æ©Ÿåˆ¶ï¼ˆDNSã€ç’°å¢ƒè®Šé‡ï¼‰

---

## 1. Service æ·±åº¦è§£æ

### 1.1 Service æ˜¯ä»€éº¼

Service æä¾›ç©©å®šçš„ç¶²çµ¡è¨ªå•å…¥å£ï¼Œå°‡æµé‡è² è¼‰å‡è¡¡åˆ°ä¸€çµ„ Podã€‚

```mermaid
graph TB
    subgraph "Clients"
        C1[Client 1]
        C2[Client 2]
        C3[Client 3]
    end
    
    subgraph "Service Layer"
        S[Service<br/>ClusterIP: 10.96.0.100:80]
    end
    
    subgraph "Pod Layer"
        P1[Pod 1<br/>10.244.1.5:8080]
        P2[Pod 2<br/>10.244.2.8:8080]
        P3[Pod 3<br/>10.244.3.12:8080]
    end
    
    C1 --> S
    C2 --> S
    C3 --> S
    
    S -->|è² è¼‰å‡è¡¡| P1
    S -->|è² è¼‰å‡è¡¡| P2
    S -->|è² è¼‰å‡è¡¡| P3
    
    style S fill:#9cf
    style P1 fill:#9f9
    style P2 fill:#9f9
    style P3 fill:#9f9
```

**ç‚ºä»€éº¼éœ€è¦ Serviceï¼Ÿ**
- âœ… Pod IP æœƒè®ŠåŒ–ï¼ˆé‡å•Ÿã€æ“´ç¸®å®¹ï¼‰
- âœ… éœ€è¦ç©©å®šçš„è¨ªå•å…¥å£
- âœ… éœ€è¦è² è¼‰å‡è¡¡
- âœ… éœ€è¦æœå‹™ç™¼ç¾

---

### 1.2 Service é¡å‹ç¸½è¦½

```mermaid
graph TB
    subgraph "ClusterIPï¼ˆé»˜èªï¼‰"
        CI[ClusterIP<br/>10.96.0.100]
        CI --> P1[Pod 1]
        CI --> P2[Pod 2]
    end
    
    subgraph "NodePort"
        NP[NodePort<br/>:30080]
        NP --> CI
    end
    
    subgraph "LoadBalancer"
        LB[External LB<br/>34.123.45.67]
        LB --> NP
    end
    
    subgraph "ExternalName"
        EN[ExternalName<br/>CNAME]
        EN -.-> EXT[external-service.com]
    end
    
    IC[é›†ç¾¤å…§éƒ¨] --> CI
    EX[å¤–éƒ¨ç”¨æˆ¶] --> LB
    
    style CI fill:#9cf
    style NP fill:#fc9
    style LB fill:#9f9
    style EN fill:#f9c
```

| é¡å‹ | ç”¨é€” | è¨ªå•æ–¹å¼ | ä½¿ç”¨å ´æ™¯ |
|-----|------|---------|---------|
| **ClusterIP** | é›†ç¾¤å…§éƒ¨è¨ªå• | ClusterIP:Port | å¾®æœå‹™é–“é€šä¿¡ |
| **NodePort** | é€šéç¯€é»ç«¯å£è¨ªå• | NodeIP:NodePort | é–‹ç™¼æ¸¬è©¦ |
| **LoadBalancer** | é›²ç«¯è² è¼‰å‡è¡¡å™¨ | å¤–éƒ¨ IP | ç”Ÿç”¢ç’°å¢ƒå°å¤–æœå‹™ |
| **ExternalName** | å¤–éƒ¨æœå‹™æ˜ å°„ | DNS CNAME | è¨ªå•å¤–éƒ¨æœå‹™ |
| **Headless** | ä¸åˆ†é… ClusterIP | Pod DNS | StatefulSet |

---

### 1.3 ClusterIP Serviceï¼ˆé»˜èªé¡å‹ï¼‰

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: default
  labels:
    app: webapp
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

spec:
  type: ClusterIP
  
  # é¸æ“‡å™¨ï¼ˆåŒ¹é… Pod labelsï¼‰
  selector:
    app: webapp
    tier: frontend
  
  # ç«¯å£å®šç¾©
  ports:
  - name: http
    protocol: TCP
    port: 80           # Service ç«¯å£
    targetPort: 8080   # Pod ç«¯å£ï¼ˆå¯ä»¥æ˜¯æ•¸å­—æˆ–åç¨±ï¼‰
  
  - name: metrics
    protocol: TCP
    port: 9090
    targetPort: metrics
  
  # æœƒè©±è¦ªå’Œæ€§ï¼ˆå¯é¸ï¼‰
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
  
  # IP å”è­°æ—
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack    # SingleStack, PreferDualStack, RequireDualStack
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```bash
# æŸ¥çœ‹ Service
kubectl get svc webapp
kubectl describe svc webapp

# é›†ç¾¤å…§è¨ªå•
curl http://webapp.default.svc.cluster.local
curl http://webapp:80

# æŸ¥çœ‹ Endpoints
kubectl get endpoints webapp
```

---

### 1.4 NodePort Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-nodeport
spec:
  type: NodePort
  
  selector:
    app: webapp
  
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 8080
    nodePort: 30080    # å¯é¸ï¼Œç¯„åœ 30000-32767
```

**è¨ªå•æ–¹å¼ï¼š**

```bash
# é€šéä»»æ„ç¯€é» IP è¨ªå•
curl http://<node-ip>:30080
curl http://192.168.1.10:30080
curl http://192.168.1.11:30080

# æŸ¥çœ‹ NodePort
kubectl get svc webapp-nodeport
```

```mermaid
graph LR
    U[å¤–éƒ¨ç”¨æˆ¶] -->|:30080| N1[Node 1]
    U -->|:30080| N2[Node 2]
    U -->|:30080| N3[Node 3]
    
    N1 --> S[Service<br/>ClusterIP]
    N2 --> S
    N3 --> S
    
    S --> P1[Pod 1]
    S --> P2[Pod 2]
    
    style S fill:#9cf
```

**ç‰¹é»ï¼š**
- âœ… ç°¡å–®ï¼Œç„¡éœ€é¡å¤–é…ç½®
- âœ… ä»»æ„ç¯€é»éƒ½å¯è¨ªå•
- âŒ ç«¯å£ç¯„åœå—é™ï¼ˆ30000-32767ï¼‰
- âŒ éœ€è¦ç®¡ç†ç¯€é» IP
- âŒ ä¸é©åˆç”Ÿç”¢ç’°å¢ƒ

---

### 1.5 LoadBalancer Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-lb
  annotations:
    # AWS
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    
    # GCP
    cloud.google.com/load-balancer-type: "Internal"
    
    # Azure
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"

spec:
  type: LoadBalancer
  
  selector:
    app: webapp
  
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 8080
  
  # å¤–éƒ¨æµé‡ç­–ç•¥
  externalTrafficPolicy: Local    # Cluster æˆ– Local
  
  # å…è¨±çš„æº IP ç¯„åœ
  loadBalancerSourceRanges:
  - 10.0.0.0/8
  - 192.168.0.0/16
```

**externalTrafficPolicy å°æ¯”ï¼š**

| ç­–ç•¥ | å„ªé» | ç¼ºé» |
|-----|------|------|
| **Cluster**ï¼ˆé»˜èªï¼‰ | è² è¼‰å‡è¡¡æ›´å¥½ | æœƒåš SNATï¼Œä¸Ÿå¤±æº IP |
| **Local** | ä¿ç•™æº IPï¼Œæ¸›å°‘è·³èº | è² è¼‰å¯èƒ½ä¸å‡ |

```mermaid
graph TB
    subgraph "Cluster æ¨¡å¼"
        LB1[Load Balancer] --> N1[Node 1]
        LB1 --> N2[Node 2]
        N1 --> P1[Pod on Node 2]
        N2 --> P2[Pod on Node 1]
    end
    
    subgraph "Local æ¨¡å¼"
        LB2[Load Balancer] --> N3[Node 1]
        LB2 --> N4[Node 2]
        N3 --> P3[Pod on Node 1]
        N4 --> P4[Pod on Node 2]
    end
    
    style LB1 fill:#fc9
    style LB2 fill:#9f9
```

**æŸ¥çœ‹å¤–éƒ¨ IPï¼š**

```bash
kubectl get svc webapp-lb
# NAME        TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE
# webapp-lb   LoadBalancer   10.96.0.100     34.123.45.67    80:30123/TCP   5m

curl http://34.123.45.67
```

---

### 1.6 ExternalName Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: external-db
spec:
  type: ExternalName
  externalName: database.example.com
  ports:
  - port: 5432
```

**ç”¨é€”ï¼š**
- å°‡å¤–éƒ¨æœå‹™æ˜ å°„åˆ°é›†ç¾¤å…§éƒ¨
- æ–¹ä¾¿æœå‹™é·ç§»ï¼ˆå…ˆç”¨ ExternalNameï¼Œå†é·ç§»åˆ°é›†ç¾¤å…§ï¼‰

```bash
# æ‡‰ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨é›†ç¾¤å…§çš„ DNS åç¨±
DB_HOST=external-db.default.svc.cluster.local

# å¯¦éš›æœƒè§£æåˆ° database.example.com
```

---

### 1.7 Headless Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  clusterIP: None    # ä¸åˆ†é… ClusterIP
  
  selector:
    app: mysql
  
  ports:
  - port: 3306
    targetPort: 3306
```

**ç‰¹é»ï¼š**
- âœ… ä¸åˆ†é… ClusterIP
- âœ… DNS ç›´æ¥è¿”å› Pod IP åˆ—è¡¨
- âœ… ç”¨æ–¼ StatefulSet

```bash
# DNS æŸ¥è©¢è¿”å›æ‰€æœ‰ Pod IP
nslookup mysql.default.svc.cluster.local

# è¿”å›ï¼š
# Name:    mysql.default.svc.cluster.local
# Address: 10.244.1.5
# Address: 10.244.2.8
# Address: 10.244.3.12

# StatefulSet Pod çš„ç©©å®š DNS
mysql-0.mysql.default.svc.cluster.local
mysql-1.mysql.default.svc.cluster.local
mysql-2.mysql.default.svc.cluster.local
```

---

### 1.8 Service å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
  namespace: production
  labels:
    app: webapp
    tier: frontend
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

spec:
  type: LoadBalancer
  
  selector:
    app: webapp
    tier: frontend
  
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: http
  
  - name: https
    protocol: TCP
    port: 443
    targetPort: https
  
  - name: metrics
    protocol: TCP
    port: 9090
    targetPort: metrics
  
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  
  externalTrafficPolicy: Local
  
  loadBalancerSourceRanges:
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
  
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
```

---

## 2. æœå‹™ç™¼ç¾æ©Ÿåˆ¶

### 2.1 DNS æœå‹™ç™¼ç¾ï¼ˆæ¨è–¦ï¼‰

Kubernetes è‡ªå‹•ç‚ºæ¯å€‹ Service å‰µå»º DNS è¨˜éŒ„ã€‚

```mermaid
graph TB
    subgraph "DNS è§£æ"
        A[æ‡‰ç”¨ Pod] -->|æŸ¥è©¢| CD[CoreDNS]
        CD -->|è¿”å› ClusterIP| A
    end
    
    subgraph "DNS æ ¼å¼"
        F1[æœå‹™å.å‘½åç©ºé–“.svc.cluster.local]
        F2[webapp.default.svc.cluster.local]
        F3[webapp.production.svc.cluster.local]
    end
    
    style CD fill:#9cf
```

**DNS æ ¼å¼ï¼š**

```bash
# å®Œæ•´æ ¼å¼
<service-name>.<namespace>.svc.cluster.local

# åŒå‘½åç©ºé–“å¯ç°¡å¯«
<service-name>

# è·¨å‘½åç©ºé–“
<service-name>.<namespace>
```

**ç¤ºä¾‹ï¼š**

```yaml
# Pod é…ç½®
env:
- name: DB_HOST
  value: "postgres.database.svc.cluster.local"

- name: REDIS_HOST
  value: "redis"    # åŒå‘½åç©ºé–“ç°¡å¯«

- name: API_HOST
  value: "api.production.svc.cluster.local"
```

**DNS è¨˜éŒ„é¡å‹ï¼š**

| Service é¡å‹ | DNS è¿”å›å€¼ |
|-------------|-----------|
| ClusterIP | ClusterIP |
| NodePort | ClusterIP |
| LoadBalancer | ClusterIP |
| ExternalName | CNAME è¨˜éŒ„ |
| Headless | Pod IP åˆ—è¡¨ |

---

### 2.2 ç’°å¢ƒè®Šé‡æœå‹™ç™¼ç¾

Kubernetes è‡ªå‹•æ³¨å…¥ç’°å¢ƒè®Šé‡ï¼ˆåƒ…é™åŒå‘½åç©ºé–“ï¼ŒPod å‰µå»ºæ™‚çš„ Serviceï¼‰ã€‚

```bash
# Service å‰µå»ºå¾Œï¼Œæ–°å»ºçš„ Pod æœƒè‡ªå‹•ç²å¾—ç’°å¢ƒè®Šé‡
WEBAPP_SERVICE_HOST=10.96.0.100
WEBAPP_SERVICE_PORT=80
WEBAPP_PORT_80_TCP=tcp://10.96.0.100:80
WEBAPP_PORT_80_TCP_PROTO=tcp
WEBAPP_PORT_80_TCP_PORT=80
WEBAPP_PORT_80_TCP_ADDR=10.96.0.100
```

**æ³¨æ„ï¼š**
- âš ï¸ ç’°å¢ƒè®Šé‡é †åºæ•æ„Ÿï¼ˆService å¿…é ˆåœ¨ Pod ä¹‹å‰å‰µå»ºï¼‰
- âš ï¸ åƒ…åŒå‘½åç©ºé–“
- âš ï¸ æ¨è–¦ä½¿ç”¨ DNSï¼Œæ›´éˆæ´»

---

## 3. Endpoints èˆ‡ EndpointSlices

### 3.1 Endpoints å·¥ä½œåŸç†

```mermaid
graph TB
    S[Service<br/>webapp] --> E[Endpoints<br/>webapp]
    
    E --> P1[10.244.1.5:8080<br/>Ready]
    E --> P2[10.244.2.8:8080<br/>Ready]
    E --> P3[10.244.3.12:8080<br/>NotReady]
    
    P1 -.readinessProbe.-> R1[âœ“ Ready]
    P2 -.readinessProbe.-> R2[âœ“ Ready]
    P3 -.readinessProbe.-> R3[âœ— NotReady]
    
    S -.åƒ…è½‰ç™¼æµé‡.-> P1
    S -.åƒ…è½‰ç™¼æµé‡.-> P2
    
    style S fill:#9cf
    style E fill:#fc9
    style P3 fill:#f96
```

**æŸ¥çœ‹ Endpointsï¼š**

```bash
kubectl get endpoints webapp
kubectl describe endpoints webapp

# è¼¸å‡ºç¤ºä¾‹ï¼š
# Name:         webapp
# Namespace:    default
# Addresses:    10.244.1.5:8080,10.244.2.8:8080
# NotReadyAddresses: 10.244.3.12:8080
```

---

### 3.2 æ‰‹å‹•ç®¡ç† Endpoints

ç”¨æ–¼å°‡å¤–éƒ¨æœå‹™æ˜ å°„åˆ° Kubernetesã€‚

```yaml
# Serviceï¼ˆä¸å¸¶ selectorï¼‰
apiVersion: v1
kind: Service
metadata:
  name: external-database
spec:
  ports:
  - protocol: TCP
    port: 5432
    targetPort: 5432

---
# æ‰‹å‹•å‰µå»º Endpoints
apiVersion: v1
kind: Endpoints
metadata:
  name: external-database    # å¿…é ˆèˆ‡ Service åŒå
subsets:
- addresses:
  - ip: 192.168.1.100
  - ip: 192.168.1.101
  ports:
  - port: 5432
```

**ç”¨é€”ï¼š**
- è¨ªå•å¤–éƒ¨æ•¸æ“šåº«
- è¨ªå•é›†ç¾¤å¤–çš„æœå‹™
- é€æ­¥é·ç§»æœå‹™åˆ° Kubernetes

---

### 3.3 EndpointSlices

EndpointSlices æ˜¯ Endpoints çš„å¯æ“´å±•æ›¿ä»£æ–¹æ¡ˆï¼ˆKubernetes 1.21+ é»˜èªå•Ÿç”¨ï¼‰ã€‚

**å„ªå‹¢ï¼š**
- âœ… æ”¯æŒå¤§è¦æ¨¡æœå‹™ï¼ˆæ•¸åƒå€‹ Podï¼‰
- âœ… æ¸›å°‘ API Server è² è¼‰
- âœ… æ›´é«˜æ•ˆçš„ç¶²çµ¡ç·¨ç¨‹

```bash
kubectl get endpointslices
kubectl describe endpointslices webapp-abcde
```

---

## 4. Ingress

### 4.1 Ingress æ˜¯ä»€éº¼

Ingress æä¾› HTTP/HTTPS è·¯ç”±ï¼Œå°‡å¤–éƒ¨æµé‡è·¯ç”±åˆ°é›†ç¾¤å…§æœå‹™ã€‚

```mermaid
graph TB
    U[å¤–éƒ¨ç”¨æˆ¶<br/>https://example.com] --> LB[Load Balancer<br/>34.123.45.67]
    LB --> IC[Ingress Controller<br/>Nginx/Traefik/Istio]
    
    IC -->|example.com/api| S1[Service: api]
    IC -->|example.com/app| S2[Service: webapp]
    IC -->|example.com/admin| S3[Service: admin]
    
    S1 --> P1[API Pods]
    S2 --> P2[WebApp Pods]
    S3 --> P3[Admin Pods]
    
    style IC fill:#9cf
    style LB fill:#fc9
```

**ç‚ºä»€éº¼éœ€è¦ Ingressï¼Ÿ**
- âœ… çµ±ä¸€å…¥å£ï¼ˆä¸éœ€è¦å¤šå€‹ LoadBalancerï¼‰
- âœ… åŸºæ–¼åŸŸå/è·¯å¾‘è·¯ç”±
- âœ… TLS/SSL çµ‚æ­¢
- âœ… ç¯€çœæˆæœ¬ï¼ˆä¸€å€‹ LB ä»£æ›¿å¤šå€‹ï¼‰

---

### 4.2 Ingress Controller

Ingress è³‡æºéœ€è¦ Ingress Controller æ‰èƒ½å·¥ä½œã€‚

**å¸¸è¦‹ Ingress Controllerï¼š**

| Controller | ç‰¹é» | ä½¿ç”¨å ´æ™¯ |
|-----------|------|---------|
| **Nginx Ingress** | æˆç†Ÿç©©å®šï¼ŒåŠŸèƒ½è±å¯Œ | é€šç”¨å ´æ™¯ |
| **Traefik** | è¼•é‡ï¼Œè‡ªå‹•æœå‹™ç™¼ç¾ | å¾®æœå‹™ |
| **HAProxy Ingress** | é«˜æ€§èƒ½ | é«˜æµé‡å ´æ™¯ |
| **Istio Gateway** | æœå‹™ç¶²æ ¼é›†æˆ | è¤‡é›œå¾®æœå‹™æ¶æ§‹ |
| **AWS ALB Ingress** | AWS åŸç”Ÿ | AWS ç’°å¢ƒ |
| **GCE Ingress** | GCP åŸç”Ÿ | GCP ç’°å¢ƒ |

---

### 4.3 å®‰è£ Nginx Ingress Controller

```bash
# ä½¿ç”¨ Helm å®‰è£
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --set controller.replicaCount=2 \
  --set controller.nodeSelector."kubernetes\.io/os"=linux \
  --set controller.admissionWebhooks.patch.nodeSelector."kubernetes\.io/os"=linux \
  --set defaultBackend.nodeSelector."kubernetes\.io/os"=linux

# æŸ¥çœ‹
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

---

### 4.4 Ingress åŸºç¤é…ç½®

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-ingress
  namespace: production
  annotations:
    # Ingress Classï¼ˆKubernetes 1.18+ï¼‰
    kubernetes.io/ingress.class: nginx
    
    # Nginx ç‰¹å®šé…ç½®
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

spec:
  # Ingress Class
  ingressClassName: nginx
  
  # TLS é…ç½®
  tls:
  - hosts:
    - example.com
    - www.example.com
    secretName: example-com-tls
  
  # è·¯ç”±è¦å‰‡
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
      
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 8080
```

---

### 4.5 è·¯å¾‘é¡å‹ (pathType)

| pathType | èªªæ˜ | ç¤ºä¾‹ |
|----------|------|------|
| **Prefix** | å‰ç¶´åŒ¹é… | `/api` åŒ¹é… `/api/users` |
| **Exact** | ç²¾ç¢ºåŒ¹é… | `/api` ä¸åŒ¹é… `/api/` |
| **ImplementationSpecific** | ç”± Ingress Controller æ±ºå®š | å–æ±ºæ–¼å¯¦ç¾ |

---

### 4.6 å®Œæ•´ Ingress é…ç½®ç¤ºä¾‹

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: complete-ingress
  namespace: production
  annotations:
    # åŸºç¤é…ç½®
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    
    # SSL é…ç½®
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # é€Ÿç‡é™åˆ¶
    nginx.ingress.kubernetes.io/limit-rps: "100"
    
    # è¶…æ™‚é…ç½®
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # è«‹æ±‚é«”å¤§å°é™åˆ¶
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    
    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://example.com"
    
    # WebSocket
    nginx.ingress.kubernetes.io/websocket-services: "chat"
    
    # ç™½åå–®
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,192.168.0.0/16"

spec:
  ingressClassName: nginx
  
  tls:
  - hosts:
    - example.com
    - www.example.com
    - api.example.com
    secretName: example-com-tls
  
  rules:
  # ä¸»ç¶²ç«™
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
  
  # www é‡å®šå‘
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
  
  # API æœå‹™
  - host: api.example.com
    http:
      paths:
      - path: /v1
        pathType: Prefix
        backend:
          service:
            name: api-v1
            port:
              number: 8080
      
      - path: /v2
        pathType: Prefix
        backend:
          service:
            name: api-v2
            port:
              number: 8080
```

---

### 4.7 TLS è­‰æ›¸ç®¡ç†

#### 4.7.1 æ‰‹å‹•å‰µå»º TLS Secret

```bash
# å‰µå»º TLS Secret
kubectl create secret tls example-com-tls \
  --cert=path/to/cert.pem \
  --key=path/to/key.pem

# æˆ–ä½¿ç”¨ YAML
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: example-com-tls
type: kubernetes.io/tls
data:
  tls.crt: $(cat cert.pem | base64 -w 0)
  tls.key: $(cat key.pem | base64 -w 0)
EOF
```

#### 4.7.2 ä½¿ç”¨ cert-manager è‡ªå‹•ç®¡ç†è­‰æ›¸

```bash
# å®‰è£ cert-manager
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml

# å‰µå»º Let's Encrypt Issuer
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
EOF
```

**Ingress ä¸­ä½¿ç”¨ï¼š**

```yaml
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - example.com
    secretName: example-com-tls    # cert-manager è‡ªå‹•å‰µå»º
```

---

### 4.8 Ingress é«˜ç´šåŠŸèƒ½

#### 4.8.1 URL é‡å¯«

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
  - host: example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 8080
```

#### 4.8.2 åŸºæ–¼ Cookie çš„è¦ªå’Œæ€§

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
```

#### 4.8.3 åŸºæœ¬èªè­‰

```bash
# å‰µå»º htpasswd
htpasswd -c auth admin
kubectl create secret generic basic-auth --from-file=auth
```

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
```

#### 4.8.4 é€Ÿç‡é™åˆ¶

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/limit-rpm: "100"
    nginx.ingress.kubernetes.io/limit-connections: "10"
```

---

## 5. NetworkPolicy

### 5.1 NetworkPolicy æ˜¯ä»€éº¼

NetworkPolicy æä¾›ç¶²çµ¡éš”é›¢ï¼Œæ§åˆ¶ Pod ä¹‹é–“çš„é€šä¿¡ã€‚

```mermaid
graph TB
    subgraph "Namespace: frontend"
        F1[Web Pod]
    end
    
    subgraph "Namespace: backend"
        B1[API Pod]
        B2[Worker Pod]
    end
    
    subgraph "Namespace: database"
        D1[DB Pod]
    end
    
    F1 -->|å…è¨±| B1
    F1 -.ç¦æ­¢.-> D1
    B1 -->|å…è¨±| D1
    B2 -->|å…è¨±| D1
    
    style F1 fill:#9f9
    style D1 fill:#f96
```

**æ³¨æ„ï¼š**
- âš ï¸ éœ€è¦ CNI æ’ä»¶æ”¯æŒï¼ˆCalicoã€Ciliumã€Weave Netï¼‰
- âš ï¸ Flannel ä¸æ”¯æŒ NetworkPolicy

---

### 5.2 NetworkPolicy åŸºç¤

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: backend
spec:
  # æ‡‰ç”¨åˆ°å“ªäº› Pod
  podSelector:
    matchLabels:
      app: api
  
  # ç­–ç•¥é¡å‹
  policyTypes:
  - Ingress
  - Egress
  
  # å…¥ç«™è¦å‰‡
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
    - podSelector:
        matchLabels:
          app: webapp
    ports:
    - protocol: TCP
      port: 8080
  
  # å‡ºç«™è¦å‰‡
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
```

---

### 5.3 NetworkPolicy ç¤ºä¾‹

#### 5.3.1 é»˜èªæ‹’çµ•æ‰€æœ‰å…¥ç«™æµé‡

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: production
spec:
  podSelector: {}    # åŒ¹é…æ‰€æœ‰ Pod
  policyTypes:
  - Ingress
```

#### 5.3.2 é»˜èªæ‹’çµ•æ‰€æœ‰å‡ºç«™æµé‡

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Egress
```

#### 5.3.3 å…è¨±ä¾†è‡ªç‰¹å®šå‘½åç©ºé–“çš„æµé‡

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-frontend
  namespace: backend
spec:
  podSelector:
    matchLabels:
      app: api
  
  policyTypes:
  - Ingress
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
    ports:
    - protocol: TCP
      port: 8080
```

#### 5.3.4 å…è¨±ä¾†è‡ªç‰¹å®š Pod çš„æµé‡

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-webapp
  namespace: backend
spec:
  podSelector:
    matchLabels:
      app: api
  
  policyTypes:
  - Ingress
  
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: webapp
    ports:
    - protocol: TCP
      port: 8080
```

#### 5.3.5 å…è¨±åˆ°ç‰¹å®šå¤–éƒ¨ IP çš„å‡ºç«™æµé‡

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-egress
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: webapp
  
  policyTypes:
  - Egress
  
  egress:
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 169.254.169.254/32    # AWS metadata service
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  
  # å…è¨± DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
```

#### 5.3.6 ä¸‰å±¤å¾®æœå‹™ç¶²çµ¡éš”é›¢

```yaml
# Frontend Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: frontend
  labels:
    name: frontend

---
# Backend Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: backend
  labels:
    name: backend

---
# Database Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: database
  labels:
    name: database

---
# Database ç­–ç•¥ï¼šåªå…è¨± Backend è¨ªå•
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-policy
  namespace: database
spec:
  podSelector:
    matchLabels:
      app: postgres
  
  policyTypes:
  - Ingress
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: backend
    ports:
    - protocol: TCP
      port: 5432

---
# Backend ç­–ç•¥ï¼šåªå…è¨± Frontend è¨ªå•
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-policy
  namespace: backend
spec:
  podSelector:
    matchLabels:
      app: api
  
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # å…è¨±è¨ªå• Database
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
  
  # å…è¨± DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Frontend ç­–ç•¥ï¼šå…è¨±å¤–éƒ¨è¨ªå•
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-policy
  namespace: frontend
spec:
  podSelector:
    matchLabels:
      app: webapp
  
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  
  egress:
  # å…è¨±è¨ªå• Backend
  - to:
    - namespaceSelector:
        matchLabels:
          name: backend
    ports:
    - protocol: TCP
      port: 8080
  
  # å…è¨± DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
```

---

### 5.4 NetworkPolicy æ¸¬è©¦

```bash
# éƒ¨ç½²æ¸¬è©¦ Pod
kubectl run test-pod --image=nicolaka/netshoot -it --rm

# æ¸¬è©¦é€£æ¥
curl http://api.backend.svc.cluster.local:8080
nc -zv postgres.database.svc.cluster.local 5432

# æŸ¥çœ‹ NetworkPolicy
kubectl get networkpolicies -A
kubectl describe networkpolicy backend-policy -n backend
```

---

## 6. å¯¦æˆ°æ¡ˆä¾‹

### 6.1 å¾®æœå‹™å®Œæ•´ç¶²çµ¡é…ç½®

```yaml
# Web Service
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: frontend
spec:
  selector:
    app: webapp
  ports:
  - port: 80
    targetPort: 8080

---
# API Service
apiVersion: v1
kind: Service
metadata:
  name: api
  namespace: backend
spec:
  selector:
    app: api
  ports:
  - port: 8080
    targetPort: 8080

---
# Database Service
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: database
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432

---
# Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-ingress
  namespace: frontend
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - example.com
    secretName: example-com-tls
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 8080
```

---

## 7. æœ€ä½³å¯¦è¸

### 7.1 Service æœ€ä½³å¯¦è¸

```yaml
# âœ… ä½¿ç”¨æœ‰æ„ç¾©çš„å‘½åç«¯å£
ports:
- name: http
  port: 80
  targetPort: http    # å¼•ç”¨å®¹å™¨çš„å‘½åç«¯å£

# âœ… è¨­ç½®æœƒè©±è¦ªå’Œæ€§ï¼ˆå¦‚éœ€è¦ï¼‰
sessionAffinity: ClientIP

# âœ… ä½¿ç”¨ Local ä¿ç•™æº IP
externalTrafficPolicy: Local

# âœ… é™åˆ¶æº IP ç¯„åœ
loadBalancerSourceRanges:
- 10.0.0.0/8
```

### 7.2 Ingress æœ€ä½³å¯¦è¸

```yaml
# âœ… å•Ÿç”¨ TLS
tls:
- hosts:
  - example.com
  secretName: example-com-tls

# âœ… è¨­ç½®é€Ÿç‡é™åˆ¶
annotations:
  nginx.ingress.kubernetes.io/limit-rps: "100"

# âœ… è¨­ç½®è¶…æ™‚
annotations:
  nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

# âœ… é™åˆ¶è«‹æ±‚é«”å¤§å°
annotations:
  nginx.ingress.kubernetes.io/proxy-body-size: "10m"
```

### 7.3 NetworkPolicy æœ€ä½³å¯¦è¸

```yaml
# âœ… é»˜èªæ‹’çµ•ï¼Œé¡¯å¼å…è¨±
# 1. å…ˆå‰µå»º default-deny
# 2. å†å‰µå»ºå…è¨±è¦å‰‡

# âœ… ä½¿ç”¨å‘½åç©ºé–“æ¨™ç±¤
namespaceSelector:
  matchLabels:
    name: backend

# âœ… å§‹çµ‚å…è¨± DNS
egress:
- to:
  - namespaceSelector: {}
    podSelector:
      matchLabels:
        k8s-app: kube-dns
  ports:
  - protocol: UDP
    port: 53
```

---

## 8. æ•…éšœæ’æŸ¥

### 8.1 Service å•é¡Œæ’æŸ¥

```bash
# æª¢æŸ¥ Service
kubectl get svc webapp
kubectl describe svc webapp

# æª¢æŸ¥ Endpoints
kubectl get endpoints webapp
# å¦‚æœ Endpoints ç‚ºç©ºï¼š
# - æª¢æŸ¥ Pod æ˜¯å¦é‹è¡Œ
# - æª¢æŸ¥ selector æ˜¯å¦åŒ¹é…
# - æª¢æŸ¥ Pod readinessProbe

# æª¢æŸ¥ Pod labels
kubectl get pods --show-labels

# æ¸¬è©¦æœå‹™é€£æ¥
kubectl run test --image=nicolaka/netshoot -it --rm -- /bin/bash
curl http://webapp.default.svc.cluster.local
```

### 8.2 Ingress å•é¡Œæ’æŸ¥

```bash
# æª¢æŸ¥ Ingress
kubectl get ingress
kubectl describe ingress webapp-ingress

# æª¢æŸ¥ Ingress Controller
kubectl get pods -n ingress-nginx
kubectl logs -n ingress-nginx <ingress-controller-pod>

# æª¢æŸ¥ TLS Secret
kubectl get secret example-com-tls
kubectl describe secret example-com-tls

# æ¸¬è©¦ DNS
nslookup example.com

# æ¸¬è©¦è­‰æ›¸
openssl s_client -connect example.com:443 -servername example.com
```

### 8.3 NetworkPolicy å•é¡Œæ’æŸ¥

```bash
# æª¢æŸ¥ CNI æ’ä»¶æ˜¯å¦æ”¯æŒ
kubectl get pods -n kube-system | grep -E "calico|cilium|weave"

# æª¢æŸ¥ NetworkPolicy
kubectl get networkpolicies -A
kubectl describe networkpolicy backend-policy -n backend

# æ¸¬è©¦é€£æ¥
kubectl run test --image=nicolaka/netshoot -it --rm -- /bin/bash
nc -zv api.backend.svc.cluster.local 8080
```

---

## 9. å°çµ

æœ¬ç« æ·±å…¥è¬›è§£äº† Kubernetes çš„ç¶²è·¯è³‡æºï¼š

**æ ¸å¿ƒè³‡æºï¼š**
- âœ… **Service**ï¼šæä¾›ç©©å®šçš„ç¶²çµ¡è¨ªå•å…¥å£å’Œè² è¼‰å‡è¡¡
  - ClusterIPã€NodePortã€LoadBalancerã€ExternalNameã€Headless
- âœ… **Ingress**ï¼šHTTP/HTTPS è·¯ç”±ï¼Œçµ±ä¸€å…¥å£ç®¡ç†
- âœ… **NetworkPolicy**ï¼šç¶²çµ¡éš”é›¢èˆ‡å®‰å…¨ç­–ç•¥
- âœ… **Endpoints/EndpointSlices**ï¼šæœå‹™ç™¼ç¾æ©Ÿåˆ¶

**æœå‹™ç™¼ç¾ï¼š**
- âœ… DNSï¼ˆæ¨è–¦ï¼‰ï¼š`<service>.<namespace>.svc.cluster.local`
- âœ… ç’°å¢ƒè®Šé‡ï¼šè‡ªå‹•æ³¨å…¥

**æœ€ä½³å¯¦è¸ï¼š**
- âœ… ä½¿ç”¨ DNS é€²è¡Œæœå‹™ç™¼ç¾
- âœ… LoadBalancer ä½¿ç”¨ Local ä¿ç•™æº IP
- âœ… Ingress çµ±ä¸€ç®¡ç†å¤–éƒ¨è¨ªå•
- âœ… NetworkPolicy å¯¦ç¾é›¶ä¿¡ä»»ç¶²çµ¡

ä¸‹ä¸€ç« å°‡å­¸ç¿’å­˜å„²è³‡æºï¼ŒåŒ…æ‹¬ PVã€PVCã€StorageClass ç­‰ã€‚

---

## åƒè€ƒè³‡æ–™ (References)

1. [Kubernetes å®˜æ–¹æ–‡æª” - Service](https://kubernetes.io/docs/concepts/services-networking/service/)
2. [Kubernetes å®˜æ–¹æ–‡æª” - Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/)
3. [Kubernetes å®˜æ–¹æ–‡æª” - NetworkPolicy](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
4. [Nginx Ingress Controller å®˜æ–¹æ–‡æª”](https://kubernetes.github.io/ingress-nginx/)
5. [cert-manager å®˜æ–¹æ–‡æª”](https://cert-manager.io/docs/)
