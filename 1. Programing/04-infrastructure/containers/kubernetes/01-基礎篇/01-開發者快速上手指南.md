# 01-é–‹ç™¼è€…å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

> å¾é–‹ç™¼è€…è¦–è§’å¿«é€Ÿç†è§£ Kubernetesï¼Œ15 åˆ†é˜éƒ¨ç½²ç¬¬ä¸€å€‹æ‡‰ç”¨

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- ç†è§£ Kubernetes è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ
- æŒæ¡é–‹ç™¼è€…æ—¥å¸¸å·¥ä½œæµç¨‹
- éƒ¨ç½²ç¬¬ä¸€å€‹æ‡‰ç”¨åˆ° K8s
- å»ºç«‹é–‹ç™¼è€…æ€ç¶­æ¨¡å‹

---

## 1. Kubernetes æ˜¯ä»€éº¼ï¼Ÿé–‹ç™¼è€…ç‚ºä½•éœ€è¦å®ƒï¼Ÿ

### 1.1 å‚³çµ±éƒ¨ç½²çš„ç—›é»

```mermaid
graph LR
    A[é–‹ç™¼ç’°å¢ƒ] -->|works on my machine| B[æ¸¬è©¦ç’°å¢ƒ]
    B -->|ç’°å¢ƒä¸ä¸€è‡´| C[ç”Ÿç”¢ç’°å¢ƒ]
    C -->|æ‰‹å‹•éƒ¨ç½²| D[æœå‹™æ›æ‰]
    D -->|æ‰‹å‹•é‡å•Ÿ| C

    style D fill:#f96
    style C fill:#ff9
```

**é–‹ç™¼è€…å¸¸è¦‹å•é¡Œï¼š**

- ã€Œåœ¨æˆ‘æ©Ÿå™¨ä¸Šå¯ä»¥è·‘å•Šï¼ã€ï¼ˆç’°å¢ƒå·®ç•°ï¼‰
- ã€Œæœå‹™æ›äº†ï¼Œèª°å»é‡å•Ÿï¼Ÿã€ï¼ˆå¯é æ€§å•é¡Œï¼‰
- ã€Œæµé‡çªç„¶æš´å¢æ€éº¼è¾¦ï¼Ÿã€ï¼ˆæ“´å±•æ€§å•é¡Œï¼‰
- ã€Œå¦‚ä½•å¿«é€Ÿå›æ»¾éŒ¯èª¤ç‰ˆæœ¬ï¼Ÿã€ï¼ˆéƒ¨ç½²å®‰å…¨ï¼‰

### 1.2 Kubernetes çš„æ ¸å¿ƒåƒ¹å€¼

```mermaid
graph TB
    subgraph "Kubernetes è§£æ±ºæ–¹æ¡ˆ"
        A[å®¹å™¨åŒ–] --> B[ç’°å¢ƒä¸€è‡´æ€§]
        C[è²æ˜å¼é…ç½®] --> D[è‡ªå‹•åŒ–éƒ¨ç½²]
        E[è‡ªæˆ‘ä¿®å¾©] --> F[é«˜å¯ç”¨æ€§]
        G[æ°´å¹³æ“´å±•] --> H[å½ˆæ€§ä¼¸ç¸®]
    end

    style B fill:#9f9
    style D fill:#9f9
    style F fill:#9f9
    style H fill:#9f9
```

**K8s æ ¸å¿ƒç†å¿µï¼š**

- **è²æ˜å¼ç®¡ç†**ï¼šå‘Šè¨´ K8sã€Œæˆ‘è¦ä»€éº¼ã€ï¼Œè€Œéã€Œå¦‚ä½•åšã€
- **è‡ªæˆ‘ä¿®å¾©**ï¼šå®¹å™¨æ›äº†è‡ªå‹•é‡å•Ÿ
- **å½ˆæ€§æ“´å±•**ï¼šæ ¹æ“šè² è¼‰è‡ªå‹•èª¿æ•´å‰¯æœ¬æ•¸
- **ç’°å¢ƒä¸€è‡´**ï¼šé–‹ç™¼ã€æ¸¬è©¦ã€ç”Ÿç”¢ä½¿ç”¨ç›¸åŒé…ç½®

---

## 2. é–‹ç™¼è€…å·¥ä½œæµç¨‹ç¸½è¦½

```mermaid
flowchart LR
    A["ç·¨å¯«ä»£ç¢¼"] --> B["å®¹å™¨åŒ– (Dockerfile)"]
    B --> C["ç·¨å¯« K8s YAML"]
    C --> D["éƒ¨ç½²åˆ°é›†ç¾¤ (kubectl apply)"]
    D --> E["é©—è­‰èˆ‡èª¿è©¦"]
    E --> F{"æ˜¯å¦æ­£å¸¸?"}
    F -- å¦ --> G["æŸ¥çœ‹æ—¥èªŒ (kubectl logs)"]
    G --> H["ä¿®å¾©å•é¡Œ"]
    H --> A
    F -- æ˜¯ --> I["æŒçºŒé–‹ç™¼"]

    style D fill:#9cf,stroke:#333
    style E fill:#fc9,stroke:#333
```

**æ ¸å¿ƒæ¦‚å¿µï¼š**

- **é–‹ç™¼éšæ®µ**ï¼šç·¨å¯«ä»£ç¢¼ + Dockerfile
- **é…ç½®éšæ®µ**ï¼šç·¨å¯« K8s YAMLï¼ˆDeployment, Serviceï¼‰
- **éƒ¨ç½²éšæ®µ**ï¼š`kubectl apply -f app.yaml`
- **é‹ç¶­éšæ®µ**ï¼šç›£æ§ã€æ—¥èªŒã€èª¿è©¦

---

## 3. 15 åˆ†é˜å¯¦æˆ°ï¼šéƒ¨ç½²ç¬¬ä¸€å€‹æ‡‰ç”¨

### 3.1 å‰ç½®æº–å‚™

ç¢ºä¿å·²å®‰è£ï¼š

- **kubectl**ï¼šK8s å‘½ä»¤è¡Œå·¥å…·
- **K8s é›†ç¾¤**ï¼šå¯ä½¿ç”¨ minikubeã€k3s æˆ–é›²ç«¯è¨—ç®¡é›†ç¾¤

é©—è­‰å®‰è£ï¼š

```bash
kubectl version --client
kubectl cluster-info
```

### 3.2 ç·¨å¯« Deployment

å‰µå»º `nginx-deployment.yaml`ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-demo
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.27
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
```

**é—œéµæ¬„ä½è§£æï¼š**

- `replicas: 3`ï¼šé‹è¡Œ 3 å€‹ Pod å‰¯æœ¬ï¼ˆé«˜å¯ç”¨ï¼‰
- `image: nginx:1.27`ï¼šä½¿ç”¨çš„å®¹å™¨é¡åƒ
- `resources`ï¼šè³‡æºé™åˆ¶ï¼ˆé˜²æ­¢è³‡æºè€—ç›¡ï¼‰

### 3.3 ç·¨å¯« Service

å‰µå»º `nginx-service.yaml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
```

**Service ä½œç”¨ï¼š**

- æä¾›ç©©å®šçš„è¨ªå•å…¥å£ï¼ˆIP ä¸è®Šï¼‰
- è‡ªå‹•è² è¼‰å‡è¡¡åˆ°å¤šå€‹ Pod
- `NodePort`ï¼šé€šéç¯€é» IP + 30080 ç«¯å£è¨ªå•

### 3.4 éƒ¨ç½²åˆ°é›†ç¾¤

```bash
kubectl apply -f nginx-deployment.yaml
kubectl apply -f nginx-service.yaml

kubectl get deployments
kubectl get pods
kubectl get services
```

**é æœŸè¼¸å‡ºï¼š**

```
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-demo   3/3     3            3           10s

NAME                         READY   STATUS    RESTARTS   AGE
nginx-demo-7d8f6c9b4-abcde   1/1     Running   0          10s
nginx-demo-7d8f6c9b4-fghij   1/1     Running   0          10s
nginx-demo-7d8f6c9b4-klmno   1/1     Running   0          10s

NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
nginx-service   NodePort   10.96.123.45   <none>        80:30080/TCP   5s
```

### 3.5 é©—è­‰éƒ¨ç½²

è¨ªå•æ‡‰ç”¨ï¼š

```bash
curl http://<NODE_IP>:30080

kubectl port-forward svc/nginx-service 8080:80
```

ç€è¦½å™¨è¨ªå•ï¼š`http://localhost:8080`

---

## 4. æ ¸å¿ƒæ¦‚å¿µé€Ÿè¦½

```mermaid
graph TB
    subgraph "Kubernetes æ ¸å¿ƒç‰©ä»¶å±¤ç´š"
        A[Deployment<br/>éƒ¨ç½²æ§åˆ¶å™¨] --> B[ReplicaSet<br/>å‰¯æœ¬é›†]
        B --> C1[Pod 1]
        B --> C2[Pod 2]
        B --> C3[Pod 3]

        D[Service<br/>æœå‹™] -.è² è¼‰å‡è¡¡.-> C1
        D -.è² è¼‰å‡è¡¡.-> C2
        D -.è² è¼‰å‡è¡¡.-> C3

        E[Ingress<br/>å…¥å£] --> D
    end

    F[å¤–éƒ¨æµé‡] --> E

    style A fill:#9cf
    style D fill:#fc9
    style E fill:#f9c
```

### 4.1 Podï¼ˆæœ€å°éƒ¨ç½²å–®å…ƒï¼‰

- åŒ…å«ä¸€å€‹æˆ–å¤šå€‹å®¹å™¨
- å…±äº«ç¶²çµ¡å’Œå­˜å„²
- **é–‹ç™¼è€…è¦–è§’**ï¼šé€šå¸¸ä¸€å€‹ Pod = ä¸€å€‹æ‡‰ç”¨å¯¦ä¾‹

### 4.2 Deploymentï¼ˆéƒ¨ç½²æ§åˆ¶å™¨ï¼‰

- ç®¡ç† Pod çš„ç”Ÿå‘½é€±æœŸ
- æ”¯æŒæ»¾å‹•æ›´æ–°ã€ç‰ˆæœ¬å›æ»¾
- **é–‹ç™¼è€…è¦–è§’**ï¼šè²æ˜ã€Œæˆ‘è¦ 3 å€‹å‰¯æœ¬ã€ï¼ŒK8s è‡ªå‹•ç¶­æŒ

### 4.3 Serviceï¼ˆæœå‹™ç™¼ç¾ï¼‰

- æä¾›ç©©å®šçš„ç¶²çµ¡å…¥å£
- è‡ªå‹•è² è¼‰å‡è¡¡
- **é–‹ç™¼è€…è¦–è§’**ï¼šåƒå¾®æœå‹™çš„ã€ŒåŸŸåã€

### 4.4 å¸¸ç”¨é¡å‹å°æ¯”

| ç‰©ä»¶é¡å‹            | ç”¨é€”     | å…¸å‹å ´æ™¯          |
| --------------- | ------ | ------------- |
| **Pod**         | æœ€å°éƒ¨ç½²å–®å…ƒ | é‹è¡Œå–®å€‹å®¹å™¨        |
| **Deployment**  | ç„¡ç‹€æ…‹æ‡‰ç”¨  | Web æœå‹™ã€API å¾Œç«¯ |
| **StatefulSet** | æœ‰ç‹€æ…‹æ‡‰ç”¨  | æ•¸æ“šåº«ã€æ¶ˆæ¯éšŠåˆ—      |
| **DaemonSet**   | æ¯ç¯€é»é‹è¡Œ  | æ—¥èªŒæ”¶é›†ã€ç›£æ§       |
| **Job/CronJob** | æ‰¹æ¬¡ä»»å‹™   | æ•¸æ“šè™•ç†ã€å®šæ™‚ä»»å‹™     |

---

## 5. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### 5.1 éƒ¨ç½²èˆ‡ç®¡ç†

```bash
kubectl apply -f app.yaml
kubectl delete -f app.yaml

kubectl get pods
kubectl get deployments
kubectl get services

kubectl get all -n <namespace>
```

### 5.2 èª¿è©¦èˆ‡æ•…éšœæ’æŸ¥

```bash
kubectl describe pod <pod-name>

kubectl logs <pod-name>
kubectl logs -f <pod-name>
kubectl logs <pod-name> -c <container-name>

kubectl exec -it <pod-name> -- /bin/bash

kubectl port-forward pod/<pod-name> 8080:80
```

### 5.3 æ“´ç¸®å®¹èˆ‡æ›´æ–°

```bash
kubectl scale deployment nginx-demo --replicas=5

kubectl set image deployment/nginx-demo nginx=nginx:1.28

kubectl rollout status deployment/nginx-demo
kubectl rollout undo deployment/nginx-demo
```

---

## 6. èª¿è©¦å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    A[Pod ç•°å¸¸] --> B{æª¢æŸ¥ç‹€æ…‹}
    B --> C[kubectl get pods]
    C --> D{ç‹€æ…‹æ˜¯?}

    D -->|Pending| E[kubectl describe pod]
    E --> F[æª¢æŸ¥è³‡æº/èª¿åº¦å•é¡Œ]

    D -->|CrashLoopBackOff| G[kubectl logs pod]
    G --> H[æª¢æŸ¥æ‡‰ç”¨éŒ¯èª¤]

    D -->|ImagePullBackOff| I[kubectl describe pod]
    I --> J[æª¢æŸ¥é¡åƒåç¨±/æ¬Šé™]

    D -->|Runningä½†ç•°å¸¸| K[kubectl exec é€²å…¥å®¹å™¨]
    K --> L[æ‰‹å‹•èª¿è©¦]

    style D fill:#fc9
    style F fill:#f96
    style H fill:#f96
    style J fill:#f96
```

### 6.1 å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ

| ç‹€æ…‹                   | åŸå›         | è§£æ±ºæ–¹æ³•                                     |
| -------------------- | --------- | ---------------------------------------- |
| **Pending**          | è³‡æºä¸è¶³ã€èª¿åº¦å¤±æ•— | æª¢æŸ¥ node è³‡æºï¼š`kubectl describe node`       |
| **ImagePullBackOff** | é¡åƒæ‹‰å–å¤±æ•—    | æª¢æŸ¥é¡åƒåç¨±ã€å€‰åº«æ¬Šé™                              |
| **CrashLoopBackOff** | å®¹å™¨å•Ÿå‹•å¾Œå´©æ½°   | æŸ¥çœ‹æ—¥èªŒï¼š`kubectl logs pod-name`             |
| **Error**            | å®¹å™¨åŸ·è¡ŒéŒ¯èª¤    | é€²å…¥å®¹å™¨èª¿è©¦ï¼š`kubectl exec -it pod-name -- sh` |

---

## 7. é–‹ç™¼è€…æœ€ä½³å¯¦è¸

### 7.1 è³‡æºç®¡ç†

**å§‹çµ‚è¨­ç½®è³‡æºé™åˆ¶ï¼š**

```yaml
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi
```

- `requests`ï¼šèª¿åº¦æ‰€éœ€çš„æœ€å°è³‡æº
- `limits`ï¼šå…è¨±ä½¿ç”¨çš„æœ€å¤§è³‡æº

### 7.2 å¥åº·æª¢æŸ¥

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
```

- **livenessProbe**ï¼šæª¢æ¸¬å®¹å™¨æ˜¯å¦å­˜æ´»ï¼ˆå¤±æ•—å‰‡é‡å•Ÿï¼‰
- **readinessProbe**ï¼šæª¢æ¸¬å®¹å™¨æ˜¯å¦å°±ç·’ï¼ˆæœªå°±ç·’å‰‡ä¸è½‰ç™¼æµé‡ï¼‰

### 7.3 æ¨™ç±¤èˆ‡é¸æ“‡å™¨

```yaml
metadata:
  labels:
    app: myapp
    tier: frontend
    environment: production
    version: v1.2.3
```

**ç”¨é€”ï¼š**

- Service é€šéæ¨™ç±¤é¸æ“‡ Pod
- ä¾¿æ–¼æŸ¥è©¢å’Œç®¡ç†ï¼š`kubectl get pods -l app=myapp`

---

## 8. ä¸‹ä¸€æ­¥å­¸ç¿’è·¯å¾‘

```mermaid
graph LR
    A[æœ¬ç« ï¼šå¿«é€Ÿä¸Šæ‰‹] --> B[ç¬¬ 2 ç« ï¼šæ ¸å¿ƒæ¦‚å¿µ]
    B --> C[ç¬¬ 3 ç« ï¼šæœ¬åœ°é–‹ç™¼]
    C --> D[Part IIï¼šæ‡‰ç”¨é–‹ç™¼]
    D --> E[Part IIIï¼šç”Ÿç”¢å¯¦è¸]

    style A fill:#9f9
    style B fill:#9cf
```

**æ¨è–¦å­¸ç¿’é †åºï¼š**

1. âœ… **æœ¬ç« **ï¼šå¿«é€Ÿä¸Šæ‰‹ï¼Œå»ºç«‹æ•´é«”èªçŸ¥
2. **ç¬¬ 2 ç« **ï¼šæ·±å…¥ç†è§£ K8s æ¶æ§‹èˆ‡æ ¸å¿ƒæ¦‚å¿µ
3. **ç¬¬ 3 ç« **ï¼šæ­å»ºæœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼ˆKind/k3d + Skaffoldï¼‰
4. **Part II**ï¼šå­¸ç¿’æ‡‰ç”¨å®¹å™¨åŒ–èˆ‡é…ç½®ç®¡ç†
5. **Part III**ï¼šæŒæ¡ç”Ÿç”¢ç’°å¢ƒæœ€ä½³å¯¦è¸

---

## 9. å¯¦æˆ°ç·´ç¿’

### ç·´ç¿’ 1ï¼šéƒ¨ç½²è‡ªå·±çš„æ‡‰ç”¨

å°‡ä½ çš„æ‡‰ç”¨å®¹å™¨åŒ–ä¸¦éƒ¨ç½²åˆ° K8sï¼š

1. ç·¨å¯« Dockerfile
2. æ§‹å»ºé¡åƒä¸¦æ¨é€åˆ° Docker Hub
3. ç·¨å¯« Deployment å’Œ Service YAML
4. éƒ¨ç½²ä¸¦é©—è­‰

### ç·´ç¿’ 2ï¼šæ¨¡æ“¬æ•…éšœæ¢å¾©

```bash
kubectl delete pod <pod-name>

kubectl get pods -w
```

è§€å¯Ÿ K8s å¦‚ä½•è‡ªå‹•é‡å»º Podã€‚

### ç·´ç¿’ 3ï¼šæ‰‹å‹•æ“´ç¸®å®¹

```bash
kubectl scale deployment nginx-demo --replicas=5

watch kubectl get pods
```

è§€å¯Ÿæ–° Pod çš„å‰µå»ºéç¨‹ã€‚

---

## 10. å°çµ

æœ¬ç« å¾é–‹ç™¼è€…è¦–è§’ä»‹ç´¹äº† Kubernetes çš„æ ¸å¿ƒåƒ¹å€¼å’ŒåŸºæœ¬å·¥ä½œæµç¨‹ï¼š

- âœ… ç†è§£ K8s è§£æ±ºçš„æ ¸å¿ƒå•é¡Œï¼ˆç’°å¢ƒä¸€è‡´æ€§ã€è‡ªå‹•åŒ–ã€é«˜å¯ç”¨ï¼‰
- âœ… æŒæ¡åŸºæœ¬æ¦‚å¿µï¼ˆPodã€Deploymentã€Serviceï¼‰
- âœ… å®Œæˆç¬¬ä¸€å€‹æ‡‰ç”¨çš„éƒ¨ç½²
- âœ… å­¸æœƒåŸºæœ¬çš„èª¿è©¦æ–¹æ³•

**é—œéµè¦é»ï¼š**

- K8s æ˜¯**è²æ˜å¼**çš„ï¼šå‘Šè¨´å®ƒã€ŒæœŸæœ›ç‹€æ…‹ã€ï¼Œå®ƒè² è²¬å¯¦ç¾
- **è‡ªæˆ‘ä¿®å¾©**ï¼šå®¹å™¨æ›äº†è‡ªå‹•é‡å•Ÿ
- **è² è¼‰å‡è¡¡**ï¼šService è‡ªå‹•åˆ†ç™¼æµé‡åˆ°å¤šå€‹ Pod
- **å¯æ“´å±•**ï¼šè¼•é¬†æ“´ç¸®å‰¯æœ¬æ•¸

ä¸‹ä¸€ç« å°‡æ·±å…¥æ¢è¨ Kubernetes çš„æ¶æ§‹è¨­è¨ˆå’Œæ ¸å¿ƒçµ„ä»¶åŸç†ã€‚
