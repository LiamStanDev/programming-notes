# 03-æœ¬åœ°é–‹ç™¼ç’°å¢ƒæ­å»º

> ä½¿ç”¨ Kind/k3d + Skaffold æ‰“é€ é«˜æ•ˆçš„æœ¬åœ° Kubernetes é–‹ç™¼ç’°å¢ƒ

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- é¸æ“‡é©åˆçš„æœ¬åœ° K8s é–‹ç™¼å·¥å…·
- å¿«é€Ÿæ­å»º Kind æˆ– k3d é›†ç¾¤
- æŒæ¡ Skaffold è‡ªå‹•åŒ–é–‹ç™¼å·¥ä½œæµ
- æ•´åˆ IDE èˆ‡èª¿è©¦å·¥å…·

---

## 1. æœ¬åœ°é–‹ç™¼å·¥å…·å°æ¯”

### 1.1 å¸¸è¦‹å·¥å…·é¸å‹

```mermaid
graph TB
    subgraph "è¼•é‡ç´šé–‹ç™¼é›†ç¾¤"
        A[minikube<br/>å–®ç¯€é»ï¼ŒåŠŸèƒ½å®Œæ•´]
        B[Kind<br/>Docker in Docker]
        C[k3d<br/>k3s in Docker]
        D[MicroK8s<br/>Snap å®‰è£]
    end
    
    subgraph "ç”Ÿç”¢ç´šå·¥å…·"
        E[kubeadm<br/>å®˜æ–¹å·¥å…·]
        F[k3s<br/>è¼•é‡ç”Ÿç”¢]
    end
    
    style B fill:#9cf
    style C fill:#9cf
    style A fill:#fc9
```

### 1.2 å·¥å…·å°æ¯”è¡¨

| å·¥å…·                 | å•Ÿå‹•é€Ÿåº¦ | è³‡æºä½”ç”¨ | å¤šç¯€é»   | æ¨è–¦å ´æ™¯             |
| ------------------ | ---- | ---- | ----- | ---------------- |
| **Kind**           | âš¡âš¡âš¡  | ä½    | âœ… æ”¯æŒ  | CI/CDã€å¤šç¯€é»æ¸¬è©¦      |
| **k3d**            | âš¡âš¡âš¡  | æ¥µä½   | âœ… æ”¯æŒ  | æ—¥å¸¸é–‹ç™¼ã€å¿«é€Ÿè¿­ä»£        |
| **minikube**       | âš¡âš¡   | ä¸­    | âœ… æ”¯æŒ  | åŠŸèƒ½å­¸ç¿’ã€æ’ä»¶è±å¯Œ        |
| **MicroK8s**       | âš¡âš¡   | ä¸­    | âœ… æ”¯æŒ  | Ubuntu ç”¨æˆ¶        |
| **Docker Desktop** | âš¡    | é«˜    | âŒ å–®ç¯€é» | Mac/Windows ç°¡å–®å ´æ™¯ |

**æ¨è–¦çµ„åˆï¼š**
- **æ—¥å¸¸é–‹ç™¼**ï¼šk3d + Skaffold
- **CI/CD**ï¼šKind + Tekton
- **å­¸ç¿’åŠŸèƒ½**ï¼šminikube + Dashboard

---

## 2. Kind å¿«é€Ÿæ­å»º

### 2.1 å®‰è£ Kind

```bash
go install sigs.k8s.io/kind@v0.30.0
```

### 2.2 å‰µå»ºé›†ç¾¤

**å–®ç¯€é»é›†ç¾¤ï¼š**
```bash
kind create cluster --name dev

kubectl cluster-info --context kind-dev
```

**å¤šç¯€é»é›†ç¾¤é…ç½®ï¼š**

å‰µå»º `kind-config.yaml`ï¼š
```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

name: dev-cluster

nodes:
- role: control-plane
  image: kindest/node:v1.30.0
  kubeadmConfigPatches:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        node-labels: "ingress-ready=true"
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP

- role: worker
  image: kindest/node:v1.30.0

- role: worker
  image: kindest/node:v1.30.0

networking:
  apiServerAddress: "0.0.0.0"
  apiServerPort: 6443
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"
```

**å•Ÿå‹•é›†ç¾¤ï¼š**
```bash
kind create cluster --config kind-config.yaml

kubectl get nodes
```

**é æœŸè¼¸å‡ºï¼š**
```
NAME                        STATUS   ROLES           AGE   VERSION
dev-cluster-control-plane   Ready    control-plane   60s   v1.30.0
dev-cluster-worker          Ready    <none>          40s   v1.30.0
dev-cluster-worker2         Ready    <none>          40s   v1.30.0
```

### 2.3 Kind æ¶æ§‹

```mermaid
graph TB
    subgraph "Docker Host"
        subgraph "Kind Cluster"
            CP[Control Plane<br/>Docker Container]
            W1[Worker 1<br/>Docker Container]
            W2[Worker 2<br/>Docker Container]
            
            CP -->|Pod Network| W1
            CP -->|Pod Network| W2
        end
        
        LB[Load Balancer<br/>Port Mapping]
    end
    
    Dev[é–‹ç™¼è€…<br/>kubectl] --> LB
    LB --> CP
    
    style CP fill:#9cf
    style W1 fill:#fc9
    style W2 fill:#fc9
```

### 2.4 å¸¸ç”¨æ“ä½œ

```bash
kind get clusters

kind delete cluster --name dev

kind load docker-image myapp:v1.0 --name dev

kind export kubeconfig --name dev

kubectl config get-contexts
kubectl config use-context kind-dev
```

---

## 3. k3d å¿«é€Ÿæ­å»º

### 3.1 å®‰è£ k3d

```bash
wget -q -O - https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

brew install k3d
```

### 3.2 å‰µå»ºé›†ç¾¤

**å–®ç¯€é»å¿«é€Ÿå•Ÿå‹•ï¼š**
```bash
k3d cluster create dev

kubectl get nodes
```

**å®Œæ•´é…ç½®ï¼š**

å‰µå»º `k3d-config.yaml`ï¼š
```yaml
apiVersion: k3d.io/v1alpha5
kind: Simple

metadata:
  name: dev-cluster

servers: 1

agents: 2

image: rancher/k3s:v1.30.0-k3s1

ports:
  - port: 80:80
    nodeFilters:
      - loadbalancer
  - port: 443:443
    nodeFilters:
      - loadbalancer
  - port: 8080:8080
    nodeFilters:
      - loadbalancer

options:
  k3d:
    wait: true
    timeout: "60s"
    disableLoadbalancer: false
    disableImageVolume: false
  
  k3s:
    extraArgs:
      - arg: --disable=traefik
        nodeFilters:
          - server:*
  
  kubeconfig:
    updateDefaultKubeconfig: true
    switchCurrentContext: true

registries:
  create:
    name: registry.localhost
    host: "0.0.0.0"
    hostPort: "5000"
```

**å•Ÿå‹•é›†ç¾¤ï¼š**
```bash
k3d cluster create --config k3d-config.yaml

kubectl get nodes
```

### 3.3 k3d æ¶æ§‹

```mermaid
graph TB
    subgraph "Docker Host"
        subgraph "k3d Cluster"
            LB[k3d-proxy<br/>Load Balancer]
            Server[k3s-server<br/>Control Plane]
            Agent1[k3s-agent-1<br/>Worker]
            Agent2[k3s-agent-2<br/>Worker]
            
            Registry[k3d-registry<br/>:5000]
        end
    end
    
    Dev[é–‹ç™¼è€…] -->|kubectl| LB
    Dev -->|docker push| Registry
    
    LB --> Server
    Server --> Agent1
    Server --> Agent2
    
    Agent1 -.pull images.-> Registry
    Agent2 -.pull images.-> Registry
    
    style LB fill:#9cf
    style Server fill:#fc9
    style Registry fill:#f9c
```

### 3.4 å¸¸ç”¨æ“ä½œ

```bash
k3d cluster list

k3d cluster delete dev

k3d image import myapp:v1.0 -c dev

k3d registry create myregistry.localhost --port 5555

docker tag myapp:v1.0 k3d-myregistry.localhost:5555/myapp:v1.0
docker push k3d-myregistry.localhost:5555/myapp:v1.0
```

---

## 4. Skaffold è‡ªå‹•åŒ–é–‹ç™¼æµç¨‹

### 4.1 Skaffold æ˜¯ä»€éº¼

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- **è‡ªå‹•æ§‹å»º**ï¼šä»£ç¢¼è®Šæ›´è‡ªå‹•æ§‹å»ºé¡åƒ
- **è‡ªå‹•éƒ¨ç½²**ï¼šè‡ªå‹•éƒ¨ç½²åˆ° K8s
- **å¯¦æ™‚åŒæ­¥**ï¼šæ–‡ä»¶è®Šæ›´å³æ™‚åŒæ­¥åˆ° Pod
- **æ—¥èªŒèšåˆ**ï¼šè‡ªå‹•é¡¯ç¤ºæ‰€æœ‰ Pod æ—¥èªŒ

```mermaid
flowchart LR
    A[ä»£ç¢¼è®Šæ›´] --> B[Skaffold åµæ¸¬]
    B --> C[æ§‹å»ºé¡åƒ]
    C --> D[æ¨é€åˆ°å€‰åº«]
    D --> E[éƒ¨ç½²åˆ° K8s]
    E --> F[å¯¦æ™‚æ—¥èªŒè¼¸å‡º]
    F --> G{ç¹¼çºŒé–‹ç™¼}
    G -->|ä¿®æ”¹ä»£ç¢¼| A
    
    style B fill:#9cf
    style E fill:#fc9
```

### 4.2 å®‰è£ Skaffold

```bash
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
chmod +x skaffold
sudo mv skaffold /usr/local/bin

brew install skaffold
```

### 4.3 é …ç›®é…ç½®

**ç›®éŒ„çµæ§‹ï¼š**
```
my-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â””â”€â”€ service.yaml
â””â”€â”€ skaffold.yaml
```

**Dockerfileï¼š**
```dockerfile
FROM python:3.12-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8080

CMD ["python", "main.py"]
```

**skaffold.yamlï¼š**
```yaml
apiVersion: skaffold/v4beta11
kind: Config

metadata:
  name: my-app

build:
  artifacts:
  - image: myapp
    context: .
    docker:
      dockerfile: Dockerfile
    sync:
      manual:
      - src: "src/**/*.py"
        dest: /app/src
  
  local:
    push: false
    useBuildkit: true

deploy:
  kubectl:
    manifests:
    - k8s/*.yaml

portForward:
- resourceType: service
  resourceName: myapp
  port: 80
  localPort: 8080

profiles:
- name: dev
  activation:
  - command: dev
  
  build:
    artifacts:
    - image: myapp
      sync:
        infer:
        - "src/**/*.py"

- name: production
  build:
    artifacts:
    - image: registry.example.com/myapp
    
    tagPolicy:
      gitCommit:
        variant: AbbrevCommitSha
  
  deploy:
    helm:
      releases:
      - name: myapp
        chartPath: helm/myapp
        namespace: production
```

### 4.4 é–‹ç™¼å·¥ä½œæµ

**å•Ÿå‹•é–‹ç™¼æ¨¡å¼ï¼š**
```bash
skaffold dev

skaffold dev --port-forward
```

**å·¥ä½œæµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant Dev as é–‹ç™¼è€…
    participant Skaffold
    participant Docker
    participant K8s
    participant Pod
    
    Dev->>Skaffold: skaffold dev
    Skaffold->>Docker: æ§‹å»ºé¡åƒ
    Docker-->>Skaffold: é¡åƒå®Œæˆ
    Skaffold->>K8s: éƒ¨ç½²è³‡æº
    K8s->>Pod: å‰µå»º Pod
    Pod-->>Skaffold: Pod Ready
    Skaffold-->>Dev: é¡¯ç¤ºæ—¥èªŒ
    
    Dev->>Dev: ä¿®æ”¹ä»£ç¢¼
    Skaffold->>Skaffold: åµæ¸¬è®Šæ›´
    
    alt File Sync æ¨¡å¼
        Skaffold->>Pod: åŒæ­¥æ–‡ä»¶
        Pod->>Pod: ç†±é‡è¼‰
    else Rebuild æ¨¡å¼
        Skaffold->>Docker: é‡æ–°æ§‹å»º
        Docker-->>Skaffold: æ–°é¡åƒ
        Skaffold->>K8s: æ›´æ–°éƒ¨ç½²
    end
    
    Skaffold-->>Dev: å³æ™‚æ—¥èªŒ
```

**å…¶ä»–å‘½ä»¤ï¼š**
```bash
skaffold run

skaffold build

skaffold deploy

skaffold debug

skaffold render
```

---

## 5. IDE æ•´åˆ

### 5.1 VS Code é…ç½®

**å®‰è£æ“´å±•ï¼š**
- Kubernetes
- Bridge to Kubernetes
- YAML
- Docker

**è¨­ç½®ï¼š**

å‰µå»º `.vscode/launch.json`ï¼š
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Kubernetes: Debug (skaffold)",
      "type": "cloudcode.kubernetes",
      "request": "launch",
      "skaffoldConfig": "${workspaceFolder}/skaffold.yaml",
      "watch": true,
      "cleanUp": true,
      "portForward": true
    }
  ]
}
```

### 5.2 èª¿è©¦é…ç½®

**Python é ç¨‹èª¿è©¦ï¼š**

```python
import debugpy

debugpy.listen(("0.0.0.0", 5678))
print("Waiting for debugger attach...")
debugpy.wait_for_client()

app.run(host='0.0.0.0', port=8080)
```

**skaffold.yaml èª¿è©¦é…ç½®ï¼š**
```yaml
build:
  artifacts:
  - image: myapp
    docker:
      dockerfile: Dockerfile.debug

portForward:
- resourceType: deployment
  resourceName: myapp
  port: 5678
  localPort: 5678
```

---

## 6. æœ¬åœ°é¡åƒå€‰åº«

### 6.1 ä½¿ç”¨ k3d å…§ç½®å€‰åº«

```bash
k3d cluster create dev --registry-create registry:0.0.0.0:5000

docker tag myapp:latest localhost:5000/myapp:latest
docker push localhost:5000/myapp:latest

kubectl run test --image=registry:5000/myapp:latest
```

### 6.2 é…ç½® Harbor æœ¬åœ°å€‰åº«

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: registry-config
  namespace: kube-system
data:
  registries.yaml: |
    mirrors:
      "harbor.local":
        endpoint:
          - "http://harbor.local"
    configs:
      "harbor.local":
        auth:
          username: admin
          password: Harbor12345
        tls:
          insecure_skip_verify: true
```

---

## 7. é–‹ç™¼ç’°å¢ƒæœ€ä½³å¯¦è¸

### 7.1 è³‡æºç®¡ç†

**ç‚ºé–‹ç™¼é›†ç¾¤è¨­ç½®è³‡æºé™åˆ¶ï¼š**

```bash
kind create cluster --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraMounts:
  - hostPath: /tmp/k8s-data
    containerPath: /data
  kubeadmConfigPatches:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        system-reserved: cpu=500m,memory=512Mi
        kube-reserved: cpu=500m,memory=512Mi
EOF
```

### 7.2 å‘½åç©ºé–“éš”é›¢

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: dev
  labels:
    env: development

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: dev-quota
  namespace: dev
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    pods: "20"
```

### 7.3 å¿«é€Ÿé‡ç½®ç’°å¢ƒ

```bash
alias k-reset='kubectl delete all --all -n dev && kubectl apply -f k8s/'

alias k-logs='kubectl logs -f -l app=myapp --all-containers=true'

alias k-restart='kubectl rollout restart deployment -n dev'
```

---

## 8. å¸¸è¦‹å•é¡Œèˆ‡è§£æ±º

### 8.1 é¡åƒæ‹‰å–å•é¡Œ

**å•é¡Œï¼š** `ImagePullBackOff`

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
kind load docker-image myapp:latest --name dev

k3d image import myapp:latest -c dev

docker tag myapp:latest localhost:5000/myapp:latest
docker push localhost:5000/myapp:latest
```

### 8.2 ç«¯å£è¡çª

**å•é¡Œï¼š** ç«¯å£å·²è¢«ä½”ç”¨

```bash
lsof -i :80
kill -9 <PID>

k3d cluster create dev -p "8080:80@loadbalancer"
```

### 8.3 è³‡æºä¸è¶³

```bash
docker system prune -a

kind delete cluster --name old-cluster

docker update --memory 4g --cpus 2 <container-id>
```

---

## 9. å®Œæ•´é–‹ç™¼æµç¨‹ç¤ºä¾‹

### 9.1 åˆå§‹åŒ–é …ç›®

```bash
mkdir my-k8s-app && cd my-k8s-app

cat > main.py <<EOF
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello from Kubernetes!'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
EOF

cat > requirements.txt <<EOF
flask==3.0.0
EOF

cat > Dockerfile <<EOF
FROM python:3.12-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]
EOF

mkdir k8s
cat > k8s/deployment.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
EOF

skaffold init
```

### 9.2 å•Ÿå‹•é–‹ç™¼

```bash
k3d cluster create dev -p "8080:80@loadbalancer"

skaffold dev --port-forward
```

**é æœŸè¼¸å‡ºï¼š**
```
Generating tags...
 - myapp -> myapp:latest
Checking cache...
 - myapp: Not found. Building
Building [myapp]...
...
Tags used in deployment:
 - myapp -> myapp:latest
Starting deploy...
 - deployment.apps/myapp created
 - service/myapp created
Waiting for deployments to stabilize...
 - deployment/myapp is ready.
Deployments stabilized in 3.456s
Port forwarding service/myapp in namespace default, remote port 80 -> http://127.0.0.1:8080
Press Ctrl+C to exit
Watching for changes...
```

è¨ªå•ï¼š`http://localhost:8080`

### 9.3 å¯¦æ™‚é–‹ç™¼

**ä¿®æ”¹ `main.py`ï¼š**
```python
@app.route('/')
def hello():
    return 'Hello from Kubernetes! (Updated)'
```

**Skaffold è‡ªå‹•é‡æ–°éƒ¨ç½²ï¼š**
```
Generating tags...
Checking cache...
Building [myapp]...
...
Deploying...
Starting deploy...
 - deployment.apps/myapp configured
Deployments stabilized in 1.234s
```

åˆ·æ–°ç€è¦½å™¨å³å¯çœ‹åˆ°æ›´æ–°ã€‚

---

## 10. å°çµ

æœ¬ç« ä»‹ç´¹äº†æœ¬åœ° Kubernetes é–‹ç™¼ç’°å¢ƒçš„æ­å»ºèˆ‡æœ€ä½³å¯¦è¸ï¼š

**å·¥å…·é¸æ“‡ï¼š**
- âœ… **Kind**ï¼šé©åˆ CI/CD å’Œå¤šç¯€é»æ¸¬è©¦
- âœ… **k3d**ï¼šè¼•é‡å¿«é€Ÿï¼Œæ—¥å¸¸é–‹ç™¼é¦–é¸
- âœ… **Skaffold**ï¼šè‡ªå‹•åŒ–é–‹ç™¼å·¥ä½œæµ

**æ ¸å¿ƒå„ªå‹¢ï¼š**
- âš¡ **å¿«é€Ÿå•Ÿå‹•**ï¼šç§’ç´šå‰µå»ºé›†ç¾¤
- ğŸ”„ **ç†±é‡è¼‰**ï¼šä»£ç¢¼è®Šæ›´å³æ™‚ç”Ÿæ•ˆ
- ğŸ¯ **ç’°å¢ƒä¸€è‡´**ï¼šé–‹ç™¼èˆ‡ç”Ÿç”¢é…ç½®ä¸€è‡´
- ğŸ› ï¸ **IDE æ•´åˆ**ï¼šç„¡ç¸«èª¿è©¦é«”é©—

**ä¸‹ä¸€æ­¥ï¼š**
- å­¸ç¿’æ‡‰ç”¨å®¹å™¨åŒ–èˆ‡é·ç§»ç­–ç•¥ï¼ˆPart IIï¼‰
- æŒæ¡é…ç½®ç®¡ç†èˆ‡ Helm ä½¿ç”¨
- äº†è§£å¾®æœå‹™é€šä¿¡èˆ‡ Service Mesh

ç¾åœ¨ä½ å·²ç¶“å…·å‚™äº†é«˜æ•ˆçš„æœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼Œå¯ä»¥é–‹å§‹å¯¦éš›çš„æ‡‰ç”¨é–‹ç™¼äº†ï¼
