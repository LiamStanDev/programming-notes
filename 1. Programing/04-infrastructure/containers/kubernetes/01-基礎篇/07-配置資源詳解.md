# 07-é…ç½®è³‡æºè©³è§£

> æ·±å…¥æŒæ¡ Kubernetes é…ç½®è³‡æºçš„å®Œæ•´é…ç½®èˆ‡ä½¿ç”¨

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- æ·±å…¥æŒæ¡ ConfigMap çš„å‰µå»ºèˆ‡ä½¿ç”¨æ–¹å¼
- å­¸æœƒ Secret çš„å®‰å…¨ç®¡ç†èˆ‡æœ€ä½³å¯¦è¸
- ç†è§£ ResourceQuota èˆ‡ LimitRange çš„è³‡æºç®¡ç†
- æŒæ¡ HorizontalPodAutoscaler (HPA) è‡ªå‹•æ“´ç¸®å®¹
- å­¸æœƒ PodDisruptionBudget (PDB) ä¿è­·æœå‹™å¯ç”¨æ€§

---

## 1. ConfigMap æ·±åº¦è§£æ

### 1.1 ConfigMap æ˜¯ä»€éº¼

ConfigMap ç”¨æ–¼å­˜å„²éæ©Ÿå¯†çš„é…ç½®æ•¸æ“šï¼Œèˆ‡æ‡‰ç”¨ä»£ç¢¼è§£è€¦ã€‚

```mermaid
graph TB
    subgraph "ConfigMap å‰µå»ºæ–¹å¼"
        L[--from-literal]
        F[--from-file]
        E[--from-env-file]
        Y[YAML å®šç¾©]
    end
    
    subgraph "ConfigMap"
        CM[ConfigMap<br/>app-config]
    end
    
    subgraph "Pod ä½¿ç”¨æ–¹å¼"
        ENV[ç’°å¢ƒè®Šé‡]
        VOL[Volume æ›è¼‰]
        CMD[å‘½ä»¤è¡Œåƒæ•¸]
    end
    
    L --> CM
    F --> CM
    E --> CM
    Y --> CM
    
    CM --> ENV
    CM --> VOL
    CM --> CMD
    
    style CM fill:#9cf
```

---

### 1.2 å‰µå»º ConfigMap

#### 1.2.1 å¾å­—é¢å€¼å‰µå»º

```bash
kubectl create configmap app-config \
  --from-literal=APP_NAME=myapp \
  --from-literal=LOG_LEVEL=info \
  --from-literal=MAX_CONNECTIONS=100
```

#### 1.2.2 å¾æ–‡ä»¶å‰µå»º

```bash
# å‰µå»ºé…ç½®æ–‡ä»¶
cat > app.properties <<EOF
app.name=myapp
app.version=1.0.0
log.level=info
database.host=postgres.default.svc.cluster.local
database.port=5432
EOF

# å¾å–®å€‹æ–‡ä»¶å‰µå»º
kubectl create configmap app-config --from-file=app.properties

# å¾å¤šå€‹æ–‡ä»¶å‰µå»º
kubectl create configmap app-config \
  --from-file=app.properties \
  --from-file=database.conf \
  --from-file=nginx.conf

# å¾ç›®éŒ„å‰µå»º
kubectl create configmap app-config --from-file=./config/
```

#### 1.2.3 å¾ç’°å¢ƒæ–‡ä»¶å‰µå»º

```bash
# .env æ–‡ä»¶
cat > app.env <<EOF
APP_NAME=myapp
LOG_LEVEL=info
MAX_CONNECTIONS=100
EOF

kubectl create configmap app-config --from-env-file=app.env
```

#### 1.2.4 ä½¿ç”¨ YAML å‰µå»º

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: production
  labels:
    app: webapp
data:
  # ç°¡å–®éµå€¼å°
  APP_NAME: "myapp"
  LOG_LEVEL: "info"
  MAX_CONNECTIONS: "100"
  
  # æ–‡ä»¶å…§å®¹ï¼ˆä½¿ç”¨ | æˆ– >ï¼‰
  app.properties: |
    app.name=myapp
    app.version=1.0.0
    log.level=info
    database.host=postgres.default.svc.cluster.local
    database.port=5432
  
  nginx.conf: |
    server {
        listen 80;
        server_name example.com;
        
        location / {
            proxy_pass http://backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
  
  application.yaml: |
    server:
      port: 8080
      shutdown: graceful
    
    spring:
      application:
        name: myapp
      datasource:
        url: jdbc:postgresql://postgres:5432/mydb
        username: ${DB_USER}
        password: ${DB_PASSWORD}
    
    logging:
      level:
        root: INFO
        com.example: DEBUG

immutable: false    # true è¡¨ç¤ºä¸å¯è®Šï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰
```

---

### 1.3 ä½¿ç”¨ ConfigMap

#### 1.3.1 ç’°å¢ƒè®Šé‡æ³¨å…¥

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    
    # æ–¹å¼ 1ï¼šå–®å€‹ç’°å¢ƒè®Šé‡
    env:
    - name: APP_NAME
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: APP_NAME
    
    - name: LOG_LEVEL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: LOG_LEVEL
          optional: true    # key ä¸å­˜åœ¨æ™‚ä¸å ±éŒ¯
    
    # æ–¹å¼ 2ï¼šæ‰€æœ‰ key ä½œç‚ºç’°å¢ƒè®Šé‡
    envFrom:
    - configMapRef:
        name: app-config
    
    # æ–¹å¼ 3ï¼šæ·»åŠ å‰ç¶´
    - configMapRef:
        name: db-config
      prefix: DB_
```

#### 1.3.2 Volume æ›è¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: nginx:1.27
    volumeMounts:
    # æ›è¼‰æ•´å€‹ ConfigMap
    - name: config
      mountPath: /etc/config
      readOnly: true
    
    # æ›è¼‰å–®å€‹ key åˆ°æŒ‡å®šè·¯å¾‘
    - name: nginx-config
      mountPath: /etc/nginx/conf.d/default.conf
      subPath: nginx.conf
      readOnly: true
  
  volumes:
  # æ›è¼‰æ•´å€‹ ConfigMap
  - name: config
    configMap:
      name: app-config
      defaultMode: 0644
  
  # é¸æ“‡æ€§æ›è¼‰
  - name: nginx-config
    configMap:
      name: app-config
      items:
      - key: nginx.conf
        path: nginx.conf
        mode: 0644
      - key: app.properties
        path: config/app.properties
```

#### 1.3.3 å‘½ä»¤è¡Œåƒæ•¸

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    command: ["/app/server"]
    args:
    - --name=$(APP_NAME)
    - --log-level=$(LOG_LEVEL)
    - --max-connections=$(MAX_CONNECTIONS)
    
    env:
    - name: APP_NAME
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: APP_NAME
    - name: LOG_LEVEL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: LOG_LEVEL
    - name: MAX_CONNECTIONS
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: MAX_CONNECTIONS
```

---

### 1.4 ConfigMap å‹•æ…‹æ›´æ–°

```mermaid
sequenceDiagram
    participant Admin
    participant ConfigMap
    participant Kubelet
    participant Pod
    participant App
    
    Admin->>ConfigMap: æ›´æ–° ConfigMap
    Kubelet->>ConfigMap: å®šæœŸåŒæ­¥<br/>(é»˜èª 60s)
    Kubelet->>Pod: æ›´æ–°æ›è¼‰çš„æ–‡ä»¶
    
    Note over App: æ–¹å¼ 1: æ‡‰ç”¨è‡ªå‹•æª¢æ¸¬è®Šæ›´
    App->>App: é‡è¼‰é…ç½®
    
    Note over Admin,App: æ–¹å¼ 2: é‡å•Ÿ Pod
    Admin->>Pod: kubectl rollout restart
    Pod->>App: æ‡‰ç”¨é‡å•Ÿ
```

**æ³¨æ„äº‹é …ï¼š**
- âœ… Volume æ›è¼‰ï¼šè‡ªå‹•æ›´æ–°ï¼ˆå»¶é² 60sï¼‰
- âŒ ç’°å¢ƒè®Šé‡ï¼šä¸æœƒæ›´æ–°ï¼Œéœ€è¦é‡å•Ÿ Pod
- âŒ subPath æ›è¼‰ï¼šä¸æœƒæ›´æ–°

**è§¸ç™¼ Pod é‡å•Ÿï¼š**

```bash
# æ–¹å¼ 1ï¼šæ·»åŠ  annotation è§¸ç™¼æ›´æ–°
kubectl patch deployment webapp -p \
  '{"spec":{"template":{"metadata":{"annotations":{"configmap-version":"'$(date +%s)'"}}}}}'

# æ–¹å¼ 2ï¼šä½¿ç”¨ rollout restart
kubectl rollout restart deployment webapp

# æ–¹å¼ 3ï¼šä½¿ç”¨ Reloaderï¼ˆè‡ªå‹•åŒ–å·¥å…·ï¼‰
# https://github.com/stakater/Reloader
```

---

### 1.5 ConfigMap å¯¦æˆ°æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1ï¼šNginx é…ç½®ç®¡ç†

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 1024;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        
        access_log /var/log/nginx/access.log main;
        
        sendfile on;
        keepalive_timeout 65;
        
        include /etc/nginx/conf.d/*.conf;
    }
  
  default.conf: |
    upstream backend {
        server api-service:8080;
    }
    
    server {
        listen 80;
        server_name example.com;
        
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        location /api/ {
            proxy_pass http://backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.27
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
      
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
```

---

## 2. Secret æ·±åº¦è§£æ

### 2.1 Secret é¡å‹

```mermaid
graph TB
    subgraph "Secret é¡å‹"
        O[Opaque<br/>é€šç”¨]
        SA[kubernetes.io/service-account-token<br/>ServiceAccount Token]
        DR[kubernetes.io/dockerconfigjson<br/>Docker Registry]
        TLS[kubernetes.io/tls<br/>TLS è­‰æ›¸]
        SSH[kubernetes.io/ssh-auth<br/>SSH å¯†é‘°]
        BA[kubernetes.io/basic-auth<br/>Basic Auth]
    end
    
    style O fill:#9cf
    style DR fill:#fc9
    style TLS fill:#9f9
```

---

### 2.2 å‰µå»º Secret

#### 2.2.1 Opaque Secretï¼ˆé€šç”¨ï¼‰

```bash
# å¾å­—é¢å€¼å‰µå»º
kubectl create secret generic db-credentials \
  --from-literal=username=admin \
  --from-literal=password=SuperSecretPassword123

# å¾æ–‡ä»¶å‰µå»º
echo -n 'admin' > username.txt
echo -n 'SuperSecretPassword123' > password.txt
kubectl create secret generic db-credentials \
  --from-file=username=username.txt \
  --from-file=password=password.txt

# ä½¿ç”¨ YAML
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
type: Opaque
stringData:
  username: admin
  password: SuperSecretPassword123
EOF

# æˆ–ä½¿ç”¨ base64 ç·¨ç¢¼
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
type: Opaque
data:
  username: $(echo -n 'admin' | base64)
  password: $(echo -n 'SuperSecretPassword123' | base64)
EOF
```

#### 2.2.2 Docker Registry Secret

```bash
kubectl create secret docker-registry regcred \
  --docker-server=myregistry.io \
  --docker-username=myuser \
  --docker-password=mypassword \
  --docker-email=user@example.com
```

**åœ¨ Pod ä¸­ä½¿ç”¨ï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  imagePullSecrets:
  - name: regcred
  
  containers:
  - name: app
    image: myregistry.io/myapp:v1.0
```

#### 2.2.3 TLS Secret

```bash
# å‰µå»ºè‡ªç°½åè­‰æ›¸
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt -subj "/CN=example.com"

# å‰µå»º TLS Secret
kubectl create secret tls example-com-tls \
  --cert=tls.crt \
  --key=tls.key
```

**åœ¨ Ingress ä¸­ä½¿ç”¨ï¼š**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-ingress
spec:
  tls:
  - hosts:
    - example.com
    secretName: example-com-tls
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
```

#### 2.2.4 SSH Auth Secret

```bash
ssh-keygen -t rsa -b 4096 -f id_rsa -N ""

kubectl create secret generic ssh-key \
  --from-file=ssh-privatekey=id_rsa \
  --from-file=ssh-publickey=id_rsa.pub
```

#### 2.2.5 Basic Auth Secret

```bash
htpasswd -c auth admin
kubectl create secret generic basic-auth --from-file=auth
```

---

### 2.3 ä½¿ç”¨ Secret

#### 2.3.1 ç’°å¢ƒè®Šé‡æ³¨å…¥

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    
    # å–®å€‹ç’°å¢ƒè®Šé‡
    env:
    - name: DB_USER
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: username
    
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: password
    
    # æ‰€æœ‰ key ä½œç‚ºç’°å¢ƒè®Šé‡
    envFrom:
    - secretRef:
        name: db-credentials
```

#### 2.3.2 Volume æ›è¼‰ï¼ˆæ¨è–¦ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    volumeMounts:
    - name: secrets
      mountPath: /etc/secrets
      readOnly: true
  
  volumes:
  - name: secrets
    secret:
      secretName: db-credentials
      defaultMode: 0400    # åªè®€æ¬Šé™
      items:
      - key: username
        path: db-user
        mode: 0400
      - key: password
        path: db-pass
        mode: 0400
```

---

### 2.4 Secret å®‰å…¨æœ€ä½³å¯¦è¸

```yaml
# âœ… å¥½çš„å¯¦è¸
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    
    # âœ… ä½¿ç”¨ Volume æ›è¼‰
    volumeMounts:
    - name: secrets
      mountPath: /etc/secrets
      readOnly: true
    
    # âœ… ä½¿ç”¨ projected volumeï¼ˆæ›´éˆæ´»ï¼‰
    - name: all-secrets
      mountPath: /var/secrets
      readOnly: true
  
  volumes:
  - name: secrets
    secret:
      secretName: db-credentials
      defaultMode: 0400
  
  - name: all-secrets
    projected:
      defaultMode: 0400
      sources:
      - secret:
          name: db-credentials
          items:
          - key: password
            path: db/password
      - secret:
          name: api-key
          items:
          - key: key
            path: api/key
  
  # âœ… å•Ÿç”¨ ServiceAccount Token è‡ªå‹•æ›è¼‰
  serviceAccountName: webapp-sa
  automountServiceAccountToken: true

---
# âŒ é¿å…çš„åšæ³•
apiVersion: v1
kind: Pod
metadata:
  name: bad-example
spec:
  containers:
  - name: app
    image: myapp:v1.0
    
    # âŒ ç’°å¢ƒè®Šé‡æœƒæš´éœ²åœ¨é€²ç¨‹åˆ—è¡¨
    env:
    - name: DB_PASSWORD
      value: "hardcoded-password"    # æ›´ç³Ÿç³•ï¼šç¡¬ç·¨ç¢¼
    
    # âŒ æ—¥èªŒä¸­å¯èƒ½æ´©éœ²
    command: ["/bin/sh", "-c"]
    args:
    - echo "Password is $DB_PASSWORD"
```

**å®‰å…¨å»ºè­°ï¼š**
- âœ… ä½¿ç”¨ Volume æ›è¼‰è€Œéç’°å¢ƒè®Šé‡
- âœ… è¨­ç½® `readOnly: true`
- âœ… è¨­ç½®åš´æ ¼æ–‡ä»¶æ¬Šé™ï¼ˆ0400ï¼‰
- âœ… ä½¿ç”¨ RBAC é™åˆ¶è¨ªå•
- âœ… å•Ÿç”¨åŠ å¯†ï¼ˆetcd åŠ å¯†ï¼‰
- âœ… ä½¿ç”¨å¤–éƒ¨å¯†é‘°ç®¡ç†ç³»çµ±ï¼ˆVaultã€AWS Secrets Managerï¼‰
- âŒ é¿å…åœ¨æ—¥èªŒä¸­è¼¸å‡ºå¯†é‘°
- âŒ é¿å…ç¡¬ç·¨ç¢¼

---

### 2.5 å¤–éƒ¨å¯†é‘°ç®¡ç†é›†æˆ

#### 2.5.1 HashiCorp Vault

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "myapp"
    vault.hashicorp.com/agent-inject-secret-database: "secret/data/database"
spec:
  serviceAccountName: webapp-sa
  containers:
  - name: app
    image: myapp:v1.0
    # Vault Agent è‡ªå‹•æ³¨å…¥åˆ° /vault/secrets/database
```

#### 2.5.2 External Secrets Operator

```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  
  target:
    name: db-credentials
    creationPolicy: Owner
  
  data:
  - secretKey: username
    remoteRef:
      key: prod/database
      property: username
  
  - secretKey: password
    remoteRef:
      key: prod/database
      property: password
```

---

## 3. ResourceQuotaï¼ˆè³‡æºé…é¡ï¼‰

### 3.1 ResourceQuota åŸºç¤

```mermaid
graph TB
    subgraph "Namespace: development"
        RQ[ResourceQuota<br/>é™åˆ¶è³‡æºä½¿ç”¨]
        
        P1[Pod 1<br/>CPU: 1, Mem: 1Gi]
        P2[Pod 2<br/>CPU: 1, Mem: 1Gi]
        P3[Pod 3 âœ—<br/>è¶…å‡ºé…é¡]
    end
    
    RQ -->|å…è¨±| P1
    RQ -->|å…è¨±| P2
    RQ -.æ‹’çµ•.-> P3
    
    style RQ fill:#9cf
    style P3 fill:#f96
```

---

### 3.2 ResourceQuota é…ç½®

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: dev-quota
  namespace: development
spec:
  hard:
    # è¨ˆç®—è³‡æº
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    
    # å­˜å„²è³‡æº
    requests.storage: 100Gi
    persistentvolumeclaims: "10"
    
    # å°è±¡æ•¸é‡
    pods: "50"
    services: "10"
    services.loadbalancers: "2"
    services.nodeports: "5"
    secrets: "20"
    configmaps: "20"
    replicationcontrollers: "10"
    
    # è³‡æºé…é¡ä½œç”¨åŸŸ
    count/deployments.apps: "10"
    count/replicasets.apps: "20"
    count/jobs.batch: "10"
    count/cronjobs.batch: "5"
```

---

### 3.3 ä½œç”¨åŸŸé™åˆ¶

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: priority-high-quota
  namespace: production
spec:
  hard:
    requests.cpu: "20"
    requests.memory: 40Gi
  
  # åªå°é«˜å„ªå…ˆç´š Pod ç”Ÿæ•ˆ
  scopeSelector:
    matchExpressions:
    - scopeName: PriorityClass
      operator: In
      values:
      - high
      - critical

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: best-effort-quota
  namespace: development
spec:
  hard:
    pods: "100"
  
  # åªå° BestEffort QoS ç”Ÿæ•ˆ
  scopes:
  - BestEffort
```

**å¯ç”¨ä½œç”¨åŸŸï¼š**
- `Terminating`ï¼šæœ‰ `activeDeadlineSeconds` çš„ Pod
- `NotTerminating`ï¼šç„¡ `activeDeadlineSeconds` çš„ Pod
- `BestEffort`ï¼šQoS ç‚º BestEffort çš„ Pod
- `NotBestEffort`ï¼šQoS ä¸æ˜¯ BestEffort çš„ Pod
- `PriorityClass`ï¼šç‰¹å®šå„ªå…ˆç´šé¡åˆ¥çš„ Pod

---

### 3.4 æŸ¥çœ‹è³‡æºé…é¡ä½¿ç”¨æƒ…æ³

```bash
# æŸ¥çœ‹ ResourceQuota
kubectl get resourcequota -n development
kubectl describe resourcequota dev-quota -n development

# è¼¸å‡ºç¤ºä¾‹ï¼š
# Name:                   dev-quota
# Namespace:              development
# Resource                Used   Hard
# --------                ----   ----
# requests.cpu            5      10
# requests.memory         10Gi   20Gi
# limits.cpu              10     20
# limits.memory           20Gi   40Gi
# pods                    25     50
# services                5      10
```

---

## 4. LimitRangeï¼ˆé»˜èªè³‡æºé™åˆ¶ï¼‰

### 4.1 LimitRange åŸºç¤

```mermaid
graph LR
    LR[LimitRange] -->|è¨­ç½®é»˜èªå€¼| P1[Pod æœªæŒ‡å®š resources]
    LR -->|é©—è­‰ç¯„åœ| P2[Pod æŒ‡å®š resources]
    
    P1 --> A[è‡ªå‹•è¨­ç½®<br/>requests/limits]
    P2 --> B{åœ¨ç¯„åœå…§?}
    B -->|æ˜¯| C[å‰µå»ºæˆåŠŸ]
    B -->|å¦| D[æ‹’çµ•å‰µå»º]
    
    style LR fill:#9cf
    style D fill:#f96
```

---

### 4.2 LimitRange é…ç½®

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: resource-limits
  namespace: development
spec:
  limits:
  # Container ç´šåˆ¥
  - type: Container
    default:    # é»˜èª limits
      cpu: 500m
      memory: 512Mi
    defaultRequest:    # é»˜èª requests
      cpu: 100m
      memory: 128Mi
    max:    # æœ€å¤§å€¼
      cpu: 2000m
      memory: 2Gi
    min:    # æœ€å°å€¼
      cpu: 50m
      memory: 64Mi
    maxLimitRequestRatio:    # limits/requests æœ€å¤§æ¯”ä¾‹
      cpu: 4
      memory: 4
  
  # Pod ç´šåˆ¥
  - type: Pod
    max:
      cpu: 4000m
      memory: 8Gi
    min:
      cpu: 100m
      memory: 128Mi
  
  # PVC ç´šåˆ¥
  - type: PersistentVolumeClaim
    max:
      storage: 10Gi
    min:
      storage: 1Gi
```

---

### 4.3 LimitRange å¯¦æˆ°

```yaml
# å‰µå»º LimitRange
apiVersion: v1
kind: LimitRange
metadata:
  name: mem-limit-range
  namespace: development
spec:
  limits:
  - type: Container
    default:
      memory: 512Mi
    defaultRequest:
      memory: 256Mi
    max:
      memory: 1Gi
    min:
      memory: 128Mi

---
# Pod æœªæŒ‡å®š resourcesï¼ˆè‡ªå‹•è¨­ç½®ï¼‰
apiVersion: v1
kind: Pod
metadata:
  name: pod-no-resources
  namespace: development
spec:
  containers:
  - name: app
    image: nginx:1.27
    # è‡ªå‹•è¨­ç½®ï¼š
    # resources:
    #   requests:
    #     memory: 256Mi
    #   limits:
    #     memory: 512Mi

---
# Pod è¶…å‡ºé™åˆ¶ï¼ˆå‰µå»ºå¤±æ•—ï¼‰
apiVersion: v1
kind: Pod
metadata:
  name: pod-exceed-limit
  namespace: development
spec:
  containers:
  - name: app
    image: nginx:1.27
    resources:
      requests:
        memory: 2Gi    # è¶…é max: 1Gi
      limits:
        memory: 2Gi
    # Error: Pod exceeds memory limit
```

---

## 5. HorizontalPodAutoscaler (HPA)

### 5.1 HPA å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant HPA as HPA Controller
    participant Metrics as Metrics Server
    participant Deployment
    participant Pods
    
    loop æ¯ 15 ç§’
        HPA->>Metrics: æŸ¥è©¢ Pod æŒ‡æ¨™
        Metrics->>HPA: è¿”å› CPU/Memory ä½¿ç”¨ç‡
        HPA->>HPA: è¨ˆç®—ç›®æ¨™å‰¯æœ¬æ•¸
        
        alt CPU > 70%
            HPA->>Deployment: æ“´å®¹ (scale up)
            Deployment->>Pods: å‰µå»ºæ–° Pod
        else CPU < 50%
            HPA->>Deployment: ç¸®å®¹ (scale down)
            Deployment->>Pods: åˆªé™¤ Pod
        else åœ¨ç¯„åœå…§
            HPA->>HPA: ä¿æŒä¸è®Š
        end
    end
```

---

### 5.2 å®‰è£ Metrics Server

```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# æŸ¥çœ‹
kubectl get pods -n kube-system | grep metrics-server
kubectl top nodes
kubectl top pods
```

---

### 5.3 åŸºæ–¼ CPU çš„ HPA

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webapp-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  
  minReplicas: 2
  maxReplicas: 10
  
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Min
    
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 4
        periodSeconds: 30
      selectPolicy: Max
```

---

### 5.4 å¤šæŒ‡æ¨™ HPA

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webapp-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  
  minReplicas: 2
  maxReplicas: 20
  
  metrics:
  # CPU
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  # Memory
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  
  # è‡ªå®šç¾©æŒ‡æ¨™ï¼ˆPrometheusï¼‰
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "1000"
  
  # å¤–éƒ¨æŒ‡æ¨™ï¼ˆSQS éšŠåˆ—é•·åº¦ï¼‰
  - type: External
    external:
      metric:
        name: sqs_queue_length
        selector:
          matchLabels:
            queue_name: my-queue
      target:
        type: Value
        value: "100"
```

---

### 5.5 HPA æ“ä½œ

```bash
# å‰µå»º HPAï¼ˆç°¡å–®æ–¹å¼ï¼‰
kubectl autoscale deployment webapp \
  --cpu-percent=70 \
  --min=2 \
  --max=10

# æŸ¥çœ‹ HPA
kubectl get hpa
kubectl describe hpa webapp-hpa

# è¼¸å‡ºç¤ºä¾‹ï¼š
# NAME         REFERENCE           TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
# webapp-hpa   Deployment/webapp   45%/70%   2         10        3          5m

# æŸ¥çœ‹äº‹ä»¶
kubectl get events --field-selector involvedObject.name=webapp-hpa

# åˆªé™¤ HPA
kubectl delete hpa webapp-hpa
```

---

## 6. PodDisruptionBudget (PDB)

### 6.1 PDB æ˜¯ä»€éº¼

PDB é™åˆ¶åŒæ™‚ä¸­æ–·çš„ Pod æ•¸é‡ï¼Œä¿è­·æœå‹™å¯ç”¨æ€§ã€‚

```mermaid
graph TB
    subgraph "ç„¡ PDB"
        N1[5 å€‹ Pod] --> N2[Node ç¶­è­·]
        N2 --> N3[åŒæ™‚é©…é€ 3 å€‹ Pod]
        N3 --> N4[æœå‹™ä¸­æ–·]
    end
    
    subgraph "æœ‰ PDB"
        P1[5 å€‹ Pod] --> P2[Node ç¶­è­·]
        P2 --> P3[PDB: maxUnavailable=1]
        P3 --> P4[é€å€‹é©…é€]
        P4 --> P5[æœå‹™æ­£å¸¸]
    end
    
    style N4 fill:#f96
    style P5 fill:#9f9
```

---

### 6.2 PDB é…ç½®

```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: webapp-pdb
spec:
  # é¸æ“‡å™¨
  selector:
    matchLabels:
      app: webapp
  
  # æ–¹å¼ 1ï¼šæœ€å°‘å¯ç”¨ Pod æ•¸
  minAvailable: 2
  
  # æ–¹å¼ 2ï¼šæœ€å¤šä¸å¯ç”¨ Pod æ•¸ï¼ˆäºŒé¸ä¸€ï¼‰
  # maxUnavailable: 1
  
  # unhealthyPodEvictionPolicyï¼ˆKubernetes 1.26+ï¼‰
  unhealthyPodEvictionPolicy: IfHealthyBudget
```

**minAvailable vs maxUnavailableï¼š**

| ç¸½ Pod æ•¸ | minAvailable: 2 | maxUnavailable: 1 | å…è¨±ä¸­æ–·æ•¸ |
|----------|----------------|-------------------|----------|
| 3 | æœ€å°‘ 2 å€‹å¯ç”¨ | æœ€å¤š 1 å€‹ä¸å¯ç”¨ | 1 |
| 5 | æœ€å°‘ 2 å€‹å¯ç”¨ | æœ€å¤š 1 å€‹ä¸å¯ç”¨ | 3 vs 1 |
| 10 | æœ€å°‘ 2 å€‹å¯ç”¨ | æœ€å¤š 1 å€‹ä¸å¯ç”¨ | 8 vs 1 |

---

### 6.3 ç™¾åˆ†æ¯”é…ç½®

```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: webapp-pdb
spec:
  selector:
    matchLabels:
      app: webapp
  
  # æœ€å°‘ 80% å¯ç”¨
  minAvailable: 80%
  
  # æˆ–æœ€å¤š 20% ä¸å¯ç”¨
  # maxUnavailable: 20%
```

---

### 6.4 PDB å¯¦æˆ°æ¡ˆä¾‹

```yaml
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 5
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
# PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: webapp-pdb
spec:
  selector:
    matchLabels:
      app: webapp
  minAvailable: 3    # 5 å€‹ Pod ä¸­æœ€å°‘ 3 å€‹å¯ç”¨
```

**æ¸¬è©¦ PDBï¼š**

```bash
# é©…é€ Podï¼ˆæœƒè¢« PDB é™åˆ¶ï¼‰
kubectl drain node-1 --ignore-daemonsets --delete-emptydir-data

# æŸ¥çœ‹ PDB ç‹€æ…‹
kubectl get pdb webapp-pdb
# NAME         MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
# webapp-pdb   3               N/A               2                     5m

kubectl describe pdb webapp-pdb
```

---

## 7. å°çµ

æœ¬ç« æ·±å…¥è¬›è§£äº† Kubernetes çš„é…ç½®è³‡æºï¼š

**é…ç½®ç®¡ç†ï¼š**
- âœ… **ConfigMap**ï¼šéæ©Ÿå¯†é…ç½®æ•¸æ“šï¼ˆç’°å¢ƒè®Šé‡ã€æ–‡ä»¶ã€å‘½ä»¤è¡Œåƒæ•¸ï¼‰
- âœ… **Secret**ï¼šæ©Ÿå¯†æ•¸æ“šï¼ˆå¯†ç¢¼ã€å¯†é‘°ã€è­‰æ›¸ï¼‰

**è³‡æºç®¡ç†ï¼š**
- âœ… **ResourceQuota**ï¼šå‘½åç©ºé–“ç´šåˆ¥è³‡æºé…é¡
- âœ… **LimitRange**ï¼šé»˜èªè³‡æºé™åˆ¶èˆ‡ç¯„åœé©—è­‰

**è‡ªå‹•åŒ–ï¼š**
- âœ… **HorizontalPodAutoscaler (HPA)**ï¼šåŸºæ–¼æŒ‡æ¨™çš„è‡ªå‹•æ“´ç¸®å®¹
- âœ… **PodDisruptionBudget (PDB)**ï¼šä¿è­·æœå‹™å¯ç”¨æ€§

**æœ€ä½³å¯¦è¸ï¼š**
- âœ… ConfigMap ç”¨æ–¼é…ç½®ï¼ŒSecret ç”¨æ–¼å¯†é‘°
- âœ… Secret ä½¿ç”¨ Volume æ›è¼‰è€Œéç’°å¢ƒè®Šé‡
- âœ… è¨­ç½® ResourceQuota é˜²æ­¢è³‡æºè€—ç›¡
- âœ… ä½¿ç”¨ HPA å¯¦ç¾å½ˆæ€§ä¼¸ç¸®
- âœ… é…ç½® PDB ä¿è­·é—œéµæœå‹™

ä¸‹ä¸€ç« å°‡é€²å…¥é–‹ç™¼ç¯‡ï¼Œå­¸ç¿’é€²éšè³‡æºä½¿ç”¨èˆ‡ Helm åŒ…ç®¡ç†ã€‚

---

## åƒè€ƒè³‡æ–™ (References)

1. [Kubernetes å®˜æ–¹æ–‡æª” - ConfigMaps](https://kubernetes.io/docs/concepts/configuration/configmap/)
2. [Kubernetes å®˜æ–¹æ–‡æª” - Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)
3. [Kubernetes å®˜æ–¹æ–‡æª” - Resource Quotas](https://kubernetes.io/docs/concepts/policy/resource-quotas/)
4. [Kubernetes å®˜æ–¹æ–‡æª” - Limit Ranges](https://kubernetes.io/docs/concepts/policy/limit-range/)
5. [Kubernetes å®˜æ–¹æ–‡æª” - HPA](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)
6. [Kubernetes å®˜æ–¹æ–‡æª” - PDB](https://kubernetes.io/docs/concepts/workloads/pods/disruptions/)
