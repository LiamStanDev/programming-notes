# 06-å­˜å„²è³‡æºè©³è§£

> æ·±å…¥æŒæ¡ Kubernetes å­˜å„²è³‡æºçš„å®Œæ•´é…ç½®èˆ‡ä½¿ç”¨

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- ç†è§£ Kubernetes å­˜å„²æ¶æ§‹èˆ‡æŠ½è±¡å±¤æ¬¡
- æŒæ¡ Volume çš„å„ç¨®é¡å‹èˆ‡ä½¿ç”¨å ´æ™¯
- æ·±å…¥å­¸ç¿’ PersistentVolume èˆ‡ PersistentVolumeClaim
- å­¸æœƒé…ç½® StorageClass å¯¦ç¾å‹•æ…‹å­˜å„²ä¾›æ‡‰
- ç†è§£ CSI å®¹å™¨å­˜å„²æ¥å£
- æŒæ¡å­˜å„²çš„æœ€ä½³å¯¦è¸èˆ‡æ•…éšœæ’æŸ¥

---

## 1. Kubernetes å­˜å„²æ¶æ§‹

### 1.1 å­˜å„²æŠ½è±¡å±¤æ¬¡

```mermaid
graph TB
    subgraph "æ‡‰ç”¨å±¤"
        Pod[Pod]
    end
    
    subgraph "Kubernetes æŠ½è±¡å±¤"
        PVC[PersistentVolumeClaim<br/>å­˜å„²è«‹æ±‚]
        PV[PersistentVolume<br/>å­˜å„²è³‡æº]
        SC[StorageClass<br/>å­˜å„²é¡åˆ¥]
    end
    
    subgraph "å­˜å„²å¯¦ç¾å±¤"
        CSI[CSI Driver]
        Backend[å­˜å„²å¾Œç«¯<br/>AWS EBS/GCP PD/Ceph/NFS]
    end
    
    Pod --> PVC
    PVC --> PV
    PV --> CSI
    SC -.å‹•æ…‹å‰µå»º.-> PV
    CSI --> Backend
    
    style PVC fill:#9cf
    style PV fill:#fc9
    style SC fill:#9f9
```

---

### 1.2 å­˜å„²é¡å‹æ¦‚è¦½

```mermaid
graph TB
    subgraph "è‡¨æ™‚å­˜å„² (Ephemeral)"
        E1[emptyDir<br/>Pod ç´šåˆ¥]
        E2[ConfigMap<br/>é…ç½®æ–‡ä»¶]
        E3[Secret<br/>å¯†é‘°]
    end
    
    subgraph "ç¯€é»æœ¬åœ°å­˜å„²"
        N1[hostPath<br/>ä¸»æ©Ÿè·¯å¾‘]
        N2[Local PV<br/>æœ¬åœ°æŒä¹…å·]
    end
    
    subgraph "ç¶²è·¯å­˜å„²"
        Net1[NFS]
        Net2[iSCSI]
        Net3[Ceph RBD]
        Net4[GlusterFS]
    end
    
    subgraph "é›²ç«¯å­˜å„²"
        C1[AWS EBS]
        C2[GCP PD]
        C3[Azure Disk]
    end
    
    subgraph "æŠ½è±¡å±¤"
        PVC[PVC + StorageClass]
    end
    
    PVC --> Net1
    PVC --> Net2
    PVC --> C1
    PVC --> C2
    
    style E1 fill:#fc9
    style PVC fill:#9cf
    style C1 fill:#9f9
```

---

## 2. Volume é¡å‹è©³è§£

### 2.1 emptyDirï¼ˆè‡¨æ™‚å­˜å„²ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-emptydir
spec:
  containers:
  - name: app
    image: nginx:1.27
    volumeMounts:
    - name: cache
      mountPath: /cache
    - name: logs
      mountPath: /var/log/nginx
  
  - name: log-processor
    image: busybox:1.36
    command: ['sh', '-c', 'tail -f /logs/access.log']
    volumeMounts:
    - name: logs
      mountPath: /logs
  
  volumes:
  - name: cache
    emptyDir: {}
  
  - name: logs
    emptyDir:
      sizeLimit: 1Gi    # é™åˆ¶å¤§å°
```

**emptyDir ç‰¹æ€§ï¼š**
- âœ… Pod å‰µå»ºæ™‚è‡ªå‹•å‰µå»º
- âœ… Pod åˆªé™¤æ™‚è‡ªå‹•æ¸…é™¤
- âœ… åŒä¸€ Pod å…§å®¹å™¨å¯å…±äº«
- âœ… é»˜èªå­˜å„²åœ¨ç¯€é»ç£ç›¤ä¸Š
- âœ… å¯é¸ä½¿ç”¨å…§å­˜ï¼ˆ`medium: Memory`ï¼‰

**ä½¿ç”¨å ´æ™¯ï¼š**
- è‡¨æ™‚ç·©å­˜
- å®¹å™¨é–“å…±äº«æ•¸æ“š
- æ—¥èªŒæ”¶é›†

**å…§å­˜æ¨¡å¼ï¼š**

```yaml
volumes:
- name: mem-cache
  emptyDir:
    medium: Memory
    sizeLimit: 512Mi
```

---

### 2.2 hostPathï¼ˆä¸»æ©Ÿè·¯å¾‘ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-hostpath
spec:
  containers:
  - name: app
    image: nginx:1.27
    volumeMounts:
    - name: host-data
      mountPath: /data
    - name: docker-socket
      mountPath: /var/run/docker.sock
  
  volumes:
  - name: host-data
    hostPath:
      path: /mnt/data
      type: DirectoryOrCreate
  
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock
      type: Socket
```

**hostPath é¡å‹ï¼š**

| é¡å‹ | èªªæ˜ |
|-----|------|
| `DirectoryOrCreate` | ç›®éŒ„ä¸å­˜åœ¨å‰‡å‰µå»º |
| `Directory` | å¿…é ˆå­˜åœ¨çš„ç›®éŒ„ |
| `FileOrCreate` | æ–‡ä»¶ä¸å­˜åœ¨å‰‡å‰µå»º |
| `File` | å¿…é ˆå­˜åœ¨çš„æ–‡ä»¶ |
| `Socket` | UNIX Socket |
| `CharDevice` | å­—ç¬¦è¨­å‚™ |
| `BlockDevice` | å¡Šè¨­å‚™ |

**æ³¨æ„äº‹é …ï¼š**
- âš ï¸ Pod èª¿åº¦åˆ°ä¸åŒç¯€é»ï¼Œæ•¸æ“šä¸åŒ
- âš ï¸ å­˜åœ¨å®‰å…¨é¢¨éšªï¼ˆè¨ªå•ä¸»æ©Ÿæ–‡ä»¶ç³»çµ±ï¼‰
- âš ï¸ åƒ…é©åˆç‰¹æ®Šå ´æ™¯ï¼ˆDaemonSetã€ç›£æ§ä»£ç†ï¼‰

---

### 2.3 configMap Volume

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  app.conf: |
    server {
        listen 80;
        server_name example.com;
        root /usr/share/nginx/html;
    }
  
  database.conf: |
    host=postgres.default.svc.cluster.local
    port=5432
    database=mydb

---
apiVersion: v1
kind: Pod
metadata:
  name: test-configmap
spec:
  containers:
  - name: app
    image: nginx:1.27
    volumeMounts:
    # æ›è¼‰æ•´å€‹ ConfigMap
    - name: config
      mountPath: /etc/config
    
    # æ›è¼‰å–®å€‹ key
    - name: nginx-config
      mountPath: /etc/nginx/conf.d/default.conf
      subPath: app.conf
  
  volumes:
  - name: config
    configMap:
      name: app-config
  
  - name: nginx-config
    configMap:
      name: app-config
      items:
      - key: app.conf
        path: app.conf
        mode: 0644
```

**ConfigMap Volume ç‰¹æ€§ï¼š**
- âœ… æ–‡ä»¶è‡ªå‹•æ›´æ–°ï¼ˆéœ€è¦æ‡‰ç”¨æ”¯æŒé‡è¼‰ï¼‰
- âœ… å¯è¨­ç½®æ–‡ä»¶æ¬Šé™
- âœ… å¯é¸æ“‡æ€§æ›è¼‰éƒ¨åˆ† key

---

### 2.4 secret Volume

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
type: Opaque
stringData:
  username: admin
  password: SuperSecretPassword123

---
apiVersion: v1
kind: Pod
metadata:
  name: test-secret
spec:
  containers:
  - name: app
    image: myapp:v1.0
    volumeMounts:
    - name: credentials
      mountPath: /etc/secrets
      readOnly: true
  
  volumes:
  - name: credentials
    secret:
      secretName: db-credentials
      defaultMode: 0400    # åªè®€æ¬Šé™
      items:
      - key: username
        path: db-user
      - key: password
        path: db-pass
```

**Secret Volume vs ç’°å¢ƒè®Šé‡ï¼š**

| ç‰¹æ€§ | Volume | ç’°å¢ƒè®Šé‡ |
|-----|--------|---------|
| å®‰å…¨æ€§ | âœ… æ›´é«˜ï¼ˆä¸æœƒæš´éœ²åœ¨é€²ç¨‹åˆ—è¡¨ï¼‰ | âŒ å¯èƒ½æš´éœ² |
| æ›´æ–° | âœ… æ”¯æŒï¼ˆéœ€æ‡‰ç”¨é‡è¼‰ï¼‰ | âŒ éœ€è¦é‡å•Ÿ |
| æ¬Šé™æ§åˆ¶ | âœ… å¯è¨­ç½®æ–‡ä»¶æ¬Šé™ | âŒ ç„¡ |

---

### 2.5 projected Volumeï¼ˆæŠ•å°„å·ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-projected
spec:
  containers:
  - name: app
    image: myapp:v1.0
    volumeMounts:
    - name: all-in-one
      mountPath: /projected
      readOnly: true
  
  volumes:
  - name: all-in-one
    projected:
      sources:
      # ConfigMap
      - configMap:
          name: app-config
          items:
          - key: app.conf
            path: config/app.conf
      
      # Secret
      - secret:
          name: db-credentials
          items:
          - key: username
            path: secrets/db-user
          - key: password
            path: secrets/db-pass
      
      # ServiceAccount Token
      - serviceAccountToken:
          path: token
          expirationSeconds: 3600
          audience: api
      
      # Downward API
      - downwardAPI:
          items:
          - path: "metadata/labels"
            fieldRef:
              fieldPath: metadata.labels
          - path: "metadata/annotations"
            fieldRef:
              fieldPath: metadata.annotations
```

---

### 2.6 downwardAPI Volume

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-downwardapi
  labels:
    app: webapp
    version: v1.0
  annotations:
    build: "12345"
spec:
  containers:
  - name: app
    image: busybox:1.36
    command: ['sh', '-c', 'while true; do cat /etc/podinfo/*; sleep 30; done']
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
    
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
  
  volumes:
  - name: podinfo
    downwardAPI:
      items:
      # Pod å…ƒæ•¸æ“š
      - path: "pod-name"
        fieldRef:
          fieldPath: metadata.name
      - path: "pod-namespace"
        fieldRef:
          fieldPath: metadata.namespace
      - path: "pod-ip"
        fieldRef:
          fieldPath: status.podIP
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
      - path: "annotations"
        fieldRef:
          fieldPath: metadata.annotations
      
      # è³‡æºä¿¡æ¯
      - path: "cpu-request"
        resourceFieldRef:
          containerName: app
          resource: requests.cpu
          divisor: 1m
      - path: "memory-limit"
        resourceFieldRef:
          containerName: app
          resource: limits.memory
          divisor: 1Mi
```

---

## 3. PersistentVolume (PV) èˆ‡ PersistentVolumeClaim (PVC)

### 3.1 PV/PVC å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ¶
    participant PVC as PersistentVolumeClaim
    participant K8s as Kubernetes
    participant PV as PersistentVolume
    participant Storage as å­˜å„²å¾Œç«¯
    
    User->>PVC: 1. å‰µå»º PVC<br/>(è«‹æ±‚ 10Gi å­˜å„²)
    PVC->>K8s: 2. æäº¤å­˜å„²è«‹æ±‚
    
    alt éœæ…‹ä¾›æ‡‰
        K8s->>PV: 3a. æŸ¥æ‰¾åŒ¹é…çš„ PV
        PV-->>K8s: æ‰¾åˆ°åŒ¹é…çš„ PV
    else å‹•æ…‹ä¾›æ‡‰
        K8s->>Storage: 3b. é€šé StorageClass<br/>å‹•æ…‹å‰µå»º PV
        Storage-->>PV: PV å‰µå»ºå®Œæˆ
    end
    
    K8s->>PVC: 4. ç¶å®š PV åˆ° PVC
    PVC-->>User: 5. PVC Bound
    
    User->>K8s: 6. å‰µå»ºä½¿ç”¨ PVC çš„ Pod
    K8s->>PV: 7. æ›è¼‰ PV åˆ° Pod
    PV->>Storage: 8. å¯¦éš›æ›è¼‰å­˜å„²
```

---

### 3.2 PersistentVolume (PV) é…ç½®

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-001
  labels:
    type: nfs
    tier: standard
spec:
  capacity:
    storage: 10Gi
  
  # è¨ªå•æ¨¡å¼
  accessModes:
  - ReadWriteMany    # RWX: å¤šç¯€é»è®€å¯«
  
  # å›æ”¶ç­–ç•¥
  persistentVolumeReclaimPolicy: Retain
  
  # å­˜å„²é¡åˆ¥
  storageClassName: nfs-storage
  
  # æ›è¼‰é¸é …
  mountOptions:
  - hard
  - nfsvers=4.1
  
  # NFS é…ç½®
  nfs:
    server: 192.168.1.100
    path: /exports/data
```

---

### 3.3 è¨ªå•æ¨¡å¼ (Access Modes)

| æ¨¡å¼ | ç¸®å¯« | èªªæ˜ | æ”¯æŒçš„å­˜å„² |
|-----|------|------|-----------|
| **ReadWriteOnce** | RWO | å–®ç¯€é»è®€å¯« | å¤§éƒ¨åˆ†é›²ç«¯å¡Šå­˜å„² |
| **ReadOnlyMany** | ROX | å¤šç¯€é»åªè®€ | NFSã€CephFS |
| **ReadWriteMany** | RWX | å¤šç¯€é»è®€å¯« | NFSã€CephFSã€GlusterFS |
| **ReadWriteOncePod** | RWOP | å–® Pod è®€å¯«ï¼ˆK8s 1.27+ï¼‰ | CSI å· |

**å¸¸è¦‹å­˜å„²æ”¯æŒï¼š**

| å­˜å„²é¡å‹ | RWO | ROX | RWX |
|---------|-----|-----|-----|
| AWS EBS | âœ… | âŒ | âŒ |
| GCP PD | âœ… | âœ… | âŒ |
| Azure Disk | âœ… | âŒ | âŒ |
| NFS | âœ… | âœ… | âœ… |
| CephFS | âœ… | âœ… | âœ… |
| iSCSI | âœ… | âœ… | âŒ |

---

### 3.4 å›æ”¶ç­–ç•¥ (Reclaim Policy)

```mermaid
stateDiagram-v2
    [*] --> Available: PV å‰µå»º
    Available --> Bound: PVC ç¶å®š
    Bound --> Released: PVC åˆªé™¤
    
    Released --> Retain: Retain ç­–ç•¥
    Released --> Delete: Delete ç­–ç•¥
    Released --> Recycle: Recycle ç­–ç•¥
    
    Retain --> Manual: æ‰‹å‹•è™•ç†
    Delete --> [*]: è‡ªå‹•åˆªé™¤
    Recycle --> Available: æ¸…ç†å¾Œå¯ç”¨
    
    note right of Retain
        ä¿ç•™æ•¸æ“š
        éœ€æ‰‹å‹•è™•ç†
    end note
    
    note right of Delete
        è‡ªå‹•åˆªé™¤ PV
        å’Œå¾Œç«¯å­˜å„²
    end note
```

| ç­–ç•¥ | èªªæ˜ | ä½¿ç”¨å ´æ™¯ |
|-----|------|---------|
| **Retain** | ä¿ç•™æ•¸æ“šï¼Œéœ€æ‰‹å‹•è™•ç† | ç”Ÿç”¢ç’°å¢ƒï¼ˆé˜²æ­¢èª¤åˆªï¼‰ |
| **Delete** | è‡ªå‹•åˆªé™¤ PV å’Œå­˜å„² | å‹•æ…‹ä¾›æ‡‰ï¼ˆé»˜èªï¼‰ |
| **Recycle** | æ¸…ç†æ•¸æ“šå¾Œé‡ç”¨ï¼ˆå·²å»¢æ£„ï¼‰ | ä¸æ¨è–¦ |

---

### 3.5 PersistentVolumeClaim (PVC) é…ç½®

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-pvc
  namespace: production
spec:
  # è¨ªå•æ¨¡å¼
  accessModes:
  - ReadWriteOnce
  
  # å­˜å„²é¡åˆ¥
  storageClassName: fast-ssd
  
  # è³‡æºè«‹æ±‚
  resources:
    requests:
      storage: 10Gi
  
  # é¸æ“‡å™¨ï¼ˆå¯é¸ï¼Œç”¨æ–¼éœæ…‹ç¶å®šï¼‰
  selector:
    matchLabels:
      type: nfs
      tier: premium
    matchExpressions:
    - key: environment
      operator: In
      values:
      - production
  
  # Volume æ¨¡å¼
  volumeMode: Filesystem    # Filesystem æˆ– Block
```

---

### 3.6 PVC ç”Ÿå‘½é€±æœŸ

```mermaid
stateDiagram-v2
    [*] --> Pending: PVC å‰µå»º
    
    Pending --> Bound: æ‰¾åˆ°åŒ¹é…çš„ PV
    Pending --> Pending: ç­‰å¾… PV æˆ–<br/>StorageClass å‰µå»º
    
    Bound --> InUse: Pod ä½¿ç”¨
    InUse --> Bound: Pod åˆªé™¤
    
    Bound --> Released: PVC åˆªé™¤
    Released --> [*]
    
    note right of Pending
        ç­‰å¾…åŒ¹é…çš„ PV
        æˆ–å‹•æ…‹ä¾›æ‡‰
    end note
    
    note right of Bound
        PVC å·²ç¶å®šåˆ° PV
        å¯ä»¥è¢« Pod ä½¿ç”¨
    end note
```

---

### 3.7 åœ¨ Pod ä¸­ä½¿ç”¨ PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: app
    image: myapp:v1.0
    volumeMounts:
    - name: data
      mountPath: /data
  
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: webapp-pvc
      readOnly: false
```

**Deployment ä¸­ä½¿ç”¨ï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 1    # RWO æ¨¡å¼ä¸‹åªèƒ½æ˜¯ 1
  template:
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        volumeMounts:
        - name: data
          mountPath: /data
      
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: webapp-pvc
```

**StatefulSet ä¸­ä½¿ç”¨ï¼ˆæ¨è–¦ï¼‰ï¼š**

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: webapp
spec:
  serviceName: webapp
  replicas: 3
  
  template:
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        volumeMounts:
        - name: data
          mountPath: /data
  
  # è‡ªå‹•ç‚ºæ¯å€‹ Pod å‰µå»º PVC
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi
```

---

## 4. StorageClassï¼ˆå­˜å„²é¡åˆ¥ï¼‰

### 4.1 StorageClass æ˜¯ä»€éº¼

StorageClass æä¾›å‹•æ…‹å­˜å„²ä¾›æ‡‰ï¼Œè‡ªå‹•å‰µå»º PVã€‚

```mermaid
graph TB
    User[ç”¨æˆ¶] -->|å‰µå»º| PVC[PersistentVolumeClaim<br/>storageClassName: fast-ssd]
    PVC --> SC[StorageClass<br/>fast-ssd]
    SC -->|èª¿ç”¨| Provisioner[Provisioner<br/>CSI Driver]
    Provisioner -->|å‰µå»º| Storage[å­˜å„²å¾Œç«¯<br/>AWS EBS gp3]
    Storage -->|ç”Ÿæˆ| PV[PersistentVolume]
    PV -->|ç¶å®š| PVC
    
    style SC fill:#9cf
    style PV fill:#9f9
```

---

### 4.2 StorageClass é…ç½®ç¤ºä¾‹

#### 4.2.1 AWS EBS

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
parameters:
  type: gp3              # gp2, gp3, io1, io2, st1, sc1
  iops: "3000"           # gp3/io1/io2 å°ˆç”¨
  throughput: "125"      # gp3 å°ˆç”¨ï¼ˆMB/sï¼‰
  encrypted: "true"
  kmsKeyId: arn:aws:kms:us-west-1:123456789012:key/xxx
  fsType: ext4

# Volume ç¶å®šæ¨¡å¼
volumeBindingMode: WaitForFirstConsumer    # Immediate æˆ– WaitForFirstConsumer

# å…è¨±æ“´å®¹
allowVolumeExpansion: true

# å›æ”¶ç­–ç•¥
reclaimPolicy: Delete    # Delete æˆ– Retain

# æ›è¼‰é¸é …
mountOptions:
- debug
```

#### 4.2.2 GCP Persistent Disk

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: pd.csi.storage.gke.io
parameters:
  type: pd-ssd           # pd-standard, pd-ssd, pd-balanced
  replication-type: regional-pd
  fstype: ext4

volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete
```

#### 4.2.3 Azure Disk

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: disk.csi.azure.com
parameters:
  skuname: Premium_LRS    # Standard_LRS, Premium_LRS, StandardSSD_LRS, UltraSSD_LRS
  kind: Managed
  cachingmode: ReadOnly
  fsType: ext4

volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete
```

#### 4.2.4 NFS

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: nfs.csi.k8s.io
parameters:
  server: nfs-server.default.svc.cluster.local
  share: /exports

volumeBindingMode: Immediate
allowVolumeExpansion: true
reclaimPolicy: Retain
mountOptions:
- hard
- nfsvers=4.1
```

#### 4.2.5 Longhornï¼ˆåˆ†å¸ƒå¼å­˜å„²ï¼‰

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn
provisioner: driver.longhorn.io
parameters:
  numberOfReplicas: "3"
  staleReplicaTimeout: "2880"
  fromBackup: ""
  fsType: "ext4"

volumeBindingMode: Immediate
allowVolumeExpansion: true
reclaimPolicy: Delete
```

---

### 4.3 volumeBindingModeï¼ˆç¶å®šæ¨¡å¼ï¼‰

| æ¨¡å¼ | èªªæ˜ | ä½¿ç”¨å ´æ™¯ |
|-----|------|---------|
| **Immediate** | PVC å‰µå»ºå¾Œç«‹å³ç¶å®š PV | ä¸é—œå¿ƒ Pod èª¿åº¦ä½ç½® |
| **WaitForFirstConsumer** | ç­‰å¾…ç¬¬ä¸€å€‹ä½¿ç”¨ PVC çš„ Pod èª¿åº¦å¾Œå†ç¶å®š | æ‹“æ’²æ„ŸçŸ¥ï¼ˆæ¨è–¦ï¼‰ |

```mermaid
sequenceDiagram
    participant PVC
    participant K8s as Kubernetes
    participant PV
    participant Pod
    
    Note over PVC,Pod: Immediate æ¨¡å¼
    PVC->>K8s: å‰µå»º PVC
    K8s->>PV: ç«‹å³å‰µå»º/ç¶å®š PV
    Pod->>K8s: å‰µå»º Pod
    K8s->>Pod: å¯èƒ½èª¿åº¦å¤±æ•—<br/>(PV åœ¨å…¶ä»– Zone)
    
    Note over PVC,Pod: WaitForFirstConsumer æ¨¡å¼
    PVC->>K8s: å‰µå»º PVC
    Note over K8s: ç­‰å¾…...
    Pod->>K8s: å‰µå»º Pod
    K8s->>Pod: å…ˆèª¿åº¦ Pod
    K8s->>PV: åœ¨ Pod æ‰€åœ¨ Zone<br/>å‰µå»º PV
    K8s->>PVC: ç¶å®š PV
```

---

### 4.4 å‹•æ…‹ä¾›æ‡‰å®Œæ•´ç¤ºä¾‹

```yaml
# StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete

---
# PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-pvc
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 20Gi

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        volumeMounts:
        - name: data
          mountPath: /data
      
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: webapp-pvc
```

---

## 5. å­˜å„²æ“´å®¹

### 5.1 åœ¨ç·šæ“´å®¹ PVC

```bash
# ç·¨è¼¯ PVC
kubectl edit pvc webapp-pvc

# ä¿®æ”¹ storage å¤§å°
spec:
  resources:
    requests:
      storage: 50Gi    # å¾ 20Gi æ“´å®¹åˆ° 50Gi
```

**æˆ–ä½¿ç”¨ patchï¼š**

```bash
kubectl patch pvc webapp-pvc -p '{"spec":{"resources":{"requests":{"storage":"50Gi"}}}}'
```

**æŸ¥çœ‹ç‹€æ…‹ï¼š**

```bash
kubectl get pvc webapp-pvc
# NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES
# webapp-pvc   Bound    pvc-abc123                                 50Gi       RWO

kubectl describe pvc webapp-pvc
# Events:
#   Normal  Resizing  1m   external-resizer  External resizer is resizing volume
#   Normal  FileSystemResizeSuccessful  30s  kubelet  MountVolume.NodeExpandVolume succeeded
```

**æ³¨æ„äº‹é …ï¼š**
- âœ… StorageClass å¿…é ˆè¨­ç½® `allowVolumeExpansion: true`
- âœ… åƒ…æ”¯æŒæ“´å®¹ï¼Œä¸æ”¯æŒç¸®å®¹
- âœ… éƒ¨åˆ†å­˜å„²éœ€è¦é‡å•Ÿ Podï¼ˆæŸ¥çœ‹ PVC Eventsï¼‰

---

## 6. CSIï¼ˆContainer Storage Interfaceï¼‰

### 6.1 CSI æ¶æ§‹

```mermaid
graph TB
    subgraph "Kubernetes Control Plane"
        API[API Server]
        Scheduler[Scheduler]
    end
    
    subgraph "CSI Controller"
        EP[External Provisioner]
        EA[External Attacher]
        ER[External Resizer]
        ES[External Snapshotter]
    end
    
    subgraph "CSI Node"
        NP[Node Plugin]
        DR[Driver Registrar]
    end
    
    subgraph "Storage Backend"
        Backend[å­˜å„²ç³»çµ±<br/>AWS/GCP/Ceph/etc]
    end
    
    API --> EP
    API --> EA
    API --> ER
    API --> ES
    
    EP --> Backend
    EA --> Backend
    ER --> Backend
    ES --> Backend
    
    NP --> Backend
    DR --> Kubelet
    
    style EP fill:#9cf
    style NP fill:#fc9
```

---

### 6.2 å¸¸ç”¨ CSI Driver

| CSI Driver | å­˜å„²é¡å‹ | ç‰¹æ€§ |
|-----------|---------|------|
| **AWS EBS CSI** | AWS EBS | å‹•æ…‹ä¾›æ‡‰ã€å¿«ç…§ã€åŠ å¯† |
| **GCP PD CSI** | GCP Persistent Disk | å‹•æ…‹ä¾›æ‡‰ã€å€åŸŸè¤‡è£½ |
| **Azure Disk CSI** | Azure Disk | å‹•æ…‹ä¾›æ‡‰ã€å¤šç¨®æ€§èƒ½å±¤ç´š |
| **Longhorn** | åˆ†å¸ƒå¼å¡Šå­˜å„² | é–‹æºã€é«˜å¯ç”¨ã€å¿«ç…§ |
| **Rook-Ceph** | Ceph | é–‹æºã€å¡Š/æ–‡ä»¶/å°è±¡å­˜å„² |
| **NFS CSI** | NFS | RWX æ”¯æŒ |
| **Local Path Provisioner** | æœ¬åœ°å­˜å„² | é«˜æ€§èƒ½ã€ä¸æ”¯æŒé·ç§» |

---

### 6.3 å®‰è£ AWS EBS CSI Driver

```bash
# ä½¿ç”¨ Helm å®‰è£
helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
helm repo update

helm install aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver \
  --namespace kube-system \
  --set enableVolumeScheduling=true \
  --set enableVolumeResizing=true \
  --set enableVolumeSnapshot=true

# æŸ¥çœ‹
kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-ebs-csi-driver
kubectl get csidrivers
```

---

### 6.4 å­˜å„²å¿«ç…§ï¼ˆVolumeSnapshotï¼‰

```yaml
# VolumeSnapshotClass
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: ebs-snapshot-class
driver: ebs.csi.aws.com
deletionPolicy: Delete
parameters:
  tagSpecifications: '[{"tags":{"team":"platform"},"resourceType":"snapshot"}]'

---
# VolumeSnapshot
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: webapp-snapshot-20250113
spec:
  volumeSnapshotClassName: ebs-snapshot-class
  source:
    persistentVolumeClaimName: webapp-pvc

---
# å¾å¿«ç…§æ¢å¾©
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-pvc-restored
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd
  dataSource:
    name: webapp-snapshot-20250113
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
  resources:
    requests:
      storage: 20Gi
```

---

## 7. å¯¦æˆ°æ¡ˆä¾‹

### 7.1 PostgreSQL æŒä¹…åŒ–å­˜å„²

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  POSTGRES_DB: mydb
  POSTGRES_USER: admin

---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
stringData:
  POSTGRES_PASSWORD: SuperSecretPassword123

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16
        
        ports:
        - containerPort: 5432
          name: postgres
        
        envFrom:
        - configMapRef:
            name: postgres-config
        - secretRef:
            name: postgres-secret
        
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
          subPath: postgres
        
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - admin
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - admin
          initialDelaySeconds: 5
          periodSeconds: 5
  
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
```

---

### 7.2 å…±äº«æ–‡ä»¶å­˜å„²ï¼ˆNFSï¼‰

```yaml
# NFS Server Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-server
  template:
    metadata:
      labels:
        app: nfs-server
    spec:
      containers:
      - name: nfs-server
        image: k8s.gcr.io/volume-nfs:0.8
        ports:
        - containerPort: 2049
          name: nfs
        - containerPort: 20048
          name: mountd
        - containerPort: 111
          name: rpcbind
        securityContext:
          privileged: true
        volumeMounts:
        - name: nfs-export
          mountPath: /exports
      
      volumes:
      - name: nfs-export
        hostPath:
          path: /mnt/nfs-export
          type: DirectoryOrCreate

---
apiVersion: v1
kind: Service
metadata:
  name: nfs-server
spec:
  clusterIP: 10.96.100.100
  selector:
    app: nfs-server
  ports:
  - port: 2049
    name: nfs
  - port: 20048
    name: mountd
  - port: 111
    name: rpcbind

---
# PV ä½¿ç”¨ NFS
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 10.96.100.100
    path: /

---
# PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shared-storage
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100Gi

---
# å¤šå€‹ Pod å…±äº«
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: app
        image: nginx:1.27
        volumeMounts:
        - name: shared
          mountPath: /usr/share/nginx/html
      
      volumes:
      - name: shared
        persistentVolumeClaim:
          claimName: shared-storage
```

---

## 8. æœ€ä½³å¯¦è¸

### 8.1 å­˜å„²é¸æ“‡æŒ‡å—

```mermaid
graph TB
    Start[é¸æ“‡å­˜å„²é¡å‹] --> Q1{éœ€è¦æŒä¹…åŒ–?}
    
    Q1 -->|å¦| E[emptyDir<br/>è‡¨æ™‚å­˜å„²]
    Q1 -->|æ˜¯| Q2{å¤šå€‹ Pod å…±äº«?}
    
    Q2 -->|å¦| RWO[ReadWriteOnce<br/>å¡Šå­˜å„²]
    Q2 -->|æ˜¯| RWX[ReadWriteMany<br/>æ–‡ä»¶å­˜å„²]
    
    RWO --> Q3{æ€§èƒ½è¦æ±‚?}
    Q3 -->|é«˜| SSD[SSD å­˜å„²<br/>EBS gp3/io2]
    Q3 -->|ä¸€èˆ¬| HDD[HDD å­˜å„²<br/>EBS st1]
    
    RWX --> NFS[NFS/CephFS<br/>GlusterFS]
    
    style E fill:#fc9
    style SSD fill:#9f9
    style NFS fill:#9cf
```

### 8.2 é…ç½®å»ºè­°

```yaml
# âœ… ç”Ÿç”¢ç’°å¢ƒé…ç½®
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: production-pvc
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 100Gi    # é ç•™è¶³å¤ ç©ºé–“
  
  # ä½¿ç”¨ WaitForFirstConsumer
  volumeBindingMode: WaitForFirstConsumer

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  encrypted: "true"    # å•Ÿç”¨åŠ å¯†
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true    # å…è¨±æ“´å®¹
reclaimPolicy: Retain    # ä¿ç•™æ•¸æ“š
```

### 8.3 å‚™ä»½ç­–ç•¥

```yaml
# å®šæ™‚å¿«ç…§
apiVersion: batch/v1
kind: CronJob
metadata:
  name: volume-snapshot
spec:
  schedule: "0 2 * * *"    # æ¯å¤©å‡Œæ™¨ 2:00
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: snapshot-creator
          restartPolicy: OnFailure
          containers:
          - name: create-snapshot
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              DATE=$(date +%Y%m%d-%H%M%S)
              cat <<EOF | kubectl apply -f -
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: postgres-snapshot-$DATE
              spec:
                volumeSnapshotClassName: ebs-snapshot-class
                source:
                  persistentVolumeClaimName: postgres-pvc
              EOF
              
              # åˆªé™¤ 7 å¤©å‰çš„å¿«ç…§
              kubectl get volumesnapshots -o json | \
                jq -r '.items[] | select(.metadata.creationTimestamp < "'$(date -d '7 days ago' -Iseconds)'") | .metadata.name' | \
                xargs -r kubectl delete volumesnapshot
```

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 PVC Pending

```bash
# æŸ¥çœ‹ PVC ç‹€æ…‹
kubectl get pvc
kubectl describe pvc webapp-pvc

# å¸¸è¦‹åŸå› ï¼š
# 1. æ²’æœ‰åŒ¹é…çš„ PVï¼ˆéœæ…‹ä¾›æ‡‰ï¼‰
# 2. StorageClass ä¸å­˜åœ¨
# 3. è³‡æºä¸è¶³
# 4. è¨ªå•æ¨¡å¼ä¸åŒ¹é…

# æª¢æŸ¥ StorageClass
kubectl get storageclass
kubectl describe storageclass fast-ssd

# æª¢æŸ¥ Provisioner
kubectl get pods -n kube-system | grep csi
kubectl logs -n kube-system <csi-provisioner-pod>
```

### 9.2 Pod æ›è¼‰å¤±æ•—

```bash
# æŸ¥çœ‹ Pod äº‹ä»¶
kubectl describe pod webapp-pod

# å¸¸è¦‹éŒ¯èª¤ï¼š
# - Multi-Attach error: Volumeå·²é™„åŠ åˆ°å…¶ä»–ç¯€é»ï¼ˆRWO é™åˆ¶ï¼‰
# - Unable to mount: å­˜å„²å¾Œç«¯ç„¡æ³•è¨ªå•
# - Timeout: æ›è¼‰è¶…æ™‚

# æª¢æŸ¥ PV ç‹€æ…‹
kubectl get pv
kubectl describe pv <pv-name>

# æª¢æŸ¥ CSI Node Plugin
kubectl get pods -n kube-system -l app=ebs-csi-node
kubectl logs -n kube-system <csi-node-pod>
```

### 9.3 æ“´å®¹å¤±æ•—

```bash
# æŸ¥çœ‹ PVC ç‹€æ…‹
kubectl describe pvc webapp-pvc

# æª¢æŸ¥ Eventsï¼š
# - FilesystemResizePending: éœ€è¦é‡å•Ÿ Pod
# - External resizer error: å­˜å„²å¾Œç«¯ä¸æ”¯æŒæ“´å®¹

# é‡å•Ÿ Pod è§¸ç™¼æ–‡ä»¶ç³»çµ±æ“´å®¹
kubectl rollout restart deployment webapp
```

---

## 10. å°çµ

æœ¬ç« æ·±å…¥è¬›è§£äº† Kubernetes çš„å­˜å„²è³‡æºï¼š

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- âœ… **Volume**ï¼šè‡¨æ™‚æˆ–æŒä¹…åŒ–å­˜å„²ï¼ˆemptyDirã€hostPathã€ConfigMapã€Secretï¼‰
- âœ… **PersistentVolume (PV)**ï¼šé›†ç¾¤ç´šåˆ¥çš„å­˜å„²è³‡æº
- âœ… **PersistentVolumeClaim (PVC)**ï¼šç”¨æˆ¶å°å­˜å„²çš„è«‹æ±‚
- âœ… **StorageClass**ï¼šå‹•æ…‹å­˜å„²ä¾›æ‡‰
- âœ… **CSI**ï¼šå®¹å™¨å­˜å„²æ¥å£æ¨™æº–

**è¨ªå•æ¨¡å¼ï¼š**
- âœ… ReadWriteOnce (RWO)ï¼šå–®ç¯€é»è®€å¯«
- âœ… ReadOnlyMany (ROX)ï¼šå¤šç¯€é»åªè®€
- âœ… ReadWriteMany (RWX)ï¼šå¤šç¯€é»è®€å¯«

**æœ€ä½³å¯¦è¸ï¼š**
- âœ… ä½¿ç”¨ StorageClass å‹•æ…‹ä¾›æ‡‰
- âœ… ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ Retain å›æ”¶ç­–ç•¥
- âœ… å•Ÿç”¨å­˜å„²åŠ å¯†
- âœ… å®šæœŸå‚™ä»½ï¼ˆå¿«ç…§ï¼‰
- âœ… StatefulSet ä½¿ç”¨ volumeClaimTemplates

ä¸‹ä¸€ç« å°‡å­¸ç¿’é…ç½®è³‡æºï¼ŒåŒ…æ‹¬ ConfigMapã€Secretã€ResourceQuota ç­‰ã€‚

---

## åƒè€ƒè³‡æ–™ (References)

1. [Kubernetes å®˜æ–¹æ–‡æª” - Storage](https://kubernetes.io/docs/concepts/storage/)
2. [Kubernetes å®˜æ–¹æ–‡æª” - Persistent Volumes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/)
3. [Kubernetes å®˜æ–¹æ–‡æª” - Storage Classes](https://kubernetes.io/docs/concepts/storage/storage-classes/)
4. [Container Storage Interface (CSI) è¦ç¯„](https://github.com/container-storage-interface/spec)
5. [AWS EBS CSI Driver](https://github.com/kubernetes-sigs/aws-ebs-csi-driver)
6. [Longhorn å®˜æ–¹æ–‡æª”](https://longhorn.io/docs/)
