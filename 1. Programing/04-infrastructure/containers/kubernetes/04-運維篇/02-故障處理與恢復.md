# 02-æ•…éšœè™•ç†èˆ‡æ¢å¾©

> å¸¸è¦‹å•é¡Œæ’æŸ¥ã€æ—¥èªŒåˆ†æã€å‚™ä»½èˆ‡ç½é›£æ¢å¾©

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- æŒæ¡ç³»çµ±åŒ–çš„æ•…éšœæ’æŸ¥æµç¨‹
- ä½¿ç”¨ kubectl å·¥å…·è¨ºæ–·å•é¡Œ
- åˆ†ææ—¥èªŒèˆ‡äº‹ä»¶å®šä½æ•…éšœ
- å¯¦æ–½å‚™ä»½èˆ‡ç½é›£æ¢å¾©æ–¹æ¡ˆ

---

## 1. æ•…éšœæ’æŸ¥æµç¨‹

### 1.1 æ¨™æº–æ’æŸ¥è·¯å¾‘

```mermaid
flowchart TD
    A[ç™¼ç¾å•é¡Œ] --> B{æœå‹™é¡å‹?}
    
    B -->|Podç•°å¸¸| C[kubectl get pods]
    B -->|ç¶²çµ¡å•é¡Œ| D[æª¢æŸ¥Service/Ingress]
    B -->|å­˜å„²å•é¡Œ| E[æª¢æŸ¥PV/PVC]
    
    C --> F{Podç‹€æ…‹?}
    F -->|Pending| G[kubectl describe pod]
    F -->|CrashLoopBackOff| H[kubectl logs]
    F -->|Error| H
    F -->|ImagePullBackOff| I[æª¢æŸ¥é¡åƒ]
    
    G --> J[Eventsåˆ†æ]
    H --> K[æ‡‰ç”¨æ—¥èªŒåˆ†æ]
    I --> L[Registryæ¬Šé™]
    
    J --> M{è§£æ±ºæ–¹æ¡ˆ}
    K --> M
    L --> M
    
    style A fill:#f96
    style M fill:#9f9
```

### 1.2 å¿«é€Ÿè¨ºæ–·å‘½ä»¤

```bash
kubectl get pods -A --field-selector=status.phase!=Running

kubectl get pods -A -o jsonpath='{range .items[?(@.status.phase!="Running")]}{.metadata.namespace}{"\t"}{.metadata.name}{"\t"}{.status.phase}{"\n"}{end}'

kubectl get events --sort-by='.lastTimestamp' -A

kubectl top nodes
kubectl top pods -A
```

---

## 2. å¸¸è¦‹æ•…éšœæ¡ˆä¾‹

### 2.1 ImagePullBackOff

**ç¾è±¡ï¼š**
```
NAME                    READY   STATUS             RESTARTS   AGE
webapp-7d8f6c9b4-abcd   0/1     ImagePullBackOff   0          2m
```

**æ’æŸ¥ï¼š**
```bash
kubectl describe pod webapp-7d8f6c9b4-abcd

kubectl get events --field-selector involvedObject.name=webapp-7d8f6c9b4-abcd
```

**å¯èƒ½åŸå› ï¼š**
- é¡åƒåç¨±éŒ¯èª¤
- é¡åƒä¸å­˜åœ¨
- Registry èªè­‰å¤±æ•—
- ç¶²çµ¡å•é¡Œ

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
kubectl create secret docker-registry regcred \
  --docker-server=myregistry.com \
  --docker-username=user \
  --docker-password=pass

kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "regcred"}]}'

kubectl set image deployment/webapp app=correct-image:tag
```

### 2.2 CrashLoopBackOff

**ç¾è±¡ï¼š**
```
NAME                    READY   STATUS             RESTARTS   AGE
webapp-7d8f6c9b4-abcd   0/1     CrashLoopBackOff   5          5m
```

**æ’æŸ¥ï¼š**
```bash
kubectl logs webapp-7d8f6c9b4-abcd

kubectl logs webapp-7d8f6c9b4-abcd --previous

kubectl logs webapp-7d8f6c9b4-abcd -c init-container

kubectl describe pod webapp-7d8f6c9b4-abcd
```

**å¸¸è¦‹åŸå› ï¼š**
- æ‡‰ç”¨å•Ÿå‹•å¤±æ•—ï¼ˆé…ç½®éŒ¯èª¤ï¼‰
- ä¾è³´æœå‹™æœªå°±ç·’
- è³‡æºä¸è¶³å°è‡´ OOMKilled
- å¥åº·æª¢æŸ¥å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆï¼š**
```yaml
# èª¿æ•´å¥åº·æª¢æŸ¥æ™‚é–“
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 60
  periodSeconds: 10

# å¢åŠ è³‡æºé™åˆ¶
resources:
  limits:
    memory: "1Gi"
  requests:
    memory: "512Mi"
```

### 2.3 Pending èª¿åº¦å¤±æ•—

**æ’æŸ¥ï¼š**
```bash
kubectl describe pod webapp-7d8f6c9b4-abcd | grep -A 10 Events
```

**å¸¸è¦‹åŸå› èˆ‡è§£æ±ºï¼š**

| åŸå›  | Events ä¿¡æ¯ | è§£æ±ºæ–¹æ¡ˆ |
|-----|------------|---------|
| è³‡æºä¸è¶³ | `Insufficient cpu/memory` | å¢åŠ ç¯€é»æˆ–æ¸›å°‘è«‹æ±‚ |
| PVC æœªç¶å®š | `PersistentVolumeClaim is not bound` | æª¢æŸ¥ PV provisioner |
| ç¯€é»è¦ªå’Œæ€§ | `didn't match node selector` | èª¿æ•´ nodeSelector |
| æ±¡é»æœªå®¹å¿ | `node(s) had taints` | æ·»åŠ  tolerations |

```bash
kubectl get nodes -o custom-columns=NAME:.metadata.name,CPU:.status.allocatable.cpu,MEMORY:.status.allocatable.memory

kubectl describe nodes | grep -A 5 "Allocated resources"
```

### 2.4 OOMKilled

**æª¢æ¸¬ï¼š**
```bash
kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[*].lastState.terminated.reason}{"\n"}{end}' | grep OOMKilled
```

**åˆ†æå…§å­˜ä½¿ç”¨ï¼š**
```bash
kubectl top pod webapp-7d8f6c9b4-abcd

kubectl get pod webapp-7d8f6c9b4-abcd -o jsonpath='{.spec.containers[0].resources}'
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```yaml
resources:
  requests:
    memory: "512Mi"
  limits:
    memory: "2Gi"
```

---

## 3. é«˜ç´šèª¿è©¦

### 3.1 kubectl debug

**é€²å…¥æ•…éšœ Podï¼š**
```bash
kubectl debug webapp-7d8f6c9b4-abcd -it --image=busybox:1.36

kubectl debug webapp-7d8f6c9b4-abcd -it --image=nicolaka/netshoot --target=app
```

**å‰µå»ºèª¿è©¦å‰¯æœ¬ï¼š**
```bash
kubectl debug webapp-7d8f6c9b4-abcd -it --copy-to=webapp-debug --container=app -- sh
```

**èª¿è©¦ç¯€é»ï¼š**
```bash
kubectl debug node/node1 -it --image=ubuntu
```

### 3.2 Ephemeral Containers

```bash
kubectl debug -it webapp-7d8f6c9b4-abcd --image=busybox:1.36 --target=app
```

**æ‰‹å‹•æ·»åŠ ï¼š**
```bash
kubectl debug webapp-7d8f6c9b4-abcd --image=nicolaka/netshoot --target=app -- bash
```

### 3.3 ç¶²çµ¡èª¿è©¦

```bash
kubectl run netshoot --rm -it --image=nicolaka/netshoot -- bash

nslookup webapp.default.svc.cluster.local

curl -v http://webapp.default.svc.cluster.local

telnet webapp.default.svc.cluster.local 80

traceroute webapp.default.svc.cluster.local
```

---

## 4. æ—¥èªŒç®¡ç†

### 4.1 kubectl logs é«˜ç´šç”¨æ³•

```bash
kubectl logs -f webapp-7d8f6c9b4-abcd

kubectl logs webapp-7d8f6c9b4-abcd -c app

kubectl logs --tail=100 webapp-7d8f6c9b4-abcd

kubectl logs --since=1h webapp-7d8f6c9b4-abcd

kubectl logs --since-time=2024-01-01T00:00:00Z webapp-7d8f6c9b4-abcd

kubectl logs -l app=webapp --all-containers=true --prefix=true
```

### 4.2 æ—¥èªŒèšåˆæŸ¥è©¢

**ä½¿ç”¨ sternï¼š**
```bash
stern webapp

stern webapp --tail 50

stern webapp --since 15m

stern "webapp-.*" --namespace production
```

### 4.3 çµæ§‹åŒ–æ—¥èªŒæœç´¢

**Kibana æŸ¥è©¢ç¤ºä¾‹ï¼š**
```
kubernetes.namespace: "production" AND kubernetes.labels.app: "webapp" AND level: "error"

message: "database connection failed" AND kubernetes.pod_name: webapp-*

@timestamp: [now-1h TO now] AND level: (ERROR OR FATAL)
```

---

## 5. å‚™ä»½ç­–ç•¥

### 5.1 etcd å‚™ä»½

**æ‰‹å‹•å‚™ä»½ï¼š**
```bash
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

etcdctl snapshot status /backup/etcd-snapshot.db --write-out=table
```

**è‡ªå‹•åŒ–å‚™ä»½ CronJobï¼š**
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup
  namespace: kube-system
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: bitnami/etcd:latest
            command:
            - /bin/sh
            - -c
            - |
              etcdctl snapshot save /backup/etcd-$(date +%Y%m%d).db \
                --endpoints=https://etcd:2379 \
                --cacert=/certs/ca.crt \
                --cert=/certs/server.crt \
                --key=/certs/server.key
              
              aws s3 cp /backup/etcd-$(date +%Y%m%d).db s3://my-backups/
            
            volumeMounts:
            - name: backup
              mountPath: /backup
            - name: etcd-certs
              mountPath: /certs
          
          volumes:
          - name: backup
            emptyDir: {}
          - name: etcd-certs
            secret:
              secretName: etcd-certs
          
          restartPolicy: OnFailure
```

### 5.2 Velero å‚™ä»½

**å®‰è£ï¼š**
```bash
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket velero-backups \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=true \
  --backup-location-config region=us-east-1
```

**å‰µå»ºå‚™ä»½ï¼š**
```bash
velero backup create production-backup --include-namespaces production

velero backup create full-cluster-backup

velero backup create webapp-backup --selector app=webapp
```

**å®šæœŸå‚™ä»½ï¼š**
```bash
velero schedule create daily-backup --schedule="0 2 * * *" --ttl 720h0m0s

velero schedule create weekly-full --schedule="0 3 * * 0" --include-namespaces '*'
```

**æ¢å¾©ï¼š**
```bash
velero restore create --from-backup production-backup

velero restore create webapp-restore --from-backup webapp-backup --namespace-mappings production:production-new
```

---

## 6. ç½é›£æ¢å¾©

### 6.1 etcd æ¢å¾©

```bash
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \
  --data-dir=/var/lib/etcd-from-backup \
  --name=master \
  --initial-cluster=master=https://10.0.0.1:2380 \
  --initial-advertise-peer-urls=https://10.0.0.1:2380
```

### 6.2 æ‡‰ç”¨ç´šç½é›£æ¢å¾©æ¼”ç·´

**æ¸¬è©¦è¨ˆåŠƒï¼š**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dr-plan
data:
  recovery-steps.md: |
    # ç½é›£æ¢å¾©æ­¥é©Ÿ
    
    ## 1. è©•ä¼°å½±éŸ¿ç¯„åœ
    - ç¢ºèªå—å½±éŸ¿çš„æœå‹™
    - æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
    
    ## 2. å•Ÿå‹•æ¢å¾©æµç¨‹
    ```bash
    # åˆ‡æ›åˆ°å‚™ç”¨é›†ç¾¤
    kubectl config use-context backup-cluster
    
    # æ¢å¾©æ‡‰ç”¨
    velero restore create --from-backup latest-backup
    
    # é©—è­‰æœå‹™
    kubectl get pods -n production
    ```
    
    ## 3. æ•¸æ“šé©—è­‰
    - æª¢æŸ¥æ•¸æ“šåº«å®Œæ•´æ€§
    - é©—è­‰é—œéµæ¥­å‹™æµç¨‹
    
    ## 4. æµé‡åˆ‡æ›
    - æ›´æ–° DNSè¨˜éŒ„
    - ç›£æ§æœå‹™ç‹€æ…‹
```

### 6.3 RTO/RPO è¦åŠƒ

| æœå‹™ç­‰ç´š | RTO | RPO | å‚™ä»½é »ç‡ | æ¢å¾©æ¸¬è©¦ |
|---------|-----|-----|---------|---------|
| é—œéµæ¥­å‹™ | < 1å°æ™‚ | < 15åˆ†é˜ | æ¯å°æ™‚ | æ¯æœˆ |
| é‡è¦æœå‹™ | < 4å°æ™‚ | < 1å°æ™‚ | æ¯å¤© | æ¯å­£ |
| ä¸€èˆ¬æœå‹™ | < 24å°æ™‚ | < 24å°æ™‚ | æ¯é€± | æ¯åŠå¹´ |

---

## 7. ç›£æ§èˆ‡å‘Šè­¦

### 7.1 é—œéµå‘Šè­¦è¦å‰‡

```yaml
groups:
- name: infrastructure
  rules:
  - alert: PodCrashLooping
    expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Pod {{ $labels.pod }} is crash looping"
  
  - alert: PodNotReady
    expr: kube_pod_status_phase{phase!~"Running|Succeeded"} > 0
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "Pod {{ $labels.pod }} not ready for 10 minutes"
```

---

## 8. æ•…éšœæ’æŸ¥æ¸…å–®

### 8.1 Pod å•é¡Œ

- â˜ æª¢æŸ¥ Pod ç‹€æ…‹ï¼š`kubectl get pods`
- â˜ æŸ¥çœ‹è©³ç´°ä¿¡æ¯ï¼š`kubectl describe pod`
- â˜ æª¢æŸ¥æ—¥èªŒï¼š`kubectl logs`
- â˜ æŸ¥çœ‹äº‹ä»¶ï¼š`kubectl get events`
- â˜ æª¢æŸ¥è³‡æºä½¿ç”¨ï¼š`kubectl top pod`

### 8.2 ç¶²çµ¡å•é¡Œ

- â˜ æª¢æŸ¥ Serviceï¼š`kubectl get svc`
- â˜ æ¸¬è©¦ DNSï¼š`nslookup service.namespace.svc.cluster.local`
- â˜ æª¢æŸ¥ NetworkPolicy
- â˜ æ¸¬è©¦é€£é€šæ€§ï¼š`curl/telnet`
- â˜ æª¢æŸ¥ Endpointsï¼š`kubectl get endpoints`

### 8.3 å­˜å„²å•é¡Œ

- â˜ æª¢æŸ¥ PVC ç‹€æ…‹ï¼š`kubectl get pvc`
- â˜ æª¢æŸ¥ PVï¼š`kubectl get pv`
- â˜ æŸ¥çœ‹ StorageClassï¼š`kubectl get sc`
- â˜ æª¢æŸ¥æ›è¼‰ï¼š`kubectl describe pod`

---

## 9. å°çµ

æœ¬ç« ä»‹ç´¹äº†å®Œæ•´çš„æ•…éšœè™•ç†èˆ‡æ¢å¾©æ–¹æ¡ˆï¼š

**æ•…éšœæ’æŸ¥ï¼š**
- âœ… ç³»çµ±åŒ–æ’æŸ¥æµç¨‹
- âœ… å¸¸è¦‹æ•…éšœæ¡ˆä¾‹ï¼ˆImagePullBackOffã€CrashLoopã€Pendingã€OOMKilledï¼‰
- âœ… kubectl debug é«˜ç´šèª¿è©¦
- âœ… æ—¥èªŒåˆ†ææŠ€å·§

**å‚™ä»½ç­–ç•¥ï¼š**
- âœ… etcd å‚™ä»½ï¼ˆæ‰‹å‹• + è‡ªå‹•åŒ–ï¼‰
- âœ… Velero å®Œæ•´å‚™ä»½æ–¹æ¡ˆ
- âœ… å®šæœŸå‚™ä»½èˆ‡ç”Ÿå‘½é€±æœŸç®¡ç†

**ç½é›£æ¢å¾©ï¼š**
- âœ… etcd æ¢å¾©æµç¨‹
- âœ… æ‡‰ç”¨ç´šæ¢å¾©æ¼”ç·´
- âœ… RTO/RPO è¦åŠƒ
- âœ… æ¢å¾©é©—è­‰

æ¥ä¸‹ä¾†æ˜¯æœ€å¾Œä¸€ç« ï¼šæˆæœ¬èˆ‡è³‡æºå„ªåŒ–ã€‚
