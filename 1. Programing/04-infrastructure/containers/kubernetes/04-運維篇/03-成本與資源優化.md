# 03-æˆæœ¬èˆ‡è³‡æºå„ªåŒ–

> é›²ç«¯æˆæœ¬åˆ†æã€è³‡æºåˆ©ç”¨ç‡å„ªåŒ–èˆ‡æˆæœ¬æ§åˆ¶ç­–ç•¥

---

## ğŸ“š æœ¬ç« ç›®æ¨™

- ç†è§£ Kubernetes æˆæœ¬æ¨¡å‹
- åˆ†æèˆ‡å„ªåŒ–è³‡æºåˆ©ç”¨ç‡
- å¯¦æ–½ç¯€é»èˆ‡å­˜å„²æˆæœ¬å„ªåŒ–
- å»ºç«‹æˆæœ¬ç›£æ§èˆ‡å‘Šè­¦æ©Ÿåˆ¶

---

## 1. Kubernetes æˆæœ¬æ¨¡å‹

### 1.1 æˆæœ¬æ§‹æˆ

```mermaid
graph TB
    subgraph "K8s æˆæœ¬æ§‹æˆ"
        A[ç¸½æˆæœ¬] --> B[è¨ˆç®—æˆæœ¬<br/>60-70%]
        A --> C[å­˜å„²æˆæœ¬<br/>15-20%]
        A --> D[ç¶²çµ¡æˆæœ¬<br/>10-15%]
        A --> E[å…¶ä»–æˆæœ¬<br/>5-10%]
    end
    
    B --> B1[EC2/Compute Engine]
    C --> C1[EBS/PD/PVC]
    D --> D1[LoadBalancer/Egress]
    E --> E1[Registry/Monitoring]
    
    style A fill:#f96
    style B fill:#fc9
```

### 1.2 æˆæœ¬åˆ†æå·¥å…·

**Kubecost å®‰è£ï¼š**
```bash
helm repo add kubecost https://kubecost.github.io/cost-analyzer/
helm install kubecost kubecost/cost-analyzer \
  --namespace kubecost \
  --create-namespace \
  --set kubecostToken="aGVsbUBrdWJlY29zdC5jb20=xm343yadf98"
```

**è¨ªå•Dashboardï¼š**
```bash
kubectl port-forward -n kubecost svc/kubecost-cost-analyzer 9090:9090
```

---

## 2. è³‡æºåˆ©ç”¨ç‡å„ªåŒ–

### 2.1 è­˜åˆ¥éåº¦é…ç½®

**æŸ¥æ‰¾ä½åˆ©ç”¨ç‡ Podï¼š**
```bash
kubectl get pods -A -o json | jq -r '
  .items[] | 
  select(.spec.containers[].resources.requests.cpu != null) |
  "\(.metadata.namespace)\t\(.metadata.name)\t\(.spec.containers[].resources.requests.cpu)"
'

kubectl top pods -A --sort-by=cpu

kubectl top pods -A --sort-by=memory
```

**è³‡æºä½¿ç”¨ç‡åˆ†æï¼š**
```promql
# CPU ä½¿ç”¨ç‡ < 20%
(
  sum(rate(container_cpu_usage_seconds_total{container!=""}[5m])) by (pod, namespace)
  /
  sum(kube_pod_container_resource_requests{resource="cpu"}) by (pod, namespace)
) < 0.2

# å…§å­˜ä½¿ç”¨ç‡ < 30%
(
  sum(container_memory_working_set_bytes{container!=""}) by (pod, namespace)
  /
  sum(kube_pod_container_resource_requests{resource="memory"}) by (pod, namespace)
) < 0.3
```

### 2.2 Right-sizing å»ºè­°

**ä½¿ç”¨ VPA æ¨è–¦ï¼š**
```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: webapp-recommender
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  
  updatePolicy:
    updateMode: "Off"
```

**æŸ¥çœ‹æ¨è–¦å€¼ï¼š**
```bash
kubectl describe vpa webapp-recommender
```

**å„ªåŒ–ç¤ºä¾‹ï¼š**
```yaml
# å„ªåŒ–å‰
resources:
  requests:
    cpu: "2000m"
    memory: "4Gi"
  limits:
    cpu: "4000m"
    memory: "8Gi"

# å„ªåŒ–å¾Œï¼ˆåŸºæ–¼å¯¦éš›ä½¿ç”¨ï¼‰
resources:
  requests:
    cpu: "500m"
    memory: "1Gi"
  limits:
    cpu: "1000m"
    memory: "2Gi"
```

**ç¯€çœï¼š** 75% è³‡æºè«‹æ±‚ï¼Œç´„ 60% æˆæœ¬é™ä½

---

## 3. ç¯€é»å„ªåŒ–

### 3.1 ç¯€é»é¡å‹é¸æ“‡

| å·¥ä½œè² è¼‰ | æ¨è–¦å¯¦ä¾‹é¡å‹ | æˆæœ¬å„ªåŒ–ç­–ç•¥ |
|---------|------------|------------|
| é€šç”¨è¨ˆç®— | t3.medium | Spot å¯¦ä¾‹ |
| å…§å­˜å¯†é›† | r5.large | Reserved Instance |
| CPU å¯†é›† | c5.xlarge | Savings Plans |
| GPU å·¥ä½œ | p3.2xlarge | æŒ‰éœ€ + Spot |

### 3.2 Spot/Preemptible å¯¦ä¾‹

**ç¯€é»æ± é…ç½®ï¼ˆGKEï¼‰ï¼š**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: spot-nodepool-config
data:
  config: |
    gcloud container node-pools create spot-pool \
      --cluster=my-cluster \
      --preemptible \
      --machine-type=n1-standard-4 \
      --num-nodes=3 \
      --enable-autoscaling \
      --min-nodes=1 \
      --max-nodes=10
```

**å®¹å¿ Spot ä¸­æ–·ï¼š**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: batch-processor
spec:
  template:
    spec:
      tolerations:
      - key: "cloud.google.com/gke-preemptible"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: cloud.google.com/gke-preemptible
                operator: In
                values:
                - "true"
```

**æˆæœ¬ç¯€çœï¼š** 60-90%

### 3.3 Cluster Autoscaler

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-config
  namespace: kube-system
data:
  config: |
    --balance-similar-node-groups=true
    --skip-nodes-with-local-storage=false
    --skip-nodes-with-system-pods=false
    --scale-down-enabled=true
    --scale-down-delay-after-add=10m
    --scale-down-unneeded-time=10m
    --scale-down-utilization-threshold=0.5
    --max-node-provision-time=15m
```

---

## 4. å­˜å„²æˆæœ¬å„ªåŒ–

### 4.1 å­˜å„²é¡å‹é¸æ“‡

| ç”¨é€” | å­˜å„²é¡å‹ | IOPS | æˆæœ¬ |
|-----|---------|------|------|
| æ•¸æ“šåº« | gp3 SSD | 16,000 | $$$ |
| æ—¥èªŒ | st1 HDD | 500 | $ |
| ç·©å­˜ | Local SSD | 400K | $$ |
| å‚™ä»½ | S3/GCS | - | $ |

**StorageClass å„ªåŒ–ï¼š**
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: cost-optimized
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete
allowVolumeExpansion: true
```

### 4.2 PV ç”Ÿå‘½é€±æœŸç®¡ç†

**è‡ªå‹•æ¸…ç† CronJobï¼š**
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pv-cleanup
spec:
  schedule: "0 0 * * 0"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pv-cleanup-sa
          containers:
          - name: cleanup
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              # åˆªé™¤ Released ç‹€æ…‹è¶…é 30 å¤©çš„ PV
              kubectl get pv -o json | \
              jq -r '.items[] | 
                select(.status.phase=="Released") | 
                select((now - (.metadata.creationTimestamp | fromdate)) > 2592000) | 
                .metadata.name' | \
              xargs -I {} kubectl delete pv {}
          restartPolicy: OnFailure
```

### 4.3 å°è±¡å­˜å„²æ›¿ä»£

**ä½¿ç”¨ S3/MinIOï¼š**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  template:
    spec:
      containers:
      - name: app
        image: myapp:v1.0
        env:
        - name: STORAGE_TYPE
          value: "s3"
        - name: S3_BUCKET
          value: "my-app-data"
        - name: S3_ENDPOINT
          value: "s3.amazonaws.com"
```

**æˆæœ¬å°æ¯”ï¼š**
- EBS gp3: $0.08/GB/æœˆ
- S3 Standard: $0.023/GB/æœˆ
- S3 IA: $0.0125/GB/æœˆ

**ç¯€çœï¼š** 71-84%

---

## 5. ç¶²çµ¡æˆæœ¬æ§åˆ¶

### 5.1 æ¸›å°‘è·¨å€åŸŸæµé‡

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp
  annotations:
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: webapp
```

### 5.2 ä½¿ç”¨ CDN

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/use-cdn: "true"
    nginx.ingress.kubernetes.io/cdn-origin: "cloudfront"
spec:
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /static
        pathType: Prefix
        backend:
          service:
            name: cdn-service
            port:
              number: 80
```

### 5.3 å…§ç¶²é€šä¿¡å„ªåŒ–

```yaml
apiVersion: v1
kind: Service
metadata:
  name: internal-api
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
spec:
  type: LoadBalancer
  selector:
    app: internal-api
```

---

## 6. æˆæœ¬ç›£æ§èˆ‡å‘Šè­¦

### 6.1 æˆæœ¬ç›£æ§é¢æ¿

**Prometheus æŸ¥è©¢ï¼š**
```promql
# æ¯å°æ™‚æˆæœ¬
sum(
  kube_pod_container_resource_requests{resource="cpu"} 
  * on(node) group_left() 
  node_cpu_hourly_cost
) / 1000

# namespace æˆæœ¬æ’å
topk(10, 
  sum(
    kube_pod_container_resource_requests{resource="cpu"}
  ) by (namespace)
)

# æœªä½¿ç”¨è³‡æºæˆæœ¬
sum(
  (
    kube_node_status_allocatable{resource="cpu"} 
    - 
    kube_pod_container_resource_requests{resource="cpu"}
  ) * node_cpu_hourly_cost
)
```

### 6.2 æˆæœ¬å‘Šè­¦

```yaml
groups:
- name: cost-alerts
  rules:
  - alert: HighMonthlyCost
    expr: sum(kubecost_cluster_management_cost) > 10000
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "Monthly cost exceeds $10,000"
  
  - alert: ResourceWaste
    expr: |
      (
        sum(kube_node_status_allocatable{resource="cpu"})
        -
        sum(kube_pod_container_resource_requests{resource="cpu"})
      ) / sum(kube_node_status_allocatable{resource="cpu"}) > 0.4
    for: 24h
    labels:
      severity: info
    annotations:
      summary: "Over 40% CPU capacity unused"
```

---

## 7. ResourceQuota é…é¡ç®¡ç†

### 7.1 Namespace é…é¡

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: team-quota
  namespace: development
spec:
  hard:
    requests.cpu: "50"
    requests.memory: 100Gi
    limits.cpu: "100"
    limits.memory: 200Gi
    
    pods: "100"
    services: "20"
    persistentvolumeclaims: "10"
    
    requests.storage: "500Gi"

---
apiVersion: v1
kind: LimitRange
metadata:
  name: resource-limits
  namespace: development
spec:
  limits:
  - max:
      cpu: "4"
      memory: "8Gi"
    min:
      cpu: "100m"
      memory: "128Mi"
    default:
      cpu: "500m"
      memory: "512Mi"
    defaultRequest:
      cpu: "200m"
      memory: "256Mi"
    type: Container
```

### 7.2 æˆæœ¬æ­¸å±¬

**æ¨™ç±¤ç­–ç•¥ï¼š**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    app: webapp
    team: backend
    cost-center: "engineering"
    project: "user-service"
    environment: "production"
```

**æˆæœ¬å ±å‘ŠæŸ¥è©¢ï¼š**
```promql
sum(
  kube_pod_labels{label_cost_center="engineering"}
  * on(pod) 
  kube_pod_container_resource_requests{resource="cpu"}
) by (label_team, label_project)
```

---

## 8. æˆæœ¬å„ªåŒ–æ¸…å–®

### 8.1 è¨ˆç®—å„ªåŒ–

- â˜ ä½¿ç”¨ VPA æ¨è–¦å€¼èª¿æ•´è³‡æº
- â˜ è­˜åˆ¥ä¸¦æ¸›å°‘éåº¦é…ç½®ï¼ˆ< 30% åˆ©ç”¨ç‡ï¼‰
- â˜ ä½¿ç”¨ Spot/Preemptible å¯¦ä¾‹ï¼ˆéé—œéµè² è¼‰ï¼‰
- â˜ å•Ÿç”¨ Cluster Autoscaler
- â˜ å®šæœŸå¯©æŸ¥ç¯€é»é¡å‹é¸æ“‡

### 8.2 å­˜å„²å„ªåŒ–

- â˜ ä½¿ç”¨åˆé©çš„å­˜å„²é¡å‹ï¼ˆgp3 vs st1ï¼‰
- â˜ æ¸…ç†æœªä½¿ç”¨çš„ PV/PVC
- â˜ é·ç§»éœæ…‹æ•¸æ“šåˆ°å°è±¡å­˜å„²
- â˜ å¯¦æ–½ç”Ÿå‘½é€±æœŸç­–ç•¥
- â˜ å£“ç¸®æ­¸æª”èˆŠæ•¸æ“š

### 8.3 ç¶²çµ¡å„ªåŒ–

- â˜ æ¸›å°‘è·¨å€åŸŸæµé‡
- â˜ ä½¿ç”¨ CDN æœå‹™éœæ…‹è³‡æº
- â˜ å…§éƒ¨æœå‹™ä½¿ç”¨å…§ç¶² LoadBalancer
- â˜ å„ªåŒ– Egress æµé‡

### 8.4 ç®¡ç†å„ªåŒ–

- â˜ è¨­ç½® namespace ResourceQuota
- â˜ å¯¦æ–½æˆæœ¬æ¨™ç±¤ç­–ç•¥
- â˜ å»ºç«‹æˆæœ¬ç›£æ§é¢æ¿
- â˜ é…ç½®æˆæœ¬å‘Šè­¦
- â˜ å®šæœŸæˆæœ¬å¯©æŸ¥æœƒè­°

---

## 9. æˆæœ¬å„ªåŒ–æ¡ˆä¾‹

### 9.1 å„ªåŒ–å‰

**é…ç½®ï¼š**
- 10 å€‹ m5.2xlarge ç¯€é»ï¼ˆæŒ‰éœ€ï¼‰
- 500GB gp2 å­˜å„²
- å…¬ç¶² LoadBalancer

**æœˆåº¦æˆæœ¬ï¼š** ~$5,000

### 9.2 å„ªåŒ–å¾Œ

**é…ç½®ï¼š**
- 3 å€‹ m5.xlarge ç¯€é»ï¼ˆReserved Instanceï¼‰
- 5 å€‹ m5.large ç¯€é»ï¼ˆSpotï¼Œéé—œéµè² è¼‰ï¼‰
- 200GB gp3 å­˜å„² + 300GB S3
- å…§ç¶² LoadBalancer + CloudFront CDN

**å„ªåŒ–æªæ–½ï¼š**
- Right-sizingï¼ˆVPA æ¨è–¦ï¼‰
- Spot å¯¦ä¾‹æ··åˆ
- å­˜å„²åˆ†å±¤
- ç¶²çµ¡å„ªåŒ–

**æœˆåº¦æˆæœ¬ï¼š** ~$1,800

**ç¯€çœï¼š** 64% ($3,200/æœˆ)

---

## 10. å°çµ

æœ¬ç« ä»‹ç´¹äº† Kubernetes æˆæœ¬å„ªåŒ–çš„å®Œæ•´ç­–ç•¥ï¼š

**æˆæœ¬åˆ†æï¼š**
- âœ… ç†è§£æˆæœ¬æ§‹æˆï¼ˆè¨ˆç®— 60-70%ã€å­˜å„² 15-20%ã€ç¶²çµ¡ 10-15%ï¼‰
- âœ… ä½¿ç”¨ Kubecost åˆ†æå·¥å…·
- âœ… è­˜åˆ¥éåº¦é…ç½®

**è³‡æºå„ªåŒ–ï¼š**
- âœ… Right-sizingï¼ˆVPA æ¨è–¦ï¼‰
- âœ… Spot/Preemptible å¯¦ä¾‹ï¼ˆ60-90% ç¯€çœï¼‰
- âœ… Cluster Autoscaler è‡ªå‹•æ“´ç¸®å®¹

**å­˜å„²å„ªåŒ–ï¼š**
- âœ… é¸æ“‡åˆé©çš„å­˜å„²é¡å‹
- âœ… PV ç”Ÿå‘½é€±æœŸç®¡ç†
- âœ… å°è±¡å­˜å„²æ›¿ä»£ï¼ˆç¯€çœ 71-84%ï¼‰

**ç¶²çµ¡å„ªåŒ–ï¼š**
- âœ… æ¸›å°‘è·¨å€åŸŸæµé‡
- âœ… CDN åŠ é€Ÿéœæ…‹è³‡æº
- âœ… å…§ç¶²æœå‹™é€šä¿¡

**æˆæœ¬ç®¡ç†ï¼š**
- âœ… ResourceQuota é…é¡æ§åˆ¶
- âœ… æˆæœ¬æ¨™ç±¤èˆ‡æ­¸å±¬
- âœ… ç›£æ§èˆ‡å‘Šè­¦
- âœ… å®šæœŸå¯©æŸ¥æ©Ÿåˆ¶

---

## ğŸ‰ Part IV é‹ç¶­ç¯‡å®Œæˆï¼

è‡³æ­¤ï¼ŒKubernetes é–‹ç™¼è€…å¯¦æˆ°æŒ‡å—çš„æ‰€æœ‰æ ¸å¿ƒç« ç¯€å·²ç¶“å®Œæˆï¼š

- âœ… **Part I: åŸºç¤ç¯‡**ï¼ˆ3ç« ï¼‰- å¿«é€Ÿä¸Šæ‰‹èˆ‡æ ¸å¿ƒæ¦‚å¿µ
- âœ… **Part II: é–‹ç™¼ç¯‡**ï¼ˆ3ç« ï¼‰- å®¹å™¨åŒ–ã€é…ç½®ã€æœå‹™é€šä¿¡
- âœ… **Part III: é€²éšç¯‡**ï¼ˆ4ç« ï¼‰- é«˜å¯ç”¨ã€ç›£æ§ã€å®‰å…¨ã€æ€§èƒ½
- âœ… **Part IV: é‹ç¶­ç¯‡**ï¼ˆ3ç« ï¼‰- GitOpsã€æ•…éšœè™•ç†ã€æˆæœ¬å„ªåŒ–

**ç¸½è¨ˆï¼š13 ç« æ ¸å¿ƒå…§å®¹ + å®Œæ•´å¯¦æˆ°æ¡ˆä¾‹**

ä¸‹ä¸€æ­¥ï¼šæ›´æ–° README æœ€çµ‚ç‰ˆæœ¬ã€‚
