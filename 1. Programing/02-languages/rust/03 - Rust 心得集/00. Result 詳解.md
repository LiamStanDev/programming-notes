### 定義與本值

`Result<T, E>` 是 Rust 標準庫中處理錯誤的主要方式，是一個泛型 `enum`，具有兩個變體：
```rust
enum Result<T, E> {
	Ok(T),
	Err(E),
}
```
* `T`, `E` 沒有限制，可以是任何型別
* 主要用於函數返回值，當預期操作可能會發生可恢復的錯誤時使用，`std crate` 中大量用於 I/O 操做。
* 可以使用 `?` 運算子立刻傳播錯誤

#### 簡單案例
```rust
fn divide(a: i32, b: i32) -> Result<i32, String> {
    if b == 0 {
        Err("Division by zero".to_string())
    } else {
        Ok(a / b)
    }
}
```
以上函數返回 `Result`，成功為 `i32` 失敗為 `String`。


#### `std` 中的 Error 設計
標準庫中定義 `std::error::Error` Trait 用於標準化 Error 類型，故可以使用 *trait object* 方便的向上傳遞，定義如下：
```rust
pub trait Error: Debug + Display {
    fn source(&self) -> Option<&(dyn Error + 'static)> { ... }
}
```
* Error 必須實現 `Display` 與 `Debug` Trait
	* 標準庫中 Error message 大部分會使用小寫並且不會有結尾的句號 e.g. `"invalid digit found in string"`
* `source()`: 用於提供導致錯誤的相關資訊

### 常見操作
#### 查詢變體
1. 判斷結果是成功或失敗  
- `is_ok(&self) -> bool`  
- `is_err(&self) -> bool`  

2. 判斷變體並對內部值套用條件函數  
- `is_ok_and(self, f: impl FnOnce(T) -> bool) -> bool`  
- `is_err_and(self, f: impl FnOnce(E) -> bool) -> bool`  

#### 提取內部值
- `expect(self, msg: &str) -> T`：`Err` 會 panic + 自訂訊息  
- `unwrap(self) -> T`：`Err` 會 panic + 通用訊息  
- **`unwrap_or(self, default: T) -> T`**：`Err` 返回預設值  
- **`unwrap_or_else(self, f: impl FnOnce(E) -> T) -> T`**：`Err` 執行函式產生預設值  

#### 轉換與適配（Transforming / Adapters）

1. 轉換成 `Option`
- `ok(self) -> Option<T>`：`Ok(v)` → `Some(v)`，`Err(_)` → `None`  
- `err(self) -> Option<E>`：`Err(e)` → `Some(e)`，`Ok(_)` → `None`  
- `transpose(self) -> Option<Result<_, _>>`：`Result<Option<T>, E>` ↔ `Option<Result<T, E>>`  

2. 針對 `Ok` 變體操作
- **`map(self, f: impl FnOnce(T) -> U) -> Result<U, E>`**：轉換內部成功值
- **`and_than(self, f: impl FnOnce(T) -> Result<U, E>) -> Result<U, E>`**: 鏈式操作，成功時執行可能失敗的函數 
- **`map_or(self, default: U, f: impl FnOnce(T) -> U) -> U`**：成功則轉換，失敗返回預設值  
- **`map_or_else(self, default: impl FnOnce(E) -> U, f: impl FnOnce(T) -> U) -> U`**：成功則轉換，失敗執行函數產生值  
- `inspect(self, f: impl FnOnce(&T)) -> Result<T, E>`：引用方式觀察成功值後返回原結果  

> `and_than` 與 `map` 最大的不同是轉換函數中是否可能會導致失敗，map 中轉換函數不會失敗也就是單純的轉換函數，而 and_than 用於對成功值進行操作會發生而外的失敗，所以會產生一個全新的 `Result`

3. 針對 `Err` 變體操作
- **`map_err(self, f: impl FnOnce(E) -> F) -> Result<T, F>`**：轉換錯誤值  
- `or(self, res: Result<T, F>) -> Result<T, F>`：錯誤時使用替代結果  
- `or_else(self, f: impl FnOnce(E) -> Result<T, F>) -> Result<T, F>`：錯誤時執行函數取得替代結果  
- `inspect_err(self, f: impl FnOnce(&E)) -> Result<T, E>`：引用方式觀察錯誤值後返回原結果  

4. 邏輯/鏈式組合操作
- `and(self, res: Result<U, E>) -> Result<U, E>`：成功時返回 `res`，失敗時保持原錯誤  




### 自定義錯誤
#### 1. 手搓錯誤類型
```rust
use std::fmt;

// 定義錯誤
#[derive(Debug)]
pub enum MyError {
    Io(std::io::Error),
    Parse(std::num::ParseIntError),
    Other(String),
}

// 為其實現 Display
impl fmt::Display for MyError {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        match self {
            MyError::Io(e) => write!(f, "IO error: {e}"),
            MyError::Parse(e) => write!(f, "Parse error: {e}"),
            MyError::Other(msg) => write!(f, "Other error: {msg}"),
        }
    }
}

// 為其實現 std::error::Error 以兼容標準庫錯誤
impl std::error::Error for MyError {
    fn source(&self) -> Option<&(dyn std::error::Error + 'static)> {
        match self {
            MyError::Io(e) => Some(e),
            MyError::Parse(e) => Some(e),
            MyError::Other(_) => None,
        }
    }
}
```


#### 2. 使用 `thiserror` 生成錯誤類型
`thiserror` crate 提供很多方便的 macro，用於 **簡化定義錯誤類型的實作**，包含生成：
* `std::fmt::Display` 實作
* `std::error::Error` 實作

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum MyError {
	// 標注型
	#[error("operation failed")]
	OperationFailed,

	// tuple 型
	#[error("invalid input: {0}")]
	InvalidInput(String),

	// struct 型
    #[error("database connection failed: {host}")]
    ConnectionFailed { host: String },

	// 其他錯誤類型轉換
	#[error("query failed: {source}")]
    QueryFailed {
        #[from] source: sqlx::Error, // 這邊表示從 sqlx::Error 轉換
    },

	// 來源錯誤資訊
	#[error("network error")]
    Network {
        #[source]
        source: reqwest::Error, // 可以用 error.source() 拿到原始錯誤
    },
}
```

##### `#from` vs `#source`

| 種類        | 說明                                                                                                                                                                       |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `#from`   | 依據上述案例 `#from` 會實現 `From<sqlx::Error>` 實作，表示你可以直接使用 `?` 或者 `into()` 將 `sqlx::Error` 轉換成 `MyError::QueryFailed` 錯誤變體，`sqlx::Error` 也會在 `std::error::Error::source()` 中返回。 |
| `#source` | 依據上述案例 `#source` 只會標注錯誤來源，並且可以在 `std::error::Error::source()` 中返回，並不會生成 `From<T>`，在其他語言中就是 `inner exception` 的概念。                                                        |
