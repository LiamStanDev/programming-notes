為了保護批處理系統不受到應用程序出錯而停止運行，我們需要 CPU 提供的特權級隔離機制。

# 特權機制的設計
---
保護操作系統安全，有以下機制
* 應用程序不能訪問任意的地址空間 (地址空間，不是本章內容)
* 應用程序不能執行可能破壞計算機系統的指令 (本章重點)

##### 應用程序如何獲得OS服務?
處理器設置兩個不同安全等級的執行環境: *用戶態特權級執行環境、內核態特權級執行環境*。明確區分內核態才能執行的指令，處理器在執行前會進行特權等級檢查，若在用戶態執行內核態特權級指令就會產生異常。
* `ecall` (Execution Environment Call): 具有用戶態到內核態的執行環境切換能力的函數調用指令。
* `eret` (Execution Environment Return): 具有內核態到用戶態執行環境切換能力的函數返回指令。
> `sret` 表示從 Supervisor 模式返回, `mret` 表示從 Machine 模式返回。

##### 用戶態道內核態轉換 (Exception)
1. 用戶態軟體需要操作系統服務，而執行特殊指令
2. 執行指令時出錯

* RISC-V 異常表

| Interrupt | Exception Code | Description                    |
| --------- | -------------- | ------------------------------ |
| 0         | 0              | Instruction address misaligned |
| 0         | 1              | Instruction access fault       |
| 0         | 2              | Illegal instruction            |
| 0         | 3              | Breakpoint                     |
| 0         | 4              | Load address misaligned        |
| 0         | 5              | Load access fault              |
| 0         | 6              | Store/AMO address misaligned   |
| 0         | 7              | Store/AMO access fault         |
| 0         | 8              | Environment call from U-mode   |
| 0         | 9              | Environment call from S-mode   |
| 0         | 11             | Environment call from M-mode   |
| 0         | 12             | Instruction page fault         |
| 0         | 13             | Load page fault                |
| 0         | 15             | Store/AMO page fault           |
其中斷點 (Break point) 與執行環境調用 (Environment call) 這兩種異常因為是有意為之，我們稱為 *Trap (陷入)*。

* M 模式與 S 模式之間相鄰的接口為 Supervisor Binary Interface (SBI)
* 內核 (S 模式) 與用戶 (U 模式) 之間的接口為 Application Binary Interface (ABI)，又被稱為「 系統調用 (syscall) 」。

![[Pasted image 20240503203120.png]]

其他異常常為執行指令時發生錯誤，或執行高於當前級別的指令與訪問不該訪問的高級資源，這些情況發生就需要將控制權轉給高特權軟體來執行處理如 OS。當錯誤/異常恢復後，則可重新回到低特權軟件繼續執行; 當不可恢復時，高特權軟件會直接殺死與清理低特權軟體。


