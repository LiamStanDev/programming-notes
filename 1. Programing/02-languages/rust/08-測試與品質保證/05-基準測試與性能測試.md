# åŸºæº–æ¸¬è©¦èˆ‡æ€§èƒ½æ¸¬è©¦

> åŸºæ–¼ Rust 1.90+ (2025) | é‡åŒ–å’Œå„ªåŒ–ç¨‹åºæ€§èƒ½

## ğŸ“‹ æ¦‚è¿°

åŸºæº–æ¸¬è©¦ (Benchmarking) æ˜¯è¡¡é‡ä»£ç¢¼æ€§èƒ½çš„é—œéµå·¥å…·ã€‚æœ¬ç« ä»‹ç´¹ Rust ç”Ÿæ…‹ä¸­çš„å„ç¨®æ€§èƒ½æ¸¬è©¦å·¥å…·å’Œæœ€ä½³å¯¦è¸,å¹«åŠ©ä½ ç·¨å¯«é«˜æ€§èƒ½çš„ä»£ç¢¼ã€‚

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦åŸºæº–æ¸¬è©¦?

### åŸºæº–æ¸¬è©¦çš„åƒ¹å€¼

```mermaid
graph LR
    A["åŸºæº–æ¸¬è©¦"] --> B["è­˜åˆ¥æ€§èƒ½ç“¶é ¸"]
    A --> C["é©—è­‰å„ªåŒ–æ•ˆæœ"]
    A --> D["é˜²æ­¢æ€§èƒ½é€€åŒ–"]
    A --> E["æŒ‡å°æ¶æ§‹æ±ºç­–"]
    
    B --> F["Profiling åˆ†æ"]
    C --> G["A/B å°æ¯”"]
    D --> H["CI é›†æˆ"]
    E --> I["ç®—æ³•é¸æ“‡"]
    
    style A fill:#4dabf7
    style B fill:#51cf66
    style C fill:#ffd93d
    style D fill:#ff6b6b
    style E fill:#b197fc
```

---

## ğŸš€ ä½¿ç”¨ Criterion.rs

### å®‰è£

```toml
[dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }

[[bench]]
name = "my_benchmark"
harness = false
```

### åŸºæœ¬ç”¨æ³•

**benches/my_benchmark.rs**:
```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn fibonacci(n: u64) -> u64 {
    match n {
        0 => 1,
        1 => 1,
        n => fibonacci(n - 1) + fibonacci(n - 2),
    }
}

fn fibonacci_benchmark(c: &mut Criterion) {
    c.bench_function("fib 20", |b| b.iter(|| fibonacci(black_box(20))));
}

criterion_group!(benches, fibonacci_benchmark);
criterion_main!(benches);
```

**é‹è¡Œ**:
```bash
$ cargo bench

fibonacci/fib 20        time:   [26.029 Âµs 26.251 Âµs 26.509 Âµs]
Found 11 outliers among 100 measurements (11.00%)
  6 (6.00%) high mild
  5 (5.00%) high severe
```

### black_box çš„é‡è¦æ€§

```rust
use criterion::{black_box, Criterion};

// âŒ éŒ¯èª¤: ç·¨è­¯å™¨æœƒå„ªåŒ–æ‰è¨ˆç®—
fn bad_benchmark(c: &mut Criterion) {
    c.bench_function("add", |b| {
        b.iter(|| 2 + 2)  // ç·¨è­¯å™¨å¯èƒ½ç›´æ¥è¿”å› 4
    });
}

// âœ… æ­£ç¢º: ä½¿ç”¨ black_box é˜²æ­¢å„ªåŒ–
fn good_benchmark(c: &mut Criterion) {
    c.bench_function("add", |b| {
        b.iter(|| black_box(2) + black_box(2))
    });
}
```

### åƒæ•¸åŒ–åŸºæº–æ¸¬è©¦

```rust
use criterion::{criterion_group, criterion_main, BenchmarkId, Criterion};

fn sort_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("sort");
    
    for size in [10, 100, 1000, 10000].iter() {
        group.bench_with_input(
            BenchmarkId::from_parameter(size),
            size,
            |b, &size| {
                b.iter(|| {
                    let mut data: Vec<i32> = (0..size).collect();
                    data.sort();
                    data
                });
            },
        );
    }
    
    group.finish();
}

criterion_group!(benches, sort_benchmark);
criterion_main!(benches);
```

**è¼¸å‡º**:
```
sort/10                 time:   [45.234 ns 45.789 ns 46.412 ns]
sort/100                time:   [892.34 ns 901.23 ns 911.45 ns]
sort/1000               time:   [12.456 Âµs 12.567 Âµs 12.689 Âµs]
sort/10000              time:   [156.78 Âµs 158.23 Âµs 159.89 Âµs]
```

---

## ğŸ¨ å¯¦æˆ°ç¯„ä¾‹

### ç¯„ä¾‹ 1: æ¯”è¼ƒä¸åŒå¯¦ç¾

```rust
use criterion::{criterion_group, criterion_main, Criterion, BenchmarkId};

// å¯¦ç¾ 1: éè¿´
fn fibonacci_recursive(n: u64) -> u64 {
    match n {
        0 | 1 => 1,
        n => fibonacci_recursive(n - 1) + fibonacci_recursive(n - 2),
    }
}

// å¯¦ç¾ 2: è¿­ä»£
fn fibonacci_iterative(n: u64) -> u64 {
    let mut a = 0;
    let mut b = 1;
    
    for _ in 0..n {
        let temp = a;
        a = b;
        b = temp + b;
    }
    
    b
}

// å¯¦ç¾ 3: ä½¿ç”¨è¨˜æ†¶åŒ–
fn fibonacci_memoized(n: u64) -> u64 {
    let mut memo = vec![0; (n + 1) as usize];
    memo[0] = 1;
    memo[1] = 1;
    
    for i in 2..=n as usize {
        memo[i] = memo[i - 1] + memo[i - 2];
    }
    
    memo[n as usize]
}

fn fibonacci_comparison(c: &mut Criterion) {
    let mut group = c.benchmark_group("fibonacci");
    
    for n in [10, 20, 30].iter() {
        group.bench_with_input(
            BenchmarkId::new("recursive", n),
            n,
            |b, &n| b.iter(|| fibonacci_recursive(black_box(n))),
        );
        
        group.bench_with_input(
            BenchmarkId::new("iterative", n),
            n,
            |b, &n| b.iter(|| fibonacci_iterative(black_box(n))),
        );
        
        group.bench_with_input(
            BenchmarkId::new("memoized", n),
            n,
            |b, &n| b.iter(|| fibonacci_memoized(black_box(n))),
        );
    }
    
    group.finish();
}

criterion_group!(benches, fibonacci_comparison);
criterion_main!(benches);
```

### ç¯„ä¾‹ 2: æ¸¬è©¦æ•¸æ“šçµæ§‹

```rust
use criterion::{criterion_group, criterion_main, Criterion};
use std::collections::{HashMap, BTreeMap};

fn map_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("map_insert");
    
    group.bench_function("HashMap", |b| {
        b.iter(|| {
            let mut map = HashMap::new();
            for i in 0..1000 {
                map.insert(i, i * 2);
            }
            map
        });
    });
    
    group.bench_function("BTreeMap", |b| {
        b.iter(|| {
            let mut map = BTreeMap::new();
            for i in 0..1000 {
                map.insert(i, i * 2);
            }
            map
        });
    });
    
    group.finish();
}

criterion_group!(benches, map_benchmark);
criterion_main!(benches);
```

### ç¯„ä¾‹ 3: æ¸¬è©¦å­—ç¬¦ä¸²æ“ä½œ

```rust
use criterion::{criterion_group, criterion_main, Criterion};

fn string_concat_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("string_concat");
    
    // æ–¹æ³• 1: + é‹ç®—ç¬¦
    group.bench_function("plus_operator", |b| {
        b.iter(|| {
            let mut result = String::new();
            for i in 0..100 {
                result = result + &i.to_string();
            }
            result
        });
    });
    
    // æ–¹æ³• 2: push_str
    group.bench_function("push_str", |b| {
        b.iter(|| {
            let mut result = String::new();
            for i in 0..100 {
                result.push_str(&i.to_string());
            }
            result
        });
    });
    
    // æ–¹æ³• 3: format!
    group.bench_function("format", |b| {
        b.iter(|| {
            let mut result = String::new();
            for i in 0..100 {
                result = format!("{}{}", result, i);
            }
            result
        });
    });
    
    // æ–¹æ³• 4: collect
    group.bench_function("collect", |b| {
        b.iter(|| {
            (0..100)
                .map(|i| i.to_string())
                .collect::<String>()
        });
    });
    
    group.finish();
}

criterion_group!(benches, string_concat_benchmark);
criterion_main!(benches);
```

---

## ğŸ”§ é€²éš Criterion åŠŸèƒ½

### è¨­ç½®æ¨£æœ¬å¤§å°å’Œæ¸¬é‡æ™‚é–“

```rust
use criterion::{criterion_group, criterion_main, Criterion};
use std::time::Duration;

fn custom_config_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("custom_config");
    
    // è¨­ç½®æ¨£æœ¬å¤§å°
    group.sample_size(10);
    
    // è¨­ç½®æ¸¬é‡æ™‚é–“
    group.measurement_time(Duration::from_secs(5));
    
    // è¨­ç½®ç†±èº«æ™‚é–“
    group.warm_up_time(Duration::from_secs(1));
    
    group.bench_function("test", |b| {
        b.iter(|| {
            // æ¸¬è©¦ä»£ç¢¼
        });
    });
    
    group.finish();
}

criterion_group!(benches, custom_config_benchmark);
criterion_main!(benches);
```

### ååé‡æ¸¬é‡

```rust
use criterion::{criterion_group, criterion_main, Criterion, Throughput};

fn throughput_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("throughput");
    
    let data = vec![0u8; 1024 * 1024]; // 1 MB
    
    group.throughput(Throughput::Bytes(data.len() as u64));
    
    group.bench_function("process_data", |b| {
        b.iter(|| {
            // è™•ç†æ•¸æ“š
            data.iter().sum::<u8>()
        });
    });
    
    group.finish();
}

criterion_group!(benches, throughput_benchmark);
criterion_main!(benches);
```

**è¼¸å‡º**:
```
throughput/process_data time:   [1.2345 ms 1.2456 ms 1.2567 ms]
                        thrpt:  [812.34 MiB/s 820.12 MiB/s 828.45 MiB/s]
```

### è¿­ä»£è¨ˆæ•¸

```rust
use criterion::{criterion_group, criterion_main, Criterion};

fn iter_count_benchmark(c: &mut Criterion) {
    c.bench_function("custom_iter", |b| {
        b.iter_custom(|iters| {
            let start = std::time::Instant::now();
            
            for _ in 0..iters {
                // æ¸¬è©¦ä»£ç¢¼
                black_box(expensive_operation());
            }
            
            start.elapsed()
        });
    });
}

criterion_group!(benches, iter_count_benchmark);
criterion_main!(benches);
```

---

## ğŸ² ä½¿ç”¨ Divan (æ›´å¿«çš„åŸºæº–æ¸¬è©¦)

### å®‰è£

```toml
[dev-dependencies]
divan = "0.1"
```

### åŸºæœ¬ç”¨æ³•

```rust
use divan::Bencher;

fn fibonacci(n: u64) -> u64 {
    match n {
        0 | 1 => 1,
        n => fibonacci(n - 1) + fibonacci(n - 2),
    }
}

#[divan::bench]
fn bench_fibonacci() {
    fibonacci(divan::black_box(20));
}

#[divan::bench(args = [10, 20, 30])]
fn bench_fibonacci_args(n: u64) {
    fibonacci(divan::black_box(n));
}

fn main() {
    divan::main();
}
```

**é‹è¡Œ**:
```bash
$ cargo bench --bench my_divan_bench
```

---

## ğŸ“Š å…§å»ºåŸºæº–æ¸¬è©¦ (Nightly)

### ä½¿ç”¨ test::Bencher

```rust
#![feature(test)]
extern crate test;

use test::Bencher;

#[bench]
fn bench_add(b: &mut Bencher) {
    b.iter(|| {
        test::black_box(2 + 2)
    });
}

#[bench]
fn bench_vec_push(b: &mut Bencher) {
    b.iter(|| {
        let mut v = Vec::new();
        for i in 0..100 {
            v.push(i);
        }
        v
    });
}
```

**é‹è¡Œ**:
```bash
$ cargo +nightly bench

running 2 tests
test bench_add      ... bench:           0 ns/iter (+/- 0)
test bench_vec_push ... bench:         234 ns/iter (+/- 12)
```

---

## ğŸ” æ€§èƒ½åˆ†æå·¥å…·

### cargo-flamegraph

```bash
# å®‰è£
$ cargo install flamegraph

# ç”Ÿæˆç«ç„°åœ–
$ cargo flamegraph --bench my_benchmark

# è¼¸å‡º: flamegraph.svg
```

### perf + cargo

```bash
# Linux ä¸Šä½¿ç”¨ perf
$ cargo build --release
$ perf record --call-graph dwarf ./target/release/my_program
$ perf report
```

### samply (ç¾ä»£æ€§èƒ½åˆ†æå™¨)

```bash
# å®‰è£
$ cargo install samply

# é‹è¡Œåˆ†æ
$ samply record cargo run --release

# åœ¨ç€è¦½å™¨ä¸­æŸ¥çœ‹çµæœ
```

---

## ğŸ¯ åŸºæº–æ¸¬è©¦æœ€ä½³å¯¦è¸

### 1. éš”é›¢æ¸¬è©¦ç’°å¢ƒ

```bash
# âŒ ä¸å¥½: åœ¨å¾Œå°é‹è¡Œå…¶ä»–ç¨‹åº
$ cargo bench

# âœ… å¥½: é—œé–‰ä¸å¿…è¦çš„ç¨‹åº,å›ºå®š CPU é »ç‡
$ sudo cpupower frequency-set --governor performance
$ cargo bench
$ sudo cpupower frequency-set --governor powersave
```

### 2. ä½¿ç”¨ baseline æ¯”è¼ƒ

```bash
# ä¿å­˜åŸºç·š
$ cargo bench --bench my_bench -- --save-baseline baseline

# ä¿®æ”¹ä»£ç¢¼å¾Œæ¯”è¼ƒ
$ cargo bench --bench my_bench -- --baseline baseline

# è¼¸å‡º:
# add                     time:   [10.234 ns 10.456 ns 10.678 ns]
#                         change: [-5.2345% -3.1234% -1.2345%] (p = 0.00 < 0.05)
#                         Performance has improved.
```

### 3. æ¸¬è©¦å¤šå€‹è¼¸å…¥å¤§å°

```rust
use criterion::{criterion_group, criterion_main, Criterion, BenchmarkId};

fn size_scaling_benchmark(c: &mut Criterion) {
    let mut group = c.benchmark_group("scaling");
    
    for size in [10, 100, 1000, 10000, 100000].iter() {
        group.bench_with_input(
            BenchmarkId::from_parameter(size),
            size,
            |b, &size| {
                let data: Vec<i32> = (0..size).collect();
                b.iter(|| process_data(&data));
            },
        );
    }
    
    group.finish();
}
```

### 4. é¿å…å¸¸è¦‹é™·é˜±

```rust
// âŒ é™·é˜± 1: åœ¨å¾ªç’°å…§åˆ†é…è¨˜æ†¶é«”
#[bench]
fn bad_benchmark(b: &mut Bencher) {
    b.iter(|| {
        let mut v = Vec::new();  // æ¯æ¬¡è¿­ä»£éƒ½åˆ†é…
        for i in 0..1000 {
            v.push(i);
        }
    });
}

// âœ… æ­£ç¢º: åœ¨å¤–éƒ¨åˆ†é…
#[bench]
fn good_benchmark(b: &mut Bencher) {
    let mut v = Vec::with_capacity(1000);
    b.iter(|| {
        v.clear();
        for i in 0..1000 {
            v.push(i);
        }
    });
}

// âŒ é™·é˜± 2: æ¸¬è©¦å¤ªç°¡å–®,è¢«å„ªåŒ–æ‰
#[bench]
fn too_simple(b: &mut Bencher) {
    b.iter(|| 2 + 2);  // å¯èƒ½è¢«å„ªåŒ–ç‚ºå¸¸é‡
}

// âœ… æ­£ç¢º: ä½¿ç”¨ black_box
#[bench]
fn properly_benchmarked(b: &mut Bencher) {
    b.iter(|| black_box(2) + black_box(2));
}
```

---

## ğŸ“ˆ CI é›†æˆ

### GitHub Actions é…ç½®

```yaml
name: Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Run benchmarks
      run: cargo bench --no-fail-fast
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: target/criterion/
```

### æ€§èƒ½é€€åŒ–æª¢æ¸¬

```yaml
    - name: Compare with baseline
      run: |
        cargo bench --bench my_bench -- --save-baseline PR
        cargo bench --bench my_bench -- --baseline main --save-baseline current
        
        # æª¢æŸ¥æ˜¯å¦æœ‰é¡¯è‘—é€€åŒ–
        if grep -q "Performance has regressed" target/criterion/*/report/index.html; then
          echo "Performance regression detected!"
          exit 1
        fi
```

---

## ğŸ“ æ€§èƒ½å„ªåŒ–å·¥ä½œæµ

### å„ªåŒ–å¾ªç’°

```mermaid
graph LR
    A["ç·¨å¯«åŸºæº–æ¸¬è©¦"] --> B["æ¸¬é‡åŸºç·šæ€§èƒ½"]
    B --> C["è­˜åˆ¥ç“¶é ¸"]
    C --> D["å¯¦æ–½å„ªåŒ–"]
    D --> E["é‡æ–°æ¸¬é‡"]
    E --> F{"æ€§èƒ½æå‡?"}
    F -->|æ˜¯| G["ä¿ç•™å„ªåŒ–"]
    F -->|å¦| H["å›æ»¾æ›´æ”¹"]
    G --> I{"é”åˆ°ç›®æ¨™?"}
    H --> I
    I -->|å¦| C
    I -->|æ˜¯| J["å®Œæˆ"]
    
    style A fill:#4dabf7
    style D fill:#ffd93d
    style F fill:#ff6b6b
    style J fill:#51cf66
```

### å¯¦æˆ°ç¯„ä¾‹: å„ªåŒ–æŸ¥æ‰¾ç®—æ³•

```rust
use criterion::{criterion_group, criterion_main, Criterion, BenchmarkId};

// ç‰ˆæœ¬ 1: ç·šæ€§æŸ¥æ‰¾
fn linear_search(data: &[i32], target: i32) -> Option<usize> {
    data.iter().position(|&x| x == target)
}

// ç‰ˆæœ¬ 2: äºŒåˆ†æŸ¥æ‰¾ (è¦æ±‚æœ‰åº)
fn binary_search(data: &[i32], target: i32) -> Option<usize> {
    data.binary_search(&target).ok()
}

// ç‰ˆæœ¬ 3: ä½¿ç”¨ HashSet
use std::collections::HashSet;

fn hashset_search(data: &HashSet<i32>, target: i32) -> bool {
    data.contains(&target)
}

fn search_comparison(c: &mut Criterion) {
    let mut group = c.benchmark_group("search");
    
    for size in [100, 1000, 10000].iter() {
        let data: Vec<i32> = (0..*size).collect();
        let target = size / 2;
        
        // ç·šæ€§æŸ¥æ‰¾
        group.bench_with_input(
            BenchmarkId::new("linear", size),
            &(&data, target),
            |b, (data, &target)| {
                b.iter(|| linear_search(data, target));
            },
        );
        
        // äºŒåˆ†æŸ¥æ‰¾
        group.bench_with_input(
            BenchmarkId::new("binary", size),
            &(&data, target),
            |b, (data, &target)| {
                b.iter(|| binary_search(data, target));
            },
        );
        
        // HashSet æŸ¥æ‰¾
        let hashset: HashSet<i32> = data.iter().copied().collect();
        group.bench_with_input(
            BenchmarkId::new("hashset", size),
            &(&hashset, target),
            |b, (set, &target)| {
                b.iter(|| hashset_search(set, target));
            },
        );
    }
    
    group.finish();
}

criterion_group!(benches, search_comparison);
criterion_main!(benches);
```

**çµæœåˆ†æ**:
```
search/linear/100       time:   [45.234 ns  ...]
search/binary/100       time:   [12.456 ns  ...]  â† å¿« 3.6x
search/hashset/100      time:   [8.123 ns   ...]  â† å¿« 5.6x

search/linear/10000     time:   [4.523 Âµs   ...]
search/binary/10000     time:   [34.56 ns   ...]  â† å¿« 130x
search/hashset/10000    time:   [8.234 ns   ...]  â† å¿« 550x
```

---

## ğŸ“– åƒè€ƒè³‡æ–™

1. [Criterion.rs Documentation](https://bheisler.github.io/criterion.rs/book/)
2. [The Rust Performance Book](https://nnethercote.github.io/perf-book/)
3. [Divan Documentation](https://docs.rs/divan/)
4. [Flamegraph Documentation](https://github.com/flamegraph-rs/flamegraph)
5. [Linux perf Tutorial](https://perf.wiki.kernel.org/index.php/Tutorial)

---

*æœ€å¾Œæ›´æ–°: 2025-01-17*  
*Rust ç‰ˆæœ¬: 1.90+*
