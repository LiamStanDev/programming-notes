# 市場數據處理管線

完整的 Feed Handler 與 Order Book 實作。

---

## 1. Feed Handler 架構

```cpp
class FeedHandler {
    int udp_socket_;
    OrderBookManager order_books_;
    
public:
    void run() {
        while (true) {
            char buffer[8192];
            ssize_t len = recvfrom(udp_socket_, buffer, sizeof(buffer), 0, nullptr, nullptr);
            
            if (len > 0) {
                process_packet(buffer, len);
            }
        }
    }
    
private:
    void process_packet(const char* data, size_t len) {
        // 解析封包
        MarketDataPacket packet;
        if (parse_packet(data, len, packet)) {
            // 更新 Order Book
            order_books_.update(packet);
        }
    }
};
```

---

## 2. Order Book 實現

```cpp
class OrderBook {
    struct PriceLevel {
        double price;
        uint64_t total_volume;
        std::list<Order> orders;
    };
    
    std::map<double, PriceLevel, std::greater<>> bids_;  // 降序
    std::map<double, PriceLevel> asks_;                  // 升序
    
public:
    void add_order(double price, uint64_t volume, Side side) {
        auto& levels = (side == Side::BID) ? bids_ : asks_;
        
        auto& level = levels[price];
        level.price = price;
        level.total_volume += volume;
        level.orders.push_back({price, volume});
    }
    
    std::pair<double, uint64_t> best_bid() const {
        if (bids_.empty()) return {0, 0};
        const auto& level = bids_.begin()->second;
        return {level.price, level.total_volume};
    }
    
    std::pair<double, uint64_t> best_ask() const {
        if (asks_.empty()) return {0, 0};
        const auto& level = asks_.begin()->second;
        return {level.price, level.total_volume};
    }
};
```

---

## 參考資料

1. **Market Data Protocols**
   - [ITCH Protocol](https://www.nasdaqtrader.com/content/technicalsupport/specifications/dataproducts/NQTVITCHspecification.pdf)
