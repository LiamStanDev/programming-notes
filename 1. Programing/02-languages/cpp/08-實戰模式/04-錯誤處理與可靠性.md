# 錯誤處理與可靠性

生產環境的錯誤處理策略與可靠性保證。

---

## 1. 錯誤處理策略

### 1.1 std::expected (C++23)

```cpp
#include <expected>

std::expected<Order, ErrorCode> create_order(const Signal& signal) {
    if (signal.price <= 0) {
        return std::unexpected(ErrorCode::INVALID_PRICE);
    }
    
    if (signal.quantity <= 0) {
        return std::unexpected(ErrorCode::INVALID_QUANTITY);
    }
    
    Order order;
    // 建立訂單...
    return order;
}

// 使用
auto result = create_order(signal);
if (result) {
    send_order(*result);
} else {
    log_error(result.error());
}
```

---

## 2. Circuit Breaker 模式

```cpp
class CircuitBreaker {
    enum class State { CLOSED, OPEN, HALF_OPEN };
    
    State state_ = State::CLOSED;
    int failure_count_ = 0;
    int threshold_ = 5;
    std::chrono::steady_clock::time_point last_failure_;
    
public:
    template<typename Func>
    auto execute(Func func) -> decltype(func()) {
        if (state_ == State::OPEN) {
            // 檢查是否可以嘗試恢復
            auto now = std::chrono::steady_clock::now();
            if (now - last_failure_ > std::chrono::seconds(60)) {
                state_ = State::HALF_OPEN;
            } else {
                throw std::runtime_error("Circuit breaker is OPEN");
            }
        }
        
        try {
            auto result = func();
            on_success();
            return result;
        } catch (...) {
            on_failure();
            throw;
        }
    }
    
private:
    void on_success() {
        failure_count_ = 0;
        state_ = State::CLOSED;
    }
    
    void on_failure() {
        ++failure_count_;
        last_failure_ = std::chrono::steady_clock::now();
        
        if (failure_count_ >= threshold_) {
            state_ = State::OPEN;
        }
    }
};
```

---

## 3. 監控與告警

```cpp
class MonitoringSystem {
public:
    void report_metric(const std::string& name, double value) {
        // 發送到 Prometheus/Grafana
    }
    
    void send_alert(const std::string& message, Severity severity) {
        // 發送告警到 PagerDuty/Slack
    }
};
```

---

## 參考資料

1. **Reliability Patterns**
   - [Release It! 2nd Edition](https://pragprog.com/titles/mnee2/release-it-second-edition/)
