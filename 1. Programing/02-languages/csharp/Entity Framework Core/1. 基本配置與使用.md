## Introduction
---
### Features
1. Modeling : 將資料庫與c# object映射
2. Querying
3. Changing Tracking
4. Saving
5. Concurrency
6. Transactions
7. Caching : 不用反覆向DB進行獲取
8. Built-in Convention : e.g. Id 對應 primary key
9. Configurations 
10. **Migrations** : EF core 會使用我們寫的 code 來建立 對應的資料庫，也就是可以進行 code first。
	* 需要使用 *Microsoft.EntityFrameworkCore.Design*
> Database first 也是沒問題的。

### Important Class
1. DBContext: 是與DB交互的getway，用來與資料庫建立session。
2. DBSet : 對應資料庫中的Table

### 核心庫
1. code first: `Microsoft.EntityFrameworkCore.Design`
2. 數據庫 Driver (database provider for EF core)
	* SQLite: `Microsoft.EntityFrameworkCore.Sqlite` 
	* MySQL, MariaDB: `Pomelo.EntityFrameworkCore.MySql`
	* Postgres: `Npgsql.EntityFrameworkCore.PostgreSQL`
	* SQL Server: `Microsoft.EntityFrameworkCore.SqlServer`

## 使用方式
---
### 初始化配置
1. 建立對應數據的數據庫連接上下文
```c#
public class StoreContext : DbContext {// 繼承
	public StoreContext(DbContextOptions options) : base(options) {} // 我們希望傳入我們客製化的內容
	// 感興趣的表
	public DbSet<Product> Products {get; set;}
	...
}
```

2. 將 StoreContext (數據庫連接上下文)添加到DI容器中，並添加數據庫連接字符串。
```c#
// Program.cs
builder.Services.AddDbContext<StoreContext>(opt => {
	// this method is for configuring database connection.
	opt.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection"));
	// opt.UseSqlite(builder.Configuration.GetSession("ConnectionStrings")["DefaultConnection"]);
});
```

3. 添加Connection String(數據庫連接字符串)於appsetting.Development.json中
```json
{
	"ConnectionStrings" : {
		"DefaultConnection" : "Data source=store.db" // for sqlite
		// "MySQL" : "server=localhost;port=3306;database=activities;uid=root;pwd=870107"
	}
}
```

4. 使用dotnet ef tool 來生成腳首架: produce template code
這邊使用 migrations 如同上面講的，migration 時會依照我們的 code 建立對應的數據庫。
```shell
dotnet ef migrations add InitialCreate -s API --project Persistence -o Data/Migrations 
# Now output dir is API/Data/Migrations
```
> -o 的起始目錄會使指定為 --project 目錄，project 目錄為 DbContext 所在項目，-s 表示 starter 項目

##### 生成出來的文件做了甚麼事呢? 
請看Migrations/xxxxxxxx_InitialCreate.cs 文件
1. 類繼承了 EFCore 的 Migration 類
2. 重寫 Up 與 Down 方法。
	1. Up : 建立 table 並且將 property 對應到 column 上。
	2. Down : 撤銷

5. 執行腳首架: execute template code to build database
* *步驟一: 建立數據庫*
這將會執行前面生成出來的程式，並實際建立一個數據庫(初始化數據庫所需要的 column)。
```shell
dotnet ef database update --project API # 更新
# dotnet ef database drop --project API # 刪除
```
* *步驟二: 生成 Seed 數據*
在 app.Run() 之前，建立一個 scope 表示每一次 HTTP 請求都會進行一次(老師教的)，但我個人認為使用 Singleton。
```c#
// 建立 scope
using (var scope = app.Services.CreateScope()) {
    try {
        // 這邊不能使用app.Serivices.GetRequiredService，因為這樣取得的服務
        // 生命週期大於scope
        var context = scope.ServiceProvider.GetRequiredService<StoreContext>();
        context.Database.Migrate();
        DbInitializer.Initialize(context);
    } catch (Exception ex) {

        var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "A problem occurred during migration");
        throw;
    }
}
```