# 用戶文件上傳
---
通過 HTTP 協議從前端（如 Chrome 瀏覽器）傳送文件到後端時，文件通常會被包含在請求的 body 中，並使用 `multipart/form-data` 這種內容類型來傳送。
### 前端
```html
<!DOCTYPE html>
<html>
<head>
    <title>File Upload</title>
</head>
<body>
    <form id="uploadForm">
	    <!-- 使用 button file 來放置文件 -->
        <input type="file" id="fileInput" name="file"><br>
        <input type="text" id="textInput" name="text" placeholder="Enter some text"><br>
        <input type="number" id="numberInput" name="number" placeholder="Enter a number"><br>
        <button type="submit">Upload</button>
    </form>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(event) {
        
		    <!-- 避免默認行為的頁面刷新到新的 URI -->
            event.preventDefault(); 
            
		    <!-- 建立一個 multipart/form-data 的 body -->
            const formData = new FormData();
            const fileInput = document.getElementById('fileInput');
            const textInput = document.getElementById('textInput');
            const numberInput = document.getElementById('numberInput');
            formData.append('file', fileInput.files[0]);
            formData.append('text', textInput.value);
            formData.append('number', numberInput.value);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                console.log('Success:', result);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
```

### 後端
```cs
namespace FileUploadDemo.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class FileUploadController : ControllerBase
    {
        [HttpPost("upload")]
        // 使用 IFormFile 來讀取 File
        public async Task<IActionResult> UploadFile([FromForm] IFormFile file, [FromForm] string text, [FromForm] int number)
        {
            if (file == null || file.Length == 0)
            {
                return BadRequest("No file uploaded");
            }

            var filePath = Path.Combine("uploads", file.FileName);

            //　保存文件
            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }

            // 將其他內容保存到數據庫中
            // ... 
            var metaData = new
            {
                Text = text,
                Number = number
            };

            // 返回结果，包括文件路徑與其他資料
            return Ok(new { filePath, metaData });
        }
    }
}
```

# 用戶文件下載
---
### 後端
```cs
namespace FileUploadDemo.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class FileDownloadController : ControllerBase
    {
        [HttpGet("download/{fileName}")]
        public async Task<IActionResult> DownloadFile(string fileName)
        {
            var filePath = Path.Combine("uploads", fileName);

            if (!System.IO.File.Exists(filePath))
            {
                return NotFound("File not found");
            }

            var memory = new MemoryStream(); // 讓內存作為緩沖，讓數據流更有效率
            using (var stream = new FileStream(filePath, FileMode.Open))
            {
                await stream.CopyToAsync(memory);
            }

            memory.Position = 0;
            var contentType = "application/octet-stream";
            return File(memory, contentType, fileName);
        }
    }
}
```
> content type:
> * `text/html`
> * `image/png`
> * `application/json`
> * `multipart/formdata`
> * `application/octet-stream`: 用於二進制流，適用於所有類型文件，大多數瀏覽器不會直接在瀏覽器中開啟該文件，而是提供下載界面供用戶下載至本地

### 前端
```html
<!DOCTYPE html>
<html>
<head>
    <title>File Download</title>
</head>
<body>
    <input type="text" id="fileNameInput" placeholder="Enter file name">
    <button id="downloadButton">Download</button>

    <script>
        document.getElementById('downloadButton').addEventListener('click', function() {
            const fileName = document.getElementById('fileNameInput').value;
            if (!fileName) {
                alert('Please enter a file name');
                return;
            }

            fetch(`/api/filedownload/download/${fileName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob(); // blob 為二進制流對象
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob); // 建立一個臨時的 URL 給 blob
                    const link = document.createElement('a'); // 建立一個 a 標籤
                    link.style.display = 'none'; // 設定其為不可見
                    link.href = url; // 設定標籤的 url
                    link.download = fileName; // 設定標籤的點擊後下載名稱
                    document.body.appendChild(link); // 添加到 dom 中
                    link.click(); // 點擊
                    window.URL.revokeObjectURL(url); // 移除臨時 URL
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                    alert('File not found or an error occurred');
                });
        });
    </script>
</body>
</html>
```
> a tag 使用方式 https://www.w3schools.com/tags/tag_a.asp


