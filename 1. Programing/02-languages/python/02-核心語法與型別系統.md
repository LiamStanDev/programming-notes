# 02-æ ¸å¿ƒèªæ³•èˆ‡å‹åˆ¥ç³»çµ±

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

Python çš„å‹åˆ¥ç³»çµ±èˆ‡è³‡æ–™çµæ§‹ï¼š
- **å…§å»ºè³‡æ–™çµæ§‹**: list, dict, set, tuple
- **å‹åˆ¥æç¤º**: Type Hints (PEP 484)
- **è³‡æ–™é¡åˆ¥**: dataclass, NamedTuple, TypedDict
- **æ¨å°å¼**: Comprehensions
- **ç”Ÿæˆå™¨**: Generators

```mermaid
graph TD
    A[Python å‹åˆ¥ç³»çµ±] --> B[åŸºç¤å‹åˆ¥]
    A --> C[å®¹å™¨å‹åˆ¥]
    A --> D[å‹åˆ¥æç¤º]
    A --> E[é€²éšå‹åˆ¥]
    
    B --> B1[int, float, str, bool]
    B --> B2[None, bytes]
    
    C --> C1[list]
    C --> C2[dict]
    C --> C3[set]
    C --> C4[tuple]
    
    D --> D1[åŸºç¤è¨»è§£]
    D --> D2[Generic]
    D --> D3[Union/Optional]
    
    E --> E1[dataclass]
    E --> E2[TypedDict]
    E --> E3[Protocol]
```

## ğŸ”§ å…§å»ºè³‡æ–™çµæ§‹

### List - å‹•æ…‹é™£åˆ—

```python
# å‰µå»ºèˆ‡åŸºæœ¬æ“ä½œ
nums = [1, 2, 3, 4, 5]
empty = []
mixed = [1, "hello", 3.14, True]

# ç´¢å¼•èˆ‡åˆ‡ç‰‡
nums[0]        # 1
nums[-1]       # 5 (å€’æ•¸ç¬¬ä¸€å€‹)
nums[1:3]      # [2, 3] (å·¦é–‰å³é–‹)
nums[:2]       # [1, 2]
nums[2:]       # [3, 4, 5]
nums[::2]      # [1, 3, 5] (æ­¥é€²ç‚º 2)
nums[::-1]     # [5, 4, 3, 2, 1] (åè½‰)

# ä¿®æ”¹æ“ä½œ
nums.append(6)           # å°¾éƒ¨æ·»åŠ : [1, 2, 3, 4, 5, 6]
nums.insert(0, 0)        # æŒ‡å®šä½ç½®æ’å…¥: [0, 1, 2, 3, 4, 5, 6]
nums.extend([7, 8])      # æ“´å±•åˆ—è¡¨: [0, 1, 2, 3, 4, 5, 6, 7, 8]
nums.pop()               # ç§»é™¤ä¸¦è¿”å›æœ€å¾Œå…ƒç´ : 8
nums.pop(0)              # ç§»é™¤ä¸¦è¿”å›æŒ‡å®šä½ç½®: 0
nums.remove(3)           # ç§»é™¤ç¬¬ä¸€å€‹å€¼ç‚º 3 çš„å…ƒç´ 
del nums[0]              # åˆªé™¤æŒ‡å®šä½ç½®
nums.clear()             # æ¸…ç©ºåˆ—è¡¨

# æ’åºèˆ‡åè½‰
nums = [3, 1, 4, 1, 5]
nums.sort()              # åŸåœ°æ’åº: [1, 1, 3, 4, 5]
nums.sort(reverse=True)  # é™åº: [5, 4, 3, 1, 1]
sorted_nums = sorted(nums)  # è¿”å›æ–°åˆ—è¡¨
nums.reverse()           # åŸåœ°åè½‰

# æŸ¥æ‰¾
nums.index(3)            # è¿”å›ç¬¬ä¸€å€‹å€¼ç‚º 3 çš„ç´¢å¼•
nums.count(1)            # çµ±è¨ˆå€¼ç‚º 1 çš„å…ƒç´ æ•¸é‡
3 in nums                # True
len(nums)                # é•·åº¦
```

### Dict - å­—å…¸

```python
# å‰µå»º
user = {"name": "Alice", "age": 30, "email": "alice@example.com"}
empty = {}
from_pairs = dict([("a", 1), ("b", 2)])

# è¨ªå•
user["name"]                  # "Alice"
user.get("name")              # "Alice"
user.get("phone", "N/A")      # ä¸å­˜åœ¨è¿”å›é è¨­å€¼ "N/A"

# ä¿®æ”¹
user["age"] = 31              # æ›´æ–°
user["phone"] = "123456"      # æ–°å¢
user.update({"city": "NY"})   # æ‰¹é‡æ›´æ–°

# åˆªé™¤
del user["phone"]             # åˆªé™¤éµ
user.pop("email")             # åˆªé™¤ä¸¦è¿”å›å€¼
user.popitem()                # åˆªé™¤ä¸¦è¿”å›æœ€å¾Œæ’å…¥çš„éµå€¼å° (3.7+)
user.clear()                  # æ¸…ç©º

# è¿­ä»£
for key in user:              # è¿­ä»£éµ
    print(key)

for value in user.values():   # è¿­ä»£å€¼
    print(value)

for key, value in user.items():  # è¿­ä»£éµå€¼å°
    print(f"{key}: {value}")

# å¸¸ç”¨æ–¹æ³•
user.keys()                   # dict_keys(['name', 'age'])
user.values()                 # dict_values(['Alice', 30])
user.items()                  # dict_items([('name', 'Alice'), ('age', 30)])
"name" in user                # True

# å­—å…¸æ¨å°å¼
squares = {x: x**2 for x in range(5)}  # {0: 0, 1: 1, 2: 4, 3: 9, 4: 16}
```

### Set - é›†åˆ

```python
# å‰µå»º
s = {1, 2, 3, 4, 5}
empty = set()                 # æ³¨æ„: {} æ˜¯ç©ºå­—å…¸
from_list = set([1, 2, 2, 3]) # {1, 2, 3} è‡ªå‹•å»é‡

# æ·»åŠ èˆ‡åˆªé™¤
s.add(6)                      # æ·»åŠ å…ƒç´ 
s.update([7, 8, 9])           # æ‰¹é‡æ·»åŠ 
s.remove(1)                   # ç§»é™¤å…ƒç´ ï¼ˆä¸å­˜åœ¨æœƒå ±éŒ¯ï¼‰
s.discard(1)                  # ç§»é™¤å…ƒç´ ï¼ˆä¸å­˜åœ¨ä¸å ±éŒ¯ï¼‰
s.pop()                       # éš¨æ©Ÿç§»é™¤ä¸¦è¿”å›å…ƒç´ 
s.clear()                     # æ¸…ç©º

# é›†åˆé‹ç®—
a = {1, 2, 3, 4}
b = {3, 4, 5, 6}

a | b                         # {1, 2, 3, 4, 5, 6} è¯é›†
a & b                         # {3, 4} äº¤é›†
a - b                         # {1, 2} å·®é›†
a ^ b                         # {1, 2, 5, 6} å°ç¨±å·®é›†

# å­é›†èˆ‡è¶…é›†
{1, 2}.issubset({1, 2, 3})    # True
{1, 2, 3}.issuperset({1, 2})  # True

# æˆå“¡æª¢æŸ¥ï¼ˆO(1)ï¼‰
3 in a                        # True
```

### Tuple - ä¸å¯è®Šåºåˆ—

```python
# å‰µå»º
point = (3, 4)
single = (1,)                 # å–®å…ƒç´ éœ€è¦é€—è™Ÿ
empty = ()

# è¨ªå•
point[0]                      # 3
x, y = point                  # è§£åŒ…
point[1] = 5                  # TypeError: ä¸å¯ä¿®æ”¹

# ç”¨é€”ï¼šä½œç‚ºå­—å…¸éµ
locations = {
    (0, 0): "origin",
    (1, 0): "right",
}
```

## ğŸ”§ å‹åˆ¥æç¤º (Type Hints)

### åŸºç¤å‹åˆ¥è¨»è§£

```python
from typing import List, Dict, Set, Tuple, Optional, Union

# åŸºç¤å‹åˆ¥
name: str = "Alice"
age: int = 30
height: float = 5.6
is_active: bool = True

# å®¹å™¨å‹åˆ¥
numbers: list[int] = [1, 2, 3]              # Python 3.9+
names: List[str] = ["Alice", "Bob"]         # Python 3.8-
scores: dict[str, int] = {"math": 90}       # Python 3.9+
old_scores: Dict[str, int] = {"math": 90}   # Python 3.8-

# å¯é¸å‹åˆ¥
email: Optional[str] = None                 # str æˆ– None
email: str | None = None                    # Python 3.10+

# è¯åˆå‹åˆ¥
user_id: Union[int, str] = "user_123"       # int æˆ– str
user_id: int | str = 123                    # Python 3.10+

# å‡½æ•¸è¨»è§£
def greet(name: str, age: int = 0) -> str:
    return f"Hello {name}, you are {age} years old"

def process_data(data: list[dict[str, int]]) -> None:
    for item in data:
        print(item)
```

### é€²éšå‹åˆ¥

```python
from typing import Any, Callable, Literal, TypeAlias, TypeVar

# Any - ä»»æ„å‹åˆ¥
data: Any = "anything"

# Callable - å‡½æ•¸å‹åˆ¥
def apply(func: Callable[[int, int], int], x: int, y: int) -> int:
    return func(x, y)

apply(lambda a, b: a + b, 1, 2)  # 3

# Literal - å­—é¢å€¼å‹åˆ¥
def set_mode(mode: Literal["read", "write", "append"]) -> None:
    print(f"Mode: {mode}")

# TypeAlias - å‹åˆ¥åˆ¥å
Vector: TypeAlias = list[float]
Matrix: TypeAlias = list[Vector]

# TypeVar - æ³›å‹
T = TypeVar("T")

def first(items: list[T]) -> T | None:
    return items[0] if items else None

first([1, 2, 3])      # æ¨æ–·ç‚º int
first(["a", "b"])     # æ¨æ–·ç‚º str
```

## ğŸ”§ è³‡æ–™é¡åˆ¥

### dataclass - è³‡æ–™é¡

```python
from dataclasses import dataclass, field
from datetime import datetime

@dataclass
class User:
    id: int
    name: str
    email: str
    created_at: datetime = field(default_factory=datetime.now)
    tags: list[str] = field(default_factory=list)
    
    def __post_init__(self):
        self.email = self.email.lower()

# ä½¿ç”¨
user = User(id=1, name="Alice", email="ALICE@example.com")
print(user)
# User(id=1, name='Alice', email='alice@example.com', created_at=..., tags=[])

# è‡ªå‹•ç”Ÿæˆ __init__, __repr__, __eq__ ç­‰æ–¹æ³•

@dataclass(frozen=True)  # ä¸å¯è®Š
class Point:
    x: float
    y: float

@dataclass(order=True)  # å¯æ¯”è¼ƒå¤§å°
class Score:
    value: int
    student: str = field(compare=False)  # æ¯”è¼ƒæ™‚å¿½ç•¥æ­¤æ¬„ä½
```

### NamedTuple - å…·åå…ƒçµ„

```python
from typing import NamedTuple

class Point(NamedTuple):
    x: float
    y: float
    
    def distance(self) -> float:
        return (self.x ** 2 + self.y ** 2) ** 0.5

p = Point(3.0, 4.0)
print(p.x, p.y)        # 3.0 4.0
print(p.distance())    # 5.0
print(p[0])            # 3.0 (ä»å¯ç”¨ç´¢å¼•è¨ªå•)

# ä¸å¯è®Š
p.x = 5  # AttributeError
```

### TypedDict - å‹åˆ¥åŒ–å­—å…¸

```python
from typing import TypedDict, NotRequired

class UserDict(TypedDict):
    id: int
    name: str
    email: str
    age: NotRequired[int]  # å¯é¸æ¬„ä½

def create_user(user: UserDict) -> None:
    print(user["name"])

user: UserDict = {
    "id": 1,
    "name": "Alice",
    "email": "alice@example.com",
}
create_user(user)
```

## ğŸ”§ æ¨å°å¼ (Comprehensions)

### List Comprehension

```python
# åŸºç¤
squares = [x**2 for x in range(10)]
# [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]

# å¸¶æ¢ä»¶
evens = [x for x in range(10) if x % 2 == 0]
# [0, 2, 4, 6, 8]

# é›™é‡è¿´åœˆ
pairs = [(x, y) for x in range(3) for y in range(3) if x != y]
# [(0, 1), (0, 2), (1, 0), (1, 2), (2, 0), (2, 1)]

# å¯¦éš›æ‡‰ç”¨ï¼šå±•å¹³äºŒç¶­åˆ—è¡¨
matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
flat = [num for row in matrix for num in row]
# [1, 2, 3, 4, 5, 6, 7, 8, 9]
```

### Dict Comprehension

```python
# åŸºç¤
squares = {x: x**2 for x in range(5)}
# {0: 0, 1: 1, 2: 4, 3: 9, 4: 16}

# æ¢ä»¶éæ¿¾
even_squares = {x: x**2 for x in range(10) if x % 2 == 0}

# éµå€¼äº’æ›
original = {"a": 1, "b": 2, "c": 3}
swapped = {v: k for k, v in original.items()}
# {1: 'a', 2: 'b', 3: 'c'}

# å¯¦éš›æ‡‰ç”¨ï¼šçµ±è¨ˆå­—æ¯å‡ºç¾æ¬¡æ•¸
text = "hello world"
char_count = {char: text.count(char) for char in set(text) if char != " "}
```

### Set Comprehension

```python
# åŸºç¤
unique_lengths = {len(word) for word in ["hello", "world", "hi"]}
# {2, 5}

# å¯¦éš›æ‡‰ç”¨ï¼šæå–æ‰€æœ‰ç¨ç‰¹å­—æ¯
text = "hello world"
unique_chars = {char for char in text if char.isalpha()}
```

## ğŸ”§ ç”Ÿæˆå™¨ (Generators)

### Generator Expression

```python
# é¡ä¼¼ list comprehensionï¼Œä½†ä½¿ç”¨åœ“æ‹¬è™Ÿ
gen = (x**2 for x in range(1000000))  # ä¸ç«‹å³è¨ˆç®—

# æƒ°æ€§æ±‚å€¼
for val in gen:
    if val > 100:
        break
    print(val)
```

### Generator Function

```python
def fibonacci(n: int):
    a, b = 0, 1
    for _ in range(n):
        yield a
        a, b = b, a + b

for num in fibonacci(10):
    print(num)  # 0 1 1 2 3 5 8 13 21 34

# å¯¦éš›æ‡‰ç”¨ï¼šè®€å–å¤§æª”æ¡ˆ
def read_large_file(file_path: str):
    with open(file_path) as f:
        for line in f:
            yield line.strip()

for line in read_large_file("large.txt"):
    process(line)
```

## ğŸ’¡ å¯¦æˆ°æ¡ˆä¾‹ï¼šè³‡æ–™è™•ç†

```python
from dataclasses import dataclass
from typing import Iterator

@dataclass
class Transaction:
    id: int
    amount: float
    category: str
    is_income: bool

# æ¨¡æ“¬è³‡æ–™
transactions = [
    Transaction(1, 1000.0, "salary", True),
    Transaction(2, 50.0, "food", False),
    Transaction(3, 200.0, "shopping", False),
    Transaction(4, 500.0, "bonus", True),
    Transaction(5, 30.0, "food", False),
]

# ä½¿ç”¨æ¨å°å¼è¨ˆç®—ç¸½æ”¶å…¥
total_income = sum(t.amount for t in transactions if t.is_income)
print(f"Total income: ${total_income}")  # $1500.0

# æŒ‰é¡åˆ¥åˆ†çµ„ï¼ˆä½¿ç”¨å­—å…¸æ¨å°å¼ï¼‰
from itertools import groupby

transactions_sorted = sorted(transactions, key=lambda t: t.category)
by_category = {
    category: list(group) 
    for category, group in groupby(transactions_sorted, key=lambda t: t.category)
}

# ç”Ÿæˆå™¨ï¼šè™•ç†å¤§é‡äº¤æ˜“è¨˜éŒ„
def process_transactions(trans: list[Transaction]) -> Iterator[dict[str, float]]:
    for t in trans:
        yield {
            "id": t.id,
            "net_amount": t.amount if t.is_income else -t.amount,
            "category": t.category,
        }

for record in process_transactions(transactions):
    print(record)
```

## âš ï¸ å¸¸è¦‹é™·é˜±

### 1. å¯è®Šé è¨­åƒæ•¸

```python
# âŒ éŒ¯èª¤ï¼šå¯è®Šé è¨­åƒæ•¸æœƒåœ¨æ‰€æœ‰å‘¼å«é–“å…±äº«
def add_item(item: str, items: list[str] = []) -> list[str]:
    items.append(item)
    return items

print(add_item("a"))  # ['a']
print(add_item("b"))  # ['a', 'b']  # é æœŸæ˜¯ ['b']

# âœ… æ­£ç¢ºï¼šä½¿ç”¨ None ä¸¦åœ¨å‡½æ•¸å…§å‰µå»º
def add_item(item: str, items: list[str] | None = None) -> list[str]:
    if items is None:
        items = []
    items.append(item)
    return items
```

### 2. è¿´åœˆè®Šæ•¸é–‰åŒ…

```python
# âŒ éŒ¯èª¤ï¼šæ‰€æœ‰å‡½æ•¸å…±äº«ç›¸åŒçš„ i
funcs = [lambda: i for i in range(5)]
print([f() for f in funcs])  # [4, 4, 4, 4, 4]

# âœ… æ­£ç¢ºï¼šä½¿ç”¨é è¨­åƒæ•¸æ•ç²ç•¶å‰å€¼
funcs = [lambda i=i: i for i in range(5)]
print([f() for f in funcs])  # [0, 1, 2, 3, 4]
```

### 3. å­—å…¸éµçš„å¯è®Šæ€§

```python
# âŒ éŒ¯èª¤ï¼šlist ä¸å¯ä½œç‚ºå­—å…¸éµ
d = {[1, 2]: "value"}  # TypeError

# âœ… æ­£ç¢ºï¼šä½¿ç”¨ tuple
d = {(1, 2): "value"}
```

### 4. é›†åˆä¿®æ”¹æ™‚è¿­ä»£

```python
# âŒ éŒ¯èª¤ï¼šè¿­ä»£æ™‚ä¿®æ”¹é›†åˆ
s = {1, 2, 3, 4, 5}
for item in s:
    if item % 2 == 0:
        s.remove(item)  # RuntimeError

# âœ… æ­£ç¢ºï¼šå‰µå»ºå‰¯æœ¬è¿­ä»£
s = {1, 2, 3, 4, 5}
for item in list(s):
    if item % 2 == 0:
        s.remove(item)
```

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **ä½¿ç”¨å‹åˆ¥æç¤ºæå‡ç¨‹å¼ç¢¼å¯è®€æ€§**
   ```python
   def process_users(users: list[dict[str, Any]]) -> list[User]:
       ...
   ```

2. **å„ªå…ˆä½¿ç”¨ dataclass è€Œéæ™®é€šé¡**
   ```python
   @dataclass
   class Config:
       host: str
       port: int
       timeout: float = 30.0
   ```

3. **ä½¿ç”¨æ¨å°å¼æ›¿ä»£ map/filter**
   ```python
   # âœ… æ¸…æ™°
   squares = [x**2 for x in nums if x > 0]
   
   # âŒ é›£è®€
   squares = list(map(lambda x: x**2, filter(lambda x: x > 0, nums)))
   ```

4. **å¤§æ•¸æ“šé›†ä½¿ç”¨ç”Ÿæˆå™¨**
   ```python
   # ç¯€çœè¨˜æ†¶é«”
   total = sum(x**2 for x in range(1000000))
   ```

5. **å–„ç”¨ get() é¿å… KeyError**
   ```python
   value = user.get("email", "no-email@example.com")
   ```
