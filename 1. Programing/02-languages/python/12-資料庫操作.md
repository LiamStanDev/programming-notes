# 12-è³‡æ–™åº«æ“ä½œ

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

- **SQLAlchemy**: ORM æ¡†æ¶
- **ç•°æ­¥è³‡æ–™åº«**: asyncpg, aiomysql
- **Redis**: å¿«å–èˆ‡æ¶ˆæ¯éšŠåˆ—
- **MongoDB**: NoSQL è³‡æ–™åº«

```mermaid
graph TD
    A[è³‡æ–™åº«æ“ä½œ] --> B[SQLAlchemy ORM]
    A --> C[ç•°æ­¥è³‡æ–™åº«]
    A --> D[Redis]
    
    B --> B1[æ¨¡å‹å®šç¾©]
    B --> B2[æŸ¥è©¢]
    B --> B3[é—œè¯]
    
    C --> C1[asyncpg]
    C --> C2[aiomysql]
```

## ğŸ”§ SQLAlchemy

### åŸºç¤è¨­ç½®

```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    
    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String, unique=True)

engine = create_engine('sqlite:///database.db')
Base.metadata.create_all(engine)

Session = sessionmaker(bind=engine)
session = Session()

# å‰µå»º
user = User(name='Alice', email='alice@example.com')
session.add(user)
session.commit()

# æŸ¥è©¢
users = session.query(User).all()
user = session.query(User).filter_by(name='Alice').first()

# æ›´æ–°
user.email = 'newemail@example.com'
session.commit()

# åˆªé™¤
session.delete(user)
session.commit()
```

### ç•°æ­¥ SQLAlchemy

```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

engine = create_async_engine('postgresql+asyncpg://user:pass@localhost/db')

async_session = sessionmaker(
    engine, class_=AsyncSession, expire_on_commit=False
)

async def create_user(name: str, email: str):
    async with async_session() as session:
        user = User(name=name, email=email)
        session.add(user)
        await session.commit()
        return user
```

## ğŸ”§ Redis

```python
import redis

r = redis.Redis(host='localhost', port=6379, db=0)

# è¨­ç½®å€¼
r.set('key', 'value')
r.setex('key', 60, 'value')  # 60ç§’éæœŸ

# ç²å–å€¼
value = r.get('key')

# Hash
r.hset('user:1', mapping={'name': 'Alice', 'email': 'alice@example.com'})
r.hget('user:1', 'name')

# List
r.lpush('queue', 'task1')
r.rpop('queue')

# ç™¼å¸ƒè¨‚é–±
r.publish('channel', 'message')
```

## ğŸ’¡ å¯¦æˆ°æ¡ˆä¾‹

```python
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship, sessionmaker
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    posts = relationship('Post', back_populates='author')

class Post(Base):
    __tablename__ = 'posts'
    id = Column(Integer, primary_key=True)
    title = Column(String)
    user_id = Column(Integer, ForeignKey('users.id'))
    author = relationship('User', back_populates='posts')

engine = create_engine('sqlite:///blog.db')
Base.metadata.create_all(engine)

Session = sessionmaker(bind=engine)
session = Session()

# å‰µå»ºç”¨æˆ¶å’Œæ–‡ç« 
user = User(name='Alice')
post1 = Post(title='First Post', author=user)
post2 = Post(title='Second Post', author=user)

session.add_all([user, post1, post2])
session.commit()

# æŸ¥è©¢
user = session.query(User).filter_by(name='Alice').first()
print(f"{user.name} has {len(user.posts)} posts")

for post in user.posts:
    print(f"- {post.title}")
```
