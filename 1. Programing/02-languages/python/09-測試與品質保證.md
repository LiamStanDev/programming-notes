# 09-æ¸¬è©¦èˆ‡å“è³ªä¿è­‰

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

- **å–®å…ƒæ¸¬è©¦**: pytest, unittest
- **æ¸¬è©¦è¦†è“‹ç‡**: coverage
- **Mock**: unittest.mock
- **æ¸¬è©¦ç­–ç•¥**: TDD, BDD

```mermaid
graph TD
    A[æ¸¬è©¦èˆ‡å“è³ª] --> B[pytest]
    A --> C[Coverage]
    A --> D[Mock]
    A --> E[CI/CD]
    
    B --> B1[fixtures]
    B --> B2[parametrize]
    B --> B3[markers]
    
    C --> C1[è¦†è“‹ç‡å ±å‘Š]
    C --> C2[åˆ†æ”¯è¦†è“‹]
    
    D --> D1[Mockå°è±¡]
    D --> D2[Patch]
```

## ğŸ”§ pytest åŸºç¤

### ç°¡å–®æ¸¬è©¦

```python
# test_calculator.py
def add(a: int, b: int) -> int:
    return a + b

def test_add():
    assert add(2, 3) == 5
    assert add(-1, 1) == 0
    assert add(0, 0) == 0

def test_add_negative():
    assert add(-5, -3) == -8

# é‹è¡Œ: pytest test_calculator.py
```

### Fixtures

```python
import pytest

@pytest.fixture
def sample_data():
    return [1, 2, 3, 4, 5]

def test_sum(sample_data):
    assert sum(sample_data) == 15

def test_length(sample_data):
    assert len(sample_data) == 5

@pytest.fixture
def database_connection():
    conn = setup_database()
    yield conn  # æä¾›çµ¦æ¸¬è©¦
    conn.close()  # æ¸…ç†

def test_query(database_connection):
    result = database_connection.query("SELECT 1")
    assert result == 1
```

### Parametrize

```python
import pytest

@pytest.mark.parametrize("a,b,expected", [
    (2, 3, 5),
    (-1, 1, 0),
    (0, 0, 0),
    (100, 200, 300),
])
def test_add(a, b, expected):
    assert add(a, b) == expected
```

### ç•°å¸¸æ¸¬è©¦

```python
import pytest

def divide(a: int, b: int) -> float:
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b

def test_divide_by_zero():
    with pytest.raises(ValueError, match="Cannot divide by zero"):
        divide(10, 0)
```

## ğŸ”§ Coverage

```bash
# å®‰è£
uv add --dev pytest-cov

# é‹è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
pytest --cov=src --cov-report=html

# æŸ¥çœ‹å ±å‘Š
open htmlcov/index.html
```

## ğŸ”§ Mock

```python
from unittest.mock import Mock, patch

# Mock å°è±¡
def test_api_call():
    mock_response = Mock()
    mock_response.status_code = 200
    mock_response.json.return_value = {"data": "success"}
    
    assert mock_response.status_code == 200
    assert mock_response.json() == {"data": "success"}

# Patch
def fetch_user_data(user_id):
    import requests
    response = requests.get(f"https://api.example.com/users/{user_id}")
    return response.json()

@patch('requests.get')
def test_fetch_user_data(mock_get):
    mock_response = Mock()
    mock_response.json.return_value = {"id": 1, "name": "Alice"}
    mock_get.return_value = mock_response
    
    result = fetch_user_data(1)
    assert result["name"] == "Alice"
    mock_get.assert_called_once_with("https://api.example.com/users/1")
```

## ğŸ’¡ å¯¦æˆ°æ¡ˆä¾‹

```python
# src/user_service.py
class UserService:
    def __init__(self, db):
        self.db = db
    
    def create_user(self, name: str, email: str) -> dict:
        if not email or "@" not in email:
            raise ValueError("Invalid email")
        user = self.db.insert({"name": name, "email": email})
        return user

# tests/test_user_service.py
import pytest
from unittest.mock import Mock
from src.user_service import UserService

@pytest.fixture
def mock_db():
    db = Mock()
    db.insert.return_value = {"id": 1, "name": "Alice", "email": "alice@example.com"}
    return db

@pytest.fixture
def user_service(mock_db):
    return UserService(mock_db)

def test_create_user_success(user_service, mock_db):
    user = user_service.create_user("Alice", "alice@example.com")
    assert user["name"] == "Alice"
    mock_db.insert.assert_called_once()

def test_create_user_invalid_email(user_service):
    with pytest.raises(ValueError, match="Invalid email"):
        user_service.create_user("Bob", "invalid-email")

@pytest.mark.parametrize("email", ["", "no-at-sign", "@", "test@"])
def test_create_user_invalid_emails(user_service, email):
    with pytest.raises(ValueError):
        user_service.create_user("Test", email)
```

## ğŸ’¡ æœ€ä½³å¯¦è¸

```python
# 1. ä½¿ç”¨ fixtures å…±äº«è¨­ç½®
@pytest.fixture(scope="module")
def expensive_resource():
    resource = setup_expensive_resource()
    yield resource
    resource.cleanup()

# 2. æ¸¬è©¦å‘½åæ¸…æ™°
def test_user_creation_with_valid_email_succeeds():
    pass

# 3. ä¸€å€‹æ¸¬è©¦ä¸€å€‹æ–·è¨€
def test_user_has_correct_name():
    user = create_user("Alice")
    assert user.name == "Alice"

def test_user_has_correct_email():
    user = create_user("Alice", "alice@example.com")
    assert user.email == "alice@example.com"

# 4. ä½¿ç”¨ parametrize æ¸›å°‘é‡è¤‡
@pytest.mark.parametrize("input,expected", [
    ("valid@email.com", True),
    ("invalid", False),
    ("@test.com", False),
])
def test_email_validation(input, expected):
    assert validate_email(input) == expected
```
