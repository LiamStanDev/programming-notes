# 04-ç‰©ä»¶å°å‘èˆ‡å”è­°

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

Python çš„ç‰©ä»¶å°å‘ç·¨ç¨‹ï¼š
- **é¡èˆ‡å¯¦ä¾‹**: é¡å®šç¾©ã€å¯¦ä¾‹åŒ–
- **ç¹¼æ‰¿**: å–®ç¹¼æ‰¿ã€å¤šé‡ç¹¼æ‰¿ã€MRO
- **å°è£**: å±¬æ€§ã€æ–¹æ³•ã€å­˜å–æ§åˆ¶
- **ç‰¹æ®Šæ–¹æ³•**: Magic Methods / Dunder Methods
- **å”è­°**: Protocolã€ABC

```mermaid
graph TD
    A[ç‰©ä»¶å°å‘] --> B[åŸºç¤æ¦‚å¿µ]
    A --> C[ç¹¼æ‰¿é«”ç³»]
    A --> D[ç‰¹æ®Šæ–¹æ³•]
    A --> E[é€²éšç‰¹æ€§]
    
    B --> B1[é¡å®šç¾©]
    B --> B2[å¯¦ä¾‹å±¬æ€§]
    B --> B3[é¡å±¬æ€§]
    B --> B4[æ–¹æ³•]
    
    C --> C1[å–®ç¹¼æ‰¿]
    C --> C2[å¤šé‡ç¹¼æ‰¿]
    C --> C3[MRO]
    
    D --> D1[__init__]
    D --> D2[__str__/__repr__]
    D --> D3[__call__]
    D --> D4[é‹ç®—ç¬¦é‡è¼‰]
    
    E --> E1[Property]
    E --> E2[Descriptor]
    E --> E3[Protocol]
    E --> E4[ABC]
```

## ğŸ”§ é¡èˆ‡å¯¦ä¾‹

### åŸºæœ¬é¡å®šç¾©

```python
class User:
    species = "Homo sapiens"  # é¡å±¬æ€§
    
    def __init__(self, name: str, age: int):
        self.name = name      # å¯¦ä¾‹å±¬æ€§
        self.age = age
    
    def greet(self) -> str:   # å¯¦ä¾‹æ–¹æ³•
        return f"Hello, I'm {self.name}"
    
    @classmethod
    def from_birth_year(cls, name: str, birth_year: int) -> "User":
        age = 2024 - birth_year
        return cls(name, age)
    
    @staticmethod
    def is_adult(age: int) -> bool:
        return age >= 18

# ä½¿ç”¨
user = User("Alice", 30)
print(user.greet())          # "Hello, I'm Alice"
print(User.species)          # "Homo sapiens"

user2 = User.from_birth_year("Bob", 1995)
print(User.is_adult(20))     # True
```

### å¯¦ä¾‹å±¬æ€§ vs é¡å±¬æ€§

```python
class Counter:
    count = 0  # é¡å±¬æ€§ï¼ˆæ‰€æœ‰å¯¦ä¾‹å…±äº«ï¼‰
    
    def __init__(self, name: str):
        self.name = name        # å¯¦ä¾‹å±¬æ€§
        Counter.count += 1      # ä¿®æ”¹é¡å±¬æ€§
        self.instance_id = Counter.count

c1 = Counter("first")
c2 = Counter("second")

print(Counter.count)     # 2
print(c1.instance_id)    # 1
print(c2.instance_id)    # 2
```

### ç§æœ‰å±¬æ€§

```python
class BankAccount:
    def __init__(self, balance: float):
        self.__balance = balance  # ç§æœ‰å±¬æ€§ï¼ˆåç¨±æ”¹å¯«ï¼‰
    
    def deposit(self, amount: float) -> None:
        if amount > 0:
            self.__balance += amount
    
    def get_balance(self) -> float:
        return self.__balance

account = BankAccount(1000)
account.deposit(500)
print(account.get_balance())  # 1500
print(account.__balance)      # AttributeError
print(account._BankAccount__balance)  # 1500 (å¯è¨ªå•ä½†ä¸æ¨è–¦)
```

## ğŸ”§ ç¹¼æ‰¿

### å–®ç¹¼æ‰¿

```python
class Animal:
    def __init__(self, name: str):
        self.name = name
    
    def speak(self) -> str:
        raise NotImplementedError("Subclass must implement")

class Dog(Animal):
    def speak(self) -> str:
        return f"{self.name} says Woof!"

class Cat(Animal):
    def speak(self) -> str:
        return f"{self.name} says Meow!"

dog = Dog("Buddy")
print(dog.speak())  # "Buddy says Woof!"

# isinstance å’Œ issubclass
print(isinstance(dog, Dog))      # True
print(isinstance(dog, Animal))   # True
print(issubclass(Dog, Animal))   # True
```

### super() ä½¿ç”¨

```python
class Person:
    def __init__(self, name: str, age: int):
        self.name = name
        self.age = age

class Employee(Person):
    def __init__(self, name: str, age: int, employee_id: str):
        super().__init__(name, age)  # èª¿ç”¨çˆ¶é¡ __init__
        self.employee_id = employee_id

emp = Employee("Alice", 30, "E001")
print(emp.name, emp.employee_id)  # Alice E001
```

### å¤šé‡ç¹¼æ‰¿èˆ‡ MRO

```python
class A:
    def method(self):
        print("A")

class B(A):
    def method(self):
        print("B")
        super().method()

class C(A):
    def method(self):
        print("C")
        super().method()

class D(B, C):
    def method(self):
        print("D")
        super().method()

d = D()
d.method()
# è¼¸å‡º: D B C A

# æŸ¥çœ‹æ–¹æ³•è§£æé †åº (MRO)
print(D.__mro__)
# (<class 'D'>, <class 'B'>, <class 'C'>, <class 'A'>, <class 'object'>)
```

## ğŸ”§ ç‰¹æ®Šæ–¹æ³• (Magic Methods)

### åˆå§‹åŒ–èˆ‡è¡¨ç¤º

```python
class Point:
    def __init__(self, x: float, y: float):
        self.x = x
        self.y = y
    
    def __repr__(self) -> str:
        return f"Point({self.x}, {self.y})"
    
    def __str__(self) -> str:
        return f"({self.x}, {self.y})"

p = Point(3, 4)
print(repr(p))  # "Point(3, 4)" - é–‹ç™¼è€…ç”¨
print(str(p))   # "(3, 4)" - ä½¿ç”¨è€…ç”¨
print(p)        # "(3, 4)"
```

### é‹ç®—ç¬¦é‡è¼‰

```python
class Vector:
    def __init__(self, x: float, y: float):
        self.x = x
        self.y = y
    
    def __add__(self, other: "Vector") -> "Vector":
        return Vector(self.x + other.x, self.y + other.y)
    
    def __sub__(self, other: "Vector") -> "Vector":
        return Vector(self.x - other.x, self.y - other.y)
    
    def __mul__(self, scalar: float) -> "Vector":
        return Vector(self.x * scalar, self.y * scalar)
    
    def __eq__(self, other: object) -> bool:
        if not isinstance(other, Vector):
            return NotImplemented
        return self.x == other.x and self.y == other.y
    
    def __repr__(self) -> str:
        return f"Vector({self.x}, {self.y})"

v1 = Vector(1, 2)
v2 = Vector(3, 4)

print(v1 + v2)    # Vector(4, 6)
print(v1 * 2)     # Vector(2, 4)
print(v1 == v2)   # False
```

### å®¹å™¨å”è­°

```python
class Stack:
    def __init__(self):
        self._items: list = []
    
    def __len__(self) -> int:
        return len(self._items)
    
    def __getitem__(self, index: int):
        return self._items[index]
    
    def __setitem__(self, index: int, value) -> None:
        self._items[index] = value
    
    def __contains__(self, item) -> bool:
        return item in self._items
    
    def __iter__(self):
        return iter(self._items)
    
    def push(self, item) -> None:
        self._items.append(item)
    
    def pop(self):
        return self._items.pop()

stack = Stack()
stack.push(1)
stack.push(2)
stack.push(3)

print(len(stack))       # 3
print(stack[0])         # 1
print(2 in stack)       # True
print(list(stack))      # [1, 2, 3]
```

### ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
class FileManager:
    def __init__(self, filename: str, mode: str):
        self.filename = filename
        self.mode = mode
        self.file = None
    
    def __enter__(self):
        self.file = open(self.filename, self.mode)
        return self.file
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.file:
            self.file.close()
        return False  # ä¸å£“åˆ¶ç•°å¸¸

# ä½¿ç”¨
with FileManager("test.txt", "w") as f:
    f.write("Hello, World!")
```

### å¯èª¿ç”¨å°è±¡

```python
class Multiplier:
    def __init__(self, factor: int):
        self.factor = factor
    
    def __call__(self, x: int) -> int:
        return x * self.factor

double = Multiplier(2)
triple = Multiplier(3)

print(double(5))  # 10
print(triple(5))  # 15
```

## ğŸ”§ Property èˆ‡ Descriptor

### Property - å±¬æ€§è£é£¾å™¨

```python
class Temperature:
    def __init__(self, celsius: float):
        self._celsius = celsius
    
    @property
    def celsius(self) -> float:
        return self._celsius
    
    @celsius.setter
    def celsius(self, value: float) -> None:
        if value < -273.15:
            raise ValueError("Temperature below absolute zero")
        self._celsius = value
    
    @property
    def fahrenheit(self) -> float:
        return self._celsius * 9/5 + 32
    
    @fahrenheit.setter
    def fahrenheit(self, value: float) -> None:
        self.celsius = (value - 32) * 5/9

temp = Temperature(25)
print(temp.celsius)      # 25
print(temp.fahrenheit)   # 77.0

temp.fahrenheit = 86
print(temp.celsius)      # 30.0
```

### Descriptor - æè¿°å™¨

```python
class Validator:
    def __init__(self, min_value: int, max_value: int):
        self.min_value = min_value
        self.max_value = max_value
    
    def __set_name__(self, owner, name):
        self.name = f"_{name}"
    
    def __get__(self, instance, owner):
        if instance is None:
            return self
        return getattr(instance, self.name)
    
    def __set__(self, instance, value):
        if not self.min_value <= value <= self.max_value:
            raise ValueError(f"Value must be between {self.min_value} and {self.max_value}")
        setattr(instance, self.name, value)

class Person:
    age = Validator(0, 150)
    
    def __init__(self, age: int):
        self.age = age

person = Person(30)
print(person.age)  # 30
person.age = 200   # ValueError
```

## ğŸ”§ æŠ½è±¡åŸºé¡ (ABC)

```python
from abc import ABC, abstractmethod

class Shape(ABC):
    @abstractmethod
    def area(self) -> float:
        pass
    
    @abstractmethod
    def perimeter(self) -> float:
        pass

class Rectangle(Shape):
    def __init__(self, width: float, height: float):
        self.width = width
        self.height = height
    
    def area(self) -> float:
        return self.width * self.height
    
    def perimeter(self) -> float:
        return 2 * (self.width + self.height)

class Circle(Shape):
    def __init__(self, radius: float):
        self.radius = radius
    
    def area(self) -> float:
        import math
        return math.pi * self.radius ** 2
    
    def perimeter(self) -> float:
        import math
        return 2 * math.pi * self.radius

# shape = Shape()  # TypeError: ç„¡æ³•å¯¦ä¾‹åŒ–æŠ½è±¡é¡
rect = Rectangle(5, 3)
print(rect.area())  # 15.0
```

## ğŸ”§ Protocol - çµæ§‹å­å‹åˆ¥

```python
from typing import Protocol

class Drawable(Protocol):
    def draw(self) -> str:
        ...

class Circle:
    def draw(self) -> str:
        return "Drawing a circle"

class Square:
    def draw(self) -> str:
        return "Drawing a square"

def render(shape: Drawable) -> None:
    print(shape.draw())

# ç„¡éœ€ç¹¼æ‰¿ Drawableï¼Œåªéœ€å¯¦ç¾ draw æ–¹æ³•
render(Circle())  # "Drawing a circle"
render(Square())  # "Drawing a square"
```

## ğŸ’¡ å¯¦æˆ°æ¡ˆä¾‹ï¼šæ§‹å»ºéˆæ´»çš„é…ç½®ç³»çµ±

```python
from abc import ABC, abstractmethod
from typing import Any, Protocol
from dataclasses import dataclass

class ConfigSource(ABC):
    @abstractmethod
    def load(self) -> dict[str, Any]:
        pass

class FileConfigSource(ConfigSource):
    def __init__(self, file_path: str):
        self.file_path = file_path
    
    def load(self) -> dict[str, Any]:
        import json
        with open(self.file_path) as f:
            return json.load(f)

class EnvConfigSource(ConfigSource):
    def load(self) -> dict[str, Any]:
        import os
        return dict(os.environ)

@dataclass
class DatabaseConfig:
    host: str
    port: int
    username: str
    password: str
    
    @classmethod
    def from_dict(cls, data: dict[str, Any]) -> "DatabaseConfig":
        return cls(
            host=data["db_host"],
            port=int(data["db_port"]),
            username=data["db_user"],
            password=data["db_password"],
        )

class ConfigManager:
    def __init__(self, source: ConfigSource):
        self._source = source
        self._cache: dict[str, Any] | None = None
    
    def load(self) -> None:
        self._cache = self._source.load()
    
    def get_database_config(self) -> DatabaseConfig:
        if self._cache is None:
            self.load()
        return DatabaseConfig.from_dict(self._cache)

# ä½¿ç”¨
config_manager = ConfigManager(FileConfigSource("config.json"))
db_config = config_manager.get_database_config()
print(f"Connecting to {db_config.host}:{db_config.port}")
```

## âš ï¸ å¸¸è¦‹é™·é˜±

### 1. å¯è®Šé¡å±¬æ€§

```python
# âŒ éŒ¯èª¤ï¼šæ‰€æœ‰å¯¦ä¾‹å…±äº«åŒä¸€å€‹ list
class MyClass:
    items = []
    
    def add_item(self, item):
        self.items.append(item)

obj1 = MyClass()
obj2 = MyClass()
obj1.add_item("a")
obj2.add_item("b")
print(obj1.items)  # ['a', 'b']

# âœ… æ­£ç¢ºï¼šåœ¨ __init__ ä¸­åˆå§‹åŒ–
class MyClass:
    def __init__(self):
        self.items = []
```

### 2. å¿˜è¨˜ self åƒæ•¸

```python
# âŒ éŒ¯èª¤
class MyClass:
    def method():  # ç¼ºå°‘ self
        print("Hello")

# âœ… æ­£ç¢º
class MyClass:
    def method(self):
        print("Hello")
```

### 3. super() ä½¿ç”¨ä¸ç•¶

```python
# âŒ éŒ¯èª¤ï¼šç¡¬ç·¨ç¢¼çˆ¶é¡åç¨±
class Child(Parent):
    def __init__(self):
        Parent.__init__(self)  # å¤šé‡ç¹¼æ‰¿æ™‚æœ‰å•é¡Œ

# âœ… æ­£ç¢º
class Child(Parent):
    def __init__(self):
        super().__init__()
```

### 4. æ··æ·† @classmethod å’Œ @staticmethod

```python
class MyClass:
    @classmethod
    def class_method(cls):
        return cls()  # å¯ä»¥è¨ªå•é¡
    
    @staticmethod
    def static_method():
        return MyClass()  # ç„¡æ³•è¨ªå• cls
```

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **å„ªå…ˆä½¿ç”¨çµ„åˆè€Œéç¹¼æ‰¿**
   ```python
   # âœ… çµ„åˆ
   class Car:
       def __init__(self):
           self.engine = Engine()
   ```

2. **ä½¿ç”¨ dataclass æ¸›å°‘æ¨£æ¿ä»£ç¢¼**
   ```python
   from dataclasses import dataclass
   
   @dataclass
   class Point:
       x: float
       y: float
   ```

3. **å¯¦ç¾ __repr__ æ–¹ä¾¿èª¿è©¦**
   ```python
   def __repr__(self):
       return f"{self.__class__.__name__}({self.x}, {self.y})"
   ```

4. **ä½¿ç”¨ Protocol æ›¿ä»£ ABCï¼ˆDuck Typingï¼‰**
   ```python
   from typing import Protocol
   
   class Printable(Protocol):
       def print(self) -> str: ...
   ```

5. **å–®ä¸€è·è²¬åŸå‰‡**
   ```python
   class User:
       pass  # åªè™•ç†ä½¿ç”¨è€…è³‡æ–™
   
   class UserRepository:
       pass  # åªè™•ç†è³‡æ–™åº«æ“ä½œ
   ```

6. **ä½¿ç”¨ Property æ§åˆ¶å±¬æ€§è¨ªå•**
   ```python
   @property
   def age(self):
       return self._age
   
   @age.setter
   def age(self, value):
       if value < 0:
           raise ValueError("Age cannot be negative")
       self._age = value
   ```
