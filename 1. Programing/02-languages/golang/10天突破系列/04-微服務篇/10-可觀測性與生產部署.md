# Day 10ï¼šå¯è§€æ¸¬æ€§èˆ‡ç”Ÿç”¢éƒ¨ç½²

## ğŸ“š å­¸ç¿’ç›®æ¨™

- å¯¦ç¾ Prometheus Metrics åŸ‹é»
- ä½¿ç”¨çµæ§‹åŒ–æ—¥èªŒï¼ˆzerolog/zapï¼‰
- æ•´åˆ OpenTelemetry Tracing
- ç·¨å¯« Kubernetes Deployment é…ç½®

---

## 1. Prometheus Metrics

### 1.1 å®‰è£

```bash
go get github.com/prometheus/client_golang
```

### 1.2 è‡ªå®šç¾© Metrics

```go
package metrics

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    HttpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "path", "status"},
    )
    
    HttpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "path"},
    )
)
```

### 1.3 ä¸­é–“ä»¶åŸ‹é»

```go
func MetricsMiddleware(c *fiber.Ctx) error {
    start := time.Now()
    
    err := c.Next()
    
    duration := time.Since(start).Seconds()
    status := c.Response().StatusCode()
    
    HttpRequestsTotal.WithLabelValues(
        c.Method(),
        c.Path(),
        fmt.Sprintf("%d", status),
    ).Inc()
    
    HttpRequestDuration.WithLabelValues(
        c.Method(),
        c.Path(),
    ).Observe(duration)
    
    return err
}
```

---

## 2. çµæ§‹åŒ–æ—¥èªŒ

### 2.1 ä½¿ç”¨ zerolog

```go
package logger

import (
    "github.com/rs/zerolog"
    "github.com/rs/zerolog/log"
    "os"
)

func Init() {
    zerolog.TimeFieldFormat = zerolog.TimeFormatUnix
    log.Logger = log.Output(zerolog.ConsoleWriter{Out: os.Stderr})
}

func Info(msg string, fields map[string]interface{}) {
    log.Info().Fields(fields).Msg(msg)
}

func Error(msg string, err error, fields map[string]interface{}) {
    log.Error().Err(err).Fields(fields).Msg(msg)
}
```

---

## 3. Kubernetes éƒ¨ç½²

### 3.1 Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:latest
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: myapp-config
              key: db_host
        resources:
          requests:
            memory: "128Mi"
            cpu: "250m"
          limits:
            memory: "256Mi"
            cpu: "500m"
```

### 3.2 Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  selector:
    app: myapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer
```

---

## 4. OpenTelemetry Tracing

### 4.1 å®‰è£

```bash
go get go.opentelemetry.io/otel
go get go.opentelemetry.io/otel/exporters/jaeger
go get go.opentelemetry.io/otel/sdk/trace
```

### 4.2 åˆå§‹åŒ– Tracer

```go
package tracing

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/jaeger"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.4.0"
)

func InitTracer(serviceName string) (*sdktrace.TracerProvider, error) {
    exporter, err := jaeger.New(jaeger.WithCollectorEndpoint(
        jaeger.WithEndpoint("http://localhost:14268/api/traces"),
    ))
    if err != nil {
        return nil, err
    }
    
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String(serviceName),
        )),
    )
    
    otel.SetTracerProvider(tp)
    return tp, nil
}
```

### 4.3 åœ¨æ‡‰ç”¨ä¸­ä½¿ç”¨

```go
package handler

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
)

func (h *UserHandler) GetUser(c *fiber.Ctx) error {
    ctx := c.Context()
    tracer := otel.Tracer("user-handler")
    
    ctx, span := tracer.Start(ctx, "GetUser")
    defer span.End()
    
    id, _ := c.ParamsInt("id")
    span.SetAttributes(attribute.Int("user.id", id))
    
    user, err := h.service.GetUser(ctx, id)
    if err != nil {
        span.RecordError(err)
        return ErrorResponse(c, 404, "User not found")
    }
    
    return SuccessResponse(c, user)
}
```

---

## 5. Kubernetes ç”Ÿç”¢éƒ¨ç½²

### 5.1 ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
data:
  db_host: "postgres-service"
  db_port: "5432"
  redis_url: "redis-service:6379"
  log_level: "info"
```

### 5.2 Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secrets
type: Opaque
data:
  db_password: cGFzc3dvcmQ=  # base64 encoded
  jwt_secret: c2VjcmV0a2V5    # base64 encoded
```

### 5.3 Deployment å®Œæ•´é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  labels:
    app: myapp
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: myapp
        image: myregistry/myapp:v1.0.0
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: grpc
          containerPort: 50051
          protocol: TCP
        env:
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: myapp-config
              key: db_host
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: myapp-secrets
              key: db_password
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: myapp-config
```

### 5.4 Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
  labels:
    app: myapp
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 8080
  - name: grpc
    protocol: TCP
    port: 50051
    targetPort: 50051
```

### 5.5 Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - api.example.com
    secretName: myapp-tls
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80
```

### 5.6 HorizontalPodAutoscaler

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: myapp-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## 6. CI/CD Pipeline

### 6.1 GitHub Actions

```yaml
name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Run tests
      run: go test -v -cover ./...
    
    - name: Run linter
      uses: golangci/golangci-lint-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t myregistry/myapp:${{ github.sha }} .
    
    - name: Push to registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push myregistry/myapp:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v1
      with:
        manifests: |
          k8s/deployment.yaml
          k8s/service.yaml
        images: myregistry/myapp:${{ github.sha }}
```

---

## 7. ç›£æ§èˆ‡å‘Šè­¦

### 7.1 Prometheus é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'myapp'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
```

### 7.2 å‘Šè­¦è¦å‰‡

```yaml
# alerts.yml
groups:
- name: myapp
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }} for {{ $labels.instance }}"
  
  - alert: HighMemoryUsage
    expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }}"
```

---

## 8. å¯¦æˆ°ç·´ç¿’

### ç·´ç¿’ 1ï¼šå¯¦ç¾åˆ†å¸ƒå¼è¿½è¹¤

```go
// TODO: åœ¨å¤šå€‹æœå‹™é–“å‚³é trace context
// 1. HTTP è«‹æ±‚ä¸­æ³¨å…¥ trace header
// 2. å¾ HTTP header ä¸­æå– trace context
// 3. åœ¨ gRPC èª¿ç”¨ä¸­å‚³é context
```

### ç·´ç¿’ 2ï¼šå¯¦ç¾è‡ªå®šç¾© Metrics

```go
type BusinessMetrics struct {
    ordersTotal     prometheus.Counter
    orderValue      prometheus.Histogram
    activeUsers     prometheus.Gauge
}

// TODO: å¯¦ç¾æ¥­å‹™æŒ‡æ¨™æ”¶é›†
```

### ç·´ç¿’ 3ï¼šå¯¦ç¾é‡‘çµ²é›€éƒ¨ç½²

```yaml
# TODO: é…ç½®é‡‘çµ²é›€éƒ¨ç½²
# 1. å‰µå»ºå…©å€‹ Deployment (stable å’Œ canary)
# 2. é…ç½®æµé‡åˆ†é… (90% stable, 10% canary)
# 3. ç›£æ§éŒ¯èª¤ç‡ï¼Œè‡ªå‹•å›æ»¾
```

---

## 9. æœ€ä½³å¯¦è¸ç¸½çµ

### âœ… Do's
1. **å¯¦ç¾çµæ§‹åŒ–æ—¥èªŒ**
2. **æ”¶é›†æ¥­å‹™å’ŒæŠ€è¡“æŒ‡æ¨™**
3. **è¨­ç½®åˆç†çš„è³‡æºé™åˆ¶**
4. **å¯¦ç¾å¥åº·æª¢æŸ¥å’Œå°±ç·’æ¢é‡**
5. **ä½¿ç”¨åˆ†å¸ƒå¼è¿½è¹¤æ’æŸ¥å•é¡Œ**
6. **è¨­ç½®å‘Šè­¦è¦å‰‡**

### âŒ Don'ts
1. **ä¸è¦å¿½ç•¥ç›£æ§æ•¸æ“š**
2. **ä¸è¦åœ¨æ—¥èªŒä¸­è¨˜éŒ„æ•æ„Ÿä¿¡æ¯**
3. **ä¸è¦è¨­ç½®éé«˜çš„è³‡æºé™åˆ¶**
4. **ä¸è¦å¿˜è¨˜è¨­ç½®è¶…æ™‚**
5. **ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ debug æ—¥èªŒç´šåˆ¥**

---

## 10. å»¶ä¼¸é–±è®€

- [Prometheus Best Practices](https://prometheus.io/docs/practices/)
- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)
- [Kubernetes Production Best Practices](https://kubernetes.io/docs/setup/best-practices/)
- [The Twelve-Factor App](https://12factor.net/)

---

## æ­å–œå®Œæˆ 10 å¤© Go èªè¨€ç‰¹è¨“ï¼ğŸ‰

ä½ å·²ç¶“æŒæ¡äº†ï¼š
- âœ… Go èªæ³•åŸºç¤èˆ‡å‹åˆ¥ç³»çµ±
- âœ… éŒ¯èª¤è™•ç†èˆ‡è³‡æºç®¡ç†
- âœ… æ•¸æ“šåº«æ“ä½œï¼ˆsqlxï¼‰
- âœ… ä½µç™¼ç·¨ç¨‹ï¼ˆGoroutineã€Channelã€Contextï¼‰
- âœ… Web é–‹ç™¼ï¼ˆFiber æ¡†æ¶ï¼‰
- âœ… å®¹å™¨åŒ–èˆ‡éƒ¨ç½²
- âœ… å¾®æœå‹™æ¶æ§‹ï¼ˆgRPCã€Kafkaï¼‰
- âœ… å¯è§€æ¸¬æ€§èˆ‡ç”Ÿç”¢éƒ¨ç½²

**ä¸‹ä¸€æ­¥å»ºè­°**ï¼š
1. å®Œæˆå°ˆæ¡ˆå¯¦è¸éƒ¨åˆ†çš„ä¸‰å€‹å¯¦æˆ°é …ç›®
2. æ·±å…¥å­¸ç¿’æŸå€‹ç‰¹å®šé ˜åŸŸï¼ˆå¦‚åˆ†å¸ƒå¼ç³»çµ±ã€é›²åŸç”Ÿï¼‰
3. ç‚ºé–‹æºé …ç›®è²¢ç»ä»£ç¢¼
4. æ§‹å»ºè‡ªå·±çš„å®Œæ•´é …ç›®

**ä¸Šä¸€ç¯‡**: [Day 9 - gRPC èˆ‡è¨Šæ¯ä½‡åˆ—](09-gRPCèˆ‡è¨Šæ¯ä½‡åˆ—.md)
