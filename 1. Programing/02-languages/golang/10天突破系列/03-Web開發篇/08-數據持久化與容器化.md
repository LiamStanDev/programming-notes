# Day 8ï¼šæ•¸æ“šæŒä¹…åŒ–èˆ‡å®¹å™¨åŒ–

## ğŸ“š å­¸ç¿’ç›®æ¨™

- æŒæ¡ sqlx äº‹å‹™è™•ç†æ¨¡å¼
- å¯¦ç¾æ•¸æ“šåº«é·ç§»ï¼ˆgolang-migrateï¼‰
- æŒæ¡ Docker Multi-Stage Build
- å¯¦ç¾å®¹å™¨åŒ–æœ€ä½³å¯¦è¸

---

## 1. sqlx äº‹å‹™è™•ç†

### 1.1 åŸºæœ¬äº‹å‹™

```go
func (r *userRepository) CreateWithProfile(user *User, profile *Profile) error {
    return WithTransaction(r.db, func(tx *sqlx.Tx) error {
        // æ’å…¥ç”¨æˆ¶
        err := tx.Get(&user.ID,
            "INSERT INTO users (username, email) VALUES ($1, $2) RETURNING id",
            user.Username, user.Email)
        if err != nil {
            return err
        }
        
        // æ’å…¥ profile
        _, err = tx.Exec(
            "INSERT INTO profiles (user_id, bio) VALUES ($1, $2)",
            user.ID, profile.Bio)
        return err
    })
}
```

### 1.2 æ‰¹é‡æ“ä½œ

```go
func (r *productRepository) BulkUpdate(products []Product) error {
    return WithTransaction(r.db, func(tx *sqlx.Tx) error {
        stmt, err := tx.Prepare("UPDATE products SET price = $1 WHERE id = $2")
        if err != nil {
            return err
        }
        defer stmt.Close()
        
        for _, p := range products {
            _, err = stmt.Exec(p.Price, p.ID)
            if err != nil {
                return err
            }
        }
        return nil
    })
}
```

---

## 2. æ•¸æ“šåº«é·ç§»

### 2.1 å®‰è£ golang-migrate

```bash
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
```

### 2.2 å‰µå»ºé·ç§»æ–‡ä»¶

```bash
migrate create -ext sql -dir migrations -seq create_users_table
```

**migrations/000001_create_users_table.up.sql**:
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**migrations/000001_create_users_table.down.sql**:
```sql
DROP TABLE IF EXISTS users;
```

### 2.3 åŸ·è¡Œé·ç§»

```bash
migrate -path migrations -database "postgres://user:pass@localhost/db?sslmode=disable" up
```

---

## 3. Docker å®¹å™¨åŒ–

### 3.1 Multi-Stage Dockerfile

```dockerfile
# éšæ®µ 1ï¼šæ§‹å»º
FROM golang:1.21-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main cmd/server/main.go

# éšæ®µ 2ï¼šé‹è¡Œ
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /root/

COPY --from=builder /app/main .
COPY --from=builder /app/migrations ./migrations

EXPOSE 8080

CMD ["./main"]
```

### 3.2 docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: myuser
      DB_PASSWORD: mypassword
      DB_NAME: mydb
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

---

## 4. å¯¦æˆ°ï¼šå®Œæ•´çš„æ‡‰ç”¨éƒ¨ç½²

### 4.1 .dockerignore

```
.git
.env
*.md
tmp/
logs/
```

### 4.2 Makefile

```makefile
.PHONY: build run test docker-build docker-up docker-down migrate-up migrate-down

build:
	go build -o bin/server cmd/server/main.go

run:
	go run cmd/server/main.go

test:
	go test -v ./...

docker-build:
	docker build -t myapp:latest .

docker-up:
	docker-compose up -d

docker-down:
	docker-compose down

migrate-up:
	migrate -path migrations -database "$(DB_URL)" up

migrate-down:
	migrate -path migrations -database "$(DB_URL)" down
```

### 4.3 ç’°å¢ƒè®Šé‡ç®¡ç†

**.env**:
```env
DB_HOST=localhost
DB_PORT=5432
DB_USER=myuser
DB_PASSWORD=mypassword
DB_NAME=mydb
REDIS_URL=localhost:6379
```

**config/config.go**:
```go
package config

import (
    "os"
    "github.com/joho/godotenv"
)

type Config struct {
    Database DatabaseConfig
    Redis    RedisConfig
    Server   ServerConfig
}

type DatabaseConfig struct {
    Host     string
    Port     string
    User     string
    Password string
    DBName   string
}

type RedisConfig struct {
    URL string
}

type ServerConfig struct {
    Port string
}

func Load() (*Config, error) {
    // è¼‰å…¥ .env æ–‡ä»¶
    godotenv.Load()
    
    return &Config{
        Database: DatabaseConfig{
            Host:     getEnv("DB_HOST", "localhost"),
            Port:     getEnv("DB_PORT", "5432"),
            User:     getEnv("DB_USER", "postgres"),
            Password: getEnv("DB_PASSWORD", ""),
            DBName:   getEnv("DB_NAME", "mydb"),
        },
        Redis: RedisConfig{
            URL: getEnv("REDIS_URL", "localhost:6379"),
        },
        Server: ServerConfig{
            Port: getEnv("SERVER_PORT", "8080"),
        },
    }, nil
}

func getEnv(key, fallback string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return fallback
}
```

---

## 5. å¥åº·æª¢æŸ¥èˆ‡å°±ç·’æ¢é‡

### 5.1 å¥åº·æª¢æŸ¥ç«¯é»

```go
type HealthChecker struct {
    db    *sqlx.DB
    redis *redis.Client
}

func (h *HealthChecker) Check(c *fiber.Ctx) error {
    status := fiber.Map{
        "status": "ok",
        "checks": fiber.Map{},
    }
    
    // æª¢æŸ¥æ•¸æ“šåº«
    if err := h.db.Ping(); err != nil {
        status["status"] = "degraded"
        status["checks"].(fiber.Map)["database"] = "unhealthy"
    } else {
        status["checks"].(fiber.Map)["database"] = "healthy"
    }
    
    // æª¢æŸ¥ Redis
    if err := h.redis.Ping(c.Context()).Err(); err != nil {
        status["status"] = "degraded"
        status["checks"].(fiber.Map)["redis"] = "unhealthy"
    } else {
        status["checks"].(fiber.Map)["redis"] = "healthy"
    }
    
    if status["status"] == "degraded" {
        return c.Status(503).JSON(status)
    }
    
    return c.JSON(status)
}

// è·¯ç”±è¨­ç½®
app.Get("/health", healthChecker.Check)
app.Get("/ready", readinessChecker.Check)
```

---

## 6. æ•¸æ“šåº«é·ç§»æœ€ä½³å¯¦è¸

### 6.1 é·ç§»æ–‡ä»¶çµ„ç¹”

```
migrations/
â”œâ”€â”€ 000001_create_users_table.up.sql
â”œâ”€â”€ 000001_create_users_table.down.sql
â”œâ”€â”€ 000002_add_users_index.up.sql
â”œâ”€â”€ 000002_add_users_index.down.sql
â”œâ”€â”€ 000003_create_posts_table.up.sql
â””â”€â”€ 000003_create_posts_table.down.sql
```

### 6.2 è¤‡é›œé·ç§»ç¤ºä¾‹

**000004_add_user_roles.up.sql**:
```sql
-- æ·»åŠ æ–°åˆ—
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user';

-- å‰µå»ºç´¢å¼•
CREATE INDEX idx_users_role ON users(role);

-- æ›´æ–°ç¾æœ‰æ•¸æ“š
UPDATE users SET role = 'admin' WHERE id IN (1, 2, 3);
```

**000004_add_user_roles.down.sql**:
```sql
DROP INDEX IF EXISTS idx_users_role;
ALTER TABLE users DROP COLUMN IF EXISTS role;
```

### 6.3 ç¨‹åºåŒ–é·ç§»

```go
package main

import (
    "database/sql"
    "github.com/golang-migrate/migrate/v4"
    "github.com/golang-migrate/migrate/v4/database/postgres"
    _ "github.com/golang-migrate/migrate/v4/source/file"
)

func runMigrations(db *sql.DB) error {
    driver, err := postgres.WithInstance(db, &postgres.Config{})
    if err != nil {
        return err
    }
    
    m, err := migrate.NewWithDatabaseInstance(
        "file://migrations",
        "postgres",
        driver,
    )
    if err != nil {
        return err
    }
    
    if err := m.Up(); err != nil && err != migrate.ErrNoChange {
        return err
    }
    
    return nil
}
```

---

## 7. å®¹å™¨åŒ–æœ€ä½³å¯¦è¸

### 7.1 å„ªåŒ– Dockerfile

```dockerfile
# éšæ®µ 1ï¼šä¾è³´ç·©å­˜
FROM golang:1.21-alpine AS deps
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

# éšæ®µ 2ï¼šæ§‹å»º
FROM deps AS builder
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main cmd/server/main.go

# éšæ®µ 3ï¼šé‹è¡Œ
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata
WORKDIR /root/

COPY --from=builder /app/main .
COPY --from=builder /app/migrations ./migrations

# å‰µå»ºé root ç”¨æˆ¶
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser && \
    chown -R appuser:appuser /root

USER appuser

EXPOSE 8080

CMD ["./main"]
```

### 7.2 Docker Compose å®Œæ•´é…ç½®

```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_URL: redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - app-network

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - app-network

  migrate:
    image: migrate/migrate
    volumes:
      - ./migrations:/migrations
    command: [
      "-path=/migrations",
      "-database=postgres://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}?sslmode=disable",
      "up"
    ]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

---

## 8. å¯¦æˆ°ç·´ç¿’

### ç·´ç¿’ 1ï¼šå¯¦ç¾æ•¸æ“šåº«å‚™ä»½è…³æœ¬

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="./backups"
DB_NAME="mydb"

mkdir -p $BACKUP_DIR

docker-compose exec -T postgres pg_dump -U postgres $DB_NAME > \
    $BACKUP_DIR/backup_${DB_NAME}_${DATE}.sql

echo "Backup created: $BACKUP_DIR/backup_${DB_NAME}_${DATE}.sql"
```

### ç·´ç¿’ 2ï¼šå¯¦ç¾æ»¾å‹•æ›´æ–°è…³æœ¬

```bash
#!/bin/bash
# rolling-update.sh

docker-compose build app
docker-compose up -d --no-deps --scale app=2 app
sleep 10
docker-compose up -d --no-deps --scale app=1 app
```

### ç·´ç¿’ 3ï¼šå¯¦ç¾é€£æ¥æ± ç›£æ§

```go
type DBStats struct {
    MaxOpenConnections int
    OpenConnections    int
    InUse              int
    Idle               int
}

func (db *DB) GetStats() DBStats {
    stats := db.DB.Stats()
    return DBStats{
        MaxOpenConnections: stats.MaxOpenConnections,
        OpenConnections:    stats.OpenConnections,
        InUse:              stats.InUse,
        Idle:               stats.Idle,
    }
}

// ç›£æ§ç«¯é»
app.Get("/metrics/db", func(c *fiber.Ctx) error {
    return c.JSON(db.GetStats())
})
```

---

## 9. æœ€ä½³å¯¦è¸ç¸½çµ

### âœ… Do's
1. **ä½¿ç”¨ Multi-Stage Build æ¸›å°é¡åƒå¤§å°**
2. **å¯¦ç¾å¥åº·æª¢æŸ¥ç«¯é»**
3. **ä½¿ç”¨ç’°å¢ƒè®Šé‡ç®¡ç†é…ç½®**
4. **å¯¦ç¾å„ªé›…é—œé–‰**
5. **å®šæœŸå‚™ä»½æ•¸æ“šåº«**
6. **ä½¿ç”¨é root ç”¨æˆ¶é‹è¡Œå®¹å™¨**

### âŒ Don'ts
1. **ä¸è¦å°‡æ•æ„Ÿä¿¡æ¯ç¡¬ç·¨ç¢¼**
2. **ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ `:latest` æ¨™ç±¤**
3. **ä¸è¦å¿½ç•¥æ•¸æ“šå·çš„å‚™ä»½**
4. **ä¸è¦åœ¨ Dockerfile ä¸­ä½¿ç”¨ `COPY . .` è€Œä¸é…ç½® `.dockerignore`**
5. **ä¸è¦å¿˜è¨˜è¨­ç½®è³‡æºé™åˆ¶**

---

## 10. å»¶ä¼¸é–±è®€

- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [golang-migrate Documentation](https://github.com/golang-migrate/migrate)
- [12-Factor App](https://12factor.net/)

---

**ä¸Šä¸€ç¯‡**: [Day 7 - Web æ¡†æ¶èˆ‡ä¸­é–“ä»¶è¨­è¨ˆ](07-Webæ¡†æ¶èˆ‡ä¸­é–“ä»¶è¨­è¨ˆ.md)  
**ä¸‹ä¸€ç¯‡**: [Day 9 - gRPC èˆ‡è¨Šæ¯ä½‡åˆ—](../04-å¾®æœå‹™ç¯‡/09-gRPCèˆ‡è¨Šæ¯ä½‡åˆ—.md)
