# Day 8ï¼šæ•¸æ“šæŒä¹…åŒ–èˆ‡å®¹å™¨åŒ–

## ğŸ“š å­¸ç¿’ç›®æ¨™

- æŒæ¡ sqlx äº‹å‹™è™•ç†æ¨¡å¼
- å¯¦ç¾æ•¸æ“šåº«é·ç§»ï¼ˆgolang-migrateï¼‰
- æŒæ¡ Docker Multi-Stage Build
- å¯¦ç¾å®¹å™¨åŒ–æœ€ä½³å¯¦è¸

---

## 1. sqlx äº‹å‹™è™•ç†

### 1.1 åŸºæœ¬äº‹å‹™

```go
func (r *userRepository) CreateWithProfile(user *User, profile *Profile) error {
    return WithTransaction(r.db, func(tx *sqlx.Tx) error {
        // æ’å…¥ç”¨æˆ¶
        err := tx.Get(&user.ID,
            "INSERT INTO users (username, email) VALUES ($1, $2) RETURNING id",
            user.Username, user.Email)
        if err != nil {
            return err
        }
        
        // æ’å…¥ profile
        _, err = tx.Exec(
            "INSERT INTO profiles (user_id, bio) VALUES ($1, $2)",
            user.ID, profile.Bio)
        return err
    })
}
```

### 1.2 æ‰¹é‡æ“ä½œ

```go
func (r *productRepository) BulkUpdate(products []Product) error {
    return WithTransaction(r.db, func(tx *sqlx.Tx) error {
        stmt, err := tx.Prepare("UPDATE products SET price = $1 WHERE id = $2")
        if err != nil {
            return err
        }
        defer stmt.Close()
        
        for _, p := range products {
            _, err = stmt.Exec(p.Price, p.ID)
            if err != nil {
                return err
            }
        }
        return nil
    })
}
```

---

## 2. æ•¸æ“šåº«é·ç§»

### 2.1 å®‰è£ golang-migrate

```bash
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
```

### 2.2 å‰µå»ºé·ç§»æ–‡ä»¶

```bash
migrate create -ext sql -dir migrations -seq create_users_table
```

**migrations/000001_create_users_table.up.sql**:
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**migrations/000001_create_users_table.down.sql**:
```sql
DROP TABLE IF EXISTS users;
```

### 2.3 åŸ·è¡Œé·ç§»

```bash
migrate -path migrations -database "postgres://user:pass@localhost/db?sslmode=disable" up
```

---

## 3. Docker å®¹å™¨åŒ–

### 3.1 Multi-Stage Dockerfile

```dockerfile
# éšæ®µ 1ï¼šæ§‹å»º
FROM golang:1.21-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main cmd/server/main.go

# éšæ®µ 2ï¼šé‹è¡Œ
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /root/

COPY --from=builder /app/main .
COPY --from=builder /app/migrations ./migrations

EXPOSE 8080

CMD ["./main"]
```

### 3.2 docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: myuser
      DB_PASSWORD: mypassword
      DB_NAME: mydb
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

---

**ä¸Šä¸€ç¯‡**: [Day 7 - Web æ¡†æ¶èˆ‡ä¸­é–“ä»¶è¨­è¨ˆ](07-Webæ¡†æ¶èˆ‡ä¸­é–“ä»¶è¨­è¨ˆ.md)  
**ä¸‹ä¸€ç¯‡**: [Day 9 - gRPC èˆ‡è¨Šæ¯ä½‡åˆ—](../04-å¾®æœå‹™ç¯‡/09-gRPCèˆ‡è¨Šæ¯ä½‡åˆ—.md)
