# 基本概念
---
### Link 
稱作鏈路，就是從一個節點到相鄰節點的一段物理線路，中間沒有任和其他的節點，可以是Twist pair, Fiber等。
![[Screenshot 2023-08-10 212333.png]]

### Data Link
數據鏈路為鏈路+協議構成，除了物理線路(物理層)以外還必須有通訊協議來**控制數據的傳輸**。
$$
Data\;Link=Link+Protocol
$$
鏈路中通信的雙方信道使用形式不同會有不同的控制協議。
> 數據鏈路層以**幀**為單位

### 數據鏈路層
不必考慮bit如何進行傳輸，就像是直接將幀發送給下一個節點的數據鏈路層。
> 網卡實現的是物理層與數據鏈路層協議。
### 功能
物理層只是將數據變成bit stream進行傳輸但還有以下問題要解決，這部分問題交就是由數據鏈路層來達成，有以下功能:
#### 封裝成幀
將網路層數據單元添加上幀頭與幀尾。
#### 透明傳輸
區分幀頭與幀尾不會將它視為數據的一部分，就可以不限制上層傳遞下來的PDU形式。
#### 差錯控制
幀在傳輸中可能產生干擾導致錯誤，但幀尾中會有發送方基於待發送的數據計利用檢錯算法算出的檢錯碼放在幀尾，每個節點會進行較驗。


# 封裝成幀 (Framing)
---
![[Screenshot 2023-08-10 214259.png]]
* SOH (Start of Header): 幀開始符
* EOT (End of Transmission): 幀結束符
> 兩者都是ASCII的一個特殊字符

# 透明傳輸
---
若數據中的某個字節的二進制代碼恰好與SOH or EOT一樣，數據鏈路層會錯誤的找到幀的邊界，所以需要透過轉義字符(ESC, 為ASCII的特殊字符)來將其進行轉義。所以不限制上層傳遞下來的數據形式又叫做透明傳輸。
![[Screenshot 2023-08-10 214828.png]]

## 差錯檢測
---
### 奇偶校驗
在待發送的數據後面添加一個奇偶校驗位，使整個數據中的1的個數為奇數(奇校驗)或偶數(偶校驗)。
* 奇校驗
	101101 (原始數據) -> **1**101101 (將1湊奇數) -> 110**0**101 (誤碼) -> 發現為偶數1檢驗失敗。
* 偶校驗
	101101 (原始數據) -> **0**101101 (將1湊偶數) -> 110**0**101 (誤碼) -> 發現為奇數1檢驗失敗。
#### 結論
若誤碼為偶數個不會導致奇偶改變，不會導致檢驗失敗，這樣錯誤檢驗率會很高，計算機網路中不使用。

### 循環冗餘校驗 - Cyclic redundancy check (CRC)
1. 雙方約定好一個生成多項式$G(x)$
2. 發送方依據待發送數據和$G(x)$計算出冗餘碼，將其添加到數據後面進行傳輸。
3. 接收方通過$G(x)$計算接收數據判斷是否產生誤碼
#### 發送方處理
![[Screenshot 2023-08-10 222438.png]]

#### 接收方處理
![[Pasted image 20230810222653.png]]
#### 常用的生成多項式
##### 簡介
$$
G(x)=x^4+x^2+x+1
$$
係數構成的bit stream為10111
##### CRC-16
$$
G(x)=x^{16}+x^{15}+x^2+1
$$
##### CRC-CCITT
$$
G(x)=x^{16}+x^{12}+x^3+1
$$
##### CRC-32
$$
G(x)=x^{32}+x^{26}+x^{23}+....+x^4+x^2+1
$$
#### 例題
待發送數據為101001，生成多項式$G(x)=x^3+x^2+1$，計算CRC?
![[Screenshot 2023-08-10 223652.png]]
> 1. 這是二進制除法，故裡面的+表示xor運算(無進位加法)
> 2. 補的零為$G(x)$的最高次方數
> 3. CRC位數與$G(x)$的最高次方數一樣多不足補零

ans: 最後傳送數據為101001**001**

#### 結論
錯誤檢驗率會很高，且非常容易用硬體實現，因此被大量使用在計算機網路中。

# 可靠傳輸概念
---
### 基本概念
1. 有線鏈路的誤碼率很低，為了減少開銷並不要求實現可靠傳輸，可靠傳輸由上層進行處理。
2. 無限鏈路因為易受干擾，誤碼率很高，因此要求數據鏈路層必須向上層提供可靠傳輸。
3. 除了bit差錯以外，傳輸差錯包含分組丟失(因路由器對列滿了丟棄分組)、分組失序以及分組重複(因為數據阻塞導致發送者進行超時重發)。
### TCP/IP下的可靠傳輸
#### 網路接口層
* 802.11協議要求實現數據鏈路層可靠傳輸。
* Enthenet協議不要求數據鏈路層實現可靠傳輸。
#### 網際層
* IP向其上層提供無連接、不可靠的傳輸服務。
#### 傳輸層
* TCP向其上層提供面向連接、可靠傳輸服務。
* UDP向其上層提供無連接、不可靠的傳輸服務。

## 可靠傳輸的實現
以下內容不僅止於數據鏈路層中，而是整個計算機網路的各層中。
### 停止等待協議 (SW, Stop-and-Wait)
![[Screenshot 2023-08-11 010029.png]]
* ACK (Acknowledgment): 為ASCII字符，確認收到收到無誤碼
* NAK (Non-Acknowledgment): 為ASCII字符，否定應答
* 發送方在發送之後不能立刻刪去緩存，直到收到接收方的ACK才能清理。
#### 可能產生的問題與解決手段
1. 數據丟失: Data可能因丟失沒送到Receiver
	ans: Sender會設定一個略大於RTT的時間做為**超時重傳**
2. 確認丟失: ACK丟失造成重複分組
	ans: 加上一個bit的編號，之前傳送的分組為1的話重傳的bit為0，反之亦然，當街收方收到重傳的數據分組會再發送ACK，以避免再次超時重傳。
3. 確認遲到: ACK較晚送到Sender，使得Sender不知道是哪個Data需要重傳
	ans: 給ACK編號，讓接收方知道是哪個數據發送對應哪個ACK
#### 其他細節
* 數據鏈路層一般不會出現ACK分組遲到，所以SW協議不用給ACK分組編號
* 數據鏈路層點對點往返比較確定，重傳時間很好設定
* 運輸層端到端往返時間不確定，重傳時間不容易設定
* SW協議在**RTT很大時**(衛星鏈路)，**信道利用率很低**: 因為每次都要等待ACK才能再次發送Data
### 推回N幀協議 (GBN, Go-Back-N)
發送方一次發送N個幀，接收方接收N幀後逐一檢查返回 $ACK_{n-k}$ 一直到返回 $ACK_n$ ，超時重發時也需要再次發送N個幀。
#### 缺點
1. 一個數據的誤碼會導致多個數據重傳，且後續數據不能被接收，是對通信資源的浪費。

### 選擇重傳協議 (SR, Selective Request)
是一個很有效率的發送方式，改進GBN協議的缺點，但稍微有點複雜這邊就不贅述。

# 數據鏈路層協議
---
### 點對點協議 (PPP, Point-to-Point Protocol)
此協議是目前最廣泛的點對點數據鏈路層協議，又稱為PPPoE (PPP over Enthernet)。
#### 例子
用戶連接到Internet時，需要通過ISP，因為只有ISP能向Internet管理機構申請ip地址，此時用戶連接Internet時與ISP進行連接就是使用PPP協議。

#### PPP的構成
1. 對各種Datagram的封裝: 也就是封裝成幀
2. 鏈路控制協議LCP: 用於建立、配置以及測試數據鏈路的連接
3. 一套網路控制協議NCPs: 每一個協議都支持不同的網路層協議，如支持網路層的IP協議, IPX協議與AppleTalk協議等。
#### 幀格式
![[Screenshot 2023-08-11 015442.png]]
* F: 為Flag，表示幀的界定符，值為0x7E
* A: 為Address，預留目前沒用，值為0xFF
* C: 為Control，預留目前沒用，值為0x03
* P: 為Protocol，指名目幀的數據部分該交給哪個協議處理。
	* 0x0021: 表示Data為IP協議
	* 0xC021: 表示Data為LCP分組，用來進行LCP配置
	* 0x8021: 表示Data為NCP分組，用來進行NCP配置
* FCS: 為Frame Check Sequence，由CRC計算出的校驗位

#### 性質
接收方收到PPP幀，就會進行CRC校驗，正確則接收，不正確則丟失，故PPP數據鏈路層協議向上**不提供可靠傳輸服務**。


# MAC地址、IP地址以及ARP協議
---
### MAC地址
全稱為Media Acess Address，是Ethenet的MAC子層所使用的地址。
#### 點對點信道:

![[Screenshot 2023-08-11 114339.png]]
因為點對點信道上只有兩個主機，收發數據是不需要使用地址	

#### 總線型區域網路:![[Screenshot 2023-08-11 114550.png]]
也就是廣播信道，該信道上有多台主機，想要實現兩個主機的通信，每個主機都需要有一個唯一的標示，即一個**數據鏈路層地址**。每個發送的幀中必須協帶發送主機與接收主機的地址，被稱作MAC地址。接收者會去匹配MAC地址找到是否屬於自己，不屬於自己的就丟棄。
#### 其他細節
* MAC地址一般被固化在網卡(網路適配器)中
* 用戶主機一般包含兩個網卡(網路適配器)為有線網卡與無線網卡，每個網卡都有一個全球唯一的MAC地址。
* 交換機和路由器通常會有更多的網路接口，故其會友更多的MAC地址。
> MAC地址是對網路上各個接口的唯一標示，不是對設備的唯一標示。
#### IEEE 802 標準 MAC地址
由兩個重要的MAC地址形式: EUI-48與EUI-64
##### EUI-48
由六個字節構成(48 bits)，前三個字節為IEEE註冊管理機構分配稱作OUI，後三個字節由獲得OUI廠商自行分配(均為FF:FF:FF表示該幀為廣播幀)。通常以12個16進制位表示，e.g.
* windows: 00-0C-CF-93-8C-92
* 類Unix系統: 00:0C:CF:93:8C:92
> 可以透過MAC地址查詢OUI，就可知道該設備是哪個廠商的產品

##### EUI-64
因為48 bits數量較少，目標壽命到2080年，現在建議使用64 bits的EUI-64進行標示。
#### 隨機MAC地址
因為MAC地址全球唯一，可以被監視所在位置，所以移動設備大部分都使用的是隨機的MAC地址。

### IP地址
為TCP/IP體系中網際層使用的地址。IP地址是Internet上的主機所使用的地址，用於標示以下兩部分信息:
1. 網路編號: 表示網路。
2. 主機編號: 識別同一網路下不同主機(或路由器下各接口)。
![[Screenshot 2023-08-11 122516.png]]
* N表示網路，R表示路由器
由上圖可以發現每一個設備都有一個ip地址如PC1, PC2與R1，且每一個網路都有自己的ip地址如N9為192.168.0，N8為192.160.1。
> MAC地址只能區分設備，但IP地址還能區分網路。

* 獨立的網路不接入Internet可以只使用MAC地址(不常用)。
* 主機要接入Internet就要同時使用MAC地址與IP地址。
#### IP地址與MAC地址在傳輸中的變化
![[Screenshot 2023-08-11 124059.png]]


### ARP協議
用於已知設備分配所分配到的IP地址，可通過ARP協議或取到設備的MAC地址，也就是**由IP地址取得MAC地址**，屬於TCP/IP的網際層。
#### 實際流程
1. 主機A知道主機B的IP地址，但不知道主機B的MAC地址，先
2. 在自己的高速ARP緩存中查找，
3. 若存在就可以知道主機B的MAC地址
4. 但因為動態IP的關係ARP緩存中不存在該鍵值對，所以主機A發送ARP請求報文(包含主機B的IP地址)
5. 每個廣播信道上都會收到ARP請求報文，每個主機就會向上執行ARP響應，若是自己的IP則，會發送ARP響應報文
6. 主機A收到ARP響應報文更新自己的ARP高速緩存。

#### 細節
* ARP協議只能在一個鏈路中或者一個網路中使用，不能跨網路使用。故兩個不同網路的主機是不能直接獲取對方的MAC地址。

# 設備
---
### 集線器 (Hub)
其本身為一個總線網路，所以發送的信號會**傳送到總線上的各個主機**，其工作在**物理層**，不進行碰撞檢測。使用RJ-45(就是常見的網路線插頭)插頭的Twist pair連接。
![[Pasted image 20230808174427.png]]

### 交換機 (Switch)
不是使用總線進行通訊，不會產生碰撞，且使用雙工通訊(可以同時收發)，作用在**數據鏈路層**與物理層中，收到幀後在幀交換表中查找幀目的的MAC地址所對應的接口，然後通過接口進行轉發。其本身的幀交換表會上電之後自行學習後建立。轉發方式為存储轉發(進行差錯控制)與直接交換(速度快但不進行差錯控制)兩種。
* 使用交換機擴展的網路相較於集線器有明顯的優勢。因集線器擴展的網路會擴大碰撞域。
	-> 故集線器被市場淘汰。
* 因為怕某一個交換機故障導致網路無法互通，所以使用冗餘鏈路(A->B A->C B->C)，來增加網路的可靠性，但會產生廣播風暴(廣播幀會無限的在環路中無限轉發)，故交換機採用STP (生成數協議)來避免環路導致的廣播風暴。

# 虛擬區域網路 vLAN
---
因為交換機建構的網路會不斷擴大廣播區域，導致安全問題與廣播大量消耗系統資源，廣播大量消耗系統資源來自於巨大的廣播區域所導致。又因為TCP/IP協議中有使用大量的廣播e.g. ARP(地址解析協議)，RIP(路由信息協議)與DHCP(動態配置地址協議)。
## 分割廣播域的方法
### 使用路由器
路由器工作在網路層中，本身不會轉發廣播數據包，但路由器造價較高不現時。
### 使用vLAN
vLAN可以將交換機構成的網路猜分成一個個vLAN，廣播只能在vLAN中進行。
![[Pasted image 20230811134046.png]]
#### IEEE 802.1Q vLAN幀格式
舊版Ethernet V2 幀
![[Screenshot 2023-08-11 150719.png]]
新版IEEE 802.1Q vLAN幀
![[Screenshot 2023-08-11 150836.png]]
其中包含4B的的vLAN標記，用戶機不會處理vLAN標記，而是當發送給交換機在由交換機打上vLAN標記。