# 基本介紹
---
網路如果只要內部互聯，只需要實現物理層與數據鏈路層即可，但是要實現**不同網路互連**就需要實現網路層。
### 網路層定義
實現**網路互連**，進而實現數據包在各網路之間的傳輸。
![[Screenshot 2023-08-11 151630.png]]
### 解決問題
1. 網路層向運輸層提供怎樣的服務 (可靠 or 不可靠)
2. 網路尋址問題
3. 路由選擇問題: 依據目的地址與路由表來決定如何選擇路徑。

# 網路層提供的服務
---
### 面向連接 - 虛電路服務
* 中心思想: 可靠通信由網路來保證
* 必須建立網路層的連接 - 虛電路(VC, Virtual Circuit)
* 通信雙方沿著建立的虛電路發送分組。
* 目的主機的地址僅在建立連接時使用，後續分組僅需攜帶一條虛電路的編號。
* 這種通信信方式+可靠網路協議可以達成按序到達、不丟失與不重複。
* 通信結束需要釋放虛電路
> 與電路交換真正使用物理線路連接不同，虛電路連接只是先設定好路徑。

### 面向無連接 - 數據報服務
* 中心思想: 可靠通信應透過用戶主機保證。
* 不需要在網路層建立連接。
* 每個分組可以走不同路徑。
* 每個分組首部必須攜帶目的主機的完整地址。
* 這種通信方式可能產生誤碼、丟失、重複與失序。
* 由於網路本身不提供端到端的可靠傳輸服務，使得網路中的路由器造價便宜。
* 為Internet採用的設計思想。

# IPv4地址
---
### 概述
* 在TCP/IP體系中，IP地址是最基本的概念
* IPv4就是給Internet上的每一台主機(or路由器)的**每一個接口**分配一個在全世界範圍內**唯一的32 bits標示符**。
* IP地址由ICANN(Internet Corporation for Assigned Names and Numbers)進行分配
	* 台灣用戶可以向APNIC(Asia Pacific Network Information Center)申請IP地址，但須繳納費用且不接受個人申請。
	* 2011年IPv4地址已經分配完畢，全面開始使用IPv6地址。
* IPv4地址使用點分十進制表示方法: 將"8 bits"分為一組每組用"."區隔 
	* e.g. 10.240.15.170
### Stage 1 - IPv4地址分類 
![[Screenshot 2023-08-11 155036.png]]
* 只有A, B, C類地址可以分配給主機與路由器的各個接口。
* D類地址為多播地址
* E類地址為保留地址
* **主機號全0**的地址是網路地址，不能分配給主機
* **主機號全1**的地址為廣播地址，不能分配給主機
> 常用二進制換算 1, 2, 4, 8, 16, 32, 64, 128，256分別表示1, 10, 100, 1000, 10000, ....
#### A類地址
* 第一個位為0表示A類地址
* network id最大為011111111 = 127，作為本地回環地址不能指派
	* 127.0.0.1 ~ 127.255.255.254都是回環地址
* 可指派範圍: **1**.0.0.1 ~ **126**.255.255.254
* 可容納網路數量: $2^{(8 -1)} - 2 = 126$ (-2因為最小網路號0與最大網路號127不能分配)
* **可容納主機數量**: $2^{(24)} - 2 = 16,777,214 \approx16\: millions$ (-2因為扣掉廣播與網路地址)
#### B類地址
* 可指派範圍: **128.0**.0.1 ~ **191.255**.255.254
* 可容納網路數量: $2^{(16 -2)} = 16,384$ 
* **可容納主機數量**: $2^{16} - 2 =  65,534$ (-2因為扣掉廣播與網路地址) 
#### C類地址
* 可指派範圍: **192.0.0**.1 ~ **223.255.255**.255.254
* 可容納網路數量: $2^{(24 -3)} = 2,097,152 \approx2\: millions$ 
* **可容納主機數量**: $2^{8} - 2 = 254$ (-2因為扣掉廣播與網路地址)
#### 總結
|first|type|
|---|---|
|< 127|A type|
|128 ~ 191|B type|
|192 ~ 223|C type|
> 記得128與192就行。
##### 分配ip地址原則為:
1. 分解出所有的網路
2. 計算每個網路所使用的主機數量
3. 以最節約原則考慮，依據可容納主機量分配A, B 或 C類地址。

### Stage 2 - 劃分子網的IPv4
#### 背景
一間公司有一個大型LAN (2,000台主機) 要連接Internet，申請了B類地址，如網路號為**145.13**.0.0，此時有大量的ip位置剩餘。但隨者公司體系變大，新增新的計算機，並將網路猜分成各個子網路。
* 若公司將每個子網路都向Internet申請ip地址:
	* 增加審核等待時間
	* 增加費用支出
	* 增加路由器的路由表紀錄
	* 浪費原有網路中的大量ip地址。
就想到能將原有的浪費的ip地址作為子網路號，如子網路1為**145.13.1**.0，子網路2為**145.13.2**.0等。

#### 子網掩碼 (subnet mask)
為了知道有哪幾位被用來做為網路號，故誕生了subnet mask，**為32 bits**，用**連續的1表示網路號(網路號+子網號)**，連續的0表示主機號，將subnet mask與IPv4地址進行邏輯與運算，就可以得到IPv4地址所在的子網地址。
#### 例題
Q: **IPv4地址為218.75.230.0, 子網掩碼為255.255.255.128**
A: 
	由218發現它為C類網路地址，故網路號為218.75.230.0
	將子網掩碼中的128轉為二進制 = 1000 0000
	故使用一個bit作為子網號，故能劃分的子網數量為$2^1$
	一個子網可容納的主機數量為$2^{7} - 2=126$
> 最好都使用2進制去看

### Stage 3 - 無分類編址的IPv4地址 (CIDR, Classless Inter-Domain Routing)
雖然可以透過子網劃分緩解Internet發展中的困難，但數量巨大的C類網路，因為其地址空間太小沒有充分利用，故IPv4面臨耗盡威脅。故IETF發表**CIDR消除了A, B, C類地址以及劃分子網**概念，可以**更有效分配IPv4地址空間**。
#### CIDR
CIDR 表示法會在後面**使用"/"寫上網路號所佔的bit數量**，如128.14.35.7/20，表示網路號占20 bits，主機號占用32 - 20 = 12 bits。
![[Screenshot 2023-08-12 203647.png]]
子網掩碼為255.255.240.0

#### 路由聚合(超網路) - Superneting
路由器A與路由器B會互相通知對方所擁有的網路，但是這樣會讓路由表新增太多紀錄，故使用路由聚合技術，概念為**找到共同前綴**如下圖所示。
![[Screenshot 2023-08-12 205601.png]]
原本R2路由表要新增5個筆資料，但是使用Superneting就可以只記錄1比資料。
##### 最長前綴匹配
表示IPv4地址有多個匹配的Superneting會選擇網路號占用bit最多的，因為路由越具體。


# IP Datagram的發送與轉發
---
