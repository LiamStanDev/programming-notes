# 設備
---
![[Pasted image 20240604084918.png]]
* 由左至右分別為：路由器、無限基地台、交換機、數據機
### 設備概述
#### 數據機
由 ISP 提供，用於取得電信業者提供的外部網路（也就是一組 IP 地址），在大陸稱為光貓，訊號來源會使用光纖、電話線或同軸電纜，可將其轉換為可以被家庭或辦公網絡使用的信號。

分為兩種模式：
1. 路由模式：此時數據機充當路由器的角色，由數據機進行 PPPoE 撥號取得公共 IP 地址。數據機負責NAT 和DHCP，向內部網絡中的設備分配私有IP地址
2. 橋接模式：數據機將光訊號（光纖）轉為電訊號之後轉給路由器，由路由器進行 PPPoE 撥號取得公共 IP 地址。路由器負責NAT和DHCP，向內部網絡中的設備分配私有IP地址。

> 建議使用橋接模式，因為可以避免 double NAT（信能損耗）。但因為路由模式插上去就能用所以幾乎是默認選項。

#### 路由器
由於 IPS 提供的 IP 地址不足以滿足所有連接設備，所以就需要路由器來提供內部網路也就是私人 IP（通過 NAT 技術），給予所有連網的裝置一個 IP 地址。
> 私人 IP 本質上其實是共用一組公共 IP

* 路由器分為: 普通路由器與無限路由器
#### 交換器
用於增加實體網路接口的設備，因為路由器與數據機的實體 RJ45 接口通常很少，它可以將網路接口**橋接**（同級）到數據機與路由器上。

#### 無限基地台 (無限 AP)
用來提供無限連接功能，但不會自動配發 IP 地址，故不會像路由器一樣建立一個內部網路，故前端一定要搭配一個路由器。
> 本質只是將有限訊號轉成無限訊號的機器

### 實體網路架構配置
#### 最簡單配置
![[Pasted image 20240604090803.png]]
直接將數據機的網路接給 PC 讓 PC 可以上網。

#### 擴充網路孔
![[Pasted image 20240604090939.png]]
透過交換機使數據機可連接更多設備

#### 多內網配置
![[Pasted image 20240604091152.png]]
不同樓層間使用路由器分配 IP 給各個設備，但就無法相互訪問不同樓層的設備。

#### 大內網配置（最常用）
![[Pasted image 20240604091449.png]]
透過數據機接一個路由器（不一定需要 wifi 功能），透過交換機連接多個 AP 路由器（or 基地台），大多數路由器會知道前面有一個路由就只會作為基地台只做有線轉無線的功能。
註1：設備也可以直接連接交換機。
註2：第一個路由器就是默認網關

> **使 IPv6 公網下放設定：**
> 將數據機改為橋接模式後，將第一個路由器設定為 PPPoE 撥接連線，直接連到 IPS 服務。可以使數據機只將數據傳給第一個路由，而不再做 double NAT。
>> 數據機可以查看底部的連接設定並使用帳號密碼登入修改，路由器也相同。

# 網路
---
注意以下都是以如下網路拓譜展開：

![[Pasted image 20240604111929.png]]

### DHCP
全名為 Dynamic Host Configuration Protocal，是一個應用層協議使用 UDP 傳輸。可以配置主機啟用該協議，它會發起 DHCP 請求。
#### 通訊流程詳解
##### 1. 由主機發出 DHCP 請求
* 應用層：
	* 大致為請給我 IP 地址，並提供本機資訊
* 傳輸層 (UDP)：
	* 源端口： 68 
	* 目標端口： 67。
* 網路層：
	* 因為不知道 DHCP 服務器 IP 地址，故目標直接使用廣播地址 `255.255.255.255`，而因為還沒有本機 IP 地址故源地址使用未指定 IP `0.0.0.0`。
* 網路接口層：
	* 源 MAC: 本機 MAC 地址
	* 目標 MAC: `ff:ff:ff:ff:ff:ff`（廣播 MAC 地址）

##### 2. 交換機
交換機只讀的懂網路接口層中的 MAC 地址，其他對它來說只是亂碼，透過查詢它的 MAC 地址映射表，發現是廣播地址，故將所有連接的設備都發送一份。

##### 3. DHCP 到達各設備
###### 由其他主機收到
* 網路接口層：
	* 雖然與目標 MAC 不同，但因為是廣播 MAC 所以會接收
* 網路層：
	* 發現不是自己的 IP，但因為是廣播 IP 所以會接收
* 傳輸層：
	* 因為沒有運行 DHCP 服務故沒有監聽 67 端口，故將數據包丟棄
###### 由路由器收到
* 網路接口層：
	* 雖然與目標 MAC 不同，但因為是廣播 MAC 所以會接收
* 網路層：
	* 發現不是自己的 IP，但因為是廣播 IP 所以會接收
* 傳輸層：
	* 由於有運行 DHCP 服務故將數據接收交給 DHCP 服務處理
> 一般家用路由器會提供很多服務：DHCP、DNS、DDNS、端口轉發、防火牆等

##### 4. 路由器發送 DHCP 響應
會從他的地址池中取得沒有使用的 IP 地址。
* 應用層：
	* 包裝：IP 地址＋子網掩碼＋默認網關＋DNS＋租約到期剩餘時間。
接下來幾層反向發送回去就好。

##### 5. 主機收到 DHCP 響應
在應用層解包後得到IP 地址＋子網掩碼＋默認網關＋DNS＋租約到期剩餘時間，之後會在到期後再次進行 DHCP 請求進行續約。

#### 其他細節
* 1. 若 DHCP 服務掛了：
	* DHCP 客戶端會在多次請求無果後會自動設定 `169.254.xxx.xxx` 為本機 IP，以使其還能與 LAN 中設備通訊，當受到這個 IP 就需要排查 DHCP 服務。
* 2. 公共場所的 wifi 租約時間:
	* 通常都會設定為 10 分鐘或更短，以免 IP 地址池中不足。
	* 家用網路默認為 12 個小時，可以自行設定。


### DNS
全名為 Domain Name Service，用於查詢域名轉所在的實際 IP 地址，協議使用 UDP 進行傳輸。
##### 1. 主機發送 DNS 請求
* 應用層：
	* 提供要查詢的域名
* 傳輸層 (UDP)：
	* 源端口：為瀏覽器選擇的空閒端口（此例為 9527）
	* 目標端口： 53
* 網路層：
	* 源 IP：本機 IP 本例為 192.168.1.3
	* 目標 IP: 為本機配置的 DNS 服務器位置
* 網路接口層：
	* 源 MAC: 本機 MAC 地址
	* 目標 MAC: 目前主機不知道默認網關的 MAC 地址，故會發起  ARP 請求，取得默認網關 MAC 地址。
##### 2. 默認網關
會將 DNS 請求向外網發送。
> 默認網關是一個特別的設備，他不會丟棄不與其 IP 批配的請求，而是會通過 PPPoE 連線 IPS 轉而送給外網。
>> 註：其他設備也能夠開啟 IP 轉發功能充當默認網關。

##### 3. 主機收到 DNS 響應
瀏覽器接收後，更新本機的 DNS 緩存表。
> DNS 緩存表中的 TTL 表示多久會過期需要更新。

### APR
全稱為 Address Resolution Protocal，用於透過 IP 地址找尋 MAC 地址，為網路層協議（與 IP 協議同級）。
##### 1. 主機發起 ARP
* 網路層：
	* 包含本機 IP 以及要查找的 IP 資訊
* 網路節口層：
	* 源 MAC: 本機 MAC
	* 目標 MAC:  `ff:ff:ff:ff:ff:ff`（廣播 MAC 地址）
##### 2. 到達交換機
交換機發現是廣播 MAC，故將所有接口都發送一次。

##### 3. 到達主機
###### 到達非正確 IP 的主機
發現與自己的 IP 不同，但會在該主機中的 ARP 緩存表中將發送者的 IP 與 MAC 紀錄起來。
> ARP 緩存表中會紀錄過期時間
###### 到達正確 IP 主機
響應該 ARP 請求，
* 網路層：
	* 添加主機的 IP 資訊
* 網路接口層：
	* 源 MAC： 本機 MAC
	* 目標 MAC：發送者 MAC

##### 4. 主機接收 ARP 響應
更新 ARP 緩存表。

# References
* [一个视频讲清楚家庭网络通信流程](https://www.youtube.com/watch?v=P38FmPAq09E&t=114s)
* [家庭網路設備](https://www.youtube.com/watch?v=FcY0i60OvVk)
* [使用 IPv6 取得公網 IP](https://www.youtube.com/watch?v=dQ1AMXAiEJk&t=987s)
