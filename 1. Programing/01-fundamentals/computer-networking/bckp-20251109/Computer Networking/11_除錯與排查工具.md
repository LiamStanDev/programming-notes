# 11_除錯與排查工具

本章介紹常用網路除錯工具的原理、用法、實務範例，以及資深後端工程師的最佳實踐建議，協助你有效排查網路問題。

---

## 1. 常用網路除錯工具原理與用法

### 1.1 tcpdump

- **原理**：`tcpdump`（封包擷取工具，Packet Capture Tool）可在命令列即時擷取網路介面上的封包，支援多種協議。
- **用法**：
  - 擷取所有封包：`tcpdump -i eth0`
  - 只擷取特定 port：`tcpdump -i eth0 port 80`
  - 儲存封包：`tcpdump -i eth0 -w output.pcap`

### 1.2 Wireshark

- **原理**：`Wireshark`（圖形化封包分析器，Packet Analyzer）可視覺化分析封包內容，支援協議解碼與篩選。
- **用法**：
  - 開啟介面擷取封包，使用 Display Filter（顯示篩選器）如 `http`、`ip.addr == 192.168.1.1`。
  - 讀取 `tcpdump` 產生的 `.pcap` 檔案。

### 1.3 curl

- **原理**：`curl`（命令列 HTTP 客戶端，Command-line HTTP Client）用於發送 HTTP/HTTPS 請求，測試 API 或網頁服務。
- **用法**：
  - 基本請求：`curl https://example.com`
  - 顯示 header：`curl -I https://example.com`
  - 發送 POST：`curl -X POST -d "key=value" https://example.com/api`

### 1.4 dig

- **原理**：`dig`（DNS 查詢工具，Domain Information Groper）用於查詢 DNS 記錄，分析網域解析狀態。
- **用法**：
  - 查詢 A 記錄：`dig example.com`
  - 查詢 MX 記錄：`dig example.com MX`

### 1.5 nslookup

- **原理**：`nslookup`（DNS 查詢工具，Name Server Lookup）可查詢 DNS 記錄，適合快速測試。
- **用法**：
  - 查詢：`nslookup example.com`
  - 指定 DNS 伺服器：`nslookup example.com 8.8.8.8`

### 1.6 traceroute

- **原理**：`traceroute`（路由追蹤工具，Route Tracing Tool）追蹤封包從本機到目的地的路徑，顯示每一跳（Hop）。
- **用法**：
  - 基本用法：`traceroute example.com`

### 1.7 netstat

- **原理**：`netstat`（網路狀態監控工具，Network Statistics）顯示網路連線、路由表、介面統計等資訊。
- **用法**：
  - 顯示所有連線：`netstat -an`
  - 顯示監聽 port：`netstat -lntp`

### 1.8 ss

- **原理**：`ss`（Socket 統計工具，Socket Statistics）類似 `netstat`，但效能更佳，支援更多 socket 資訊。
- **用法**：
  - 顯示所有 TCP 連線：`ss -t -a`
  - 顯示監聽 port：`ss -lnt`

### 1.9 iftop

- **原理**：`iftop`（即時流量監控工具，Interface Top）即時顯示網路介面的流量排行，方便找出高流量來源。
- **用法**：
  - 監控介面：`sudo iftop -i eth0`

---

## 2. Mermaid 圖解：封包擷取與分析流程

```mermaid
flowchart TD
    A[啟動封包擷取工具<br>(tcpdump/Wireshark)] --> B[擷取網路封包]
    B --> C{儲存封包檔案？}
    C -- 是 --> D[儲存為 .pcap 檔]
    C -- 否 --> E[即時分析]
    D --> F[用 Wireshark 開啟分析]
    E --> F
    F --> G[套用協議/條件篩選]
    G --> H[分析封包內容]
    H --> I[定位問題]
```

---

## 3. 真實範例

### 3.1 tcpdump 抓包指令

- 擷取本機 80 port 封包並存檔：
  ```bash
  sudo tcpdump -i eth0 port 80 -w web_traffic.pcap
  ```
- 只顯示來源為 192.168.1.10 的封包：
  ```bash
  sudo tcpdump src 192.168.1.10
  ```

### 3.2 Wireshark 篩選

- 篩選 HTTP 封包：`http`
- 篩選特定 IP：`ip.addr == 10.0.0.5`
- 篩選 TCP port 443：`tcp.port == 443`

### 3.3 curl 測試

- 測試 API 並顯示回應 header：
  ```bash
  curl -I https://api.example.com/v1/status
  ```
- 發送 JSON 資料：
  ```bash
  curl -X POST -H "Content-Type: application/json" -d '{"id":123}' https://api.example.com/v1/data
  ```

### 3.4 iftop 監控截圖說明

- 執行 `sudo iftop -i eth0`，畫面會顯示：
  - 左側：來源與目的 IP
  - 右側：即時流量（bps/pps）
  - 下方：總流量統計
- 可用於快速找出異常流量來源。

---

## 4. 資深後端工程師的實務建議與最佳實踐

### 4.1 工具選擇建議

- **tcpdump** 適合 CLI 環境、遠端伺服器初步抓包。
- **Wireshark** 適合進階協議分析與視覺化追蹤。
- **curl** 是 API、HTTP 問題排查的首選。
- **iftop**、**netstat**、**ss** 適合即時監控與 socket 狀態檢查。

### 4.2 排查流程建議

1. **明確問題現象**：先確認問題是連線失敗、延遲、還是資料異常。
2. **分層排查**：從應用層（curl）、傳輸層（tcpdump）、網路層（traceroute、iftop）逐層檢查。
3. **封包擷取與分析**：用 tcpdump 抓包，Wireshark 詳查協議內容。
4. **DNS 驗證**：用 dig/nslookup 檢查網域解析。
5. **路由追蹤**：traceroute 檢查路徑與延遲。

### 4.3 常見誤區

- **只用單一工具**：建議多工具交叉驗證，避免盲點。
- **忽略 DNS 問題**：DNS 解析錯誤常是連線問題主因。
- **未儲存封包檔案**：現場抓包應儲存 `.pcap` 以便後續分析。
- **未考慮權限問題**：部分工具需 root 權限，建議用 `sudo` 執行。

---
