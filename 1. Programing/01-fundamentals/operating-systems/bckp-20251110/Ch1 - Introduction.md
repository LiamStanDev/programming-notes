# 操作系統概念
---
指的是**管理整個計算機系統的軟體與硬體的資源**，提供用戶與其他軟體**方便調用的接口**，為計算機最基本的系統環境。

### OS提供的功能
- 進程管理
- 文件管理
- 內存管理
- I/O管理

### OS向上層提供的服務方式
#### 給用戶直接使用
* GUI
* CLI
#### 給程序使用
* 系統調用：程序接口
![[Untitled(1).png]]



# 操作系統的特徵
---
### 併發
> 多個事件在同一時間間隔內**同時發生**
- 在巨觀上看是同時發生，在微觀上看是**交替發生**（除了多核CPU）
- 併發為操作系統提供，平行為物理CPU提供
	- 平行為併發的子集合

💡 併發是操作系統最重要的特徵也**是其他特徵的基礎**，也是最初建立OS的理由

### 共享
> 指操作系統的資源能**被多個併發執行的進程所使用**
- 互斥共享
- 同時共享

### 虛擬
> 把物理上的實體映射到邏輯上的對應，用戶感受到的是邏輯上的對應，不會直接管理物理實體

有以下例子：
1. 電腦可以運行總和超出實際RAM大小的軟體 （多個並行）⇒ 空分複用技術（虛擬存處技術）
2. 單核心CPU可以併發的跑多個應用，就像每個應用都有一個CPU服務 ⇒ 分時複用技術（虛擬處理器技術）

### 異步
> 允許多個程序**併發執行**，但因為資源有限，進程執行不是一貫到底，而是**走走停停**，所以以**不可預知的速度**前進。
- 資源有限：計算資源、儲存資源、網路資源等

# 操作系統分類
---
### 單道批處理系統（Simple Batch Processing System）
執行一次程式就要進行：
1. 讀入 (I/O -> 慢)
2. 計算
3. 輸出 (I/O -> 慢)
這三個部分並不重疊，cpu真正運行時間只有運行部分，cpu利用率很低

### 多道批處理系統（Batch Processing System）
將多個程序一次性讀入，使得cpu不用等待I/O讀入與I/O輸出，提高CPU利用率。
![[Pasted image 20230806131930.png]]
* 缺點：
	* 程式需要一次進行到底，無法進行交互
	* 無法併發(Concurency): 巨觀上多個程式同時運行

### 分時操作系統（Time-Sharing System）
將CPU時的計算時間分片，均勻地分配給所有軟件（用戶）使用，因為該時間片獨佔cpu資源，故可以實現交互。
* 缺點：無法區分優先級

### 時實操作系統（Real-time operating system（RTOS））
計算機能接受到外部信號後進行即時處理，並要求在時間限制內完成任務


# OS的運行機制
---
### 特權指令 vs. 非特權指令
些指令會讓CPU執行會（對其他程序或者計算機本身）造成很嚴重的影響，如內存清零等，所以**只允許管理者也就是內核程序執行**，稱作特權指令。
> CPU本身就可以區分指令是否為特權與非特權。

### 內核態 vs. 用戶態
CPU可以識別特權與非特權指令，識別用戶使用PWD(程序狀態寄存器)，當PWD為0表示用戶態，1表示內核態。
#### 狀態切換案例
1. 開機時計算機初始化為內核態，運行內核程序
2. 初始化完成之後，使用者啟用應用程序
4. 操作系統在合適的時間將PSW設定為0，切換成用戶態，並轉讓CPU時間
5. 應用程序指令一條一條執行
6. 程序中被植入一條特權指令，CPU運行時發現用戶態執行特權指令
7. CPU立刻發起中斷信號，停止運行該應用的指令，並切換為內核態
8. 操作系統因“中斷”信號奪回CPU控制權，進行中斷處理
9. 處理完成再度切換為用戶態
10. 用戶可以繼續執行其他應用

# 中斷與異常
---
### 異常（又稱為內中斷）  
**與運行的指令有關**，中斷信號來自於CPU內部
- 分為
	1. trap（陷入）：由應用程序主動請求OS服務
	2. fault（故障）：由錯誤條件引起，可以由OS進行修復 e.g. 缺頁故障
	3. abort（終止）：無法由OS進行修復 e.g. 除零、用戶態運行特權指令
- 有以下例子：
	1. 試圖在用戶態運行特權指令(abort)
	2. 除以零錯誤(abort)
	3. 陷入指令(trap)：由應用程序主動請求OS 服務（系統調用）
		* **陷入指令為非特權指令**
		
### 中斷（又稱為外中斷）
中斷信號來自於CPU外部，**不是透過執行指令引起**。
- 有以下例子：
	1. 時鐘中斷：由時鐘這個部件發出的中斷信號，每間隔一段時間發出
		當發起時鐘中斷後，CPU進入內核態，並運行中斷處理，此處理OS會決定執行哪個程序，並切換為用戶態，執行該程序
	2. I/O中斷：由外部的I/O設備發起的中斷信號

### 中斷處理方式
不同的中斷要對應不同的中斷處理，CPU在檢測中斷時會查詢**中斷向量表**，找到對應的中斷處理程序存放位置並執行。
> 中斷向量表存放函數指針。


# 系統調用 (System Call)
---
系統調用存在主要是因為要訪問公共資源，再多個進程需要統一管理資源，所以產生系統調用用來分配系統資源。
### 系統調用種類
1. 設備管理
2. 文件管理
3. 進程管理
4. 進程通信
5. 內存管理

# 操作系統架構
---
![[Untitled(2).png]]
* 藍色部分的管理類不會直接操控硬體，而是利用數據結構進行管理。

### 架構分類
#### 大內核架構
內核態包含管理類。
* 優點：進行一次狀態切換，就能訪問多種服務。
	* e.g. 進程管理需要文件管理的服務，只需要一次狀態切換。
* 缺點：內核臃腫較難維護。

#### 微內核架構
極小化內核功能，管理類不包含在內核態。
* 優點：方便維護。
* 缺點：需要多次狀態切換。

# 開機流程
---
### 外存結構
![[Untitled(3).png]]
* 分區表紀錄每個分區的起始與結束的地址＋分區的類型

### 啟動流程

1. CPU執行ROM (Read-only memory)引導程序，先進行硬件自檢後開機
	* ROM鑲嵌在主機板上，裡面包涵ROM引導程序也就是BIOS程序
1. ROM引導程序指示CPU使MBR讀入內存，進行磁盤引導，掃描分區表找到PBR
2. 讀入RBR並執行其中程序，該程序會找到根目錄的操作系統完整程序
3. 讀入操作系統程序中的啟動引導程序（Bootloader: 通常在boot目錄裡），完成開機動作